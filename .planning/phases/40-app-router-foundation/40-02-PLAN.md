---
phase: 40-app-router-foundation
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - app/layout.tsx
  - src/AppShell.tsx
autonomous: true
requirements:
  - MIGR-04

must_haves:
  truths:
    - "app/layout.tsx is a Server Component root with metadata, viewport, fonts, CSS, theme script, and ClientProviders wrapping children"
    - "AppShell uses ClientProviders with BrowserRouter as routerWrapper instead of inline provider nesting"
    - "The app builds successfully with both routers coexisting"
    - "Existing tests pass without regression"
  artifacts:
    - path: "app/layout.tsx"
      provides: "App Router root layout (Server Component)"
      exports: ["default", "metadata", "viewport"]
    - path: "src/AppShell.tsx"
      provides: "Pages Router SPA shell using ClientProviders"
      contains: "ClientProviders"
  key_links:
    - from: "app/layout.tsx"
      to: "src/components/ClientProviders.tsx"
      via: "import and render"
      pattern: "import.*ClientProviders"
    - from: "app/layout.tsx"
      to: "src/lib/themeScript.ts"
      via: "import THEME_SCRIPT for inline script"
      pattern: "import.*THEME_SCRIPT.*themeScript"
    - from: "src/AppShell.tsx"
      to: "src/components/ClientProviders.tsx"
      via: "import and render with routerWrapper"
      pattern: "ClientProviders.*routerWrapper"
---

<objective>
Replace the minimal `app/layout.tsx` stub with a production-ready Server Component root layout, and refactor AppShell to use ClientProviders.

Purpose: Complete the App Router shell infrastructure (MIGR-04) and validate that ClientProviders works correctly with the existing Pages Router routes.
Output: Full `app/layout.tsx`, refactored `src/AppShell.tsx`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-app-router-foundation/40-CONTEXT.md
@.planning/phases/40-app-router-foundation/40-RESEARCH.md
@.planning/phases/40-app-router-foundation/40-01-SUMMARY.md

@app/layout.tsx
@src/AppShell.tsx
@pages/_app.tsx
@src/components/ClientProviders.tsx
@src/lib/themeScript.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build production-ready app/layout.tsx</name>
  <files>app/layout.tsx</files>
  <action>
Replace the current minimal stub `app/layout.tsx` with a full Server Component root layout.

**Structure:**
```typescript
import type { Metadata, Viewport } from 'next';
import { ClientProviders } from '@/components/ClientProviders';
import { THEME_SCRIPT } from '@/lib/themeScript';

// Self-hosted Myanmar font (PWA offline support) — match _app.tsx import order
import '@fontsource/noto-sans-myanmar/400.css';
import '@fontsource/noto-sans-myanmar/500.css';
import '@fontsource/noto-sans-myanmar/700.css';

import '../src/styles/globals.css';

export const metadata: Metadata = { ... };
export const viewport: Viewport = { ... };

export default function RootLayout({ children }) {
  return (
    <html lang="en" suppressHydrationWarning>
      <head>
        <script dangerouslySetInnerHTML={{ __html: THEME_SCRIPT }} />
        <link rel="apple-touch-icon" href="/icons/icon-192.png" />
      </head>
      <body>
        <ClientProviders>{children}</ClientProviders>
      </body>
    </html>
  );
}
```

**Metadata export** (match what's currently in `_document.tsx` `<Head>`):
- `title`: 'Civic Test Prep - Master Your U.S. Citizenship Test'
- `description`: same as current meta description
- `manifest`: '/manifest.json'
- `appleWebApp`: `{ capable: true, statusBarStyle: 'black-translucent', title: 'US Civics' }`
- `other`: `{ 'mobile-web-app-capable': 'yes' }`

**Viewport export:**
- `width: 'device-width'`
- `initialScale: 1`
- `viewportFit: 'cover'`
- `themeColor`: Array with light (`#002868`) and dark (`#1a1f36`) media query variants

**Critical details:**
- `suppressHydrationWarning` on `<html>` tag — theme script adds class before hydration
- CSS import order: Myanmar fonts first, then globals.css (matches `_app.tsx`)
- `<head>` only contains the inline theme `<script>` and `<link rel="apple-touch-icon">` — everything else uses the metadata/viewport API
- ClientProviders wraps `{children}` WITHOUT a routerWrapper prop (App Router doesn't use react-router-dom)
- No `not-found.tsx` or `loading.tsx` (deferred to Phase 41)

Import from: `@/components/ClientProviders` (created in Plan 01)
Import from: `@/lib/themeScript` (created in Plan 01)
  </action>
  <verify>
    <automated>cd /c/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && npx tsc --noEmit --pretty 2>&1 | tail -5</automated>
  </verify>
  <done>
    - `app/layout.tsx` is a Server Component (no 'use client' directive)
    - Exports `metadata` (Metadata type) and `viewport` (Viewport type)
    - Imports and renders `ClientProviders` wrapping `{children}`
    - Theme script injected via `dangerouslySetInnerHTML`
    - `suppressHydrationWarning` on `<html>`
    - Myanmar font CSS and globals.css imported in correct order
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor AppShell to use ClientProviders</name>
  <files>src/AppShell.tsx</files>
  <action>
Refactor `src/AppShell.tsx` to use `ClientProviders` instead of inline provider nesting. This validates the extraction works with existing routes.

**Changes:**
1. Remove all 10 individual provider imports (ErrorBoundary, LanguageProvider, ThemeProvider, TTSProvider, ToastProvider, OfflineProvider, AuthProvider, SocialProvider, SRSProvider, StateProvider, NavigationProvider) — these are now in ClientProviders
2. Add import: `import { ClientProviders } from '@/components/ClientProviders';`
3. Keep import: `import { BrowserRouter as Router } from 'react-router-dom';`
4. Replace the entire inline provider nesting (lines 201-335) with:

```tsx
<ClientProviders routerWrapper={Router}>
  <Head>
    <title>Civic Test Prep - Master Your U.S. Citizenship Test</title>
    <meta name="description" content="..." />
  </Head>
  <ErrorBoundary>
    <NavigationShell>
      <PageTransition>
        <Routes>
          {/* ... all routes unchanged ... */}
        </Routes>
      </PageTransition>
    </NavigationShell>
  </ErrorBoundary>
  <CelebrationOverlay />
  <PWAOnboardingFlow />
  <OnboardingTour />
  <GreetingFlow />
  <SyncStatusIndicator />
</ClientProviders>
```

**What stays in AppShell:**
- `useIsClient()` hook and its usage (SSR guard for the whole SPA)
- `useViewportHeight()` call
- `cleanExpiredSessions()` effect
- `installHistoryGuard()` call at module level
- `<Head>` with title/description (for Pages Router routes)
- Inner `<ErrorBoundary>` around `<NavigationShell>` (the outer ErrorBoundary moved into ClientProviders)
- `<NavigationShell>` — it uses `useLocation()` from react-router-dom
- `<PageTransition>` and all `<Routes>`/`<Route>` definitions
- All overlay components (CelebrationOverlay, PWAOnboardingFlow, OnboardingTour, GreetingFlow, SyncStatusIndicator)
- `PWAOnboardingFlow`, `RedirectWithLoading`, `GreetingFlow` inner components

**What moves out (handled by ClientProviders):**
- The outer ErrorBoundary wrapping
- All 10 context provider imports and nesting
- The `<Router>` wrapping (now passed as `routerWrapper={Router}`)

**Keep imports for:**
- `ErrorBoundary` — still needed for inner ErrorBoundary around routes
- `NavigationShell` — still rendered inside AppShell
- `BrowserRouter as Router` — passed as routerWrapper prop
- All page imports, overlay imports, etc. — unchanged

Import from: `@/components/ClientProviders` (created in Plan 01)
  </action>
  <verify>
    <automated>cd /c/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && pnpm test:run 2>&1 | tail -10</automated>
    <manual>Verify the app still loads at localhost:3000 with all routes working</manual>
  </verify>
  <done>
    - AppShell uses `<ClientProviders routerWrapper={Router}>` instead of inline provider nesting
    - All 10 individual provider imports removed from AppShell
    - Inner ErrorBoundary + NavigationShell + overlays still in AppShell
    - `pnpm test:run` passes with no regressions
    - Provider nesting order is preserved (single source of truth in ClientProviders)
  </done>
</task>

</tasks>

<verification>
- `pnpm test:run` passes (existing tests work with refactored providers)
- `pnpm build` succeeds (both routers coexist, app/layout.tsx compiles)
- `app/layout.tsx` exports metadata and viewport
- `src/AppShell.tsx` uses ClientProviders with routerWrapper
- No duplicate provider nesting between AppShell and ClientProviders
</verification>

<success_criteria>
- App Router root layout is production-ready with metadata, viewport, fonts, CSS, theme script, and ClientProviders
- AppShell is refactored to use ClientProviders — single source of truth for provider nesting
- Build succeeds with both Pages Router and App Router coexisting
- All existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/40-app-router-foundation/40-02-SUMMARY.md`
</output>
