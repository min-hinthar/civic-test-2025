---
phase: 43-test-readiness-score-and-drill-mode
plan: 03
type: execute
wave: 2
depends_on: ["43-01"]
files_modified:
  - app/(protected)/drill/page.tsx
  - src/views/DrillPage.tsx
  - src/components/drill/DrillConfig.tsx
  - src/components/drill/DrillResults.tsx
  - src/components/drill/DrillBadge.tsx
autonomous: true
requirements: [RDNS-04, RDNS-05, RDNS-06]

must_haves:
  truths:
    - "User can navigate to /drill from Dashboard 'Drill Weak Areas' button and start a drill session"
    - "User can navigate to /drill?category=X from a category-specific drill button"
    - "Pre-drill screen shows focus areas, question count selector (5/10/20), estimated time, Start Drill button"
    - "Drill session reuses existing PracticeSession component with drill-specific questions"
    - "Drill mode has distinct orange accent or header badge to distinguish from normal practice"
    - "After completion, results page shows headline score (X of Y correct) and mastery delta"
    - "Mastery delta shows animated counter counting from pre to post mastery value"
    - "Mini readiness ring animates from old readiness score to new value"
    - "80%+ correct triggers confetti celebration, 50-79% shows encouraging message, <50% shows motivational nudge"
    - "Three post-drill actions: New Drill, Practice [Category], Back to Dashboard"
    - "Early exit preserves answered progress and shows partial results"
    - "All text fully localized for Burmese"
  artifacts:
    - path: "app/(protected)/drill/page.tsx"
      provides: "App Router page wrapper for DrillPage"
      min_lines: 5
    - path: "src/views/DrillPage.tsx"
      provides: "Drill page managing config -> session -> results flow"
      exports: ["default"]
      min_lines: 100
    - path: "src/components/drill/DrillConfig.tsx"
      provides: "Pre-drill configuration screen with focus areas and count selector"
      exports: ["DrillConfig"]
      min_lines: 60
    - path: "src/components/drill/DrillResults.tsx"
      provides: "Post-drill results with mastery delta, celebration, readiness ring animation"
      exports: ["DrillResults"]
      min_lines: 100
    - path: "src/components/drill/DrillBadge.tsx"
      provides: "Visual drill mode indicator badge"
      exports: ["DrillBadge"]
  key_links:
    - from: "app/(protected)/drill/page.tsx"
      to: "src/views/DrillPage.tsx"
      via: "import DrillPage from '@/views/DrillPage'"
      pattern: "DrillPage"
    - from: "src/views/DrillPage.tsx"
      to: "src/components/practice/PracticeSession.tsx"
      via: "PracticeSession component for quiz flow"
      pattern: "PracticeSession"
    - from: "src/views/DrillPage.tsx"
      to: "src/lib/readiness/drillSelection.ts"
      via: "selectDrillQuestions for question selection"
      pattern: "selectDrillQuestions"
    - from: "src/views/DrillPage.tsx"
      to: "src/hooks/useReadinessScore.ts"
      via: "useReadinessScore for pre/post readiness comparison"
      pattern: "useReadinessScore"
    - from: "src/views/DrillPage.tsx"
      to: "postDrillReadiness state"
      via: "useState + useEffect: when phase becomes 'results', refresh() then set postDrillReadiness from updated readiness.score"
      pattern: "setPostDrillReadiness.*readiness\\.score"
    - from: "src/components/drill/DrillResults.tsx"
      to: "src/components/celebrations/CountUpScore.tsx"
      via: "CountUpScore for animated score display"
      pattern: "CountUpScore"
    - from: "src/components/drill/DrillResults.tsx"
      to: "src/hooks/useCelebration.ts"
      via: "celebrate() for confetti on 80%+ correct"
      pattern: "celebrate"
    - from: "src/components/drill/DrillResults.tsx"
      to: "src/components/hub/ReadinessRing.tsx"
      via: "ReadinessRing for animated mini ring on results"
      pattern: "ReadinessRing"
---

<objective>
Build the drill mode page: route, pre-drill config, session wrapper, and post-drill results with mastery delta animation.

Purpose: Drill mode lets users target their weakest areas with focused sessions that show tangible improvement, creating a satisfying feedback loop that keeps them practicing.

Output: Working `/drill` route with config, session, and results phases.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-test-readiness-score-and-drill-mode/43-CONTEXT.md
@.planning/phases/43-test-readiness-score-and-drill-mode/43-RESEARCH.md
@.planning/phases/43-test-readiness-score-and-drill-mode/43-01-SUMMARY.md
@src/views/PracticePage.tsx
@src/components/practice/PracticeSession.tsx
@src/components/practice/PracticeResults.tsx
@src/components/celebrations/CountUpScore.tsx
@src/hooks/useCelebration.ts
@src/components/hub/ReadinessRing.tsx
@src/lib/readiness/index.ts
@src/lib/readiness/drillSelection.ts
@app/(protected)/practice/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Drill route, DrillPage state machine, DrillConfig, and DrillBadge</name>
  <files>
    app/(protected)/drill/page.tsx
    src/views/DrillPage.tsx
    src/components/drill/DrillConfig.tsx
    src/components/drill/DrillBadge.tsx
  </files>
  <action>
    Create `app/(protected)/drill/page.tsx`:
    - 'use client' directive
    - Import and render DrillPage from '@/views/DrillPage'
    - Follow exact same pattern as app/(protected)/practice/page.tsx

    Create `src/components/drill/DrillBadge.tsx`:
    - Simple badge component: orange background pill with "Drill Mode" / "လေ့ကျင့်မုဒ်" text
    - Props: showBurmese (boolean)
    - Styling: bg-orange-500/15 text-orange-600 dark:text-orange-400, rounded-full, px-3 py-1, text-xs font-semibold
    - Icon: Target from lucide-react (small, inline before text)

    Create `src/components/drill/DrillConfig.tsx`:
    - Props: onStart(config: DrillConfigType), mode ('weak-all' | 'category'), categoryName? (CategoryName), showBurmese (boolean)
    - DrillConfigType: { count: number, mode: 'weak-all' | 'category', category?: string }
    - Layout: centered card with rounded-2xl, p-6, max-w-md mx-auto
    - Header: DrillBadge + "Drill Weak Areas" / category name title (localized)
    - Focus areas section: brief text explaining what will be drilled
      - weak-all mode: "Your weakest questions across all categories"
      - category mode: "Questions from {categoryName} you need to practice"
    - Question count selector: 3 option buttons (5, 10, 20) with active state styling
      - Default: 10 selected
      - Active: bg-orange-500 text-white, inactive: bg-muted text-foreground
    - Estimated time: "{count * 30}s - {count * 60}s" (30-60 seconds per question)
    - "Start Drill" button: large, orange accent, rounded-xl, font-bold
      - Localized: "Start Drill" / "လေ့ကျင့်ခန်း စတင်ပါ"
    - All text localized for Burmese

    Create `src/views/DrillPage.tsx`:
    - State machine: 'config' | 'session' | 'results' (same pattern as PracticePage)
    - Read `?category=X` from URL search params using useSearchParams() -- wrap in Suspense if needed (App Router requirement)
    - If category param present: mode = 'category', filter allQuestions to that category's questions using getCategoryQuestionIds
    - If no category param: mode = 'weak-all', use allQuestions as pool
    - Category name: look up from SUB_CATEGORY_NAMES or USCIS_CATEGORY_NAMES
    - On config start:
      1. Capture pre-drill mastery: get overallMastery from useCategoryMastery() (or category-specific mastery if category mode)
      2. Capture pre-drill readiness: store readiness.score into preDrillReadiness state
      3. Load answer history via getAnswerHistory()
      4. Call selectDrillQuestions(pool, config.count, answerHistory) from readiness module
      5. Shuffle answer options via fisherYatesShuffle for each question
      6. Set practiceQuestions state, transition to 'session' phase
    - Session phase:
      - Render PracticeSession with drill questions, timerEnabled=false
      - Add DrillBadge in the session header area (or pass drill visual styling)
      - Navigation lock: useNavigation().setLock(phase === 'session', 'Complete or exit the drill first')
      - onComplete callback: save results, transition to 'results'
    - Results phase:
      - Render DrillResults with results, questions, preDrillMastery, preDrillReadiness, postDrillReadiness
      - Post-drill readiness refresh data flow (EXPLICIT):
        1. Add `const [postDrillReadiness, setPostDrillReadiness] = useState<number>(preDrillReadiness)` -- initialize to pre-drill value as fallback
        2. Add a useEffect keyed on `phase === 'results'`: when phase transitions to 'results', call `refresh()` (from useCategoryMastery). The useReadinessScore hook depends on useCategoryMastery data, so after refresh resolves and the hook re-computes, readiness.score will reflect the post-drill state.
        3. Add a second useEffect watching `[phase, readiness?.score]`: when phase is 'results' AND readiness.score differs from preDrillReadiness, call `setPostDrillReadiness(readiness.score)`. This captures the updated score after the refresh propagates through.
        4. Pass postDrillReadiness to DrillResults as a prop. DrillResults receives the stale pre-drill value initially, then the corrected post-drill value once the async refresh completes. The ReadinessRing animation naturally handles this because it animates to whatever value it receives.
    - "New Drill" action: reset state (including postDrillReadiness), go back to config (re-selects weakest -- per user decision, not replay same set)
    - "Back to Dashboard" action: router.push('/home')
    - Release nav lock on unmount: useEffect(() => () => setLock(false), [setLock])

    IMPORTANT:
    - Do NOT add session persistence for drill mode (no drill history tracking per user decision)
    - Do NOT add timer to drill mode (timerEnabled=false)
    - Drill answers use 'practice' session type for recordAnswer (not a new type)
    - Use fisherYatesShuffle from '@/lib/shuffle' for answer option randomization
    - If selectDrillQuestions returns fewer questions than requested (e.g., user has very few questions in a category), proceed with available count
  </action>
  <verify>
    <automated>cd /c/Users/minkk/GitHub/civic-test-2025 && pnpm build 2>&1 | tail -5</automated>
    <manual>Verify /drill route compiles, DrillConfig renders count selector and start button, DrillPage state machine transitions between phases</manual>
  </verify>
  <done>
    /drill route accessible in App Router. DrillConfig shows focus areas, count selector (5/10/20), estimated time, and Start Drill button. DrillPage manages config -> session -> results flow. DrillBadge distinguishes drill mode from practice. PracticeSession reused for quiz flow. postDrillReadiness captured via explicit useState + useEffect pattern after refresh. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: DrillResults with mastery delta, celebration, and readiness ring animation</name>
  <files>
    src/components/drill/DrillResults.tsx
  </files>
  <action>
    Create `src/components/drill/DrillResults.tsx`:
    - Props:
      - results: QuestionResult[]
      - questions: Question[]
      - totalQuestionCount: number (how many questions were in the drill, for partial completion)
      - preDrillMastery: number (0-100, mastery before drill)
      - preDrillReadiness: number (0-100, readiness score before drill)
      - postDrillReadiness: number (0-100, readiness score after drill, from refreshed hook)
      - mode: 'weak-all' | 'category'
      - categoryName?: CategoryName
      - showBurmese: boolean
      - onNewDrill: () => void
      - onPracticeCategory: () => void
      - onBackToDashboard: () => void

    Layout: Full-screen dedicated results page, centered content, max-w-md mx-auto, py-10

    Header section:
    - DrillBadge at top
    - "Drill Complete" / "လေ့ကျင့်ခန်း ပြီးဆုံးပါပြီ" heading (text-2xl font-bold)
    - Partial completion note: if results.length < totalQuestionCount, show "Completed {results.length} of {totalQuestionCount} questions" / Burmese

    Headline metrics section (centered):
    - Drill score: Use CountUpScore component with score={correctCount}, total={results.length}
      - correctCount = results.filter(r => r.isCorrect).length
    - Show "X of Y correct" / Burmese below

    Mastery delta section:
    - Show mastery change: "Your mastery: {preDrillMastery}% -> {postDrillMastery}%"
    - For the delta, use CountUp from react-countup to animate from preDrillMastery to postDrillMastery
    - Green text if improved, neutral if same, amber if declined
    - postDrillMastery: derive from `useCategoryMastery` after drill completes (caller provides via refresh)
    - Delta display: "+2%" or "-1%" or "0%" next to the animated counter

    Mini readiness ring section:
    - Animated ReadinessRing (size 80, strokeWidth 10)
    - Ring animates from preDrillReadiness to postDrillReadiness
    - Show "Your readiness: {old}% -> {new}%" below ring (localized)
    - Use consistent red->green gradient matching main ring

    Celebration logic (triggered on mount with delay):
    - Calculate drill accuracy: correctCount / results.length
    - 80%+ correct: celebrate({ level: 'celebration', source: 'drill-complete', isDarkMode }) -- full confetti
    - 50-79% correct: celebrate({ level: 'sparkle', source: 'drill-good', isDarkMode }) -- encouraging sparkle
    - Below 50%: no celebration, show motivational text:
      - "Tough set! Review these topics and try again." / Burmese
    - No-improvement/decline: show encouraging message:
      - "Every practice session makes you stronger!" / Burmese
    - isDarkMode from useThemeContext or document.documentElement.classList check

    Post-drill action buttons (vertical stack, gap-3):
    1. "New Drill" -- primary orange button, calls onNewDrill
       - Localized: "New Drill" / "လေ့ကျင့်ခန်း အသစ်"
    2. "Practice {Category}" -- secondary button, calls onPracticeCategory
       - Shows weakest category name from the drill results
       - Localized: "Practice {categoryName.en}" / "လေ့ကျင့်ပါ {categoryName.my}"
       - Only show if mode is 'weak-all' (for category drills, the user is already in that category)
    3. "Back to Dashboard" -- ghost/text button, calls onBackToDashboard
       - Localized: "Back to Dashboard" / "ပင်မစာမျက်နှာသို့ ပြန်သွားမည်"

    Animation timing:
    - Results page fade in: 0ms
    - Score count-up: starts at 500ms delay
    - Mastery delta counter: starts at 1500ms (after score lands)
    - Readiness ring animation: starts at 2000ms
    - Celebration confetti: fires at 2500ms (after all animations land)

    ANTI-PATTERNS TO AVOID:
    - Do NOT use `useMemo<Type>()` syntax
    - Do NOT use refs for render-time value access (React Compiler)
    - Use stable callback refs for CountUp's formattingFn (same pattern as CountUpScore)
    - Do NOT save drill results to history (no drill history tracking per user decision)
    - ReadinessRing gradient ID: pass unique ID or use useId() to avoid collision with Dashboard ring
  </action>
  <verify>
    <automated>cd /c/Users/minkk/GitHub/civic-test-2025 && pnpm build 2>&1 | tail -5 && pnpm test:run -- --reporter=verbose 2>&1 | tail -20</automated>
    <manual>Verify DrillResults compiles, renders score, mastery delta, readiness ring, celebration, and action buttons</manual>
  </verify>
  <done>
    DrillResults shows headline score with CountUpScore, mastery delta with animated counter (green for improvement, amber for decline), mini ReadinessRing animating from old to new value, tiered celebration (confetti at 80%+, sparkle at 50-79%, motivational below 50%), partial completion note, and three action buttons. All text localized. Build succeeds with all tests passing.
  </done>
</task>

</tasks>

<verification>
  <automated>cd /c/Users/minkk/GitHub/civic-test-2025 && pnpm build 2>&1 | tail -5 && pnpm test:run -- --reporter=verbose 2>&1 | tail -20</automated>
  <manual>Navigate to /drill -- pre-drill config shows focus areas and count selector. Start drill, answer questions (same as practice). Complete drill -- results show score, mastery delta animation, mini readiness ring, celebration effects, and 3 action buttons.</manual>
</verification>

<success_criteria>
- /drill route is accessible and protected by auth guard
- Pre-drill screen shows focus areas, count selector (5/10/20), estimated time
- Drill session uses PracticeSession with drill-specific questions (weakest first)
- Drill mode has orange accent badge distinguishing it from practice
- Category-specific drill (/drill?category=X) filters to that category
- Results page shows score (X of Y) with CountUpScore animation
- Mastery delta animates from pre to post value
- Mini readiness ring animates from old to new readiness score
- 80%+ correct triggers confetti, 50-79% sparkle, <50% motivational text
- Early exit shows partial results with "Completed X of Y" note
- Three post-drill actions: New Drill, Practice [Category], Back to Dashboard
- All text fully localized for Burmese
- No drill history persisted
- pnpm build succeeds
- All existing and new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/43-test-readiness-score-and-drill-mode/43-03-SUMMARY.md`
</output>
