---
phase: 38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history
plan: 05
type: execute
wave: 2
depends_on: [03]
files_modified:
  - src/__tests__/errorBoundary.test.tsx
  - CLAUDE.md
autonomous: true
requirements: [CONTEXT-errorboundary-test-fix, CONTEXT-claude-md-audit, CONTEXT-sentry-cleanup]

must_haves:
  truths:
    - "ErrorBoundary tests pass consistently with no localStorage mock issues"
    - "CLAUDE.md accurately reflects the current codebase state"
    - "Outdated guidance in CLAUDE.md is removed or updated"
    - "Sentry stale issues are categorized with recommended actions"
  artifacts:
    - path: "src/__tests__/errorBoundary.test.tsx"
      provides: "Passing ErrorBoundary test suite"
    - path: "CLAUDE.md"
      provides: "Accurate project guidance document"
  key_links:
    - from: "CLAUDE.md"
      to: "actual codebase patterns"
      via: "documentation accuracy"
      pattern: "withRetry|safeAsync"
---

<objective>
Fix ErrorBoundary test failures, audit CLAUDE.md for accuracy, and categorize remaining Sentry stale issues.

Purpose: Close documentation and test debt — ensure CLAUDE.md reflects Phase 38 changes (new async utilities, error handling patterns), verify ErrorBoundary tests pass, and provide Sentry cleanup recommendations.
Output: Passing tests, accurate documentation, Sentry categorization
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history/38-RESEARCH.md
@.planning/phases/38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history/38-03-SUMMARY.md
@src/__tests__/errorBoundary.test.tsx
@src/components/ErrorBoundary.tsx
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ErrorBoundary tests and audit CLAUDE.md</name>
  <files>src/__tests__/errorBoundary.test.tsx, CLAUDE.md</files>
  <action>
    **1. ErrorBoundary test fix:**

    Run `npx vitest run src/__tests__/errorBoundary.test.tsx` to check current state. The research says all 11 tests now pass (the 9 localStorage mock failures appear resolved).

    - If all tests pass: No code changes needed. Update MEMORY.md to remove the "9 pre-existing test failures" known issue.
    - If tests still fail: Fix the localStorage mock issue. The typical fix is ensuring `vi.stubGlobal('localStorage', ...)` is called in `beforeEach` and cleaned up in `afterEach`. Check `src/__tests__/setup.ts` for existing mocks.

    **2. CLAUDE.md accuracy audit:**

    Read every section of CLAUDE.md and verify against the actual codebase state after Phase 38 changes. Specific updates needed:

    a. **Architecture > State Management**: Verify the 8 context providers list is accurate. Add mention of the new `src/lib/async/` utilities if they were created in Plan 02.

    b. **Key Conventions**: Add the throw-vs-fallback convention under a new subsection "Error Handling":
       - Critical operations (useTTS, useAuth, useSRS) throw when used outside provider
       - Convenience operations (useToast) return no-op fallback
       - Async operations use `withRetry` for transient failures
       - Background sync uses `safeAsync` for fire-and-forget error reporting

    c. **Testing**: Verify coverage thresholds are accurate. Check if any new thresholds should be added for `withRetry.ts` or `safeAsync.ts`.

    d. **Security**: Update to mention the security checklist artifact at `.planning/security/security-checklist.md`. Mention that Sentry DSN is now env-var sourced.

    e. **Remove outdated**: Check for any guidance that contradicts Phase 38 changes (e.g., if there was guidance about console.error being acceptable in catch blocks).

    f. **Common Pitfalls in MEMORY.md**: Read the pitfalls list. For any that are now addressed by Phase 38 code changes (e.g., error handling patterns), add a note that the pattern is now enforced by utilities. Do NOT remove pitfalls — they serve as historical context.

    **3. Sentry stale issue categorization:**

    Based on the research findings, create a brief categorization section in the plan summary (not a separate file) with recommendations for the ~15 remaining stale Sentry issues:
    - Issues likely already fixed by Phase 37-38 code changes → recommend "Resolve as Fixed"
    - Issues that are noise/transient (e.g., network errors from users going offline) → recommend "Resolve as Ignored" after fingerprinting is live
    - "Rendered more hooks" (3 events) → recommend monitoring for 1 more week, then resolve if no new events
    - Issues needing dashboard-only action → list them

    This categorization goes in the SUMMARY, not a separate artifact — the user will act on it manually in the Sentry dashboard.
  </action>
  <verify>
    - `npx vitest run src/__tests__/errorBoundary.test.tsx` — all tests pass
    - `npm run typecheck` — no type errors
    - `npm run lint` — no lint errors
    - CLAUDE.md mentions `withRetry`, `safeAsync`, throw-vs-fallback convention
    - CLAUDE.md mentions security checklist artifact
  </verify>
  <done>ErrorBoundary tests pass, CLAUDE.md accurately reflects Phase 38 changes and current codebase patterns, Sentry stale issues categorized with dashboard recommendations</done>
</task>

</tasks>

<verification>
- `npm run test:run` — all tests pass including ErrorBoundary
- CLAUDE.md is accurate and complete
- No known issues remain in MEMORY.md that are actually fixed
</verification>

<success_criteria>
- Zero test failures in errorBoundary.test.tsx
- CLAUDE.md reflects async utilities, error handling convention, and security checklist
- Sentry stale issues categorized with actionable recommendations
- MEMORY.md known issues updated to reflect resolved items
</success_criteria>

<output>
After completion, create `.planning/phases/38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history/38-05-SUMMARY.md`
</output>
