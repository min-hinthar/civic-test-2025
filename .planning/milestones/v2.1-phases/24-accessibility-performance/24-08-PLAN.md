---
phase: 24-accessibility-performance
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/study/Flashcard3D.tsx
  - src/components/study/FlashcardStack.tsx
autonomous: true

must_haves:
  truths:
    - "Back face is NOT visible through front face during flip animation"
    - "Card does not flicker during flip (no brief both-faces-visible moment)"
    - "Deck cards below top card are fully opaque (not transparent)"
    - "Flipping a card does not shift the card below it in layout"
  artifacts:
    - path: "src/components/study/Flashcard3D.tsx"
      provides: "Fixed 3D flip with proper backfaceVisibility and stacking"
      contains: "backfaceVisibility"
  key_links:
    - from: "src/components/study/Flashcard3D.tsx"
      to: "CSS 3D transforms"
      via: "transform-style: preserve-3d + backfaceVisibility: hidden"
      pattern: "preserve-3d"
---

<objective>
Fix 4 flashcard 3D rendering bugs: back face visibility, flip flickering, transparent deck cards, and layout shift during flip.

Purpose: Flashcards render correctly on all browsers without CSS 3D transform glitches (flashcard bug fixes from phase context).
Output: Fixed Flashcard3D.tsx and FlashcardStack.tsx with reliable 3D transforms.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@src/components/study/Flashcard3D.tsx
@src/components/study/FlashcardStack.tsx
@.planning/phases/24-accessibility-performance/24-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix backfaceVisibility and flip flickering in Flashcard3D</name>
  <files>src/components/study/Flashcard3D.tsx</files>
  <action>
    **Bug 1: Back face visible through front face:**

    1. Currently both `backface-hidden` class AND inline `backfaceVisibility: 'hidden'` are set. CSS specificity or browser inconsistency may cause one to override the other.
    2. Fix: Use ONLY inline style for backfaceVisibility (remove the `backface-hidden` class). Inline styles have highest specificity for CSS properties used with 3D transforms.
    3. Also ensure the parent `motion.div` has `transformStyle: 'preserve-3d'` as an inline style (not a class). Currently it's inline -- good.

    **Bug 2: Card flickering during flip (both faces briefly visible):**

    1. The FLIP_SPRING config has `damping: 18` which allows slight overshoot past 180 degrees. During overshoot (e.g., rotation hits 185deg briefly), the back face's backfaceVisibility kicks in and the front face becomes visible again -- causing a flicker.

    2. Fix approach A (increase damping): Change `damping: 18` to `damping: 22-25` to reduce overshoot. This makes the flip slightly less bouncy but eliminates the flicker.

    3. Fix approach B (opacity at midpoint): At the 90-degree midpoint, add opacity transitions so the front fades to 0 as it passes 90deg and the back fades to 1. This is more complex but preserves the bounce.

    4. Recommended: Approach A (increase damping). The slight bounce at 18 is subtle enough that increasing to 22 won't be noticeable, and it's the simplest fix.

    5. Additionally, add `isolation: isolate` on the card container div to create a new stacking context, preventing compositing issues with sibling elements.

    **Additional fixes:**

    6. Remove `className="backface-hidden"` from cardFaceClasses (keep only inline style).
    7. Add `will-change: transform` to the motion.div to hint the browser to create a compositor layer for the 3D transform.
    8. Ensure the front and back face divs have explicit `position: absolute` (already in `cardFaceClasses` via `absolute inset-0`).
  </action>
  <verify>
    - `pnpm run typecheck` passes
    - `pnpm run lint` passes
    - No `backface-hidden` class in Flashcard3D (only inline backfaceVisibility)
    - FLIP_SPRING damping increased to reduce overshoot
    - `isolation: isolate` on card container
  </verify>
  <done>Back face hidden reliably via inline style only. Flip flicker eliminated by reducing spring overshoot. Card creates isolated stacking context.</done>
</task>

<task type="auto">
  <name>Task 2: Fix deck card transparency and flip layout shift</name>
  <files>src/components/study/Flashcard3D.tsx, src/components/study/FlashcardStack.tsx</files>
  <action>
    **Bug 3: Deck cards below are transparent:**

    1. Find the FlashcardStack component (may be in `src/components/study/` or check the study page for how cards are stacked).
    2. Cards below the top card likely have reduced opacity from transform styles or missing explicit opacity.
    3. Fix: Ensure ALL cards in the stack have `opacity: 1` explicitly set. Add it to the card wrapper style:
       ```tsx
       style={{ opacity: 1, ... }}
       ```
    4. If cards behind use `scale(0.96)` and `translateY(8px)` for depth (like SwipeableStack), verify opacity is not being reduced as part of the depth effect.
    5. Each card in the stack should have an explicit `zIndex` based on position (top card highest).

    **Bug 4: Flipping moves the card below it (layout shift):**

    1. The 3D flip changes the card's visual rendering but should NOT affect layout.
    2. Root cause: If the card wrapper doesn't have explicit dimensions, the 3D transform can cause reflow.
    3. Fix: Ensure the card container (the `perspective-1000` div) has:
       - Explicit `width: 100%` and `aspect-ratio: 3/4` (already has via Tailwind classes)
       - `position: relative` (already has)
    4. The inner `motion.div` should NOT change height during flip. Verify it has `position: relative` and fixed dimensions matching the container.
    5. If FlashcardStack renders cards absolutely positioned, verify each card's wrapper has explicit dimensions.
    6. Add `transform-origin: center center` to the motion.div to ensure the flip rotates around the center axis.
    7. Test: After fixes, the card should flip without any neighboring elements shifting position.
  </action>
  <verify>
    - `pnpm run typecheck` passes
    - `pnpm run lint` passes
    - `pnpm run build` passes
    - FlashcardStack cards have explicit opacity: 1 and z-index stacking
    - No layout shift during flip (card container has fixed dimensions)
  </verify>
  <done>Deck cards below are fully opaque with proper z-index stacking. Flip animation does not cause layout shift in surrounding elements.</done>
</task>

</tasks>

<verification>
- `pnpm run typecheck` passes
- `pnpm run lint` passes
- `pnpm run build` passes
- `pnpm test:run` passes
- Flashcard3D uses only inline backfaceVisibility (no class)
- FLIP_SPRING damping increased
- FlashcardStack cards have opacity: 1 and z-index
</verification>

<success_criteria>
- Back face hidden during flip on all browsers
- No flickering at the 90-degree midpoint
- All deck cards below top card are fully opaque
- Flipping does not cause layout shift in the deck
</success_criteria>

<output>
After completion, create `.planning/phases/24-accessibility-performance/24-08-SUMMARY.md`
</output>
