---
phase: 22-tts-quality
plan: 09
type: execute
wave: 5
depends_on: [22-06, 22-07, 22-08]
files_modified:
  - src/__tests__/tts.integration.test.tsx
  - src/hooks/useAutoRead.test.ts
  - src/lib/audio/burmeseAudio.test.ts
autonomous: true

must_haves:
  truths:
    - "Unit tests cover useAutoRead hook trigger/cleanup/retry behavior"
    - "Unit tests cover Burmese audio URL helper correctness"
    - "Unit tests cover voice filtering logic"
    - "Integration tests verify TTSSettings persistence round-trip"
    - "Build passes with zero type errors"
  artifacts:
    - path: "src/hooks/useAutoRead.test.ts"
      provides: "Tests for auto-read hook"
    - path: "src/lib/audio/burmeseAudio.test.ts"
      provides: "Tests for Burmese audio URL helper and player adapter"
  key_links:
    - from: "src/hooks/useAutoRead.test.ts"
      to: "src/hooks/useAutoRead.ts"
      via: "renderHook testing"
      pattern: "useAutoRead"
---

<objective>
Add unit tests for the new Phase 22 modules: useAutoRead hook, Burmese audio URL helper, voice filtering logic, and TTSSettings persistence. Ensure build and all tests pass clean.

Purpose: Validates the core logic of Phase 22 features before end-to-end testing. Catches regressions in settings persistence, auto-read timing, and audio URL generation.
Output: Test files with ~15-20 test cases covering Phase 22 logic.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-tts-quality/22-RESEARCH.md

@src/hooks/useAutoRead.ts
@src/lib/audio/burmeseAudio.ts
@src/lib/ttsTypes.ts
@src/contexts/TTSContext.tsx
@src/__tests__/setup.ts
@src/__tests__/tts.integration.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for useAutoRead and Burmese audio utilities</name>
  <files>src/hooks/useAutoRead.test.ts, src/lib/audio/burmeseAudio.test.ts</files>
  <action>
**useAutoRead.test.ts** (~8 test cases):
1. "does not speak when enabled is false"
2. "speaks text after delay when enabled"
3. "cancels speech when triggerKey changes" (verify cancel is called before new speak)
4. "cancels speech on unmount"
5. "does not speak when text is empty"
6. "retries once on speak failure" (mock speak to reject first call, resolve second)
7. "does not retry after unmount" (verify cancelled flag prevents retry)
8. "uses custom delay when provided"

Use `renderHook` from `@testing-library/react`. Mock `useTTS` to return `{ speak: vi.fn(), cancel: vi.fn() }`. Use `vi.useFakeTimers()` for delay testing.

**burmeseAudio.test.ts** (~8 test cases):
1. `getBurmeseAudioUrl` returns correct path for nilar female: `/audio/my-MM/female/GOV-P01-q.mp3`
2. `getBurmeseAudioUrl` returns correct path for thiha male: `/audio/my-MM/male/GOV-P01-q.mp3`
3. `getBurmeseAudioUrl` handles answer type: `GOV-P01-a.mp3`
4. `getBurmeseAudioUrl` handles explanation type: `GOV-P01-e.mp3`
5. `getBurmeseAudioUrl` defaults to nilar when voice not specified
6. `createBurmesePlayer` returns object with play/pause/resume/cancel/onStateChange methods
7. `createBurmesePlayer.play()` sets isSpeaking to true (mock HTMLAudioElement)
8. `createBurmesePlayer.cancel()` resets state to idle

For createBurmesePlayer tests, mock `HTMLAudioElement`:
```typescript
const mockPlay = vi.fn().mockResolvedValue(undefined);
vi.stubGlobal('Audio', vi.fn().mockImplementation(() => ({
  play: mockPlay,
  pause: vi.fn(),
  set src(v: string) { /* noop */ },
  set playbackRate(v: number) { /* noop */ },
  set onended(v: () => void) { /* store */ },
  set onerror(v: () => void) { /* store */ },
})));
```
  </action>
  <verify>
`npm run test:run -- src/hooks/useAutoRead.test.ts src/lib/audio/burmeseAudio.test.ts` -- all tests pass.
`npx tsc --noEmit` passes.
  </verify>
  <done>
16 test cases covering useAutoRead (8) and burmeseAudio utilities (8). All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests and final build verification</name>
  <files>src/__tests__/tts.integration.test.tsx</files>
  <action>
**Extend existing tts.integration.test.tsx** with Phase 22 tests (~6 test cases):
1. "TTSSettings persists autoRead to localStorage" -- update settings, read from localStorage, verify new fields
2. "TTSSettings persists burmeseVoice to localStorage" -- same
3. "TTSSettings defaults for new fields when stored settings lack them" -- set old-format settings in localStorage, load, verify defaults applied
4. "Voice picker filters to English voices only" -- create voices array with mixed languages, verify filtering logic produces only en-* voices
5. "SpeechButton renders speed label when showSpeedLabel is true"
6. "SpeechButton renders paused state with correct aria"

Use `render` from `@testing-library/react` for component tests. Wrap in `TTSProvider` for integration tests.

**Final build verification:**
1. Run `npm run build` -- must succeed
2. Run `npm run test:run` -- all tests must pass (except pre-existing errorBoundary failures)
3. Run `npx tsc --noEmit` -- zero errors
4. Run `npm run lint` -- zero errors
  </action>
  <verify>
`npm run test:run` -- all new tests pass (6 integration + 16 unit = 22 new test cases).
`npm run build` succeeds.
`npx tsc --noEmit` passes.
`npm run lint` passes.
  </verify>
  <done>
22 new test cases across 3 test files. Full build, typecheck, and lint pass. Phase 22 is verified at the code level.
  </done>
</task>

</tasks>

<verification>
1. `npm run test:run` -- all new Phase 22 tests pass
2. `npm run build` succeeds
3. `npx tsc --noEmit` passes
4. `npm run lint` passes
5. No regressions in existing tests (pre-existing errorBoundary failures unchanged)
</verification>

<success_criteria>
- useAutoRead tests: trigger, cleanup, retry, delay all verified
- burmeseAudio tests: URL helper correctness, player lifecycle verified
- Integration tests: settings persistence, voice filtering, SpeechButton states
- Full build passes with zero type errors
- All Phase 22 new code has test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/22-tts-quality/22-09-SUMMARY.md`
</output>
