---
phase: 26-gap-closure-session-nav-tts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/quiz/quizTypes.ts
  - src/lib/quiz/quizReducer.ts
  - src/pages/TestPage.tsx
autonomous: true
requirements:
  - SESS-01
gap_closure: true

must_haves:
  truths:
    - "User who resumes an interrupted mock test continues from their saved question index, not question 1"
    - "Previous answers are preserved when resuming (correct/incorrect tally matches saved state)"
    - "Timer restores to saved timeLeft value (not full TEST_DURATION_SECONDS)"
  artifacts:
    - path: "src/lib/quiz/quizTypes.ts"
      provides: "RESUME_SESSION action type in QuizAction union"
      contains: "RESUME_SESSION"
    - path: "src/lib/quiz/quizReducer.ts"
      provides: "RESUME_SESSION case handler that restores index, results, and phase"
      contains: "case 'RESUME_SESSION'"
    - path: "src/pages/TestPage.tsx"
      provides: "handleCountdownComplete dispatches RESUME_SESSION before clearing ref"
      contains: "dispatch"
  key_links:
    - from: "src/pages/TestPage.tsx"
      to: "src/lib/quiz/quizReducer.ts"
      via: "dispatch({ type: 'RESUME_SESSION' })"
      pattern: "dispatch.*RESUME_SESSION"
    - from: "src/pages/TestPage.tsx"
      to: "resumeDataRef"
      via: "reads ref before clearing"
      pattern: "resumeDataRef\\.current"
---

<objective>
Fix mock test resume so quizReducer receives saved state when user resumes an interrupted mock test session.

Purpose: SESS-01 requires that a user who resumes an interrupted mock test continues from their saved question with previous answers preserved. Currently, `handleCountdownComplete` clears `resumeDataRef` without dispatching to `quizReducer`, so the quiz always starts at index 0 with empty results.

Output: Working mock test resume that restores question index, accumulated results, and remaining time.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-gap-closure-session-nav-tts/26-RESEARCH.md

@src/lib/quiz/quizTypes.ts
@src/lib/quiz/quizReducer.ts
@src/pages/TestPage.tsx
@src/components/practice/PracticeSession.tsx (reference: working resume pattern at lines 340-356)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RESUME_SESSION action to quiz state machine</name>
  <files>src/lib/quiz/quizTypes.ts, src/lib/quiz/quizReducer.ts</files>
  <action>
1. In `src/lib/quiz/quizTypes.ts`, add `RESUME_SESSION` to the `QuizAction` union type:
   ```typescript
   | { type: 'RESUME_SESSION'; currentIndex: number; results: QuestionResult[] }
   ```
   Add it after the existing `FINISH` action in the union.

2. In `src/lib/quiz/quizReducer.ts`, add a `case 'RESUME_SESSION'` handler in the switch statement:
   ```typescript
   case 'RESUME_SESSION': {
     return {
       ...state,
       phase: 'answering',
       currentIndex: action.currentIndex,
       results: action.results,
       selectedAnswer: null,
       isCorrect: null,
       streakCount: 0,
     };
   }
   ```
   This should NOT be phase-guarded (resume can happen from the initial `answering` phase at index 0). Place it before the `default` case. Reset `selectedAnswer`, `isCorrect`, and `streakCount` to clean state since we are jumping to a new position.
  </action>
  <verify>Run `npm run typecheck` to confirm no type errors. Run `npm run test:run -- src/lib/quiz/` to confirm existing quiz reducer tests still pass.</verify>
  <done>QuizAction union includes RESUME_SESSION with currentIndex and results fields. quizReducer handles RESUME_SESSION by restoring phase to 'answering', setting currentIndex and results from the action payload.</done>
</task>

<task type="auto">
  <name>Task 2: Wire resume dispatch into TestPage handleCountdownComplete</name>
  <files>src/pages/TestPage.tsx</files>
  <action>
Fix the `handleCountdownComplete` callback in TestPage.tsx (currently around line 514):

**Current (broken):**
```typescript
const handleCountdownComplete = useCallback(() => {
  setShowCountdown(false);
  resumeDataRef.current = null;
}, []);
```

**Replace with:**
```typescript
const handleCountdownComplete = useCallback(() => {
  setShowCountdown(false);
  const resumeData = resumeDataRef.current;
  if (resumeData) {
    dispatch({
      type: 'RESUME_SESSION',
      currentIndex: resumeData.currentIndex,
      results: resumeData.results,
    });
    setTimeLeft(resumeData.timeLeft > 0 ? resumeData.timeLeft : TEST_DURATION_SECONDS);
  }
  resumeDataRef.current = null;
}, []);
```

Key points:
- Read `resumeDataRef.current` into a local variable BEFORE clearing it
- Dispatch `RESUME_SESSION` to the quizReducer with saved currentIndex and results
- Restore `timeLeft` from the saved snapshot (fall back to full duration if <= 0)
- Clear the ref AFTER dispatching (order matters)
- This runs in a callback (not useEffect), so it is React Compiler safe
- `dispatch` is stable (from useReducer), so it doesn't need to be in the dependency array

Also verify that the `MockTestSnapshot` type (from sessionTypes.ts) includes `currentIndex`, `results`, and `timeLeft` fields. These should already exist from Phase 20 session persistence work.
  </action>
  <verify>Run `npm run typecheck` to confirm no type errors. Run `npm run build` to confirm production build succeeds. Manually verify: the dispatch call should reference the RESUME_SESSION action type added in Task 1.</verify>
  <done>handleCountdownComplete reads resume data from ref, dispatches RESUME_SESSION with saved currentIndex and results, restores timeLeft, then clears the ref. Mock test resume flow is now complete: user sees countdown -> countdown finishes -> quiz state jumps to saved position.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` -- zero errors
2. `npm run test:run -- src/lib/quiz/` -- all existing quiz tests pass
3. `npm run build` -- production build succeeds
4. Code review: `RESUME_SESSION` action exists in quizTypes.ts, handled in quizReducer.ts, dispatched in TestPage.tsx handleCountdownComplete
</verification>

<success_criteria>
- QuizAction type includes RESUME_SESSION with currentIndex and results
- quizReducer handles RESUME_SESSION by restoring state
- TestPage.handleCountdownComplete dispatches RESUME_SESSION from saved ref data before clearing ref
- Timer restores to saved timeLeft
- All existing tests pass, typecheck clean, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/26-gap-closure-session-nav-tts/26-01-SUMMARY.md`
</output>
