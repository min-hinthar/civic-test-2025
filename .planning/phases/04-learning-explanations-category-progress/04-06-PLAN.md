---
phase: 04-learning-explanations-category-progress
plan: 06
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - src/components/progress/CategoryRing.tsx
  - src/components/progress/MasteryBadge.tsx
  - src/components/progress/CategoryGrid.tsx
  - src/components/progress/MasteryMilestone.tsx
  - src/hooks/useMasteryMilestones.ts
  - src/hooks/useCategoryMastery.ts
autonomous: true

must_haves:
  truths:
    - "CategoryRing shows animated SVG radial progress per category"
    - "MasteryBadge shows bronze/silver/gold badge based on mastery percentage"
    - "CategoryGrid displays compact grid of all categories with rings and badges"
    - "Milestone detection triggers celebration at 50%, 75%, 100% thresholds"
    - "Celebration intensity scales: sparkle (50%), confetti (75%), big celebration (100%)"
  artifacts:
    - path: "src/components/progress/CategoryRing.tsx"
      provides: "Animated SVG circular progress ring"
      exports: ["CategoryRing"]
    - path: "src/components/progress/MasteryBadge.tsx"
      provides: "Bronze/Silver/Gold badge component"
      exports: ["MasteryBadge", "getMilestoneLevel"]
    - path: "src/components/progress/CategoryGrid.tsx"
      provides: "Compact grid of all category progress rings"
      exports: ["CategoryGrid"]
    - path: "src/components/progress/MasteryMilestone.tsx"
      provides: "Celebration modal for milestone achievements"
      exports: ["MasteryMilestone"]
    - path: "src/hooks/useMasteryMilestones.ts"
      provides: "Hook that detects new milestone crossings"
      exports: ["useMasteryMilestones"]
    - path: "src/hooks/useCategoryMastery.ts"
      provides: "Hook that loads mastery data and computes per-category scores"
      exports: ["useCategoryMastery"]
  key_links:
    - from: "src/hooks/useCategoryMastery.ts"
      to: "src/lib/mastery/calculateMastery.ts"
      via: "calculateCategoryMastery import"
      pattern: "calculateCategoryMastery"
    - from: "src/hooks/useCategoryMastery.ts"
      to: "src/lib/mastery/masteryStore.ts"
      via: "getAnswerHistory import"
      pattern: "getAnswerHistory"
    - from: "src/components/progress/CategoryGrid.tsx"
      to: "src/lib/mastery/categoryMapping.ts"
      via: "USCIS_CATEGORIES import"
      pattern: "USCIS_CATEGORIES"
---

<objective>
Build the progress visualization component library: animated radial rings, mastery badges, compact category grid, and milestone celebration system.

Purpose: These are the visual building blocks for the progress page and dashboard. Duolingo-style animated rings per category, bronze/silver/gold badges, and celebration animations that scale by milestone intensity.

Output: Reusable progress visualization components and mastery data hooks.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-learning-explanations-category-progress/04-CONTEXT.md
@.planning/phases/04-learning-explanations-category-progress/04-RESEARCH.md
@src/lib/mastery/categoryMapping.ts
@src/lib/mastery/calculateMastery.ts
@src/lib/mastery/masteryStore.ts
@src/lib/design-tokens.ts
@src/components/celebrations/Confetti.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CategoryRing, MasteryBadge, CategoryGrid, and useCategoryMastery hook</name>
  <files>
    src/components/progress/CategoryRing.tsx,
    src/components/progress/MasteryBadge.tsx,
    src/components/progress/CategoryGrid.tsx,
    src/hooks/useCategoryMastery.ts
  </files>
  <action>
    1. **useCategoryMastery.ts** - Hook that loads and computes mastery data:
       - Uses `getAnswerHistory()` from masteryStore on mount
       - Uses `USCIS_CATEGORIES` from categoryMapping
       - Uses `allQuestions` to get question IDs per category
       - Computes mastery percentage per USCIS main category AND sub-category
       - Computes overall mastery (weighted by question count)
       - Returns: `{ categoryMasteries: Record<string, number>, subCategoryMasteries: Record<string, number>, overallMastery: number, isLoading: boolean, refresh: () => void }`
       - Uses useMemo to cache computed mastery (avoid recalculating on every render)
       - `refresh()` function re-fetches answer history and recalculates (call after recording new answers)

    2. **CategoryRing.tsx** - Animated SVG circular progress:
       - Props: `percentage: number`, `color: string`, `size?: number` (default 100), `strokeWidth?: number` (default 8), `children?: ReactNode`
       - Custom SVG approach (not library, per research recommendation for more control)
       - SVG circle with `strokeDasharray` and `strokeDashoffset` for progress
       - Animate with `motion.circle` from motion/react
       - Spring animation: stiffness 100, damping 20 (matching existing progress bar spring from 03-03)
       - Background track circle in text-muted/30
       - Progress circle color via `className` prop (e.g., `text-blue-500`, `text-amber-500`, `text-emerald-500`)
       - Center content via children (percentage number, badge, etc.)
       - Respect prefers-reduced-motion (skip animation, just set final value)
       - Rotate SVG -90deg so progress starts from top

    3. **MasteryBadge.tsx** - Badge component:
       - Props: `mastery: number`, `size?: 'sm' | 'md' | 'lg'`
       - Export `getMilestoneLevel(mastery: number): 'none' | 'bronze' | 'silver' | 'gold'`
         - 0-49: 'none'
         - 50-74: 'bronze'
         - 75-99: 'silver'
         - 100: 'gold'
       - Visual: Icon-based badges
         - none: empty/outline circle
         - bronze: Medal icon in amber-600 with subtle warm background
         - silver: Medal icon in slate-400 with cool background
         - gold: Crown/Star icon in yellow-500 with golden glow background
       - Size variants: sm (16px), md (24px), lg (32px)
       - Use lucide-react icons (Medal, Crown, Star, Award)

    4. **CategoryGrid.tsx** - Compact grid of all categories:
       - Props: `categoryMasteries: Record<string, number>`, `onCategoryClick?: (category: string) => void`
       - Uses `USCIS_CATEGORIES` to iterate main categories
       - For each main category, renders:
         - CategoryRing with percentage
         - Category name (bilingual, from USCIS_CATEGORY_NAMES)
         - MasteryBadge
         - Sub-category progress bars (horizontal) within each main category
       - Staggered entrance animation (80ms gap, matching 03-04 pattern)
       - Grid layout: 1 col on mobile, 3 cols on desktop (one per USCIS category)
       - Each card is tappable (calls onCategoryClick)
       - Distinct color per main category: blue (Government), amber (History), emerald (Civics)
  </action>
  <verify>
    `npx tsc --noEmit` passes. Components can be imported and rendered. CategoryRing animates from 0 to target percentage. MasteryBadge shows correct badge level.
  </verify>
  <done>
    useCategoryMastery hook loads mastery data from IndexedDB and computes per-category scores. CategoryRing renders animated SVG progress. MasteryBadge shows bronze/silver/gold levels. CategoryGrid displays compact grid of all USCIS categories with rings, badges, and sub-category bars.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create milestone detection hook and celebration modal</name>
  <files>
    src/hooks/useMasteryMilestones.ts,
    src/components/progress/MasteryMilestone.tsx
  </files>
  <action>
    1. **useMasteryMilestones.ts** - Hook for milestone detection:
       - Tracks previous mastery values in useRef
       - Compares new vs previous mastery for each category
       - Detects threshold crossings: 50% (bronze), 75% (silver), 100% (gold)
       - Checks localStorage `civic-prep-shown-milestones` to avoid repeat celebrations
       - Returns `MilestoneEvent | null` with: `{ category, level, previousPercentage, newPercentage }`
       - Only returns one milestone at a time (queue if multiple)
       - Provides `dismissMilestone()` function to clear current milestone and show next queued
       - Debounce: max 1 milestone per session (use sessionStorage for session tracking)

    2. **MasteryMilestone.tsx** - Celebration modal:
       - Props: `milestone: MilestoneEvent | null`, `onDismiss: () => void`
       - Uses @radix-ui/react-dialog (already installed) for accessible modal
       - Celebration intensity scales by level (per CONTEXT.md):
         - **Bronze (50%):** Subtle sparkle animation (CSS keyframes, small particle effect)
           - Encouraging bilingual message rotating from pool (e.g., "You're getting there!", "Keep going!")
           - Bronze-colored badge display
         - **Silver (75%):** Confetti animation (react-canvas-confetti, intensity: 'burst')
           - Congratulatory bilingual message (e.g., "Excellent progress!")
           - Silver badge with glow
         - **Gold (100%):** Big celebration (react-canvas-confetti, intensity: 'celebration')
           - Crown/star badge with golden glow
           - "You mastered [Category]!" bilingual message
           - Gold card treatment (golden border glow)
       - All messages bilingual (EN + MY) using BilingualText pattern
       - Rotating encouraging phrases from a pool (message variety per CONTEXT.md)
       - Dismiss button to close modal
       - Auto-dismiss after 5 seconds for bronze, 8 seconds for silver/gold
       - Mark milestone as shown in localStorage so it never repeats
  </action>
  <verify>
    `npx tsc --noEmit` passes. useMasteryMilestones correctly detects threshold crossings. MasteryMilestone renders appropriate celebration for each level.
  </verify>
  <done>
    Milestone detection hook tracks threshold crossings with localStorage persistence. Celebration modal scales intensity: sparkle for bronze, confetti for silver, big celebration for gold. All messages bilingual with rotating encouraging phrases.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. CategoryRing renders animated SVG progress with correct colors
3. MasteryBadge shows appropriate badge for mastery levels
4. CategoryGrid displays 3 USCIS categories with rings and sub-category bars
5. useMasteryMilestones detects 50/75/100 threshold crossings without repeats
6. MasteryMilestone renders scaled celebrations (sparkle/confetti/big)
7. All components respect prefers-reduced-motion
</verification>

<success_criteria>
- Progress visualization components render with animated fills
- Badge evolution: none -> bronze -> silver -> gold at correct thresholds
- Milestone detection persists shown milestones in localStorage
- Celebration modal uses existing confetti infrastructure (react-canvas-confetti)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-learning-explanations-category-progress/04-06-SUMMARY.md`
</output>
