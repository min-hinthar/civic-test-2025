---
phase: 23-flashcard-sort
plan: 08
type: execute
wave: 4
depends_on: ["23-02", "23-06"]
files_modified:
  - src/hooks/useSortSession.ts
  - src/components/sort/SortModeContainer.tsx
  - src/components/sessions/ResumePromptModal.tsx
autonomous: true

must_haves:
  truths:
    - "Sort session state persists to IndexedDB when user navigates away or closes app"
    - "User sees resume prompt with round number and cards remaining when returning to sort mode"
    - "Undo history resets on resume (fresh undo stack for resumed session)"
    - "Expired sort sessions (>24h) are silently discarded"
    - "Dashboard unfinished session banner includes sort sessions"
  artifacts:
    - path: "src/hooks/useSortSession.ts"
      provides: "Save/load sort session snapshot to/from IndexedDB"
      contains: "saveSession"
    - path: "src/components/sort/SortModeContainer.tsx"
      provides: "Resume flow integration with ResumePromptModal"
      contains: "ResumePromptModal"
  key_links:
    - from: "src/hooks/useSortSession.ts"
      to: "src/lib/sessions/sessionStore.ts"
      via: "saveSession and getSessionsByType for sort snapshot persistence"
      pattern: "saveSession.*sort"
    - from: "src/components/sort/SortModeContainer.tsx"
      to: "src/components/sessions/ResumePromptModal.tsx"
      via: "Renders ResumePromptModal when existing sort session found"
      pattern: "ResumePromptModal"
---

<objective>
Add session persistence to sort mode: save state to IndexedDB, resume prompt on return, and dashboard integration.

Purpose: Users should never lose sort progress when the app is closed or they navigate away. The resume prompt (using existing ResumePromptModal from Phase 20) shows round number and cards remaining, letting users pick up where they left off (FLSH-07).

Output: Updated `useSortSession.ts` with save/load, updated `SortModeContainer.tsx` with resume flow, extended `ResumePromptModal.tsx` for sort display.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/sessions/sessionTypes.ts (SortSnapshot from Plan 02)
@src/lib/sessions/sessionStore.ts (saveSession, getSessionsByType, deleteSession)
@src/lib/sessions/useSessionPersistence.ts (hook for loading sessions)
@src/components/sessions/ResumePromptModal.tsx (existing resume modal)
@src/hooks/useSortSession.ts (from Plan 06 -- extend with persistence)
@src/components/sort/SortModeContainer.tsx (from Plan 06 -- extend with resume)
@.planning/phases/23-flashcard-sort/23-RESEARCH.md
@.planning/phases/23-flashcard-sort/23-02-SUMMARY.md
@.planning/phases/23-flashcard-sort/23-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sort session save/load in useSortSession</name>
  <files>src/hooks/useSortSession.ts</files>
  <action>
Extend `useSortSession.ts` from Plan 06 to add session persistence:

1. **Save on state change:** Add an effect that saves the sort session to IndexedDB whenever the state changes during active sorting (phase is 'sorting', 'animating', 'round-summary', or 'countdown'). Debounce saves to every 2 seconds or on significant state change (card sorted, round completed). Use a `useRef` for debounce timer.

   Create the SortSnapshot from current state:
   ```typescript
   const snapshot: SortSnapshot = {
     id: `session-sort-${sessionStartRef.current}`,
     type: 'sort',
     savedAt: new Date().toISOString(),
     version: SESSION_VERSION,
     sourceCardIds: state.sourceCards.map(c => c.id),
     round: state.round,
     knownIds: [...state.knownIds],          // Set -> Array for IndexedDB
     unknownIds: [...state.unknownIds],
     allUnknownIds: [...state.allUnknownIds],
     remainingCardIds: state.cards.slice(state.currentIndex).map(c => c.id),
     currentIndex: state.currentIndex,
     roundHistory: state.roundHistory,
     categoryFilter: state.categoryFilter,
     startTime: state.startTime,
   };
   ```

2. **Load on mount:** Check for existing sort session via `getSessionsByType('sort')`. If found, expose it via a `pendingSession` state.

3. **Resume session:** Add `resumeSession(snapshot: SortSnapshot)` function:
   - Reconstruct Question objects from IDs using `allQuestions`
   - Reconstruct Set objects from arrays
   - Dispatch RESUME_SESSION with reconstructed state
   - Delete the old snapshot from IndexedDB (will be re-saved as progress continues)

4. **Delete on completion:** When session finishes (phase changes to 'idle' after FINISH_SESSION, or 'mastery'), delete the sort session from IndexedDB.

5. **Cleanup:** On unmount, if session is active, save a final snapshot before cleanup.

6. **Expose:** Add `pendingSession`, `resumeSession`, and `discardSession` to the hook return.

Note: undo history resets on resume per locked decision -- RESUME_SESSION already sets empty undoStack.
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run lint -- --no-warn-ignored` -- compiles and lints cleanly.</verify>
  <done>useSortSession saves sort state to IndexedDB on state changes, loads pending sessions on mount, supports resume with Set/Array conversion, and deletes sessions on completion.</done>
</task>

<task type="auto">
  <name>Task 2: Resume flow in SortModeContainer + ResumePromptModal extension</name>
  <files>
    src/components/sort/SortModeContainer.tsx
    src/components/sessions/ResumePromptModal.tsx
  </files>
  <action>
**SortModeContainer.tsx updates:**

1. **Mount behavior change:** Instead of auto-starting a new session on mount, check for pending session first:
   - If `pendingSession` exists from `useSortSession`, show the `ResumePromptModal`
   - If no pending session, start a new session as before

2. **Resume prompt integration:**
   ```tsx
   {pendingSession && (
     <ResumePromptModal
       sessions={[pendingSession]}
       onResume={(session) => {
         resumeSession(session as SortSnapshot);
       }}
       onStartFresh={() => {
         discardSession();
         startSession(categoryFilter);
       }}
       sessionType="sort"
     />
   )}
   ```

3. **Loading state:** While checking for pending session, show a loading skeleton.

**ResumePromptModal.tsx updates:**

Extend the existing `ResumePromptModal` to display sort-specific information:

1. **Add sort session type handling:** The modal already handles `'mock-test'`, `'practice'`, and `'interview'`. Add `'sort'` type handling:
   - Title: "Resume Sort Session?" / "အမျိုးအစားခွဲခြင်းကို ဆက်လုပ်မလား?"
   - Info display: "Round {n}, {remaining} cards left" / bilingual
   - Show Know/Don't Know counts from the snapshot

2. **ResumeSessionCard extension:** If the modal uses a card component for session info, extend it to show sort-specific metadata:
   - Round number
   - Cards remaining (remainingCardIds.length)
   - Know count (knownIds.length)
   - Don't Know count (unknownIds.length)
   - Time since saved (using existing timeAgo utility)

3. **Category filter display:** If the sort session had a category filter, show it: "Category: American Government"

Ensure backward compatibility -- existing mock-test/practice/interview resume flows must continue working unchanged. The session type is used to determine which display variant to show.
  </action>
  <verify>Run `npx tsc --noEmit`, `npm run lint -- --no-warn-ignored`, and `npm run build` -- all pass. Verify existing session tests still pass: `npx vitest run src/lib/sessions/`.</verify>
  <done>Sort sessions persist to IndexedDB. ResumePromptModal shows sort-specific info (round, cards remaining). Resume reconstructs state with fresh undo stack. Existing session flows unaffected.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run lint -- --no-warn-ignored` passes
3. `npm run build` succeeds
4. Existing session persistence tests pass: `npx vitest run src/lib/sessions/`
5. Sort session saves correctly (Sets converted to arrays, Questions stored as IDs)
6. Resume reconstructs Questions from IDs and arrays back to Sets
</verification>

<success_criteria>
- FLSH-07: Sort session state persists and resumes after closing app
- Resume prompt shows round number and cards remaining per locked decision
- Undo history resets on resume per locked decision
- Expired sessions (>24h) silently discarded by existing session store logic
- No regressions in mock-test/practice/interview session persistence
- Dashboard unfinished session indicators include sort sessions
</success_criteria>

<output>
After completion, create `.planning/phases/23-flashcard-sort/23-08-SUMMARY.md`
</output>
