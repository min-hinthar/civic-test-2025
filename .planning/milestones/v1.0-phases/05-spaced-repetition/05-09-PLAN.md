---
phase: 05-spaced-repetition
plan: 09
type: execute
wave: 5
depends_on: ["05-04", "05-05", "05-07", "05-08"]
files_modified:
  - src/components/AppNavigation.tsx
  - src/pages/SettingsPage.tsx
  - src/lib/pwa/pushNotifications.ts
  - pages/api/push/srs-reminder.ts
autonomous: true

must_haves:
  truths:
    - "User sees badge count on Study Guide nav when cards are due"
    - "User receives push notification when cards are due at their preferred time"
    - "User can configure preferred reminder time in settings"
  artifacts:
    - path: "src/components/AppNavigation.tsx"
      provides: "Study Guide nav link with due card badge"
      contains: "dueCount"
    - path: "src/pages/SettingsPage.tsx"
      provides: "SRS reminder time configuration"
      contains: "reminderTime"
    - path: "pages/api/push/srs-reminder.ts"
      provides: "API endpoint to trigger SRS due card push notifications"
      exports: ["default"]
  key_links:
    - from: "src/components/AppNavigation.tsx"
      to: "src/contexts/SRSContext.tsx"
      via: "useSRS().dueCount for badge"
      pattern: "useSRS|dueCount"
    - from: "pages/api/push/srs-reminder.ts"
      to: "supabase srs_cards"
      via: "query due cards per user"
      pattern: "srs_cards"
---

<objective>
Add the Study Guide navigation badge for due cards, push notification infrastructure for SRS reminders, and reminder time settings.

Purpose: Completes the SRS experience by ensuring users are aware of due cards (nav badge) and are prompted to review via push notifications at their preferred time.
Output: Nav badge, push notification API endpoint, and settings page reminder configuration.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-spaced-repetition/05-RESEARCH.md
@src/components/AppNavigation.tsx
@src/pages/SettingsPage.tsx
@src/lib/pwa/pushNotifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add due card badge to Study Guide navigation link</name>
  <files>src/components/AppNavigation.tsx</files>
  <action>
    1. Import `useSRS` from `@/contexts/SRSContext` in AppNavigation.tsx
    2. Inside the AppNavigation component, get dueCount: `const { dueCount } = useSRS()`
    3. Add a badge to the Study Guide nav link (per locked decision: badge count on Study Guide nav for due cards):

    In the `navLinks.map()` section (both desktop and mobile versions), for the `/study` link only:
    - After the BilingualText label, add a small badge if `dueCount > 0`:
      ```
      {link.href === '/study' && dueCount > 0 && (
        <span className="ml-1 inline-flex items-center justify-center rounded-full bg-warning-500 text-white text-xs font-bold min-w-[20px] h-5 px-1.5">
          {dueCount > 99 ? '99+' : dueCount}
        </span>
      )}
      ```
    - Badge styling: small pill (warning-500 background, white text, rounded-full)
    - Shows on both desktop nav links and mobile hamburger menu links
    - Cap display at 99+ to prevent layout issues

    4. Ensure this doesn't break navigation or layout for other links. The badge should be inline after the text, not affecting click area.

    NOTE: If SRSProvider is not yet mounted (edge case during initial load), dueCount defaults to 0 and badge won't show. This is fine.
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes
    - AppNavigation compiles with dueCount badge
    - Badge only shows on Study Guide link, only when dueCount > 0
  </verify>
  <done>
    - Study Guide nav link shows orange badge with due card count
    - Badge visible on both desktop and mobile nav
    - Capped at 99+ for display
    - No visual disruption when count is 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SRS push notification endpoint and settings</name>
  <files>
    pages/api/push/srs-reminder.ts
    src/pages/SettingsPage.tsx
    src/lib/pwa/pushNotifications.ts
  </files>
  <action>
    1. Create `pages/api/push/srs-reminder.ts` (Pages Router API route, per project convention from Phase 2):
       - POST endpoint that can be called by a cron job or scheduled function
       - Query Supabase: find all users with srs_cards where `due <= now()`
       - For each user with due cards, look up their push subscription
       - Send push notification with bilingual content:
         - Title: "Cards Due for Review! / ပြန်လှည့်ရန် ကတ်များရှိပါတယ်!"
         - Body: "You have X cards ready to review. / ပြန်လှည့်ရန် ကတ် X ခုရှိသည်။"
       - Reuse existing push notification infrastructure from Phase 2 (src/lib/pwa/pushNotifications.ts)
       - Use web-push library (already installed from Phase 2)
       - Protect endpoint with a simple API key check (check for `x-api-key` header matching env var `SRS_CRON_API_KEY`)
       - Return JSON: `{ notified: number, errors: number }`

    2. Add reminder time preference to SettingsPage.tsx:
       - Add new section "Review Reminders / ပြန်လှည့်သတိပေးခြင်း" after existing notification settings
       - Time picker input for preferred reminder time (default: 09:00)
       - Store preference in localStorage: key `civic-prep-srs-reminder-time`
       - Brief description: "Choose when you'd like to be reminded about due cards / ကတ်ပြန်လှည့်ရန် သတိပေးချိန်ရွေးပါ"
       - Use a simple `<input type="time" />` styled with Tailwind
       - Note in settings: "Requires notification permission / အကြောင်းကြားခွင့် လိုအပ်သည်"
       - If push notifications not enabled, show message suggesting to enable them

    3. Update `src/lib/pwa/pushNotifications.ts` if needed:
       - Add helper function `sendSRSReminderNotification(subscription, dueCount)` that formats the bilingual notification payload
       - Reuse existing `sendPushNotification` infrastructure

    NOTE: The actual cron scheduling (calling the API endpoint at the user's preferred time) is a server-side concern that depends on hosting setup. The API endpoint is ready to be called. Document this in the summary as a manual setup step: "Configure cron job to call POST /api/push/srs-reminder daily."
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes
    - pages/api/push/srs-reminder.ts exists as valid API route
    - SettingsPage renders reminder time input
  </verify>
  <done>
    - Push notification API endpoint ready for SRS due card reminders
    - Settings page has reminder time preference (user-configurable per locked decision)
    - Bilingual notification content
    - Reuses Phase 2 push notification infrastructure
    - Nav badge shows due count on Study Guide link
  </done>
</task>

</tasks>

<verification>
- `pnpm exec tsc --noEmit` passes
- All modified files compile
- No ESLint errors
</verification>

<success_criteria>
- User sees badge count on Study Guide nav when cards are due (per locked decision)
- Push notification endpoint sends bilingual reminders about due cards
- User can configure preferred reminder time in settings (per locked decision)
- Infrastructure reuses Phase 2 push notification system
</success_criteria>

<output>
After completion, create `.planning/phases/05-spaced-repetition/05-09-SUMMARY.md`
</output>
