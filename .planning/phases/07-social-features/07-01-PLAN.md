---
phase: 07-social-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/social/streakTracker.ts
  - src/lib/social/streakStore.ts
  - src/lib/social/badgeDefinitions.ts
  - src/lib/social/badgeEngine.ts
  - src/lib/social/badgeStore.ts
  - src/lib/social/compositeScore.ts
  - src/lib/social/index.ts
autonomous: true

must_haves:
  truths:
    - "Streak calculation correctly counts consecutive study days including freeze days"
    - "Badge check functions evaluate streak, accuracy, and coverage milestones"
    - "Composite score formula weights accuracy 50%, coverage 30%, streak 20%"
    - "Streak data persists in IndexedDB across sessions"
    - "Badge earned state persists in IndexedDB"
  artifacts:
    - path: "src/lib/social/streakTracker.ts"
      provides: "Pure streak calculation logic"
      exports: ["calculateStreak", "shouldAutoUseFreeze", "checkFreezeEligibility"]
    - path: "src/lib/social/streakStore.ts"
      provides: "IndexedDB streak data storage"
      exports: ["getStreakData", "recordStudyActivity", "earnFreeze", "StreakData"]
    - path: "src/lib/social/badgeDefinitions.ts"
      provides: "Declarative badge configuration"
      exports: ["BADGE_DEFINITIONS", "BadgeDefinition", "BadgeCheckData"]
    - path: "src/lib/social/badgeEngine.ts"
      provides: "Badge evaluation logic"
      exports: ["evaluateBadges", "getNewlyEarnedBadge"]
    - path: "src/lib/social/badgeStore.ts"
      provides: "IndexedDB earned badge storage"
      exports: ["getEarnedBadges", "markBadgeEarned", "markBadgeShown"]
    - path: "src/lib/social/compositeScore.ts"
      provides: "Leaderboard composite score formula"
      exports: ["calculateCompositeScore"]
    - path: "src/lib/social/index.ts"
      provides: "Barrel export for social module"
  key_links:
    - from: "src/lib/social/streakTracker.ts"
      to: "src/lib/social/streakStore.ts"
      via: "streakStore calls streakTracker pure functions"
      pattern: "calculateStreak|shouldAutoUseFreeze"
    - from: "src/lib/social/badgeEngine.ts"
      to: "src/lib/social/badgeDefinitions.ts"
      via: "engine iterates BADGE_DEFINITIONS"
      pattern: "BADGE_DEFINITIONS"
---

<objective>
Create the foundational data layer for social features: streak tracking logic, badge definitions and evaluation engine, badge/streak IndexedDB storage, and composite score calculator.

Purpose: All social UI components (widgets, heatmaps, celebrations, leaderboard) depend on these core data modules. Building them first enables parallel UI development in Wave 2.
Output: Seven files in src/lib/social/ providing streak calculation, badge evaluation, persistent storage, and composite scoring — all with zero UI dependencies.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-social-features/07-RESEARCH.md
@src/lib/mastery/masteryStore.ts (idb-keyval pattern reference)
@src/lib/mastery/index.ts (barrel export pattern)
@src/lib/srs/srsStore.ts (IndexedDB store pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Streak tracking core and IndexedDB store</name>
  <files>
    src/lib/social/streakTracker.ts
    src/lib/social/streakStore.ts
  </files>
  <action>
    Create `src/lib/social/streakTracker.ts` with pure functions (no side effects, no IndexedDB):

    1. `calculateStreak(activityDates: string[], freezesUsed: string[]): { current: number; longest: number }` — Sort dates descending, walk backwards from today checking each day is either an activity day or freeze day. Count consecutive days. Track longest streak across all gaps. Use user's LOCAL date (`new Date().toISOString().slice(0, 10)`) per timezone pitfall in research.

    2. `shouldAutoUseFreeze(activityDates: string[], freezesAvailable: number): { useFreeze: boolean; freezeDate: string | null }` — Check if yesterday has no activity AND user has freezes available AND today has activity (user returned). If so, return freeze date = yesterday.

    3. `checkFreezeEligibility(activityType: 'test' | 'practice' | 'srs_review' | 'study_guide' | 'interview', dailyActivityCounts: DailyActivityCounts): boolean` — A full practice test (activityType='practice' with isPracticeTest flag) OR 10+ SRS reviews in a day earns a freeze. Max 3 freezes banked.

    4. `getLocalDateString(): string` — Returns today's date as YYYY-MM-DD in local timezone.

    Interface `DailyActivityCounts`: `{ srsReviewCount: number; practiceTestCompleted: boolean }`.

    Create `src/lib/social/streakStore.ts` with IndexedDB persistence using idb-keyval (follow masteryStore.ts pattern):

    1. Create dedicated store: `createStore('civic-prep-streaks', 'streak-data')`.

    2. Interface `StreakData`: `{ activityDates: string[]; freezesAvailable: number; freezesUsed: string[]; longestStreak: number; lastSyncedAt: string | null; dailyActivityCounts: DailyActivityCounts }`.

    3. `getStreakData(): Promise<StreakData>` — Read from IndexedDB, return defaults if empty.

    4. `recordStudyActivity(activityType: 'test' | 'practice' | 'srs_review' | 'study_guide' | 'interview', meta?: { isPracticeTest?: boolean }): Promise<{ streakUpdated: boolean; freezeEarned: boolean; freezeAutoUsed: boolean }>` — Records today's date, checks freeze auto-use (calls shouldAutoUseFreeze), checks freeze eligibility (calls checkFreezeEligibility), updates longestStreak via calculateStreak. Returns status flags for UI notifications.

    5. `earnFreeze(): Promise<boolean>` — Increment freezesAvailable (cap at 3). Returns false if already at max.

    6. Default StreakData: `{ activityDates: [], freezesAvailable: 0, freezesUsed: [], longestStreak: 0, lastSyncedAt: null, dailyActivityCounts: { srsReviewCount: 0, practiceTestCompleted: false } }`.
  </action>
  <verify>TypeScript compiles with `npx tsc --noEmit src/lib/social/streakTracker.ts src/lib/social/streakStore.ts` (or full project typecheck).</verify>
  <done>Streak calculation handles consecutive days with freeze gaps, freeze auto-use detects missed days, freeze eligibility checks practice test / 10+ SRS reviews, all persisted to IndexedDB.</done>
</task>

<task type="auto">
  <name>Task 2: Badge definitions, engine, store, composite score, and barrel export</name>
  <files>
    src/lib/social/badgeDefinitions.ts
    src/lib/social/badgeEngine.ts
    src/lib/social/badgeStore.ts
    src/lib/social/compositeScore.ts
    src/lib/social/index.ts
  </files>
  <action>
    Create `src/lib/social/badgeDefinitions.ts`:

    Interface `BadgeDefinition`: `{ id: string; category: 'streak' | 'accuracy' | 'coverage'; name: { en: string; my: string }; description: { en: string; my: string }; requirement: { en: string; my: string }; icon: string; check: (data: BadgeCheckData) => boolean }`.

    Interface `BadgeCheckData`: `{ currentStreak: number; longestStreak: number; bestTestAccuracy: number; bestTestScore: number; totalTestsTaken: number; uniqueQuestionsAnswered: number; categoriesMastered: number; totalCategories: number }`.

    Export `BADGE_DEFINITIONS: BadgeDefinition[]` with these badges:
    - Streak: `streak-7` (7 days, "Week Warrior", Flame icon), `streak-14` (14 days, "Fortnight Focus", Flame), `streak-30` (30 days, "Monthly Master", Flame).
    - Accuracy: `accuracy-90` (90% on test, "Sharp Shooter", Target), `accuracy-100` (100% on test, "Perfect Score", Star).
    - Coverage: `coverage-all` (100 questions answered, "Complete Scholar", BookCheck), `coverage-mastered` (all categories mastered, "Category Champion", Award).

    Include bilingual name/description/requirement for all badges using Burmese translations from research file. Use lucide-react icon names as strings.

    Create `src/lib/social/badgeEngine.ts`:

    1. `evaluateBadges(data: BadgeCheckData, earnedBadgeIds: Set<string>): BadgeDefinition[]` — Returns list of newly earned badges (check passes but not in earnedBadgeIds).

    2. `getNewlyEarnedBadge(data: BadgeCheckData, earnedBadgeIds: Set<string>, shownBadgeIds: Set<string>): BadgeDefinition | null` — Returns the first badge that is earned but not yet shown (for celebration modal). Prioritizes by category order: streak -> accuracy -> coverage.

    Create `src/lib/social/badgeStore.ts` using idb-keyval:

    1. Store: `createStore('civic-prep-badges', 'badge-data')`.
    2. `getEarnedBadges(): Promise<EarnedBadge[]>` — Returns array of `{ badgeId: string; earnedAt: string }`.
    3. `markBadgeEarned(badgeId: string): Promise<void>` — Add to earned list with current timestamp.
    4. `markBadgeShown(badgeId: string): Promise<void>` — Track which badges have been shown in celebration modal (separate key in store).
    5. `getShownBadgeIds(): Promise<Set<string>>` — Returns set of badge IDs already celebrated.

    Create `src/lib/social/compositeScore.ts`:

    1. `calculateCompositeScore(data: { currentStreak: number; bestTestAccuracy: number; coveragePercent: number }): number` — Weights: accuracy 50%, coverage 30%, streak 20%. Streak capped at 30 days = 100%. Returns 0-100 rounded integer. Per research discretion recommendation.

    Create `src/lib/social/index.ts` as barrel export re-exporting all public APIs from the 6 modules. Follow the pattern from `src/lib/mastery/index.ts`.
  </action>
  <verify>TypeScript compiles with full project typecheck (`npx tsc --noEmit`). Badge definitions array has 7 entries. Composite score returns 0-100 range.</verify>
  <done>Badge system has 7 badges across 3 categories with bilingual content, engine evaluates newly earned badges, store persists earned/shown state, composite score weights accuracy 50% / coverage 30% / streak 20%.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All 7 files exist in src/lib/social/
3. Barrel export in index.ts re-exports key types and functions
4. No UI imports (no React, no components) in any of these files
5. idb-keyval stores use unique database names (civic-prep-streaks, civic-prep-badges)
</verification>

<success_criteria>
- Pure streak calculation handles consecutive days, freeze gaps, timezone-safe dates
- Badge definitions cover 7 badges across 3 categories with bilingual content
- Badge engine detects newly earned badges and tracks shown state
- Composite score formula produces 0-100 with correct weights
- All data persists in IndexedDB via idb-keyval
- Zero UI dependencies — pure data layer
</success_criteria>

<output>
After completion, create `.planning/phases/07-social-features/07-01-SUMMARY.md`
</output>
