---
phase: 28-interview-ux-voice-flow-polish
plan: 04
type: execute
wave: 2
depends_on: [28-01]
files_modified:
  - src/components/interview/InterviewCountdown.tsx
  - src/components/interview/TTSFallbackBadge.tsx
  - src/components/interview/LandscapeOverlay.tsx
autonomous: true
requirements: [IVPOL-01, IVPOL-02, IVPOL-09]
must_haves:
  truths:
    - "Loading progress bar shows during countdown while audio pre-caches"
    - "Interview only starts when audio caching is complete (or all batches attempted)"
    - "Subtle badge indicates when browser TTS fallback is used instead of pre-cached MP3"
    - "Landscape overlay appears on devices that don't support orientation lock"
  artifacts:
    - path: "src/components/interview/InterviewCountdown.tsx"
      provides: "Enhanced countdown with audio loading progress"
    - path: "src/components/interview/TTSFallbackBadge.tsx"
      provides: "Badge indicator for TTS fallback mode"
      exports: ["TTSFallbackBadge"]
    - path: "src/components/interview/LandscapeOverlay.tsx"
      provides: "CSS-based portrait rotation prompt"
      exports: ["LandscapeOverlay"]
  key_links:
    - from: "src/components/interview/InterviewCountdown.tsx"
      to: "src/lib/audio/audioPrecache.ts"
      via: "calls precacheInterviewAudio during countdown"
      pattern: "precacheInterviewAudio"
---

<objective>
Enhance the interview countdown with audio pre-caching progress and create support UI components.

Purpose: The countdown becomes the audio loading phase -- showing progress while pre-caching all interview audio. The interview only starts once caching is complete (or all attempts are made). Additional UI components handle TTS fallback indication and landscape orientation.

Output: Enhanced InterviewCountdown, TTSFallbackBadge, LandscapeOverlay
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/components/interview/InterviewCountdown.tsx
@src/lib/audio/audioPrecache.ts
@.planning/phases/28-interview-ux-voice-flow-polish/28-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance InterviewCountdown with audio loading</name>
  <files>src/components/interview/InterviewCountdown.tsx</files>
  <action>
Modify `src/components/interview/InterviewCountdown.tsx`:

Add new props:
- `questionIds: string[]` -- the 20 question IDs to pre-cache
- `includeBurmese: boolean` -- whether to pre-cache Burmese audio
- `onCacheComplete?: (result: PrecacheProgress) => void` -- reports cache result to parent

New behavior (two-phase countdown):
1. **Phase 1: Audio Loading** -- show "Loading audio..." text with progress bar
   - Call `precacheInterviewAudio(questionIds, { includeBurmese }, onProgress)` on mount
   - Show animated progress bar below the loading text: `width: ${(loaded/total)*100}%`
   - Progress bar uses `bg-primary` fill in a `bg-slate-700` track
   - Show count: "Loading audio: {loaded}/{total}"
   - When cache is complete (or all attempted): transition to Phase 2
   - Also run `checkNetworkQuality()` during this phase; if 'slow', show subtle warning text: "Slow connection detected. Audio may take longer to load."
   - If 'offline', show warning: "You're offline. Some audio may use voice synthesis."
2. **Phase 2: Number Countdown** -- existing 3-2-1-Begin sequence (unchanged)
   - Call `onCacheComplete(result)` before starting countdown numbers
   - onComplete fires after "Begin" as before

Keep all existing animation logic (spring scale, reduced motion support).
Preserve the InterviewerAvatar above the countdown.

Import `precacheInterviewAudio` from `@/lib/audio/audioPrecache` and `checkNetworkQuality` from `@/lib/audio/networkCheck`.
  </action>
  <verify>TypeScript compiles. Component renders both loading phase and countdown phase.</verify>
  <done>InterviewCountdown pre-caches all audio during loading phase, then runs 3-2-1-Begin sequence</done>
</task>

<task type="auto">
  <name>Task 2: Create TTSFallbackBadge component</name>
  <files>src/components/interview/TTSFallbackBadge.tsx</files>
  <action>
Create `src/components/interview/TTSFallbackBadge.tsx`:

Props:
- `visible: boolean` -- whether to show the badge
- `compact?: boolean` -- smaller variant for chat bubbles

Implementation:
1. Small rounded badge with `Volume2` icon (lucide) and "TTS" text
2. Subtle styling: `bg-amber-500/20 text-amber-400 text-xs px-2 py-0.5 rounded-full`
3. Tooltip (native title attribute): "Using voice synthesis (audio unavailable)"
4. AnimatePresence for smooth show/hide
5. Compact mode: icon-only (no text), smaller size
6. Use `motion.span` with fade in/out animation (respects reduced motion)

This badge appears next to the examiner's chat bubble when a specific audio file failed to pre-cache and browser TTS is being used as fallback.
  </action>
  <verify>TypeScript compiles. Component renders badge with icon and text.</verify>
  <done>TTSFallbackBadge shows subtle amber indicator when TTS fallback is active for a specific audio</done>
</task>

<task type="auto">
  <name>Task 3: Create LandscapeOverlay component</name>
  <files>src/components/interview/LandscapeOverlay.tsx</files>
  <action>
Create `src/components/interview/LandscapeOverlay.tsx`:

Props:
- `active: boolean` -- whether the overlay should show (interview is in progress)

Implementation:
1. Fixed full-screen overlay with `z-50` that shows ONLY in landscape orientation
2. Uses CSS media query: `@media (orientation: landscape)` via Tailwind `landscape:` prefix
3. Show message: "Please rotate your device to portrait" with a phone rotation icon (RotateCcw from lucide)
4. Dark background matching interview aesthetic: `bg-slate-900/95`
5. The overlay is always mounted but uses `hidden portrait:hidden landscape:flex` classes
6. Only renders when `active` is true (prevents showing on non-interview pages)
7. Include bilingual text using `useLanguage()` hook -- show Burmese translation below English

This is the fallback for browsers that don't support `screen.orientation.lock()` (Safari).
  </action>
  <verify>TypeScript compiles. Component uses correct Tailwind responsive classes.</verify>
  <done>LandscapeOverlay prompts portrait rotation on unsupported browsers using CSS orientation detection</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- `npm run lint` passes
- Components are importable and render without errors
</verification>

<success_criteria>
- Countdown shows loading progress bar then 3-2-1-Begin
- TTSFallbackBadge provides subtle TTS mode indication
- LandscapeOverlay works as CSS-only fallback for orientation lock
</success_criteria>

<output>
After completion, create `.planning/phases/28-interview-ux-voice-flow-polish/28-04-SUMMARY.md`
</output>
