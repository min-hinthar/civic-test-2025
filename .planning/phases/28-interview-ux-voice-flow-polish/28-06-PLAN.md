---
phase: 28-interview-ux-voice-flow-polish
plan: 06
type: execute
wave: 3
depends_on: [28-01, 28-02, 28-03, 28-04, 28-05]
files_modified:
  - src/components/interview/InterviewSession.tsx
autonomous: true
requirements: [IVPOL-01, IVPOL-03, IVPOL-04, IVPOL-05, IVPOL-06, IVPOL-07, IVPOL-08, IVPOL-09]
must_haves:
  truths:
    - "InterviewSession uses pre-cached audio for all examiner speech"
    - "Failed pre-cache audio falls back to browser TTS with fallback badge"
    - "Text input mode works when speech recognition unavailable"
    - "Keyboard/text toggle appears only when speech recognition IS available"
    - "Practice mode reads correct answer aloud after grading"
    - "Practice mode shows keyword highlights in feedback"
    - "Real mode hides running score"
    - "Real mode progress bar uses monochrome segments"
    - "Back navigation intercepted with confirmation dialog"
    - "Tab backgrounding auto-pauses interview"
    - "Portrait orientation locked during session"
  artifacts:
    - path: "src/components/interview/InterviewSession.tsx"
      provides: "Fully integrated interview session with all Phase 28 features"
  key_links:
    - from: "src/components/interview/InterviewSession.tsx"
      to: "src/lib/audio/audioPrecache.ts"
      via: "uses isAudioCached to decide MP3 vs TTS"
      pattern: "isAudioCached"
    - from: "src/components/interview/InterviewSession.tsx"
      to: "src/components/interview/TextAnswerInput.tsx"
      via: "renders when inputMode is 'text'"
      pattern: "TextAnswerInput"
    - from: "src/components/interview/InterviewSession.tsx"
      to: "src/hooks/useInterviewGuard.ts"
      via: "hook call for back navigation protection"
      pattern: "useInterviewGuard"
---

<objective>
Integrate all Phase 28 components and hooks into InterviewSession.tsx.

Purpose: This is the main integration plan that wires all the new features (audio pre-caching fallback, text input, keyword highlights, mode differentiation, mobile edge case hooks) into the existing InterviewSession orchestrator.

Output: Fully enhanced InterviewSession.tsx with all Phase 28 features
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/components/interview/InterviewSession.tsx
@.planning/phases/28-interview-ux-voice-flow-polish/28-01-SUMMARY.md
@.planning/phases/28-interview-ux-voice-flow-polish/28-02-SUMMARY.md
@.planning/phases/28-interview-ux-voice-flow-polish/28-03-SUMMARY.md
@.planning/phases/28-interview-ux-voice-flow-polish/28-04-SUMMARY.md
@.planning/phases/28-interview-ux-voice-flow-polish/28-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire audio pre-cache fallback into playback</name>
  <files>src/components/interview/InterviewSession.tsx</files>
  <action>
Modify the audio playback logic in InterviewSession.tsx:

1. **Accept pre-cache result** via new prop `precacheResult?: PrecacheProgress`:
   - Store failed URLs in a `Set` for O(1) lookup
   - When playing audio via `audioPlayer.play(url)`, first check if url is in the failed set
   - If url is in failed set AND browser TTS is available: use `speak()` from useTTS instead
   - Track whether current audio is using TTS fallback in a `usingTTSFallback` state

2. **Add TTSFallbackBadge** to examiner's ChatBubble:
   - Render `<TTSFallbackBadge visible={usingTTSFallback} compact />` next to the examiner message
   - Badge shows only while TTS fallback is actively being used for that specific message
   - Reset `usingTTSFallback` to false when moving to next question

3. **Practice mode answer read-aloud**:
   - After grading in Practice mode, play the correct answer audio:
     - `audioPlayer.play(getEnglishAudioUrl(questionId, 'a'))` for the answer
     - If in bilingual mode, also play `getBurmeseAudioUrl(questionId, 'a')` after English finishes
   - Use the `correct-prefix.mp3` audio before the answer audio: "That's correct" + answer
   - For incorrect: use `incorrect-prefix.mp3` + answer audio
   - Fall back to TTS if audio is in the failed set

4. **Real mode score hiding**:
   - Conditionally hide the score display when `mode === 'realistic'`
   - No score count shown during session -- only revealed in results
  </action>
  <verify>TypeScript compiles. Audio fallback logic is testable.</verify>
  <done>InterviewSession plays pre-cached audio with TTS fallback, Practice reads correct answers aloud, Real hides score</done>
</task>

<task type="auto">
  <name>Task 2: Wire text input and mode UI components</name>
  <files>src/components/interview/InterviewSession.tsx</files>
  <action>
Continue modifying InterviewSession.tsx:

1. **Text input mode**:
   - Add `inputMode` state: `'voice' | 'text'`
   - Default to 'text' when `!speechRecognitionSupported`
   - If speech IS supported: show toggle button (Keyboard icon to switch to text, Mic icon to switch back)
   - When `inputMode === 'text'`: render `<TextAnswerInput>` instead of mic/waveform area
   - TextAnswerInput `onSubmit` calls the same grading path as speech: `gradeAnswer(text, question)`
   - Pass `showIOSSafariHint` when detected as iOS Safari without SpeechRecognition

2. **Keyboard/text toggle**:
   - Only render toggle when speech recognition IS available
   - Small icon button in the input area: Keyboard when in voice mode, Mic when in text mode
   - Toggling cancels any active speech recognition or audio

3. **Mode components integration**:
   - Replace current header with `<ModeBadge mode={mode} />` positioned in corner
   - Replace current progress display with `<InterviewProgress mode={mode} currentIndex={currentIndex} totalQuestions={questions.length} results={results} />`
   - Real mode: wrap exit button with `<LongPressButton onLongPress={handleEmergencyExit}>` -- 3s hold discards session and navigates home
   - Practice mode: keep existing exit button with confirmation dialog

4. **Keyword highlights in Practice feedback**:
   - In the feedback phase for Practice mode: render `<KeywordHighlight>` with gradeResult data
   - Show matched keywords in green, missing keywords as pills
   - This appears in the feedback ChatBubble alongside the correct answer text

5. **Previous transcription display**:
   - When user re-records (attempt 2 or 3), pass `previousTranscription` to TextAnswerInput
   - Shows what was previously heard so user can see what was misheard
  </action>
  <verify>TypeScript compiles. Both voice and text paths grade answers correctly.</verify>
  <done>Text input works as fallback, keyboard toggle available, mode components integrated, keyword highlights in Practice feedback</done>
</task>

<task type="auto">
  <name>Task 3: Wire edge case hooks and mobile handling</name>
  <files>src/components/interview/InterviewSession.tsx</files>
  <action>
Continue modifying InterviewSession.tsx:

1. **useInterviewGuard hook**:
   - Call `useInterviewGuard({ active: interviewActive, onBackAttempt: () => setShowExitConfirmation(true) })`
   - Back press shows the existing exit confirmation dialog
   - Guard is only active during the interview session (not countdown, not results)

2. **useOrientationLock hook**:
   - Call `useOrientationLock({ active: interviewActive })`
   - If `{ locked: false, supported: false }`: render `<LandscapeOverlay active={interviewActive} />`

3. **useVisibilityPause hook**:
   - Call with `onHidden` that: pauses audioPlayer, pauses timer (if active), sets `interviewPaused` state
   - Call with `onVisible` that: shows brief "Resuming..." message (1s), then resumes
   - If in `reading` phase when hidden: re-play the current question audio when visible
   - If in `responding` phase when hidden: just resume timer
   - `interviewPaused` state shows a semi-transparent overlay: "Interview Paused" with "Tap to resume" (or auto-resume after brief delay)

4. **Mobile keyboard scroll**:
   - When `inputMode === 'text'` and textarea receives focus:
     - Use `scrollIntoView({ behavior: 'smooth', block: 'nearest' })` on the input container
     - Ensure the latest question ChatBubble is still visible above the input
     - Use `visualViewport` API resize listener if available to detect keyboard open

5. **StorageQuota error handling**:
   - Wrap session save (existing `saveSession` call) in try/catch
   - On QuotaExceededError: show toast "Couldn't save progress" but don't stop the interview
   - Use existing BilingualToast pattern

6. **Mic permission handling**:
   - If micPermission is 'denied' and inputMode is 'voice': show prompt to either enable mic or switch to text mode
   - Don't block the interview -- allow text mode as fallback
  </action>
  <verify>TypeScript compiles. All hooks are properly called with correct dependencies.</verify>
  <done>Edge case hooks integrated, mobile keyboard scrolls, storage errors handled gracefully, visibility auto-pause works</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- `npm run lint` passes
- `npm run build` produces no errors
- InterviewSession imports all new components and hooks
</verification>

<success_criteria>
- Pre-cached audio plays with TTS fallback for failures
- Text input works for non-speech browsers
- Practice mode shows keyword highlights and reads correct answers
- Real mode hides score, uses monochrome progress, has long-press exit
- Back navigation, orientation lock, and visibility pause all function
- Mobile keyboard doesn't hide the question being answered
</success_criteria>

<output>
After completion, create `.planning/phases/28-interview-ux-voice-flow-polish/28-06-SUMMARY.md`
</output>
