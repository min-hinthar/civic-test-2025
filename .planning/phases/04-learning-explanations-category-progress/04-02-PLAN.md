---
phase: 04-learning-explanations-category-progress
plan: 02
type: tdd
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/mastery/calculateMastery.ts
  - src/lib/mastery/calculateMastery.test.ts
  - src/lib/mastery/masteryStore.ts
  - src/lib/mastery/weakAreaDetection.ts
autonomous: true

must_haves:
  truths:
    - "Mastery calculation weights recent answers more heavily than old ones"
    - "Answer history persists in IndexedDB across sessions"
    - "Practice answers weighted at 0.7x vs test answers at 1.0x"
    - "Weak categories identified using 60% threshold"
  artifacts:
    - path: "src/lib/mastery/calculateMastery.ts"
      provides: "Recency-weighted mastery calculation with exponential decay"
      exports: ["calculateCategoryMastery", "calculateOverallMastery", "calculateQuestionAccuracy"]
    - path: "src/lib/mastery/calculateMastery.test.ts"
      provides: "Unit tests for mastery calculation"
      contains: "describe.*calculateCategoryMastery"
    - path: "src/lib/mastery/masteryStore.ts"
      provides: "IndexedDB storage for answer history"
      exports: ["recordAnswer", "getAnswerHistory", "getQuestionHistory", "clearAnswerHistory"]
    - path: "src/lib/mastery/weakAreaDetection.ts"
      provides: "Weak area identification and stale category detection"
      exports: ["detectWeakAreas", "detectStaleCategories", "getNextMilestone"]
  key_links:
    - from: "src/lib/mastery/calculateMastery.ts"
      to: "src/lib/mastery/masteryStore.ts"
      via: "StoredAnswer type import"
      pattern: "StoredAnswer"
    - from: "src/lib/mastery/weakAreaDetection.ts"
      to: "src/lib/mastery/calculateMastery.ts"
      via: "calculateCategoryMastery import"
      pattern: "calculateCategoryMastery"
---

<objective>
Build the mastery calculation engine with TDD: recency-weighted accuracy scoring, IndexedDB answer history storage, and weak area detection.

Purpose: This is the intelligence core of Phase 4. Every progress visualization, practice recommendation, and nudge depends on accurate mastery calculation. TDD ensures the math is correct and edge cases are handled.

Output: Tested mastery calculation library, IndexedDB storage layer, and weak area detection utilities.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-learning-explanations-category-progress/04-CONTEXT.md
@.planning/phases/04-learning-explanations-category-progress/04-RESEARCH.md
@src/types/index.ts
@src/lib/mastery/categoryMapping.ts
</context>

<feature>
  <name>Recency-Weighted Mastery Calculation Engine</name>
  <files>
    src/lib/mastery/calculateMastery.ts,
    src/lib/mastery/calculateMastery.test.ts,
    src/lib/mastery/masteryStore.ts,
    src/lib/mastery/weakAreaDetection.ts
  </files>
  <behavior>
    **calculateCategoryMastery(answers, questionIds):**
    - Empty answers -> returns 0
    - All correct today -> returns 100
    - All incorrect today -> returns 0
    - 50/50 split today -> returns 50
    - Old correct answers (30 days ago) weigh less than recent incorrect answers
    - DECAY_HALF_LIFE_DAYS = 14 (weight halves every 14 days)
    - Practice answers weighted at 0.7x, test answers at 1.0x (Claude's discretion decision)

    **calculateQuestionAccuracy(answers, questionId):**
    - Returns { correct, total, accuracy } for a specific question
    - Uses simple ratio (no decay) for per-question display

    **calculateOverallMastery(categoryMasteries):**
    - Weighted average across categories (proportional to question count)

    **masteryStore:**
    - recordAnswer({ questionId, isCorrect, sessionType }) -> stores with timestamp in IndexedDB
    - getAnswerHistory() -> returns all StoredAnswer[]
    - getQuestionHistory(questionId) -> returns filtered StoredAnswer[]
    - clearAnswerHistory() -> for testing/reset
    - Uses idb-keyval with dedicated store 'civic-prep-mastery'

    **weakAreaDetection:**
    - detectWeakAreas(categoryMasteries, threshold=60) -> returns categories below threshold, sorted weakest first
    - detectStaleCategories(answerHistory, categories, staleDays=7) -> returns categories not practiced recently
    - getNextMilestone(mastery) -> returns { level: 'bronze'|'silver'|'gold', target: 50|75|100, remaining: number } or null if gold achieved

    Test cases:
    - calculateCategoryMastery([], [...]) -> 0
    - calculateCategoryMastery([{correct, today}], [id]) -> 100
    - calculateCategoryMastery([{incorrect, today}], [id]) -> 0
    - calculateCategoryMastery([{correct, 30d ago}, {incorrect, today}], [id]) -> ~30 (recent incorrect dominates)
    - calculateCategoryMastery([{incorrect, 30d ago}, {correct, today}], [id]) -> ~70 (recent correct dominates)
    - Practice weight: practice answer contributes 0.7x vs test answer 1.0x
    - detectWeakAreas({Gov: 80, Hist: 45, Civics: 55}, 60) -> [{Hist, 45}, {Civics, 55}]
    - getNextMilestone(72) -> { level: 'silver', target: 75, remaining: 3 }
    - getNextMilestone(100) -> null
  </behavior>
  <implementation>
    1. RED: Write failing tests for calculateCategoryMastery edge cases, practice weighting, weakAreaDetection
    2. GREEN: Implement exponential decay formula: weight = Math.pow(0.5, ageDays / DECAY_HALF_LIFE_DAYS). Apply sessionType multiplier (test: 1.0, practice: 0.7). Implement weak area detection with configurable threshold.
    3. REFACTOR: Extract constants, ensure memoization-friendly pure functions

    masteryStore uses idb-keyval (already installed):
    ```typescript
    import { createStore, get, set } from 'idb-keyval';
    const masteryStore = createStore('civic-prep-mastery', 'answer-history');
    ```

    StoredAnswer type:
    ```typescript
    interface StoredAnswer {
      questionId: string;
      isCorrect: boolean;
      timestamp: number;
      sessionType: 'test' | 'practice';
    }
    ```
  </implementation>
</feature>

<verification>
1. `npm test -- --run src/lib/mastery/calculateMastery.test.ts` - all tests pass
2. `npx tsc --noEmit` - no type errors
3. Mastery calculation correctly applies exponential decay with 14-day half-life
4. Practice sessions weighted at 0.7x compared to test sessions at 1.0x
5. Weak area detection correctly identifies categories below 60% threshold
</verification>

<success_criteria>
- All mastery calculation tests pass (RED -> GREEN -> REFACTOR complete)
- calculateCategoryMastery handles empty, all-correct, all-incorrect, mixed, and time-decay cases
- Practice vs test weighting implemented (0.7x vs 1.0x)
- masteryStore exports recordAnswer, getAnswerHistory, getQuestionHistory, clearAnswerHistory
- weakAreaDetection exports detectWeakAreas, detectStaleCategories, getNextMilestone
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-learning-explanations-category-progress/04-02-SUMMARY.md`
</output>
