---
phase: 37-bug-fixes-ux-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/bookmarks/bookmarkStore.ts
  - src/lib/bookmarks/index.ts
  - src/hooks/useBookmarks.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "Bookmarks persist across page refreshes via IndexedDB"
    - "Toggling a bookmark updates UI instantly (optimistic) before IndexedDB write completes"
    - "Failed IndexedDB writes revert the optimistic UI state"
  artifacts:
    - path: "src/lib/bookmarks/bookmarkStore.ts"
      provides: "IndexedDB CRUD for bookmarks using idb-keyval"
      contains: "createStore"
    - path: "src/lib/bookmarks/index.ts"
      provides: "Re-exports for bookmark store"
      contains: "export"
    - path: "src/hooks/useBookmarks.ts"
      provides: "React hook with optimistic toggle, loading state, and bookmarked IDs set"
      contains: "useBookmarks"
  key_links:
    - from: "src/hooks/useBookmarks.ts"
      to: "src/lib/bookmarks/bookmarkStore.ts"
      via: "Hook wraps store with React state"
      pattern: "import.*bookmarkStore"
---

<objective>
Create bookmark persistence layer and React hook for flashcard star/bookmark feature. Uses idb-keyval with dedicated IndexedDB store, mirroring the exact srsStore.ts pattern. Hook provides optimistic state updates for instant UI feedback.

Purpose: Foundation for flashcard bookmark toggle (Plan 06 depends on this).
Output: bookmarkStore.ts, index.ts, useBookmarks.ts — ready for UI consumption.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/srs/srsStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bookmark store and hook</name>
  <files>src/lib/bookmarks/bookmarkStore.ts, src/lib/bookmarks/index.ts, src/hooks/useBookmarks.ts</files>
  <action>
**Step 1: Create `src/lib/bookmarks/bookmarkStore.ts`**

Follow the exact same idb-keyval pattern as `src/lib/srs/srsStore.ts`:

```typescript
import { createStore, get, set, del, keys } from 'idb-keyval';

const bookmarkDb = createStore('civic-prep-bookmarks', 'starred');

export async function isBookmarked(questionId: string): Promise<boolean> {
  const val = await get<boolean>(questionId, bookmarkDb);
  return val === true;
}

export async function setBookmark(questionId: string, starred: boolean): Promise<void> {
  if (starred) {
    await set(questionId, true, bookmarkDb);
  } else {
    await del(questionId, bookmarkDb);
  }
}

export async function getAllBookmarkIds(): Promise<string[]> {
  const allKeys = await keys(bookmarkDb);
  return allKeys as string[];
}

export async function clearAllBookmarks(): Promise<void> {
  const allKeys = await keys(bookmarkDb);
  for (const key of allKeys) {
    await del(key as string, bookmarkDb);
  }
}
```

**Step 2: Create `src/lib/bookmarks/index.ts`**

Re-export all functions:
```typescript
export { isBookmarked, setBookmark, getAllBookmarkIds, clearAllBookmarks } from './bookmarkStore';
```

**Step 3: Create `src/hooks/useBookmarks.ts`**

Create the React hook with optimistic state updates following the pattern from research:

```typescript
import { useState, useEffect, useCallback } from 'react';
import { getAllBookmarkIds, setBookmark as persistBookmark } from '@/lib/bookmarks';

export function useBookmarks() {
  const [bookmarkedIds, setBookmarkedIds] = useState<Set<string>>(new Set());
  const [isLoading, setIsLoading] = useState(true);

  // Load all bookmarks on mount
  useEffect(() => {
    let cancelled = false;
    getAllBookmarkIds()
      .then(ids => {
        if (!cancelled) {
          setBookmarkedIds(new Set(ids));
          setIsLoading(false);
        }
      })
      .catch(() => {
        if (!cancelled) setIsLoading(false);
      });
    return () => { cancelled = true; };
  }, []);

  const toggleBookmark = useCallback(async (questionId: string) => {
    const wasBookmarked = bookmarkedIds.has(questionId);

    // Optimistic update — instant UI feedback
    setBookmarkedIds(prev => {
      const next = new Set(prev);
      if (wasBookmarked) {
        next.delete(questionId);
      } else {
        next.add(questionId);
      }
      return next;
    });

    // Persist to IndexedDB
    try {
      await persistBookmark(questionId, !wasBookmarked);
    } catch {
      // Revert optimistic update on failure
      setBookmarkedIds(prev => {
        const next = new Set(prev);
        if (wasBookmarked) {
          next.add(questionId);
        } else {
          next.delete(questionId);
        }
        return next;
      });
    }
  }, [bookmarkedIds]);

  const isBookmarked = useCallback(
    (questionId: string) => bookmarkedIds.has(questionId),
    [bookmarkedIds]
  );

  return {
    isBookmarked,
    toggleBookmark,
    bookmarkedIds,
    bookmarkCount: bookmarkedIds.size,
    isLoading,
  };
}
```

Key design decisions:
- Local-only persistence (no Supabase sync — per research recommendation)
- Optimistic state for instant UI feedback (idb-keyval writes are ~1-5ms but async)
- Closure-local `cancelled` flag for effect cleanup (per CLAUDE.md convention)
- No context provider needed — simple hook wrapping idb-keyval is sufficient (per research anti-patterns)
- `bookmarkCount` exposed for future "X bookmarked" badge on nav/toolbar
  </action>
  <verify>Run `npm run typecheck` — all three new files should compile without errors. Run `npm run lint` — no lint issues. The hook follows all React Compiler rules (no setState in effects, no ref.current during render).</verify>
  <done>bookmarkStore.ts provides IndexedDB CRUD via idb-keyval. useBookmarks.ts provides optimistic toggle, loading state, and bookmarked IDs set. Ready for UI integration in Plan 06.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with new files
2. `npm run lint` passes
3. bookmarkStore.ts uses `createStore` from idb-keyval with dedicated store name
4. useBookmarks.ts implements optimistic state update pattern
5. Effect cleanup uses `cancelled` flag pattern
</verification>

<success_criteria>
- Three files created following project conventions
- idb-keyval store pattern matches srsStore.ts
- Hook provides isBookmarked, toggleBookmark, bookmarkedIds, bookmarkCount, isLoading
- No React Compiler rule violations
</success_criteria>

<output>
After completion, create `.planning/phases/37-bug-fixes-ux-polish/37-03-SUMMARY.md`
</output>
