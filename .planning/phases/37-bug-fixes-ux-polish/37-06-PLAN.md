---
phase: 37-bug-fixes-ux-polish
plan: 06
type: execute
wave: 3
depends_on: ["37-03", "37-05"]
files_modified:
  - src/components/study/Flashcard3D.tsx
  - src/components/study/FlashcardStack.tsx
  - src/hooks/useAutoPlay.ts
  - src/components/study/AutoPlayControls.tsx
  - src/pages/StudyGuidePage.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Card back shows answer, explanation, category, difficulty, and mastery level"
    - "Star/bookmark toggle on flashcards persists across sessions via IndexedDB"
    - "Auto-play mode reads question, pauses, flips to answer, reads answer, pauses, advances"
    - "Auto-play can be paused and resumed without audio overlap"
  artifacts:
    - path: "src/components/study/Flashcard3D.tsx"
      provides: "Enriched card back with answer, explanation, category, difficulty, mastery, and bookmark toggle"
      contains: "useBookmarks"
    - path: "src/hooks/useAutoPlay.ts"
      provides: "Auto-play hook with TTS sequencing and cancellation"
      contains: "useAutoPlay"
    - path: "src/components/study/AutoPlayControls.tsx"
      provides: "Play/pause toggle with speed controls"
      contains: "AutoPlayControls"
  key_links:
    - from: "src/components/study/Flashcard3D.tsx"
      to: "src/hooks/useBookmarks.ts"
      via: "Card back uses useBookmarks for star toggle"
      pattern: "toggleBookmark"
    - from: "src/hooks/useAutoPlay.ts"
      to: "src/hooks/useTTS.ts"
      via: "Auto-play uses TTS for speech"
      pattern: "useTTS|speak"
---

<objective>
Enrich flashcard back with full question details (answer, explanation, category, difficulty, mastery), add bookmark/star toggle, and implement auto-play study mode for hands-free study with TTS.

Purpose: User decision locks card back showing "everything available" plus bookmark and auto-play features.
Output: Enhanced Flashcard3D back, useAutoPlay hook, AutoPlayControls component.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-bug-fixes-ux-polish/37-03-SUMMARY.md
@.planning/phases/37-bug-fixes-ux-polish/37-05-SUMMARY.md
@src/components/study/Flashcard3D.tsx
@src/components/study/FlashcardStack.tsx
@src/hooks/useTTS.ts
@src/hooks/useAutoRead.ts
@src/lib/audio/audioPlayer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enrich Flashcard3D back face with full details + bookmark toggle</name>
  <files>src/components/study/Flashcard3D.tsx, src/pages/StudyGuidePage.tsx</files>
  <action>
**User decision (locked):** Card back shows everything available: answer, explanation, category, difficulty, mastery level. Bookmark/star toggle on individual flashcards.

**Step 1: Enhance Flashcard3D back face**

Currently Flashcard3D shows the answer text on the back. Enrich it to show:

1. **Answer text** (already there — keep it)
2. **Explanation** — if the question has an explanation object, show it below the answer in a bordered section:
   - Short summary text (1-2 sentences)
   - Muted foreground color, smaller text
   - Bilingual if showBurmese (explanation has `text_en` and `text_my`)
3. **Category badge** — small pill showing the question's category name with accent color (use `getSubCategoryColors`)
4. **Difficulty indicator** — visual indicator:
   - Show as small dots (3 dots: easy/medium/hard based on question position/data)
   - OR use a label like "Beginner" / "Intermediate" / "Advanced" based on USCIS category difficulty
   - Per Claude's discretion: use 3-level system with color-coded labels
5. **Mastery level** — if the user has SRS data for this question:
   - Show mastery as: New / Learning / Review / Mastered
   - Use FSRS card state: State.New, State.Learning, State.Review, State.Relearning
   - Color code: New=muted, Learning=warning, Review=info, Mastered=success
   - Import from SRSContext or use a lightweight lookup

**Step 2: Add bookmark/star toggle**

- Import `useBookmarks` from `@/hooks/useBookmarks`
- Add a star icon (lucide `Star`) in the top-right corner of the card back
- When bookmarked: filled star with primary color (`fill-current text-primary`)
- When not bookmarked: outline star with muted color
- On click: `toggleBookmark(questionId)` — instant UI update (optimistic)
- Prevent the star click from triggering card flip: `e.stopPropagation()`
- Touch target: 44x44px minimum
- Spring animation on toggle: scale pulse `whileTap={{ scale: 0.85 }}`

**Step 3: Pass additional data to Flashcard3D**

Flashcard3D will need additional props. Check its current props interface and add:
- `explanation?: { text_en: string; text_my?: string }` — from question data
- `category: string` — for category badge
- `questionId: string` — for bookmark functionality
- `masteryState?: string` — FSRS state label

Update the caller in FlashcardStack.tsx to pass these new props. FlashcardStack gets questions which have all this data. For mastery state, either pass it from StudyGuidePage (which has SRSContext access) or import useSRS in FlashcardStack.

Note: The card back must remain scrollable if content overflows. Add `overflow-y-auto` to the back face content area. The back face itself has `backface-visibility: hidden` — ensure the scroll container is inside the face, not on the face element itself (otherwise it breaks 3D on mobile, per CLAUDE.md pitfall).
  </action>
  <verify>Run `npm run typecheck`. View a flashcard, flip to back — should show answer, explanation, category badge, difficulty, mastery level, and star toggle. Star persists after page refresh (IndexedDB). Star click does not flip card.</verify>
  <done>Flashcard back shows answer, explanation, category, difficulty, mastery. Star toggle persists via IndexedDB. Card back is scrollable for long content.</done>
</task>

<task type="auto">
  <name>Task 2: Implement auto-play study mode hook and controls</name>
  <files>src/hooks/useAutoPlay.ts, src/components/study/AutoPlayControls.tsx, src/components/study/FlashcardStack.tsx</files>
  <action>
**User decision (locked):** Auto-play study mode: hands-free study with TTS and auto-advance.

**Step 1: Create `src/hooks/useAutoPlay.ts`**

Sequential TTS playback with auto-advance through flashcards:
1. Read question text (English audio MP3 or TTS fallback)
2. Wait configurable pause (default 2s)
3. Flip card to answer
4. Read answer text
5. Wait configurable pause (default 3s)
6. Advance to next card
7. Loop until paused or end of deck

Implementation following the research pattern:

```typescript
import { useEffect, useCallback, useState } from 'react';
import { useTTS } from './useTTS';
import { createAudioPlayer, getEnglishAudioUrl } from '@/lib/audio/burmeseAudio';
```

Key design:
- `let cancelled = false` in effect cleanup (per CLAUDE.md convention for effect race conditions)
- Cancel all audio players in cleanup
- Reset state synchronously on pause
- Use `createAudioPlayer()` from audioPlayer.ts (NOT `new Audio()` — mobile autoplay requires element reuse)
- Configurable pauses via props
- Stop at end of deck, set `isPlaying` to false
- Re-run effect when `currentIndex` changes (auto-play advances trigger next cycle)
- `enabled` prop gates the entire effect (only runs when user activates auto-play)

Return: `{ isPlaying, play, pause, toggle }`

**Step 2: Create `src/components/study/AutoPlayControls.tsx`**

Simple control bar for auto-play:

Props: `isPlaying`, `onToggle`, `disabled?`

Layout:
- Play/Pause button (lucide `Play`/`Pause` icons) — primary color, 44px touch target
- Label: "Auto-Play" / "Pause" (bilingual with font-myanmar)
- Small dot animation when playing (3 bouncing dots or pulsing indicator)
- Spring press animation: `whileTap={{ scale: 0.92 }}`

Reduced motion: Replace bouncing dots with static "Playing..." text.

**Step 3: Wire auto-play into FlashcardStack**

- Import `useAutoPlay` and `AutoPlayControls`
- Add `useAutoPlay` hook call with current questions, index, and callbacks
- `onAdvance`: calls existing `goToNext()`
- `onFlip`: sets the card's flipped state (need to expose this — currently Flashcard3D manages its own flip state. Pass a `flipped` prop + `onFlipChange` callback, or use an imperative ref)
- Place `AutoPlayControls` below the FlashcardStack card area
- When auto-play is active, disable manual swipe (set `drag={false}` on the motion.div)
- Stop auto-play when user manually navigates (arrow click, swipe, or chip change)

Important: The auto-play hook effect must handle the async chain carefully:
```typescript
useEffect(() => {
  if (!enabled || !isPlaying) return;
  let cancelled = false;

  const run = async () => {
    // ... async TTS chain with cancelled checks between each step
  };

  run();
  return () => {
    cancelled = true;
    cancel(); // Cancel TTS
  };
}, [enabled, isPlaying, currentIndex]);
```

This ensures no audio overlap when the user toggles play/pause rapidly.
  </action>
  <verify>Run `npm run typecheck`. Start auto-play on FlashcardStack — should read question, pause, flip, read answer, pause, advance. Pausing stops audio immediately. Resuming continues from current card. No audio overlap when toggling. Reaching end of deck stops auto-play.</verify>
  <done>Auto-play mode reads question and answer with configurable pauses and auto-advance. Play/pause controls work without audio overlap. Effect cleanup prevents race conditions.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. `npm run test:run` passes
3. Card back shows all enriched data: answer, explanation, category, difficulty, mastery
4. Bookmark star persists across page refresh
5. Star click doesn't flip card
6. Auto-play reads question, flips, reads answer, advances
7. Pause/resume work cleanly without overlap
8. End of deck stops auto-play
9. Reduced motion respected
</verification>

<success_criteria>
- Flashcard3D back shows answer, explanation, category, difficulty, mastery, bookmark
- useBookmarks integration: optimistic toggle, IndexedDB persistence
- useAutoPlay: sequential TTS with cancellation, no race conditions
- AutoPlayControls: play/pause with visual indicators
- All animations respect prefers-reduced-motion
</success_criteria>

<output>
After completion, create `.planning/phases/37-bug-fixes-ux-polish/37-06-SUMMARY.md`
</output>
