---
phase: 41-route-migration
plan: 03
type: execute
wave: 2
depends_on:
  - 41-01
files_modified:
  - src/components/navigation/NavigationShell.tsx
  - src/components/navigation/BottomTabBar.tsx
  - src/components/navigation/GlassHeader.tsx
  - src/components/navigation/Sidebar.tsx
  - src/components/navigation/NavItem.tsx
  - src/components/navigation/NavigationProvider.tsx
  - src/components/navigation/navConfig.ts
  - src/hooks/useFocusOnNavigation.ts
  - src/hooks/useInterviewGuard.ts
  - src/hooks/useNavigationGuard.ts
  - src/pages/LandingPage.tsx
  - src/pages/AuthPage.tsx
  - src/pages/Dashboard.tsx
  - src/pages/HubPage.tsx
  - src/pages/TestPage.tsx
  - src/pages/StudyGuidePage.tsx
  - src/pages/OpEdPage.tsx
  - src/pages/PasswordResetPage.tsx
  - src/pages/PasswordUpdatePage.tsx
  - src/pages/SettingsPage.tsx
  - src/pages/PracticePage.tsx
  - src/pages/InterviewPage.tsx
autonomous: true
requirements:
  - MIGR-05
  - MIGR-06

must_haves:
  truths:
    - "All navigation components use next/navigation hooks instead of react-router-dom"
    - "All page files use next/navigation hooks instead of react-router-dom"
    - "Link components use next/link with href prop instead of react-router-dom Link with to prop"
    - "useNavigationGuard provides unified back-button guard for test and interview pages"
    - "HubPage accepts initialTab prop for catch-all integration"
  artifacts:
    - path: "src/hooks/useNavigationGuard.ts"
      provides: "Unified navigation guard hook for active sessions"
      exports: ["useNavigationGuard"]
      min_lines: 25
    - path: "src/components/navigation/NavigationShell.tsx"
      provides: "Navigation shell using usePathname"
      contains: "usePathname"
    - path: "src/pages/HubPage.tsx"
      provides: "Hub page accepting initialTab prop"
      contains: "initialTab"
    - path: "src/pages/AuthPage.tsx"
      provides: "Auth page using searchParams for returnTo"
      contains: "useSearchParams"
  key_links:
    - from: "src/components/navigation/NavItem.tsx"
      to: "next/link"
      via: "Link component import"
      pattern: "from 'next/link'"
    - from: "src/pages/TestPage.tsx"
      to: "src/hooks/useNavigationGuard.ts"
      via: "useNavigationGuard hook"
      pattern: "useNavigationGuard"
    - from: "src/pages/HubPage.tsx"
      to: "app/(protected)/hub/[[...tab]]/HubPageClient.tsx"
      via: "initialTab prop from catch-all"
      pattern: "initialTab"
---

<objective>
Migrate all navigation components, hooks, and page files from react-router-dom to next/navigation. Create the unified useNavigationGuard hook. This converts ~22 source files from react-router-dom imports to next/navigation equivalents.

Purpose: Core import migration that makes all components compatible with App Router. After this plan, the navigation and page layers no longer depend on react-router-dom.
Output: 22 migrated files + 1 new hook file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-route-migration/41-CONTEXT.md
@.planning/phases/41-route-migration/41-RESEARCH.md
@.planning/phases/41-route-migration/41-INTEGRATION-MAP.md
@.planning/phases/41-route-migration/41-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate navigation components and create useNavigationGuard</name>
  <files>
    src/components/navigation/NavigationShell.tsx
    src/components/navigation/BottomTabBar.tsx
    src/components/navigation/GlassHeader.tsx
    src/components/navigation/Sidebar.tsx
    src/components/navigation/NavItem.tsx
    src/components/navigation/NavigationProvider.tsx
    src/hooks/useFocusOnNavigation.ts
    src/hooks/useInterviewGuard.ts
    src/hooks/useNavigationGuard.ts
  </files>
  <action>
**Create `src/hooks/useNavigationGuard.ts`** (new file -- unified guard per user decision):

```typescript
import { useEffect, useCallback } from 'react';

interface NavigationGuardOptions {
  /** Whether the guard is currently active */
  active: boolean;
  /** Called when user attempts to navigate back during active session */
  onBackAttempt: () => void;
  /** Unique marker key to identify this guard's history state */
  markerKey: string;
}

/**
 * Unified navigation guard for back-button interception during active sessions.
 * Used by TestPage (markerKey: 'navLock') and InterviewPage (markerKey: 'interviewGuard').
 *
 * Pushes a marked history entry when active, intercepts popstate events,
 * and shows beforeunload warning.
 */
export function useNavigationGuard({ active, onBackAttempt, markerKey }: NavigationGuardOptions) {
  const stableOnBackAttempt = useCallback(onBackAttempt, [onBackAttempt]);

  useEffect(() => {
    if (!active) return;

    const guardState = { [markerKey]: true };
    window.history.pushState(guardState, '');

    const handlePopState = (event: PopStateEvent) => {
      const state = event.state as Record<string, unknown> | null;
      if (state && state[markerKey] === true) return;
      window.history.pushState(guardState, '');
      stableOnBackAttempt();
    };

    const handleBeforeUnload = (event: BeforeUnloadEvent) => {
      event.preventDefault();
    };

    window.addEventListener('popstate', handlePopState);
    window.addEventListener('beforeunload', handleBeforeUnload);

    return () => {
      window.removeEventListener('popstate', handlePopState);
      window.removeEventListener('beforeunload', handleBeforeUnload);
      const currentState = window.history.state as Record<string, unknown> | null;
      if (currentState && currentState[markerKey] === true) {
        window.history.back();
      }
    };
  }, [active, stableOnBackAttempt, markerKey]);
}
```

Wire into: Used by TestPage (Task 2) and InterviewPage (Task 2) to replace their individual guard implementations.

**Migrate `src/hooks/useInterviewGuard.ts`:** This hook currently uses `useNavigate` from react-router-dom. Refactor to use `useRouter` from `next/navigation` for the `navigate` function. Also consider whether this should now delegate to `useNavigationGuard` -- if so, rewrite to use `useNavigationGuard({ active, onBackAttempt, markerKey: 'interviewGuard' })` internally or have InterviewPage call `useNavigationGuard` directly. The simplest approach: keep `useInterviewGuard` as a thin wrapper that calls `useNavigationGuard` and also handles the interview-specific `useRouter().push()` redirect.

**Migrate `src/hooks/useFocusOnNavigation.ts`:** Replace `useLocation` from `react-router-dom` with `usePathname` from `next/navigation`. The hook uses `location.pathname` -- replace with the pathname string directly.

**Migrate `src/components/navigation/NavigationProvider.tsx`:** Replace `useLocation` with `usePathname` from `next/navigation`. This context tracks current location. Replace `location.pathname` with the `usePathname()` return value. Replace `location.hash` with `window.location.hash` (if used) or remove hash tracking (hash routing is being eliminated).

**Migrate `src/components/navigation/NavigationShell.tsx`:** Replace `useLocation` with `usePathname` from `next/navigation`. Remove the `HIDDEN_ROUTES` check entirely -- NavigationShell will only render inside `(protected)/layout.tsx`, so all routes it sees are protected routes that should show nav. Remove `HIDDEN_ROUTES` import.

**Migrate `src/components/navigation/NavItem.tsx`:** Replace `import { Link, useLocation } from 'react-router-dom'` with `import Link from 'next/link'` and `import { usePathname } from 'next/navigation'`. Change `<Link to={href}>` to `<Link href={href}>`. Replace `location.pathname` with `usePathname()`. Check for `to` prop usage and rename to `href` in the component's interface if needed.

**Migrate `src/components/navigation/BottomTabBar.tsx`:** Replace `useNavigate` with `useRouter` from `next/navigation`. Replace `navigate(path)` with `router.push(path)`. Replace any `useLocation` with `usePathname`. Replace any `<Link to=...>` with `<Link href=...>` from `next/link`.

**Migrate `src/components/navigation/GlassHeader.tsx`:** Replace `useNavigate` with `useRouter` from `next/navigation`. Replace `navigate(-1)` with `router.back()`. Replace any `useLocation` with `usePathname`.

**Migrate `src/components/navigation/Sidebar.tsx`:** Replace `useNavigate` with `useRouter` from `next/navigation`. Replace `<Link to=...>` with `<Link href=...>` from `next/link`. Replace `useLocation` with `usePathname`.

For ALL navigation components: Read each file first to understand exact imports and usage patterns, then apply the appropriate replacements. The mapping is:
- `import { useNavigate } from 'react-router-dom'` -> `import { useRouter } from 'next/navigation'`
- `const navigate = useNavigate()` -> `const router = useRouter()`
- `navigate(path)` -> `router.push(path)`
- `navigate(path, { replace: true })` -> `router.replace(path)`
- `navigate(-1)` -> `router.back()`
- `import { useLocation } from 'react-router-dom'` -> `import { usePathname } from 'next/navigation'`
- `const location = useLocation()` -> `const pathname = usePathname()`
- `location.pathname` -> `pathname`
- `import { Link } from 'react-router-dom'` -> `import Link from 'next/link'`
- `<Link to={x}>` -> `<Link href={x}>`
  </action>
  <verify>
    <automated>cd C:/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && pnpm typecheck 2>&1 | head -30</automated>
    <manual>Verify no react-router-dom imports remain in navigation components and hooks</manual>
  </verify>
  <done>All 7 navigation component files + 2 hook files migrated from react-router-dom to next/navigation. New useNavigationGuard hook created. No react-router-dom imports remain in src/components/navigation/ or src/hooks/. Typecheck passes.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate all 10+ page files from react-router-dom to next/navigation</name>
  <files>
    src/pages/LandingPage.tsx
    src/pages/AuthPage.tsx
    src/pages/Dashboard.tsx
    src/pages/HubPage.tsx
    src/pages/TestPage.tsx
    src/pages/StudyGuidePage.tsx
    src/pages/OpEdPage.tsx
    src/pages/PasswordResetPage.tsx
    src/pages/PasswordUpdatePage.tsx
    src/pages/SettingsPage.tsx
    src/pages/PracticePage.tsx
    src/pages/InterviewPage.tsx
  </files>
  <action>
Migrate all page files from react-router-dom to next/navigation. Read each file first to understand exact usage, then apply changes.

**Common pattern for ALL pages:**
- `import { useNavigate, useLocation, Link, useSearchParams } from 'react-router-dom'` -> appropriate next/navigation and next/link imports
- `useNavigate()` -> `useRouter()` from `next/navigation`
- `useLocation()` -> `usePathname()` from `next/navigation`
- `useSearchParams()` -> `useSearchParams()` from `next/navigation` (NOTE: next/navigation version returns read-only URLSearchParams, NOT a `[params, setParams]` tuple. To update params, use `router.replace(pathname + '?' + newParams.toString())`)
- `<Link to=...>` -> `<Link href=...>` from `next/link`
- `<Navigate to=... replace />` -> `router.replace(path)` in an effect or render

**Page-specific changes:**

`AuthPage.tsx`:
- Remove `location.state.from` fallback (per user decision -- consolidated to returnTo search param only)
- Keep `useSearchParams().get('returnTo')` as the sole redirect-after-login source
- Replace react-router-dom `useSearchParams` with `next/navigation` version
- Replace `navigate()` with `router.push()` / `router.replace()`
- After successful login: `router.replace(returnTo || '/home')`

`LandingPage.tsx`:
- Replace `useNavigate` with `useRouter`
- Authenticated redirect: `router.replace('/home')` (client-side, per user decision)
- Replace `<Link to=...>` with `<Link href=...>` from next/link

`Dashboard.tsx`:
- Replace `useNavigate` with `useRouter`
- Replace `<Link to=...>` with `<Link href=...>`

`HubPage.tsx`:
- **Accept `initialTab` prop** (for the catch-all page.tsx integration): add `initialTab?: string` to props interface. If provided, use it as the default tab. If not provided, derive from pathname or use 'overview'.
- Replace `useLocation` with `usePathname`
- Replace react-router-dom `useSearchParams` with next/navigation version for `focusBadge` param
- Replace `location.state.focusBadge` with `searchParams.get('focusBadge')` (per user decision -- badge deep-linking via search params)
- Tab navigation: replace `navigate('/hub/' + tab)` with `router.push('/hub/' + tab)` (back button cycles tabs per user decision)
- Scroll memory for hub tabs should be preserved (internal state, not router-dependent)

`TestPage.tsx`:
- Replace `useNavigate` with `useRouter`
- Replace existing navigation guard logic with `useNavigationGuard({ active: isTestActive, onBackAttempt: handleBackDuringTest, markerKey: 'navLock' })` from `src/hooks/useNavigationGuard`
- Import from: `src/hooks/useNavigationGuard.ts`

`InterviewPage.tsx`:
- Replace `useNavigate` with `useRouter`
- Replace existing navigation guard with `useNavigationGuard({ active: isInterviewActive, onBackAttempt: handleBackDuringInterview, markerKey: 'interviewGuard' })` or use the refactored `useInterviewGuard` that internally delegates to `useNavigationGuard`

`StudyGuidePage.tsx`:
- Replace `useNavigate` and/or `<Link>` imports

`OpEdPage.tsx`:
- Replace `<Link to=...>` with `<Link href=...>` from next/link
- Replace any `useNavigate` with `useRouter`

`PasswordResetPage.tsx`, `PasswordUpdatePage.tsx`:
- Replace `useNavigate` with `useRouter`
- Replace `navigate('/auth')` with `router.push('/auth')`

`SettingsPage.tsx`:
- Replace `useNavigate` with `useRouter`
- Replace `<Link to=...>` with `<Link href=...>`

`PracticePage.tsx`:
- If it exists in `src/pages/`, check for router imports and migrate

**For ALL page files:** Audit every Link destination while migrating (per user decision -- not just mechanical swap). Ensure all paths use clean URLs (no `#/` prefix, correct canonical paths like `/home` not `/dashboard`).

Import from: `next/navigation` for hooks, `next/link` for Link component.
  </action>
  <verify>
    <automated>cd C:/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && pnpm typecheck && ! grep -r "from 'react-router-dom'" src/pages/ --include="*.tsx" --include="*.ts"</automated>
    <manual>Verify AuthPage uses searchParams for returnTo (no location.state.from), HubPage accepts initialTab prop, TestPage/InterviewPage use useNavigationGuard</manual>
  </verify>
  <done>All 10+ page files migrated from react-router-dom to next/navigation. AuthPage uses searchParams-only returnTo. HubPage accepts initialTab. TestPage and InterviewPage use unified useNavigationGuard. No react-router-dom imports remain in src/pages/. Typecheck passes.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `grep -r "from 'react-router-dom'" src/pages/ src/components/navigation/ src/hooks/` returns no results
- useNavigationGuard.ts exists with exported hook
- HubPage has initialTab prop
- AuthPage uses useSearchParams from next/navigation
</verification>

<success_criteria>
- 0 react-router-dom imports in src/pages/, src/components/navigation/, src/hooks/
- useNavigationGuard hook created and used by TestPage + InterviewPage
- HubPage accepts initialTab prop for catch-all integration
- AuthPage returnTo is searchParams-only (no location.state fallback)
- `pnpm typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/41-route-migration/41-03-SUMMARY.md`
</output>
