---
phase: 12-uscis-2025-question-bank
plan: 04
type: execute
wave: 2
depends_on: ["12-01", "12-02", "12-03"]
files_modified:
  - src/pages/SettingsPage.tsx
  - src/components/onboarding/OnboardingTour.tsx
  - src/components/study/Flashcard3D.tsx
  - src/pages/Dashboard.tsx
  - src/pages/StudyGuidePage.tsx
  - src/pages/TestPage.tsx
  - src/pages/InterviewPage.tsx
  - src/AppShell.tsx
autonomous: true

must_haves:
  truths:
    - "User can select their state in Settings and during onboarding"
    - "Dynamic questions show bilingual 'Answer may change' note with lastVerified date"
    - "State-specific questions show personalized answers (governor, senators, capital) when state is selected"
    - "Update banner is visible on dashboard, study page, test intro, and interview intro"
    - "What's New modal appears once for returning users on app load"
  artifacts:
    - path: "src/pages/SettingsPage.tsx"
      provides: "State picker section in settings"
      contains: "useUserState"
    - path: "src/components/onboarding/OnboardingTour.tsx"
      provides: "State selection step in onboarding tour"
      contains: "Select Your State"
    - path: "src/components/study/Flashcard3D.tsx"
      provides: "Dynamic answer note on flashcards"
      contains: "dynamic"
  key_links:
    - from: "src/pages/SettingsPage.tsx"
      to: "src/contexts/StateContext.tsx"
      via: "useUserState hook for state picker"
      pattern: "useUserState"
    - from: "src/components/study/Flashcard3D.tsx"
      to: "src/contexts/StateContext.tsx"
      via: "useUserState hook for personalized answers"
      pattern: "useUserState"
    - from: "src/AppShell.tsx"
      to: "src/components/update/WhatsNewModal.tsx"
      via: "WhatsNewModal in PWAOnboardingFlow or standalone"
      pattern: "WhatsNewModal"
---

<objective>
Integrate state picker, dynamic answer display, update indicators, and What's New modal across the app.

Purpose: Connects the data layer (Plans 01-02) and UI components (Plan 03) to the actual user-facing pages. Users can select their state, see personalized dynamic answers, and are informed about the USCIS 2025 update.

Output: State picker in Settings + onboarding, dynamic answer notes on study/test questions, update banner on 4 pages, What's New modal on app load.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-uscis-2025-question-bank/12-RESEARCH.md
@.planning/phases/12-uscis-2025-question-bank/12-01-SUMMARY.md
@.planning/phases/12-uscis-2025-question-bank/12-02-SUMMARY.md
@.planning/phases/12-uscis-2025-question-bank/12-03-SUMMARY.md
@src/pages/SettingsPage.tsx
@src/components/onboarding/OnboardingTour.tsx
@src/pages/Dashboard.tsx
@src/pages/StudyGuidePage.tsx
@src/pages/TestPage.tsx
@src/pages/InterviewPage.tsx
@src/components/study/Flashcard3D.tsx
@src/AppShell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add state picker to Settings and onboarding, plus What's New modal</name>
  <files>
    src/pages/SettingsPage.tsx
    src/components/onboarding/OnboardingTour.tsx
    src/AppShell.tsx
  </files>
  <action>
**Step 1: State picker in SettingsPage.tsx**

Add a new settings section for state/territory selection. Place it after the "Language" section and before "Notifications".

Use the existing `SettingsSection` and `SettingsRow` pattern components already in the file.

Section details:
- Icon: `MapPin` from lucide-react (add to imports)
- Title EN: "Location"
- Title MY: "တည်နေရာ"
- Row: State/Territory selector
  - Label: "Your State" / "သင့်ပြည်နယ်"
  - Description: "Used for governor, senator, and capital questions" / "အုပ်ချုပ်ရေးမှူး၊ အထက်လွှတ်တော်အမတ်နှင့် မြို့တော်မေးခွန်းများအတွက် အသုံးပြုသည်"
  - Action: A `<select>` dropdown (native HTML select for simplicity on mobile)
    - Default option: "Select state..." / "ပြည်နယ်ရွေးချယ်ပါ..."
    - Options: From `allStates` array via `useUserState()` hook
    - Value: `selectedState` from context
    - onChange: `setSelectedState(e.target.value || null)`

Import `useUserState` from `@/contexts/StateContext`.

**Step 2: State selection step in OnboardingTour.tsx**

Add a new tour step that prompts the user to select their state. Insert it as step 2 (after the Dashboard overview, before Study Guide step).

New step:
```typescript
{
  target: '[data-tour="state-select"]',
  content: (
    <div>
      <h3 className="font-bold text-lg mb-2">Select Your State</h3>
      <p className="text-muted-foreground text-sm">
        Choose your state to see your governor, senators, and capital in study questions.
      </p>
      <p className="font-myanmar text-sm text-muted-foreground mt-2">
        လေ့လာမေးခွန်းများတွင် သင့်အုပ်ချုပ်ရေးမှူး၊ အထက်လွှတ်တော်အမတ်များနှင့် မြို့တော်ကို ကြည့်ရှုရန် သင့်ပြည်နယ်ကို ရွေးချယ်ပါ။
      </p>
    </div>
  ),
  placement: 'bottom',
  disableBeacon: true,
}
```

NOTE: The `data-tour="state-select"` attribute needs to be added to a visible element on the Dashboard. This should be added to a small "state indicator" badge or the state section on Dashboard (if added) or to the settings icon. Since this is during onboarding and the tour step uses `disableBeacon: true`, react-joyride will skip the step if the target is not found -- which is acceptable for now. A simpler approach: make this step target `'body'` with `placement: 'center'` and include a "Go to Settings to select your state" instruction instead of pointing to a specific element.

Use `placement: 'center'` with `target: 'body'` for this step since there's no natural dashboard element for state selection yet.

**Step 3: WhatsNewModal in AppShell.tsx**

Add the What's New modal to the PWAOnboardingFlow or as a standalone component rendered after the OnboardingTour in AppShell.tsx.

1. Import `WhatsNewModal` and `useWhatsNew` from `@/components/update/WhatsNewModal`
2. Create a small wrapper component in AppShell that uses the hook:

```typescript
function WhatsNewFlow() {
  const { showWhatsNew, dismissWhatsNew } = useWhatsNew();
  if (!showWhatsNew) return null;
  return <WhatsNewModal onClose={dismissWhatsNew} />;
}
```

3. Render `<WhatsNewFlow />` after `<OnboardingTour />` in the Router block. This ensures the What's New modal appears after the tour completes (not during the tour).
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npx eslint src/pages/SettingsPage.tsx src/components/onboarding/OnboardingTour.tsx src/AppShell.tsx --no-warn-ignored` passes
3. SettingsPage imports and uses `useUserState`
4. OnboardingTour has a state selection step
5. WhatsNewModal renders in AppShell
  </verify>
  <done>
- State picker available in Settings with all 56 states/territories
- Onboarding tour includes state selection guidance
- What's New modal shows once for returning users
  </done>
</task>

<task type="auto">
  <name>Task 2: Dynamic answer display and update banners on study/test/interview pages</name>
  <files>
    src/components/study/Flashcard3D.tsx
    src/pages/Dashboard.tsx
    src/pages/StudyGuidePage.tsx
    src/pages/TestPage.tsx
    src/pages/InterviewPage.tsx
  </files>
  <action>
**Step 1: Dynamic answer note on Flashcard3D.tsx (study mode)**

When displaying a question with a `dynamic` field, add a bilingual note below the answer:

For `dynamic.type === 'time'`:
- EN: "⚠ This answer may change with elections. Last verified: {lastVerified}"
- MY: "⚠ ဤအဖြေသည် ရွေးကောက်ပွဲများနှင့်အတူ ပြောင်းလဲနိုင်ပါသည်။ နောက်ဆုံးအတည်ပြုချိန်: {lastVerified}"

For `dynamic.type === 'state'`:
- If user has selected a state (via `useUserState()`):
  - Show the state-specific answer from `stateInfo`
  - Map `dynamic.field` to stateInfo property:
    - `'governor'` → stateInfo.governor
    - `'senators'` → stateInfo.senators (show both)
    - `'capital'` → stateInfo.capital
    - `'representative'` → "Visit house.gov to find your representative" (too granular for state-level)
  - EN: "For {stateName}: {answer}"
  - MY: "{stateName}အတွက်: {answer}"
- If no state selected:
  - EN: "Go to Settings to select your state for a personalized answer."
  - MY: "ပုဂ္ဂိုလ်ရေးအဖြေအတွက် ဆက်တင်တွင် သင့်ပြည်နယ်ကို ရွေးချယ်ပါ။"

Style: Small text (text-xs), muted color with a subtle info-box background (`bg-warning-subtle rounded-lg p-2 mt-2`). Use the warning emoji (⚠) as a text prefix, not an icon component.

Read the `Flashcard3D.tsx` file to understand where to insert this note. The note should appear on the answer side of the flashcard, below the study answers.

**Step 2: Dynamic answer note on TestPage.tsx (mock test mode)**

After a question is answered in the mock test, if the question has `dynamic` metadata, show the same bilingual note below the answer feedback. This should appear in the results review section and during the in-test feedback moment.

Read `TestPage.tsx` to find where answer feedback is rendered. Add the dynamic note conditionally when `question.dynamic` exists.

**Step 3: Dynamic answer note on InterviewPage.tsx (interview sim)**

Same pattern as TestPage -- show dynamic notes during the interview review phase.

Read `InterviewPage.tsx` to find the answer review/feedback section.

**Step 4: UpdateBanner on Dashboard, StudyGuidePage, TestPage, InterviewPage**

Import `UpdateBanner` from `@/components/update/UpdateBanner` and place it on:

1. **Dashboard.tsx** -- At the top of the main content area, above the readiness indicator. Pass `showBurmese` from `useLanguage()`.

2. **StudyGuidePage.tsx** -- At the top, below the page header/navigation.

3. **TestPage.tsx** -- In the pre-test screen (before the test starts), above the "Start Test" button. Only visible before the test begins (not during or after).

4. **InterviewPage.tsx** -- In the pre-interview screen, similar to TestPage placement.

For each page, import `useLanguage` if not already imported to get `showBurmese`.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npx eslint src/components/study/ src/pages/Dashboard.tsx src/pages/StudyGuidePage.tsx src/pages/TestPage.tsx src/pages/InterviewPage.tsx --no-warn-ignored` passes
3. Grep confirms `dynamic` check appears in Flashcard3D.tsx
4. Grep confirms `UpdateBanner` is imported in all 4 pages
5. Grep confirms `useUserState` is used in Flashcard3D.tsx
  </verify>
  <done>
- Dynamic questions show bilingual "answer may change" note with date
- State-specific questions show personalized answers when state is selected
- State-specific questions prompt "go to Settings" when no state selected
- UpdateBanner visible on dashboard, study, test intro, and interview intro
- All TypeScript and ESLint checks pass
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` passes
3. State picker functional in Settings
4. Onboarding tour includes state selection step
5. Dynamic questions show appropriate notes in study, test, and interview
6. UpdateBanner visible on 4 pages
7. WhatsNewModal appears once for returning users
</verification>

<success_criteria>
- State selection works in Settings and persists across sessions
- Dynamic questions clearly indicate changing answers with last-verified dates
- State-specific answers personalized when state is selected
- "Updated for USCIS 2025" banner on all relevant pages
- What's New modal shown once to existing users
- No broken TypeScript or ESLint
</success_criteria>

<output>
After completion, create `.planning/phases/12-uscis-2025-question-bank/12-04-SUMMARY.md`
</output>
