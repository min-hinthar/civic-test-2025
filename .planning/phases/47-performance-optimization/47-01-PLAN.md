---
phase: 47-performance-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/interview/ScoreTrendChart.tsx
  - src/components/interview/InterviewResults.tsx
  - next.config.mjs
autonomous: true
requirements: [PERF-01, PERF-02]

must_haves:
  truths:
    - "InterviewResults no longer statically imports recharts -- uses dynamic import via ScoreTrendChart"
    - "InterviewResults no longer statically imports Confetti -- uses next/dynamic with ssr: false"
    - "ScoreTrendChart is a new extracted component containing all recharts usage"
    - "next.config.mjs optimizePackageImports includes both lucide-react and recharts"
    - "DotLottie is NOT touched -- already lazy-loaded"
  artifacts:
    - path: "src/components/interview/ScoreTrendChart.tsx"
      provides: "Extracted recharts chart component for dynamic import"
      contains: "ResponsiveContainer"
    - path: "src/components/interview/InterviewResults.tsx"
      provides: "Dynamic imports for ScoreTrendChart and Confetti"
      contains: "next/dynamic"
    - path: "next.config.mjs"
      provides: "optimizePackageImports with recharts added"
      contains: "recharts"
  key_links:
    - from: "src/components/interview/InterviewResults.tsx"
      to: "src/components/interview/ScoreTrendChart.tsx"
      via: "next/dynamic import with ssr: false"
      pattern: "dynamic(() => import"
---

<objective>
Dynamic-import recharts and confetti in InterviewResults, add recharts to optimizePackageImports.

Purpose: Remove recharts (~200KB) and canvas-confetti from initial bundle by lazy-loading them
Output: ScoreTrendChart extracted component, InterviewResults updated with dynamic imports, next.config.mjs updated
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/47-performance-optimization/47-CONTEXT.md
@.planning/phases/47-performance-optimization/47-RESEARCH.md

@src/components/interview/InterviewResults.tsx
@src/components/GlobalOverlays.tsx
@next.config.mjs

<interfaces>
<!-- Key interfaces the executor needs -->
From src/components/interview/InterviewResults.tsx (lines 6-14, recharts imports to extract):
```typescript
import {
  ResponsiveContainer,
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
} from 'recharts';
```

From src/components/interview/InterviewResults.tsx (line 29, Confetti import to replace):
```typescript
import { Confetti } from '@/components/celebrations/Confetti';
```

From src/components/celebrations/Confetti.tsx (ConfettiProps):
```typescript
interface ConfettiProps {
  fire: boolean;
  intensity?: 'sparkle' | 'burst' | 'celebration';
  onComplete?: () => void;
  isDarkMode?: boolean;
}
```

From src/lib/tokens.ts (used by chart):
```typescript
export function getTokenColor(token: string, opacity?: number): string;
```

Existing next/dynamic pattern from GlobalOverlays.tsx:
```typescript
const CelebrationOverlay = dynamic(
  () => import('@/components/celebrations').then(m => m.CelebrationOverlay),
  { ssr: false }
);
```

Current next.config.mjs optimizePackageImports (line 18):
```javascript
optimizePackageImports: ['lucide-react'],
```

Usage of recharts in InterviewResults (lines 736-786):
- The recharts chart is rendered inside a `<Card>` within the "Score Trend" section
- It uses `trendData` (Array<{ date: string; score: number }>) as data
- It calls `getTokenColor()` for theme-aware colors
- Wrapped in condition: `trendData.length >= 2`

Usage of Confetti in InterviewResults (line 473):
```typescript
<Confetti fire={showConfetti} intensity="celebration" onComplete={handleConfettiComplete} />
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract ScoreTrendChart and dynamic-import recharts and confetti</name>
  <files>src/components/interview/ScoreTrendChart.tsx, src/components/interview/InterviewResults.tsx</files>
  <action>
**1. Create `src/components/interview/ScoreTrendChart.tsx`:**

Extract the recharts chart rendering from InterviewResults into a new component:

```typescript
'use client';

import {
  ResponsiveContainer,
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
} from 'recharts';
import { getTokenColor } from '@/lib/tokens';
import { useThemeContext } from '@/contexts/ThemeContext';

interface ScoreTrendChartProps {
  data: Array<{ date: string; score: number }>;
}

export function ScoreTrendChart({ data }: ScoreTrendChartProps) {
  // Subscribe to theme changes so getTokenColor() re-resolves on toggle
  useThemeContext();

  return (
    <div className="h-48 w-full">
      <ResponsiveContainer>
        <LineChart data={data} margin={{ left: 0, right: 0, top: 10, bottom: 0 }}>
          <CartesianGrid
            strokeDasharray="3 3"
            stroke={getTokenColor('--color-border', 0.3)}
            opacity={0.3}
          />
          <XAxis
            dataKey="date"
            stroke={getTokenColor('--color-text-secondary')}
            fontSize={11}
          />
          <YAxis
            domain={[0, 20]}
            stroke={getTokenColor('--color-text-secondary')}
            fontSize={11}
            tickFormatter={(value: number) => `${value}`}
          />
          <Tooltip
            formatter={value => [`${Number(value)} / 20`, 'Score']}
            contentStyle={{
              backgroundColor: getTokenColor('--color-surface'),
              borderRadius: '1rem',
              border: `1px solid ${getTokenColor('--color-border')}`,
            }}
          />
          <Line
            type="monotone"
            dataKey="score"
            stroke={getTokenColor('--color-chart-blue')}
            strokeWidth={3}
            dot={{ r: 4 }}
          />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
}
```

Note: Include `useThemeContext()` in ScoreTrendChart so it re-renders on theme change. The parent InterviewResults also calls it, but since ScoreTrendChart is dynamically loaded and calls `getTokenColor()` directly, it needs its own subscription.

**2. Update `src/components/interview/InterviewResults.tsx`:**

a. Remove the static recharts imports (lines 6-14):
```typescript
// DELETE these lines:
import {
  ResponsiveContainer,
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
} from 'recharts';
```

b. Remove the static Confetti import (line 29):
```typescript
// DELETE this line:
import { Confetti } from '@/components/celebrations/Confetti';
```

c. Add `next/dynamic` import at the top (after other imports):
```typescript
import dynamic from 'next/dynamic';
```

d. Add dynamic import declarations (after the other imports, before the component-level constants):
```typescript
const ScoreTrendChart = dynamic(
  () => import('./ScoreTrendChart').then(m => m.ScoreTrendChart),
  { ssr: false, loading: () => null }
);

const Confetti = dynamic(
  () => import('@/components/celebrations/Confetti').then(m => m.Confetti),
  { ssr: false, loading: () => null }
);
```

e. Replace the inline recharts chart JSX (approximately lines 736-786) with the extracted component.

Find the section that looks like:
```typescript
<Card className="bg-slate-800/50 border-slate-700/50 p-4" elevated={false}>
  <div className="h-48 w-full">
    <ResponsiveContainer>
      <LineChart data={trendData} ...>
        ...
      </LineChart>
    </ResponsiveContainer>
  </div>
</Card>
```

Replace the inner `<div className="h-48 w-full">` and everything inside it with:
```typescript
<Card className="bg-slate-800/50 border-slate-700/50 p-4" elevated={false}>
  <ScoreTrendChart data={trendData} />
</Card>
```

f. The `<Confetti>` usage on line 473 remains unchanged -- it already uses the same `Confetti` name, so the dynamic import is a drop-in replacement:
```typescript
<Confetti fire={showConfetti} intensity="celebration" onComplete={handleConfettiComplete} />
```

g. Since ScoreTrendChart now has its own `useThemeContext()`, you can leave the existing `useThemeContext()` call in InterviewResults (it's also used for other theme-dependent rendering).
  </action>
  <verify>
    <automated>pnpm typecheck && pnpm lint</automated>
    No type errors. No lint errors. ScoreTrendChart created. InterviewResults no longer has static recharts/Confetti imports.
  </verify>
  <done>ScoreTrendChart extracted with all recharts usage. InterviewResults uses dynamic imports for both ScoreTrendChart and Confetti. Null fallback used for both (no spinners).</done>
</task>

<task type="auto">
  <name>Task 2: Add recharts to optimizePackageImports and verify build</name>
  <files>next.config.mjs</files>
  <action>
**1. Update `next.config.mjs`:**

Change line 18 from:
```javascript
optimizePackageImports: ['lucide-react'],
```

To:
```javascript
optimizePackageImports: ['lucide-react', 'recharts'],
```

This tells Next.js to automatically transform barrel imports from recharts into direct file imports, improving tree-shaking even for the dynamically imported ScoreTrendChart.

**2. Run full build pipeline:**

```bash
pnpm lint
pnpm lint:css
pnpm format:check
pnpm typecheck
pnpm test
pnpm build --webpack
```

Fix any issues that arise. Common potential issues:
- Formatter may complain about new file style -- run `pnpm format:write` if needed
- Lint may flag unused imports in InterviewResults after removing recharts -- verify all removed

**3. Verify dynamic imports work correctly:**

After successful build, check the build output for route sizes. The `/interview` route's "First Load JS" should be noticeably smaller since recharts is no longer in its initial chunk.

Note the build output route table -- it will be needed in Plan 02 for the "after" comparison.
  </action>
  <verify>
    <automated>pnpm lint && pnpm typecheck && pnpm test && pnpm build --webpack</automated>
    Full pipeline passes. Build succeeds with recharts in optimizePackageImports.
  </verify>
  <done>next.config.mjs updated with recharts in optimizePackageImports. Full build pipeline (lint, typecheck, test, build) passes clean.</done>
</task>

</tasks>

<verification>
- `pnpm build --webpack` succeeds
- `pnpm typecheck` passes -- no type errors
- `pnpm lint` clean
- `pnpm test` passes -- no regressions
- InterviewResults.tsx has `import dynamic from 'next/dynamic'` and no static recharts/Confetti imports
- ScoreTrendChart.tsx exists and contains all recharts imports
- next.config.mjs has `optimizePackageImports: ['lucide-react', 'recharts']`
</verification>

<success_criteria>
- Recharts and Confetti are no longer in InterviewResults' initial bundle (verified by dynamic import pattern)
- ScoreTrendChart component extracted and dynamically imported
- optimizePackageImports includes recharts
- Full build pipeline passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/47-performance-optimization/47-01-SUMMARY.md`
</output>
