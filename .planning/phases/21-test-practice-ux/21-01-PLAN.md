---
phase: 21-test-practice-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/quiz/quizTypes.ts
  - src/lib/quiz/quizReducer.ts
  - src/lib/haptics.ts
  - src/lib/audio/soundEffects.ts
autonomous: true

must_haves:
  truths:
    - "Quiz state machine prevents invalid state combinations (no feedback+answering overlap)"
    - "Haptic feedback fires on Android and gracefully no-ops on iOS"
    - "New sound effects (skip, streak, panel reveal) play in event handlers"
  artifacts:
    - path: "src/lib/quiz/quizTypes.ts"
      provides: "QuizPhase enum, QuizState, QuizAction, QuizConfig types"
      contains: "QuizPhase"
    - path: "src/lib/quiz/quizReducer.ts"
      provides: "Quiz state machine reducer with all transitions"
      exports: ["quizReducer", "initialQuizState"]
    - path: "src/lib/haptics.ts"
      provides: "Vibration API wrappers with iOS fallback"
      exports: ["hapticLight", "hapticDouble", "hapticMedium"]
    - path: "src/lib/audio/soundEffects.ts"
      provides: "Extended sound effects with skip, streak, panel reveal sounds"
      exports: ["playSkip", "playStreak", "playPanelReveal"]
  key_links:
    - from: "src/lib/quiz/quizReducer.ts"
      to: "src/lib/quiz/quizTypes.ts"
      via: "imports types"
      pattern: "import.*quizTypes"
---

<objective>
Create the foundational quiz state machine, haptic feedback utility, and extended sound effects that all subsequent quiz/test/practice plans depend on.

Purpose: Replace scattered boolean state management with a single state machine, add haptic and audio feedback primitives.
Output: Quiz state machine types + reducer, haptics.ts utility, extended soundEffects.ts
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-test-practice-ux/21-CONTEXT.md
@.planning/phases/21-test-practice-ux/21-RESEARCH.md

@src/types/index.ts
@src/lib/audio/soundEffects.ts
@src/lib/motion-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Quiz state machine types and reducer</name>
  <files>src/lib/quiz/quizTypes.ts, src/lib/quiz/quizReducer.ts</files>
  <action>
Create `src/lib/quiz/quizTypes.ts`:

```typescript
type QuizPhase =
  | 'answering'      // User selecting an answer
  | 'checked'        // Check pressed, showing delay (200-300ms)
  | 'feedback'       // Feedback panel visible, waiting for Continue
  | 'transitioning'  // Slide-left animation to next question
  | 'skipped-review' // Reviewing skipped questions (Practice only)
  | 'finished';      // All questions answered, show results

type QuizMode = 'mock-test' | 'practice';

interface QuizState {
  phase: QuizPhase;
  mode: QuizMode;
  currentIndex: number;
  selectedAnswer: Answer | null;
  results: QuestionResult[];
  skippedIndices: number[];
  streakCount: number;
  isCorrect: boolean | null;  // null = not yet checked
  questionCount: number;
  reviewingSkippedIndex: number;  // index into skippedIndices during review phase
}

type QuizAction =
  | { type: 'SELECT_ANSWER'; answer: Answer }
  | { type: 'DESELECT_ANSWER' }
  | { type: 'CHECK' }
  | { type: 'SHOW_FEEDBACK'; result: QuestionResult; isCorrect: boolean }
  | { type: 'CONTINUE' }
  | { type: 'SKIP' }
  | { type: 'TRANSITION_COMPLETE' }
  | { type: 'START_SKIPPED_REVIEW' }
  | { type: 'FINISH' };

interface QuizConfig {
  mode: QuizMode;
  questionCount: number;
  passThreshold?: number;       // Mock test: 12
  failThreshold?: number;       // Mock test: 9 incorrect
  allowSkipReview?: boolean;    // Practice only
  allowSegmentTap?: boolean;    // Practice only
  showLiveScore?: boolean;      // Practice only
  showExplanation?: boolean;    // Practice only (not mock test)
}
```

Create `src/lib/quiz/quizReducer.ts`:

Implement a pure reducer function `quizReducer(state: QuizState, action: QuizAction): QuizState` with these transitions:
- `SELECT_ANSWER` (only in 'answering'): sets selectedAnswer, preserves phase
- `DESELECT_ANSWER` (only in 'answering'): clears selectedAnswer
- `CHECK` (only in 'answering' with selectedAnswer !== null): transitions to 'checked'
- `SHOW_FEEDBACK`: transitions from 'checked' to 'feedback', records result, updates streakCount (increment if correct, reset to 0 if incorrect), checks pass/fail thresholds for mock-test
- `CONTINUE`: from 'feedback' -> 'transitioning', clears selectedAnswer/isCorrect
- `SKIP`: from 'answering' -> 'transitioning', adds currentIndex to skippedIndices
- `TRANSITION_COMPLETE`: from 'transitioning', increments currentIndex, transitions to 'answering'. If at end of questions and mode is practice with skipped, check if should start skipped-review
- `START_SKIPPED_REVIEW`: enters 'skipped-review' phase
- `FINISH`: transitions to 'finished'

Also export `initialQuizState(config: QuizConfig): QuizState` factory function and `createQuizConfig(mode, questionCount): QuizConfig` helper.

Guard every transition: if action type doesn't match current phase, return state unchanged (no-op). This prevents race conditions per user decision.

Use `const x: Type = ...` pattern (not `useMemo<Type>`) per React Compiler rules.
  </action>
  <verify>Run `npx tsc --noEmit` -- types compile. Manually review reducer has guards on every action handler.</verify>
  <done>Quiz state machine reducer handles all transitions with phase guards, preventing invalid state combinations. Types exported for downstream consumers.</done>
</task>

<task type="auto">
  <name>Task 2: Haptic feedback utility and sound effects extensions</name>
  <files>src/lib/haptics.ts, src/lib/audio/soundEffects.ts</files>
  <action>
Create `src/lib/haptics.ts` per locked decision (Vibration API with iOS no-op):

```typescript
const supportsVibration = typeof navigator !== 'undefined' && 'vibrate' in navigator;

export function hapticLight(): void {
  if (!supportsVibration) return;
  try { navigator.vibrate(10); } catch { /* silently ignore */ }
}

export function hapticDouble(): void {
  if (!supportsVibration) return;
  try { navigator.vibrate([10, 50, 10]); } catch { /* silently ignore */ }
}

export function hapticMedium(): void {
  if (!supportsVibration) return;
  try { navigator.vibrate(20); } catch { /* silently ignore */ }
}
```

Extend `src/lib/audio/soundEffects.ts` with 3 new exports (keep existing code intact):

1. `playSkip()` - Short 500Hz triangle wave, 100ms. Called when user taps Skip.
2. `playStreak()` - Ascending 3-note triangle wave (E5->G5->C6). Called on streak milestones.
3. `playPanelReveal()` - Quick frequency sweep 200->600Hz sine, 120ms. Called when feedback panel slides up.

Follow the exact same pattern as existing functions: check `isSoundMuted()`, get context with `getContext()`, silently catch errors.

Also add `playCompletionSparkle()` - Short sparkly high-frequency burst for progress bar completion animation. Sine wave 2000Hz with quick decay.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Run `npm run lint` -- no lint errors. Verify haptics.ts exports 3 functions and soundEffects.ts has all new exports.</verify>
  <done>Haptics utility provides Android vibration with iOS no-op. Sound effects module extended with skip, streak, panel reveal, and completion sounds.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run lint` passes
- All new files import/export correctly
- QuizReducer handles all 9 action types with phase guards
- Haptics feature-detects vibration API
- Sound effects follow existing pattern (mute check, lazy AudioContext, silent catch)
</verification>

<success_criteria>
- Quiz state machine types and reducer exist and compile
- Haptics utility exists with 3 exported functions
- Sound effects extended with 4 new sounds
- All new code follows existing codebase patterns (no new dependencies needed)
</success_criteria>

<output>
After completion, create `.planning/phases/21-test-practice-ux/21-01-SUMMARY.md`
</output>
