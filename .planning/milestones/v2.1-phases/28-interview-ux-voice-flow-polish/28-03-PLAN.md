---
phase: 28-interview-ux-voice-flow-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useInterviewGuard.ts
  - src/hooks/useOrientationLock.ts
  - src/hooks/useVisibilityPause.ts
autonomous: true
requirements: [IVPOL-07, IVPOL-08, IVPOL-09]
must_haves:
  truths:
    - "Browser back button during interview shows confirmation dialog instead of navigating"
    - "Screen locks to portrait on supporting browsers during interview"
    - "Interview auto-pauses when tab/app loses focus and resumes when focus returns"
  artifacts:
    - path: "src/hooks/useInterviewGuard.ts"
      provides: "Back navigation interception hook"
      exports: ["useInterviewGuard"]
    - path: "src/hooks/useOrientationLock.ts"
      provides: "Portrait orientation lock hook"
      exports: ["useOrientationLock"]
    - path: "src/hooks/useVisibilityPause.ts"
      provides: "Auto-pause on tab background hook"
      exports: ["useVisibilityPause"]
  key_links:
    - from: "src/hooks/useInterviewGuard.ts"
      to: "window.history"
      via: "pushState + popstate listener"
      pattern: "history\\.pushState|popstate"
    - from: "src/hooks/useOrientationLock.ts"
      to: "screen.orientation"
      via: "Screen Orientation API with try/catch fallback"
      pattern: "screen\\.orientation"
    - from: "src/hooks/useVisibilityPause.ts"
      to: "document"
      via: "visibilitychange event listener"
      pattern: "visibilitychange"
---

<objective>
Create reusable hooks for mobile/browser edge case handling during interviews.

Purpose: Prevent accidental interview exits, handle orientation changes, and manage audio focus loss -- all critical for the mobile interview experience.

Output: Three focused hooks for interview session protection
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/components/interview/InterviewSession.tsx
@src/pages/InterviewPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useInterviewGuard hook</name>
  <files>src/hooks/useInterviewGuard.ts</files>
  <action>
Create `src/hooks/useInterviewGuard.ts`:

Parameters:
- `active: boolean` -- whether the guard is active (true during interview session)
- `onBackAttempt: () => void` -- called when user presses back (show exit confirmation)

Implementation:
1. On mount (when active=true): push a dummy history state with `{ interviewGuard: true }` marker
2. Listen for `popstate` event
3. When popstate fires: check if the popped state does NOT have our `interviewGuard` marker
4. If no marker (user pressed back): call `onBackAttempt()` and re-push the guard state
5. On unmount or when active becomes false: remove listener. Clean up dummy history entry by calling `history.back()` if guard state is still on the stack
6. Also add `beforeunload` listener that warns on page close/refresh (shows browser default "Leave site?" dialog)
7. Use `useEffect` with `active` dependency -- only setup when active is true

IMPORTANT: Hash routing uses `popstate` for normal navigation. The guard must check the state object to distinguish back press from hash navigation. Only intercept when our marker state is missing.
  </action>
  <verify>TypeScript compiles. Hook signature matches expected usage.</verify>
  <done>useInterviewGuard intercepts back navigation with confirmation callback, works with hash routing</done>
</task>

<task type="auto">
  <name>Task 2: Create useOrientationLock hook</name>
  <files>src/hooks/useOrientationLock.ts</files>
  <action>
Create `src/hooks/useOrientationLock.ts`:

Parameters:
- `active: boolean` -- whether orientation lock is active

Returns:
- `{ locked: boolean; supported: boolean }` -- whether lock succeeded and whether API is available

Implementation:
1. On mount (when active=true): try `screen.orientation.lock('portrait')`
2. Wrap in try/catch -- Safari throws, some Android WebViews throw
3. Set `locked` state based on success/failure
4. Check `supported` by testing `'lock' in screen.orientation`
5. On unmount or active=false: call `screen.orientation.unlock()` in try/catch
6. Use `useState` for locked/supported (not useRef, since affects render for landscape overlay)

If lock fails (Safari), the consuming component should show a CSS-based landscape overlay: "Please rotate your device to portrait" message. The hook returns `{ locked: false, supported: false }` so the component knows to render the overlay.
  </action>
  <verify>TypeScript compiles. Hook handles unsupported browsers without throwing.</verify>
  <done>useOrientationLock attempts portrait lock and reports success/support status for fallback UI</done>
</task>

<task type="auto">
  <name>Task 3: Create useVisibilityPause hook</name>
  <files>src/hooks/useVisibilityPause.ts</files>
  <action>
Create `src/hooks/useVisibilityPause.ts`:

Parameters:
- `active: boolean` -- whether visibility monitoring is active
- `onHidden: () => void` -- called when tab becomes hidden (pause audio, timer)
- `onVisible: () => void` -- called when tab becomes visible again (resume)

Implementation:
1. Listen for `document.visibilitychange` event when active is true
2. When `document.hidden` becomes true: call `onHidden()`
3. When `document.hidden` becomes false: call `onVisible()`
4. Cleanup listener on unmount or when active becomes false
5. Use `useEffect` with `[active, onHidden, onVisible]` dependencies
6. Wrap callbacks in `useCallback` check -- if consumer provides stable refs via useCallback, this avoids unnecessary re-subscriptions

Note: The consuming InterviewSession will use onHidden to pause the audioPlayer and timer, and onVisible to show a brief "Resuming..." toast before continuing.
  </action>
  <verify>TypeScript compiles. Hook properly subscribes/unsubscribes on active changes.</verify>
  <done>useVisibilityPause notifies consumer on tab visibility changes for auto-pause/resume</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- No new lint errors
- Hooks follow React Compiler safety rules (no ref.current during render)
</verification>

<success_criteria>
- useInterviewGuard intercepts back navigation without interfering with hash routing
- useOrientationLock attempts portrait lock with graceful Safari fallback
- useVisibilityPause detects tab backgrounding for audio pause/resume
- All hooks are clean, reusable, and correctly cleanup on unmount
</success_criteria>

<output>
After completion, create `.planning/phases/28-interview-ux-voice-flow-polish/28-03-SUMMARY.md`
</output>
