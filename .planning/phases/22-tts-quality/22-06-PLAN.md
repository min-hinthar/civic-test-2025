---
phase: 22-tts-quality
plan: 06
type: execute
wave: 3
depends_on: [22-03, 22-04]
files_modified:
  - scripts/generate-burmese-audio.py
  - scripts/export-questions.ts
  - scripts/compress-audio.sh
autonomous: false

must_haves:
  truths:
    - "Python script generates MP3 files for all 128 questions using edge-tts"
    - "Audio files follow naming convention: {questionId}-{q|a|e}.mp3"
    - "Both Nilar (female) and Thiha (male) voices are generated"
    - "Compression script reduces bitrate to 64kbps mono"
  artifacts:
    - path: "scripts/generate-burmese-audio.py"
      provides: "Edge-tts generation script for all 128 questions"
    - path: "scripts/export-questions.ts"
      provides: "TypeScript script to export question text to JSON for Python consumption"
    - path: "scripts/compress-audio.sh"
      provides: "ffmpeg compression script for bitrate reduction"
  key_links:
    - from: "scripts/generate-burmese-audio.py"
      to: "public/audio/my-MM/"
      via: "writes MP3 files to voice directories"
      pattern: "public/audio/my-MM"
---

<objective>
Create the Burmese audio generation pipeline: a TypeScript script to export question text to JSON, a Python script to generate MP3 files via edge-tts for both voices, and a shell script to compress audio to 64kbps mono. Then run the pipeline to generate all audio files.

Purpose: Produces the actual MP3 files for TTS-06 (Burmese audio for all 128 questions). This is a one-time generation that gets committed to the repo.
Output: Generation scripts + 768 MP3 files in public/audio/my-MM/.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-tts-quality/22-RESEARCH.md

@src/constants/questions/index.ts
@src/constants/questions/uscis-2025-additions.ts (now has explanations from 22-03)
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create question export script and edge-tts generation script</name>
  <files>scripts/export-questions.ts, scripts/generate-burmese-audio.py</files>
  <action>
**Question export script** (`scripts/export-questions.ts`):
Create a Node/TypeScript script (can be run with `npx tsx`) that:
1. Imports all questions from `src/constants/questions/index.ts`
2. Exports a JSON file (`scripts/questions-export.json`) with the structure:
```json
[
  {
    "id": "GOV-P01",
    "question_my": "...",
    "studyAnswers": [{ "text_my": "..." }, ...],
    "explanation": { "brief_my": "..." }
  },
  ...
]
```
3. Only includes Burmese text fields (question_my, studyAnswer text_my, explanation brief_my)
4. For answer text, join all studyAnswer text_my values with "·Åã " (Burmese period + space) into a single string
5. Run: `npx tsx scripts/export-questions.ts`

**Edge-tts generation script** (`scripts/generate-burmese-audio.py`):
```python
#!/usr/bin/env python3
"""Generate Burmese audio files for all 128 civics questions.

Usage:
  pip install edge-tts
  python scripts/generate-burmese-audio.py

Generates:
  public/audio/my-MM/female/{id}-{q|a|e}.mp3  (Nilar)
  public/audio/my-MM/male/{id}-{q|a|e}.mp3    (Thiha)
"""
import asyncio
import json
import os
import sys

try:
    import edge_tts
except ImportError:
    print("Install edge-tts: pip install edge-tts")
    sys.exit(1)

VOICES = {
    'female': 'my-MM-NilarNeural',
    'male': 'my-MM-ThihaNeural',
}

OUTPUT_DIR = 'public/audio/my-MM'
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
QUESTIONS_FILE = os.path.join(SCRIPT_DIR, 'questions-export.json')

async def generate(text: str, voice: str, output_path: str):
    """Generate a single audio file."""
    if not text or not text.strip():
        print(f"  SKIP (empty text): {output_path}")
        return
    communicate = edge_tts.Communicate(text, voice, rate='+0%')
    await communicate.save(output_path)
    size_kb = os.path.getsize(output_path) / 1024
    print(f"  OK ({size_kb:.1f}KB): {output_path}")

async def main():
    if not os.path.exists(QUESTIONS_FILE):
        print(f"Error: {QUESTIONS_FILE} not found. Run: npx tsx scripts/export-questions.ts")
        sys.exit(1)

    with open(QUESTIONS_FILE, 'r', encoding='utf-8') as f:
        questions = json.load(f)

    print(f"Loaded {len(questions)} questions")
    total_files = 0
    skipped = 0

    for gender, voice_name in VOICES.items():
        out_dir = os.path.join(OUTPUT_DIR, gender)
        os.makedirs(out_dir, exist_ok=True)
        print(f"\n=== Generating {gender} voice ({voice_name}) ===")

        for i, q in enumerate(questions):
            qid = q['id']
            print(f"\n[{i+1}/{len(questions)}] {qid}")

            # Question audio
            q_path = os.path.join(out_dir, f'{qid}-q.mp3')
            if not os.path.exists(q_path):
                await generate(q['question_my'], voice_name, q_path)
                total_files += 1
            else:
                print(f"  EXISTS: {q_path}")

            # Answer audio (joined study answers)
            a_path = os.path.join(out_dir, f'{qid}-a.mp3')
            if not os.path.exists(a_path):
                answer_text = q.get('answer_my', '')
                if answer_text:
                    await generate(answer_text, voice_name, a_path)
                    total_files += 1
                else:
                    skipped += 1
            else:
                print(f"  EXISTS: {a_path}")

            # Explanation audio
            e_path = os.path.join(out_dir, f'{qid}-e.mp3')
            if not os.path.exists(e_path):
                explanation_my = q.get('explanation_my', '')
                if explanation_my:
                    await generate(explanation_my, voice_name, e_path)
                    total_files += 1
                else:
                    print(f"  SKIP (no explanation): {e_path}")
                    skipped += 1
            else:
                print(f"  EXISTS: {e_path}")

    print(f"\n=== Done: {total_files} files generated, {skipped} skipped ===")

if __name__ == '__main__':
    asyncio.run(main())
```

Key features:
- Skips already-generated files (idempotent re-runs)
- Progress logging with file sizes
- Handles missing explanation text gracefully
- Uses `+0%` rate for natural speech speed
  </action>
  <verify>
`npx tsx scripts/export-questions.ts` produces `scripts/questions-export.json` with 128 entries.
`python scripts/generate-burmese-audio.py --help` (or `python -c "import edge_tts"`) confirms edge-tts is available.
  </verify>
  <done>
Export script produces JSON with all 128 questions' Burmese text. Python generation script is ready to run with edge-tts. Scripts are idempotent (skip existing files).
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Generate Burmese audio files</name>
  <action>
The user needs to run the audio generation pipeline. This requires:
1. Python 3 installed
2. `pip install edge-tts` (requires internet)
3. ffmpeg installed (for compression)
  </action>
  <instructions>
**Step 1: Export question text**
```bash
npx tsx scripts/export-questions.ts
```
Verify: `scripts/questions-export.json` has 128 entries.

**Step 2: Generate audio (requires internet)**
```bash
pip install edge-tts
python scripts/generate-burmese-audio.py
```
This generates ~768 MP3 files in `public/audio/my-MM/`. Takes 5-15 minutes depending on network speed.

**Step 3: Compress audio (optional, reduces size ~50%)**
If ffmpeg is available:
```bash
bash scripts/compress-audio.sh
```
This converts all MP3s to 64kbps mono. Without this step, files are ~48kHz/192kbps (larger but still functional).

**Step 4: Verify**
- `ls public/audio/my-MM/female/ | wc -l` should be ~384 (128 x 3)
- `ls public/audio/my-MM/male/ | wc -l` should be ~384
- Spot check: play `public/audio/my-MM/female/GOV-P01-q.mp3` -- should be clear Burmese speech

**Step 5: Commit**
```bash
git add public/audio/
git commit -m "feat(22-06): add pre-generated Burmese audio for 128 questions"
```

If you don't have Python/edge-tts/ffmpeg, skip this step and the audio will be generated later.
  </instructions>
  <resume-signal>Type "audio generated" once files are committed, or "skip audio" to continue without</resume-signal>
</task>

</tasks>

<verification>
1. `scripts/export-questions.ts` runs and produces valid JSON
2. `scripts/generate-burmese-audio.py` generates MP3 files in correct directory structure
3. Audio files follow naming convention: `{id}-{q|a|e}.mp3`
4. Both female/ and male/ directories have files
5. Files play as clear Burmese speech
</verification>

<success_criteria>
- Question export produces 128-entry JSON
- Python script generates MP3s for both Nilar and Thiha voices
- File naming follows convention: `{questionId}-{type}.mp3`
- Directory structure: `public/audio/my-MM/{female,male}/`
- Scripts are idempotent and handle missing data gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/22-tts-quality/22-06-SUMMARY.md`
</output>
