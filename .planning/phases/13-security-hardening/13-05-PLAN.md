---
phase: 13-security-hardening
plan: 05
type: execute
wave: 2
depends_on: [13-01, 13-02, 13-03, 13-04]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Build succeeds with all security changes applied"
    - "All existing tests pass"
    - "CSP headers are present in dev server responses"
    - "Push subscription flow works end-to-end with JWT auth"
    - "Google Sign-In is not blocked by CSP"
  artifacts: []
  key_links: []
---

<objective>
Verify that all Phase 13 security hardening changes work together without breaking existing functionality. Run build, tests, and manual spot-checks.

Purpose: Security hardening touches middleware (CSP), API routes (push auth), database schema (RLS), and dependency tree (Next.js upgrade). Each was implemented independently in Wave 1 -- this plan verifies they compose correctly.

Output: Verified working system, confidence that no regressions were introduced.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-security-hardening/13-01-SUMMARY.md
@.planning/phases/13-security-hardening/13-02-SUMMARY.md
@.planning/phases/13-security-hardening/13-03-SUMMARY.md
@.planning/phases/13-security-hardening/13-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full verification suite</name>
  <files></files>
  <action>
Run the complete verification suite to ensure all Phase 13 changes compose correctly:

```bash
# 1. TypeScript compilation
pnpm run typecheck

# 2. Linting
pnpm run lint

# 3. Format check
pnpm run format:check

# 4. Build (most comprehensive -- catches middleware + config issues)
pnpm run build

# 5. All tests
pnpm run test:run

# 6. Security audit
pnpm audit --audit-level=high
```

If any step fails, diagnose and fix the issue. Common integration failures:
- Middleware.ts import errors (edge runtime restrictions -- no Node.js APIs like `fs`)
- CSP header too long (some CDNs/proxies truncate headers > 4KB)
- Next.js upgrade breaking type signatures (check release notes)
- Sentry SDK incompatibility with new Next.js version

After all pass, verify key security artifacts exist:
```bash
# Verify middleware exists
ls middleware.ts

# Verify dependabot config exists
ls .github/dependabot.yml

# Verify RLS audit exists
ls .planning/security/rls-audit.md

# Verify push_subscriptions in schema
grep "push_subscriptions" supabase/schema.sql
```
  </action>
  <verify>
All 6 commands exit with code 0. All 4 artifacts exist.
  </verify>
  <done>
- typecheck, lint, format, build, test, and audit all pass
- middleware.ts, dependabot.yml, rls-audit.md all exist
- push_subscriptions defined in schema.sql
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 13 Security Hardening -- all 4 security domains implemented:
1. Push subscribe API now requires JWT authentication with rate limiting
2. Content Security Policy headers active on all pages with nonce-based script protection
3. Supabase RLS audit complete with push_subscriptions table added to schema.sql
4. Next.js upgraded, unused deps pruned, Dependabot + CI audit configured
  </what-built>
  <how-to-verify>
1. **Start dev server:** `pnpm run dev` and open http://localhost:3000

2. **CSP Headers:** Open browser DevTools > Network tab. Load any page. Click the document request and check Response Headers:
   - Should see `Content-Security-Policy` header with nonce-based script-src
   - Should see `X-Content-Type-Options: nosniff`
   - Should see `X-Frame-Options: DENY`

3. **Google Sign-In:** Navigate to the auth/sign-in page.
   - Google One Tap popup should appear (if you have a Google account in the browser)
   - Google Sign-In button should be visible and functional
   - No CSP errors in DevTools console related to accounts.google.com

4. **Theme Script:** Toggle between light and dark mode.
   - No flash of unstyled content on page reload
   - No CSP violation errors in console about inline scripts

5. **General Functionality:** Navigate around the app:
   - Dashboard loads correctly
   - Study guide works
   - No broken images, fonts, or scripts
   - No CSP violation errors in DevTools console

6. **Console Check:** In DevTools console, filter for "CSP" or "Content Security Policy" errors. There should be none from legitimate app functionality.

NOTE: Push notification JWT verification cannot be easily tested in dev without a full Supabase auth session + VAPID key setup. The automated tests + typecheck verify the code paths.
  </how-to-verify>
  <resume-signal>Type "approved" if everything works, or describe any issues you see.</resume-signal>
</task>

</tasks>

<verification>
1. All automated checks pass (typecheck, lint, format, build, test, audit)
2. Dev server starts without errors
3. CSP headers visible in browser DevTools
4. No CSP violation errors in browser console
5. Google Sign-In functional
6. Theme toggle works without FOUC
</verification>

<success_criteria>
- Full CI-equivalent test suite passes
- CSP headers confirmed in browser
- No CSP violations from legitimate app functionality
- User confirms visual/functional verification
</success_criteria>

<output>
After completion, create `.planning/phases/13-security-hardening/13-05-SUMMARY.md`
</output>
