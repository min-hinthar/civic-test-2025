---
phase: 01-foundation-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.ts
  - src/__tests__/setup.ts
  - package.json
  - .github/workflows/ci.yml
  - .husky/pre-commit
  - .lintstagedrc.json
  - .prettierrc
  - .prettierignore
  - eslint.config.mjs
autonomous: true

must_haves:
  truths:
    - "Developer runs `npm test` and Vitest executes successfully"
    - "Developer runs `npm run lint` and ESLint passes"
    - "Developer commits code and pre-commit hooks run lint + typecheck"
    - "GitHub Actions CI runs tests on push/PR"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest test runner configuration"
      contains: "defineConfig"
    - path: "src/__tests__/setup.ts"
      provides: "Test setup with jsdom and testing-library"
      contains: "setupFiles"
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline for tests and linting"
      contains: "vitest"
    - path: ".husky/pre-commit"
      provides: "Pre-commit hook for lint-staged"
      contains: "lint-staged"
  key_links:
    - from: "package.json"
      to: "vitest.config.ts"
      via: "npm test script"
      pattern: "vitest"
    - from: ".husky/pre-commit"
      to: ".lintstagedrc.json"
      via: "lint-staged execution"
      pattern: "lint-staged"
---

<objective>
Set up testing infrastructure with Vitest and establish CI pipeline with code quality enforcement.

Purpose: Creates the foundation for all subsequent testing work. Without a test runner, we cannot write regression tests for bug fixes. Without CI, we cannot enforce code quality on every commit.

Output: Working Vitest configuration, GitHub Actions CI pipeline, Husky pre-commit hooks with lint-staged, ESLint flat config migration, Prettier configuration.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-code-quality/01-RESEARCH.md
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install testing and code quality dependencies</name>
  <files>package.json</files>
  <action>
Install all testing and code quality dependencies in a single npm install command:

**Testing dependencies (devDependencies):**
- vitest ^3.x
- @vitejs/plugin-react ^4.x
- @testing-library/react ^16.x
- @testing-library/dom ^10.x
- @testing-library/user-event ^14.x
- vite-tsconfig-paths ^5.x
- jsdom ^26.x
- @vitest/coverage-v8 ^3.x

**Code quality dependencies (devDependencies):**
- husky ^9.x
- lint-staged ^15.x
- prettier ^3.x
- eslint-config-prettier ^10.x
- @typescript-eslint/parser ^8.x
- @typescript-eslint/eslint-plugin ^8.x

**Runtime dependency:**
- async-mutex ^0.5.x (for bug fix in Plan 02)

Add npm scripts to package.json:
- "test": "vitest"
- "test:run": "vitest run"
- "test:coverage": "vitest run --coverage"
- "typecheck": "tsc --noEmit"
- "format": "prettier --write ."
- "format:check": "prettier --check ."
- "prepare": "husky"

Run: `npm install -D vitest @vitejs/plugin-react @testing-library/react @testing-library/dom @testing-library/user-event vite-tsconfig-paths jsdom @vitest/coverage-v8 husky lint-staged prettier eslint-config-prettier @typescript-eslint/parser @typescript-eslint/eslint-plugin && npm install async-mutex`
  </action>
  <verify>
Run `npm test -- --version` shows Vitest version.
Run `npx prettier --version` shows Prettier version.
Run `npx husky --version` shows Husky version.
  </verify>
  <done>All dependencies installed, npm scripts added to package.json</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vitest and test setup</name>
  <files>vitest.config.ts, src/__tests__/setup.ts</files>
  <action>
Create vitest.config.ts at project root:

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import tsconfigPaths from 'vite-tsconfig-paths';

export default defineConfig({
  plugins: [tsconfigPaths(), react()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: ['./src/__tests__/setup.ts'],
    include: ['src/**/*.{test,spec}.{ts,tsx}'],
    exclude: ['node_modules', '.next', 'dist'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'json-summary', 'html'],
      include: ['src/**/*.{ts,tsx}'],
      exclude: [
        'src/**/*.test.{ts,tsx}',
        'src/**/*.spec.{ts,tsx}',
        'src/types/**',
        'src/__tests__/**',
      ],
      thresholds: {
        lines: 70,
        functions: 70,
        branches: 70,
        statements: 70,
      },
    },
  },
});
```

Create src/__tests__/setup.ts:

```typescript
import '@testing-library/jest-dom/vitest';
import { cleanup } from '@testing-library/react';
import { afterEach, vi } from 'vitest';

// Cleanup after each test
afterEach(() => {
  cleanup();
});

// Mock window.matchMedia for components using media queries
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation((query: string) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});

// Mock speechSynthesis for TTS tests
Object.defineProperty(window, 'speechSynthesis', {
  writable: true,
  value: {
    speak: vi.fn(),
    cancel: vi.fn(),
    pause: vi.fn(),
    resume: vi.fn(),
    getVoices: vi.fn().mockReturnValue([]),
    onvoiceschanged: null,
    paused: false,
    pending: false,
    speaking: false,
  },
});
```

Also install @testing-library/jest-dom: `npm install -D @testing-library/jest-dom`
  </action>
  <verify>
Create a minimal test file src/__tests__/smoke.test.ts:
```typescript
import { describe, it, expect } from 'vitest';

describe('Vitest setup', () => {
  it('runs tests successfully', () => {
    expect(1 + 1).toBe(2);
  });
});
```

Run `npm test -- --run` and verify test passes.
Delete the smoke test file after verification.
  </verify>
  <done>Vitest configured with jsdom, React plugin, coverage thresholds (70%), and test setup file with common mocks</done>
</task>

<task type="auto">
  <name>Task 3: Configure ESLint flat config, Prettier, Husky, and GitHub Actions CI</name>
  <files>eslint.config.mjs, .prettierrc, .prettierignore, .husky/pre-commit, .lintstagedrc.json, .github/workflows/ci.yml</files>
  <action>
**1. Create eslint.config.mjs (ESLint 9 flat config):**

```javascript
import js from '@eslint/js';
import tseslint from '@typescript-eslint/eslint-plugin';
import tsparser from '@typescript-eslint/parser';
import reactHooks from 'eslint-plugin-react-hooks';
import next from '@next/eslint-plugin-next';
import prettier from 'eslint-config-prettier';

export default [
  js.configs.recommended,
  {
    ignores: ['.next/**', 'node_modules/**', 'dist/**', 'coverage/**'],
  },
  {
    files: ['**/*.{ts,tsx}'],
    plugins: {
      '@typescript-eslint': tseslint,
      'react-hooks': reactHooks,
      '@next/next': next,
    },
    languageOptions: {
      parser: tsparser,
      parserOptions: {
        ecmaVersion: 'latest',
        sourceType: 'module',
        ecmaFeatures: { jsx: true },
      },
    },
    rules: {
      ...tseslint.configs.recommended.rules,
      ...reactHooks.configs.recommended.rules,
      '@typescript-eslint/no-explicit-any': 'error',
      '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
      'no-console': ['warn', { allow: ['warn', 'error'] }],
    },
  },
  prettier,
];
```

Install missing eslint plugins: `npm install -D @eslint/js eslint-plugin-react-hooks`

**2. Create .prettierrc:**

```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "arrowParens": "avoid"
}
```

**3. Create .prettierignore:**

```
.next
node_modules
dist
coverage
*.md
package-lock.json
```

**4. Initialize Husky and create pre-commit hook:**

Run: `npx husky init`

Create .husky/pre-commit:
```bash
npx lint-staged
```

**5. Create .lintstagedrc.json:**

```json
{
  "*.{ts,tsx}": ["eslint --fix", "prettier --write"],
  "*.{js,mjs,json,css}": ["prettier --write"]
}
```

Note: We run `tsc --noEmit` in CI only (not in lint-staged) because TypeScript needs the full project context.

**6. Create .github/workflows/ci.yml:**

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7
```
  </action>
  <verify>
Run `npm run lint` - should pass (or show only existing issues, not config errors).
Run `npm run format:check` - should run without errors.
Run `npm run typecheck` - should pass.
Verify .husky/pre-commit exists and is executable.
Verify .github/workflows/ci.yml exists.
  </verify>
  <done>ESLint flat config, Prettier, Husky pre-commit hooks, lint-staged, and GitHub Actions CI pipeline all configured and working</done>
</task>

</tasks>

<verification>
1. `npm test -- --run` executes Vitest and passes
2. `npm run lint` runs ESLint with flat config
3. `npm run typecheck` runs TypeScript compiler check
4. `npm run format:check` verifies Prettier formatting
5. `.husky/pre-commit` file exists and contains lint-staged command
6. `.github/workflows/ci.yml` exists with test, lint, and typecheck jobs
7. Coverage thresholds set to 70% in vitest.config.ts
</verification>

<success_criteria>
- Vitest runs tests with `npm test`
- ESLint 9 flat config works with `npm run lint`
- Prettier formatting enforced with `npm run format:check`
- Pre-commit hooks run lint-staged on staged files
- GitHub Actions CI pipeline ready for test runs
- 70% coverage threshold configured (will fail until tests added in Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-code-quality/01-01-SUMMARY.md`
</output>
