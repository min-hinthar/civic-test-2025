---
phase: 39-next-js-16-upgrade-and-tooling
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - package.json
  - pnpm-lock.yaml
  - next.config.mjs
  - proxy.ts
  - middleware.ts
  - tsconfig.json
  - eslint.config.mjs
autonomous: true
requirements:
  - MIGR-01
  - MIGR-02

must_haves:
  truths:
    - "Next.js 16 is pinned at an exact version in package.json (no caret)"
    - "pnpm build succeeds using the --webpack flag"
    - "Dev server starts with Turbopack by default (next dev)"
    - "middleware.ts is renamed to proxy.ts with proxy() export function"
    - "ESLint runs via eslint . instead of next lint"
    - "Dual npm scripts exist: dev (Turbopack) and dev:webpack (webpack fallback)"
    - "All existing Vitest tests pass after the Next.js 16 upgrade"
    - "tsconfig.json follows Next.js 16 recommendations"
  artifacts:
    - path: "package.json"
      provides: "Next.js 16 pinned version, updated scripts"
      contains: "16.1.6"
    - path: "proxy.ts"
      provides: "Renamed middleware with proxy() export"
      contains: "export function proxy"
    - path: "next.config.mjs"
      provides: "Build configuration compatible with Next.js 16"
      contains: "withSentryConfig"
    - path: "tsconfig.json"
      provides: "Updated TypeScript config for Next.js 16"
      contains: "bundler"
  key_links:
    - from: "package.json"
      to: "next.config.mjs"
      via: "build scripts reference next build --webpack"
      pattern: "next build --webpack"
    - from: "proxy.ts"
      to: "next.config.mjs"
      via: "Next.js auto-detects proxy.ts at project root"
      pattern: "proxy"
    - from: "next.config.mjs"
      to: "package.json"
      via: "withSentryConfig and withSerwist require webpack"
      pattern: "withSentryConfig.*withSerwist"
---

<objective>
Upgrade Next.js to version 16, rename middleware to proxy, update build scripts and TypeScript config, and verify the build succeeds.

Purpose: This is the core upgrade task. Next.js 16 makes Turbopack default, removes `next lint`, renames middleware to proxy, and requires `--webpack` flag for builds that use webpack plugins (Sentry + Serwist).

Output: Working Next.js 16 app that builds with `--webpack`, runs dev with Turbopack, and has all tests passing.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-next-js-16-upgrade-and-tooling/39-RESEARCH.md
@.planning/phases/39-next-js-16-upgrade-and-tooling/39-01-SUMMARY.md
@package.json
@next.config.mjs
@middleware.ts
@tsconfig.json
@eslint.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade Next.js 16 and update package.json scripts</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
1. Upgrade Next.js to exact pinned version (no caret range per user decision):
   ```bash
   pnpm add next@16.1.6
   ```
   Then manually edit package.json to pin exact: `"next": "16.1.6"` (remove any `^` or `~`).

2. Ensure React is at latest alongside Next.js 16:
   ```bash
   pnpm add react@latest react-dom@latest
   pnpm add -D @types/react@latest @types/react-dom@latest
   ```

3. Update `package.json` scripts per Next.js 16 changes:
   - `"dev": "next dev"` — Turbopack is now default in Next.js 16 (no flag needed)
   - ADD `"dev:webpack": "next dev --webpack"` — webpack fallback per user decision
   - `"build": "next build --webpack"` — MUST use --webpack because Sentry and Serwist use webpack plugins
   - `"lint": "eslint ."` — `next lint` is REMOVED in Next.js 16
   - Keep all other scripts unchanged

4. If pnpm reports peer dependency issues, add overrides with TODO comments:
   ```json
   "pnpm": {
     "overrides": {
       "some-package": ">=version"
     }
   }
   ```

5. Run `pnpm install` to update lockfile.

6. Delete `.next` directory to avoid cache corruption:
   ```bash
   rm -rf .next
   ```
  </action>
  <verify>
    <automated>pnpm typecheck</automated>
    <manual>Check package.json has "next": "16.1.6" (exact, no caret)</manual>
  </verify>
  <done>Next.js 16.1.6 installed with exact pin. Scripts updated: dev (Turbopack), dev:webpack (fallback), build (--webpack), lint (eslint .). React at latest.</done>
</task>

<task type="auto">
  <name>Task 2: Rename middleware to proxy and update build config</name>
  <files>middleware.ts, proxy.ts, next.config.mjs, tsconfig.json, eslint.config.mjs</files>
  <action>
1. Run the Next.js 16 middleware-to-proxy codemod:
   ```bash
   npx @next/codemod@canary middleware-to-proxy .
   ```
   This should:
   - Rename `middleware.ts` to `proxy.ts`
   - Rename the `middleware()` function to `proxy()`
   - Keep the `config` export unchanged

   If the codemod fails or doesn't work on Windows, do it manually:
   - Rename `middleware.ts` to `proxy.ts` (git mv middleware.ts proxy.ts)
   - Change `export function middleware()` to `export function proxy()`
   - Keep all CSP logic and config export unchanged

2. Verify `middleware.ts` no longer exists and `proxy.ts` has the correct exports.

3. Update `tsconfig.json` to follow Next.js 16 recommendations:
   - Keep `"module": "esnext"` and `"moduleResolution": "bundler"` (already correct)
   - Keep `"target": "es2017"` (fine for Next.js 16)
   - Ensure `"include"` array covers root-level files like `proxy.ts`, `instrumentation.ts`, `instrumentation-client.ts`, `sentry.server.config.ts`, `sentry.edge.config.ts`
   - If Next.js 16 updated `next-env.d.ts`, ensure it's included

4. Update `next.config.mjs` if needed:
   - The wrapping pattern `withSentryConfig(analyzer(withSerwist(nextConfig)))` stays unchanged
   - If `optimizePackageImports` was moved from `experimental` in Next.js 16, update accordingly. Research says it's still fine in experimental.
   - No conversion to `next.config.ts` in this phase (anti-pattern per research)

5. Verify `eslint.config.mjs` still works with `eslint .`:
   - Run `pnpm lint` to verify the flat config works
   - If `@next/eslint-plugin-next` needs format changes for v16, update the import/config

6. Run full verification:
   ```bash
   rm -rf .next
   pnpm build
   pnpm test:run
   pnpm typecheck
   pnpm lint
   ```

7. Fix any build errors, test failures, or lint issues caused by the upgrade. Common issues:
   - Turbopack detection of webpack config: solved by --webpack flag in build script
   - ESLint config incompatibility: update @next/eslint-plugin-next import if needed
   - TypeScript errors from new Next.js types: fix as they arise
  </action>
  <verify>
    <automated>pnpm build && pnpm test:run && pnpm typecheck && pnpm lint</automated>
  </verify>
  <done>middleware.ts renamed to proxy.ts with proxy() export. Build succeeds with --webpack. All tests pass. Lint passes with eslint . command. tsconfig.json updated for Next.js 16.</done>
</task>

</tasks>

<verification>
- `proxy.ts` exists at project root with `export function proxy()` and CSP headers
- `middleware.ts` does NOT exist
- `pnpm build` (which runs `next build --webpack`) succeeds
- `pnpm test:run` passes all tests
- `pnpm typecheck` passes
- `pnpm lint` runs `eslint .` and passes
- `package.json` shows `"next": "16.1.6"` (exact, no caret)
- `package.json` has `"dev:webpack"` script
</verification>

<success_criteria>
Next.js 16 is installed and builds successfully. Middleware is renamed to proxy. Scripts are updated for Turbopack default and webpack fallback. All tests and linting pass.
</success_criteria>

<output>
After completion, create `.planning/phases/39-next-js-16-upgrade-and-tooling/39-02-SUMMARY.md`
</output>
