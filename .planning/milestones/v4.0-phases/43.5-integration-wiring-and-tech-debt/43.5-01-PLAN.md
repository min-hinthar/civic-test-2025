---
phase: 43.5-integration-wiring-and-tech-debt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(protected)/practice/page.tsx
  - src/views/PracticePage.tsx
  - src/components/practice/PracticeConfig.tsx
  - src/components/GoogleOneTapSignIn.tsx
autonomous: true
requirements: [RDNS-04, RDNS-05, MIGR-12]

must_haves:
  truths:
    - Navigating to /practice?category=american-government pre-selects "American Government" in PracticeConfig
    - Navigating to /practice?category=Presidents pre-selects "Presidents" sub-category and expands parent accordion
    - Navigating to /practice (no param) shows normal config with no pre-selection
    - Navigating to /practice?category=invalid shows normal config with no pre-selection
    - GoogleOneTapSignIn fallback redirects to /home not /dashboard
  artifacts:
    - app/(protected)/practice/page.tsx with Suspense boundary
    - src/views/PracticePage.tsx with useSearchParams
    - src/components/practice/PracticeConfig.tsx with initialCategory prop
  key_links:
    - DrillResults "Practice [Category]" button → /practice?category=X → PracticeConfig pre-selects category
    - TestResultsScreen practice button → /practice?category=X → PracticeConfig pre-selects category
    - GoogleOneTapSignIn → /home (direct, no redirect hop)
---

<objective>
Wire PracticePage ?category= search param pre-selection and fix GoogleOneTapSignIn stale redirect.

Purpose: Close 2 integration gaps and 2 flow gaps identified by the v4.0 milestone audit.
Output: PracticePage reads URL params, GoogleOneTapSignIn redirects to canonical /home route.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43.5-integration-wiring-and-tech-debt/43.5-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs -->

From src/components/practice/PracticeConfig.tsx:
```typescript
export interface PracticeConfigType {
  category: USCISCategory | Category | 'weak';
  categoryName: CategoryName;
  count: number;
  timerEnabled: boolean;
  speedOverride?: 'slow' | 'normal' | 'fast';
  autoReadOverride?: boolean;
}

interface PracticeConfigProps {
  onStart: (config: PracticeConfigType) => void;
}

// State:
const [selectedCategory, setSelectedCategory] = useState<USCISCategory | Category | 'weak' | null>(null);
const [expandedCategory, setExpandedCategory] = useState<USCISCategory | null>(null);
```

From src/lib/mastery/index.ts:
```typescript
export { USCIS_CATEGORIES, USCIS_CATEGORY_NAMES, SUB_CATEGORY_NAMES, CATEGORY_COLORS } from './categories';
export type { USCISCategory, CategoryName } from './categories';
```

From src/types/index.ts:
```typescript
type Category = string; // sub-category identifiers like "Presidents", "Geography"
```

Reference pattern — app/(protected)/drill/page.tsx:
```typescript
'use client';
import { Suspense } from 'react';
import DrillPage from '@/views/DrillPage';
export default function Drill() {
  return <Suspense><DrillPage /></Suspense>;
}
```

Reference pattern — src/views/DrillPage.tsx search param usage:
```typescript
const searchParams = useSearchParams();
const categoryParam = searchParams.get('category');
const drillMode: 'weak-all' | 'category' = categoryParam ? 'category' : 'weak-all';
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire PracticePage ?category= search param to PracticeConfig pre-selection</name>
  <files>
    app/(protected)/practice/page.tsx
    src/views/PracticePage.tsx
    src/components/practice/PracticeConfig.tsx
  </files>
  <action>
**1. Add Suspense boundary to practice page wrapper** (`app/(protected)/practice/page.tsx`):
- Import `Suspense` from `'react'`
- Wrap `<PracticePage />` in `<Suspense>` (no fallback — matches drill/page.tsx pattern)
- Keep `'use client'` directive

**2. Read search param in PracticePage** (`src/views/PracticePage.tsx`):
- Import `useSearchParams` from `'next/navigation'`
- Import `USCIS_CATEGORY_NAMES, SUB_CATEGORY_NAMES` from `'@/lib/mastery'` (add to existing mastery import)
- After existing hooks, add:
  ```typescript
  const searchParams = useSearchParams();
  const categoryParam = searchParams.get('category');
  ```
- Add a `useMemo` to validate and derive `initialCategory`:
  ```typescript
  const initialCategory = useMemo(() => {
    if (!categoryParam) return null;
    if (categoryParam in USCIS_CATEGORY_NAMES) return categoryParam as USCISCategory;
    if (categoryParam in SUB_CATEGORY_NAMES) return categoryParam as Category;
    return null;
  }, [categoryParam]);
  ```
- Pass `initialCategory` prop to `<PracticeConfig>`:
  ```typescript
  <PracticeConfig onStart={handleStart} initialCategory={initialCategory} />
  ```

**3. Accept initialCategory prop in PracticeConfig** (`src/components/practice/PracticeConfig.tsx`):
- Update `PracticeConfigProps` interface to add optional `initialCategory`:
  ```typescript
  interface PracticeConfigProps {
    onStart: (config: PracticeConfigType) => void;
    initialCategory?: USCISCategory | Category | null;
  }
  ```
- Update function signature to destructure `initialCategory`
- Initialize `selectedCategory` state from prop:
  ```typescript
  const [selectedCategory, setSelectedCategory] = useState<USCISCategory | Category | 'weak' | null>(initialCategory ?? null);
  ```
- Initialize `expandedCategory` to auto-expand parent when initial is a sub-category:
  ```typescript
  const [expandedCategory, setExpandedCategory] = useState<USCISCategory | null>(() => {
    if (!initialCategory) return null;
    // If it's a main category, expand it
    if (initialCategory in USCIS_CATEGORY_NAMES) return initialCategory as USCISCategory;
    // If sub-category, find and expand parent
    for (const [main, def] of Object.entries(USCIS_CATEGORIES)) {
      if (def.subCategories.includes(initialCategory as Category)) {
        return main as USCISCategory;
      }
    }
    return null;
  });
  ```

**IMPORTANT:** Do NOT use `useMemo<Type>()` generic syntax — incompatible with React Compiler (see project CLAUDE.md). Use `const x: Type = useMemo(...)` pattern instead.
  </action>
  <verify>
    <automated>cd /c/Users/minkk/GitHub/civic-test-2025 && npx next build 2>&1 | tail -5</automated>
    Manually verify: grep for `useSearchParams` in PracticePage.tsx, `initialCategory` in PracticeConfig.tsx, `Suspense` in practice/page.tsx
  </verify>
  <done>
    - /practice?category=american-government pre-selects "American Government" in config
    - /practice?category=Presidents pre-selects "Presidents" and expands parent accordion
    - /practice with no param shows normal config (selectedCategory = null)
    - /practice?category=bogus shows normal config (invalid param gracefully ignored)
    - Suspense boundary wraps PracticePage in page wrapper
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix GoogleOneTapSignIn stale /dashboard redirect to /home</name>
  <files>
    src/components/GoogleOneTapSignIn.tsx
  </files>
  <action>
In `src/components/GoogleOneTapSignIn.tsx`, line 76 in the `fallbackOAuthRedirect` callback:

Change:
```typescript
redirectTo: `${window.location.origin}/dashboard`,
```
To:
```typescript
redirectTo: `${window.location.origin}/home`,
```

This is a single string change. `/home` is the canonical Dashboard route since Phase 41 (App Router migration). The old `/dashboard` path creates an unnecessary redirect hop through `next.config.mjs` permanent redirect.
  </action>
  <verify>
    <automated>cd /c/Users/minkk/GitHub/civic-test-2025 && grep -n "redirectTo.*origin" src/components/GoogleOneTapSignIn.tsx</automated>
    Output should show `/home` not `/dashboard`
  </verify>
  <done>
    - GoogleOneTapSignIn fallbackOAuthRedirect targets /home directly
    - No redirect hop through /dashboard → /home chain
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. `grep -r "useSearchParams" src/views/PracticePage.tsx` returns match
3. `grep "initialCategory" src/components/practice/PracticeConfig.tsx` returns match
4. `grep "Suspense" app/\(protected\)/practice/page.tsx` returns match
5. `grep "/home" src/components/GoogleOneTapSignIn.tsx` returns match (not /dashboard)
</verification>

<success_criteria>
- PracticePage reads ?category=X and pre-selects matching category in PracticeConfig
- Sub-category params auto-expand the parent USCIS category accordion
- Invalid/missing category params gracefully fall through to normal config
- GoogleOneTapSignIn redirects to /home (no /dashboard redirect hop)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/43.5-integration-wiring-and-tech-debt/43.5-01-SUMMARY.md`
</output>
