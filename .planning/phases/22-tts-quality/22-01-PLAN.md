---
phase: 22-tts-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ttsTypes.ts
  - src/contexts/TTSContext.tsx
  - src/hooks/useTTSSettings.ts
  - src/components/ui/VoicePicker.tsx
  - src/pages/SettingsPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can select preferred TTS voice from available voices in Settings"
    - "User can set global speech rate (slow/normal/fast) in a dedicated Speech & Audio section"
    - "Settings page shows 'No voices available' message when no voices found"
    - "Selecting a voice plays a preview sample of a civics question"
  artifacts:
    - path: "src/components/ui/VoicePicker.tsx"
      provides: "Voice selection dropdown with preview"
    - path: "src/pages/SettingsPage.tsx"
      provides: "Speech & Audio settings section"
  key_links:
    - from: "src/components/ui/VoicePicker.tsx"
      to: "src/hooks/useTTS.ts"
      via: "useTTS speak() for voice preview"
      pattern: "speak.*preview"
    - from: "src/pages/SettingsPage.tsx"
      to: "src/hooks/useTTSSettings.ts"
      via: "updateSettings for voice/rate/autoRead persistence"
      pattern: "updateSettings|updateTTSSettings"
---

<objective>
Extend TTSSettings with autoRead/autoReadLang/burmeseVoice fields, create a VoicePicker component with voice preview, and add a dedicated "Speech & Audio" section to the Settings page with voice picker, speed selector, auto-read toggle, and auto-read language selector.

Purpose: Users gain control over TTS voice and speed (TTS-01, TTS-02), and the Settings page becomes the central hub for all speech preferences.
Output: Extended TTSSettings type, VoicePicker component, redesigned Settings Speech & Audio section.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-tts-quality/22-RESEARCH.md

@src/lib/ttsTypes.ts
@src/contexts/TTSContext.tsx
@src/hooks/useTTSSettings.ts
@src/hooks/useTTS.ts
@src/pages/SettingsPage.tsx
@src/styles/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend TTSSettings type and TTSContext defaults</name>
  <files>src/lib/ttsTypes.ts, src/contexts/TTSContext.tsx</files>
  <action>
In `src/lib/ttsTypes.ts`:
1. Add `AutoReadLang` type: `export type AutoReadLang = 'english' | 'burmese' | 'both';`
2. Add `BurmeseVoice` type: `export type BurmeseVoice = 'nilar' | 'thiha';`
3. Extend `TTSSettings` type with three new fields:
   - `autoRead: boolean;` (off by default)
   - `autoReadLang: AutoReadLang;` (default 'both')
   - `burmeseVoice: BurmeseVoice;` (default 'nilar' = female)

In `src/contexts/TTSContext.tsx`:
1. Update `DEFAULT_SETTINGS` to include the 3 new fields: `autoRead: false`, `autoReadLang: 'both'`, `burmeseVoice: 'nilar'`
2. In `loadInitialSettings()`, ensure the validation handles stored settings that may lack the new fields (merge with defaults: `return { ...DEFAULT_SETTINGS, ...parsed }` after rate validation)
3. No changes needed to the engine creation or voice loading -- those are separate from settings persistence
  </action>
  <verify>
`npx tsc --noEmit` passes with zero errors.
`npx eslint src/lib/ttsTypes.ts src/contexts/TTSContext.tsx` passes.
  </verify>
  <done>
TTSSettings type has autoRead, autoReadLang, and burmeseVoice fields. DEFAULT_SETTINGS includes their defaults. Existing settings in localStorage gracefully merge with new defaults (no breakage for existing users).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VoicePicker component and add Speech & Audio section to Settings</name>
  <files>src/components/ui/VoicePicker.tsx, src/pages/SettingsPage.tsx</files>
  <action>
**VoicePicker component** (`src/components/ui/VoicePicker.tsx`):
1. Create a dropdown component that accepts `voices: SpeechSynthesisVoice[]`, `selectedVoice: string | null`, `onSelect: (voiceName: string) => void`, `showBurmese: boolean`
2. Filter voices to show English voices (`en-*` locale) by default. Normalize voice lang with `.toLowerCase().replace(/_/g, '-')` before matching
3. Group voices by local vs remote (use `voice.localService` property). Show "(Local)" or "(Online)" suffix
4. Include a "System default" option at the top (value `""`)
5. On selection change, call `onSelect(name)` AND play a preview using `useTTS().speak()` with the text "What is the supreme law of the land?" and the selected voice
6. To pass the voice object to speak, find it from the voices array by name: `const voice = voices.find(v => v.name === name)` then `speak(previewText, { voice, lang: voice.lang })`
7. If `filteredVoices.length === 0`, render a warning box: "No voices available" with a description: "Your browser may not have any speech voices installed." Style with `border-warning bg-warning-subtle` per design tokens
8. Use a `<select>` element (not custom dropdown) for native accessibility. Style with `rounded-xl border border-border bg-card px-3 py-2 text-sm text-foreground min-h-[48px] min-w-[200px]`

**Settings page** (`src/pages/SettingsPage.tsx`):
1. Rename the existing "Interview" section to "Speech & Audio" and change the icon from `<Mic>` to `<Volume2>` (already imported). Move it ABOVE the "Sound & Notifications" section for logical grouping
2. Add VoicePicker as the first row in the Speech & Audio section with label "English Voice" / Burmese label. Use `useTTSSettings()` to read `settings.preferredVoice` and write via `updateTTSSettings({ preferredVoice: name || null })`
3. Keep the existing speech rate radio buttons (they already use useTTSSettings)
4. Add an auto-read toggle row using `ToggleSwitch` with label "Auto-Read Questions" / Burmese label. Reads `settings.autoRead`, updates via `updateTTSSettings({ autoRead: !settings.autoRead })`
5. Add an auto-read language selector (only visible when autoRead is true AND showBurmese is true). Three-button radio group: "English" / "Burmese" / "Both". Uses `settings.autoReadLang`, updates via `updateTTSSettings({ autoReadLang: value })`
6. Add a Burmese voice selector (only visible when showBurmese is true). Two-button radio group: "Nilar (Female)" / "Thiha (Male)". Uses `settings.burmeseVoice`, updates via `updateTTSSettings({ burmeseVoice: value })`
7. Pass `voices` from TTSContext (via `useTTS()`) to VoicePicker
8. Import VoicePicker at the top: `import { VoicePicker } from '@/components/ui/VoicePicker'`
  </action>
  <verify>
`npx tsc --noEmit` passes.
`npx eslint src/components/ui/VoicePicker.tsx src/pages/SettingsPage.tsx` passes.
`npm run build` succeeds.
  </verify>
  <done>
Settings page has a "Speech & Audio" section with: voice picker dropdown with preview, speech rate selector (existing, relocated), auto-read toggle, auto-read language selector (conditional), Burmese voice selector (conditional). All settings persist via useTTSSettings.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. `npx tsc --noEmit` passes
3. `npm run lint` passes
4. Settings page renders the Speech & Audio section with voice picker, speed, auto-read, and Burmese voice controls
5. Voice picker shows filtered English voices with preview on selection
6. Settings persist across page refresh (check localStorage key `civic-prep-tts-settings`)
</verification>

<success_criteria>
- TTSSettings type extended with autoRead, autoReadLang, burmeseVoice
- VoicePicker component renders voice dropdown with preview sample playback
- Settings page has dedicated "Speech & Audio" section with all 5 controls
- No voices scenario shows "No voices available" warning
- All settings flow through useTTSSettings and persist to localStorage
</success_criteria>

<output>
After completion, create `.planning/phases/22-tts-quality/22-01-SUMMARY.md`
</output>
