---
phase: 40-app-router-foundation
plan: 03
type: execute
wave: 3
depends_on: ["40-02"]
files_modified:
  - app/(protected)/layout.tsx
  - src/components/ProtectedRoute.tsx
  - src/pages/AuthPage.tsx
autonomous: true
requirements:
  - MIGR-07

must_haves:
  truths:
    - "app/(protected)/layout.tsx redirects unauthenticated users to /auth with returnTo URL param"
    - "ProtectedRoute.tsx uses URL param (?returnTo=) instead of react-router state for redirect"
    - "AuthPage reads returnTo from URL search params and navigates there after login"
    - "returnTo values are validated to only accept relative paths starting with / (open redirect prevention)"
    - "The full build succeeds with all three components working together"
  artifacts:
    - path: "app/(protected)/layout.tsx"
      provides: "Auth guard layout for App Router protected routes"
      contains: "use client"
    - path: "src/components/ProtectedRoute.tsx"
      provides: "Auth guard for Pages Router protected routes (updated returnTo pattern)"
      contains: "returnTo"
    - path: "src/pages/AuthPage.tsx"
      provides: "Auth page reading returnTo from URL param"
      contains: "returnTo"
  key_links:
    - from: "app/(protected)/layout.tsx"
      to: "src/contexts/SupabaseAuthContext.tsx"
      via: "useAuth() hook"
      pattern: "useAuth"
    - from: "app/(protected)/layout.tsx"
      to: "/auth?returnTo="
      via: "redirect() from next/navigation"
      pattern: "redirect.*auth.*returnTo"
    - from: "src/components/ProtectedRoute.tsx"
      to: "/auth?returnTo="
      via: "Navigate component with search params"
      pattern: "returnTo"
    - from: "src/pages/AuthPage.tsx"
      to: "URL search params"
      via: "useSearchParams or location.search"
      pattern: "returnTo"
---

<objective>
Create the auth guard layout for the App Router protected route group and unify the returnTo pattern across both routers.

Purpose: Implement MIGR-07 (auth guard via route group) and ensure consistent redirect-after-login behavior during the coexistence period.
Output: `app/(protected)/layout.tsx`, updated `ProtectedRoute.tsx`, updated `AuthPage.tsx`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-app-router-foundation/40-CONTEXT.md
@.planning/phases/40-app-router-foundation/40-RESEARCH.md
@.planning/phases/40-app-router-foundation/40-02-SUMMARY.md

@src/components/ProtectedRoute.tsx
@src/pages/AuthPage.tsx
@src/contexts/SupabaseAuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth guard layout and update returnTo pattern</name>
  <files>app/(protected)/layout.tsx, src/components/ProtectedRoute.tsx, src/pages/AuthPage.tsx</files>
  <action>
**1. Create `app/(protected)/layout.tsx`:**

A `'use client'` component that serves as the auth guard for all App Router protected routes.

```typescript
'use client';

import { redirect, usePathname } from 'next/navigation';
import { useAuth } from '@/contexts/SupabaseAuthContext';

export default function ProtectedLayout({ children }: { children: React.ReactNode }) {
  const { user, isLoading } = useAuth();
  const pathname = usePathname();

  if (isLoading) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-background">
        <div className="h-12 w-12 animate-spin rounded-full border-4 border-primary border-t-transparent" />
      </div>
    );
  }

  if (!user) {
    // Validate returnTo is a safe relative path (open redirect prevention)
    const safeReturnTo = pathname.startsWith('/') && !pathname.startsWith('//') ? pathname : undefined;
    const authUrl = safeReturnTo ? `/auth?returnTo=${encodeURIComponent(safeReturnTo)}` : '/auth';
    redirect(authUrl);
  }

  return <>{children}</>;
}
```

**Critical details:**
- Uses `redirect()` from `next/navigation` (NOT `useRouter().push()`) — redirect() works during render and throws NEXT_REDIRECT to halt rendering. Do NOT wrap in try/catch.
- Spinner matches existing ProtectedRoute UX: full-screen centered, same Tailwind classes (`bg-background`, `border-primary`, `border-t-transparent`)
- `useAuth()` is available because ClientProviders wraps all routes in `app/layout.tsx`
- `usePathname()` from `next/navigation` gets the current App Router path for returnTo
- Open redirect prevention: validate returnTo starts with `/` and doesn't start with `//`
- No routes in `(protected)` yet — this is "ready but empty" for Phase 41

Wire into: `app/layout.tsx` — nested route group layout, automatically applied to routes under `app/(protected)/`
Import from: `@/contexts/SupabaseAuthContext` — `useAuth()` hook

**2. Update `src/components/ProtectedRoute.tsx`:**

Switch from react-router state to URL param for returnTo pattern.

Current: `<Navigate to="/auth" state={{ from: location.pathname }} replace />`
New: `<Navigate to={`/auth?returnTo=${encodeURIComponent(location.pathname)}`} replace />`

Add the same open redirect validation: ensure `location.pathname` starts with `/` and not `//`.

Keep all other logic identical (useAuth, isLoading spinner, children rendering).

Wire into: Already wired in AppShell.tsx routes — no change needed.

**3. Update `src/pages/AuthPage.tsx`:**

Change how AuthPage reads the returnTo value after successful login.

Current (line 44): `const redirectTo = (location.state as { from?: string })?.from ?? '/home';`

New: Read from URL search params instead of router state:
```typescript
// Read returnTo from URL search params (works with both App Router redirect and Pages Router Navigate)
const searchParams = new URLSearchParams(location.search);
const rawReturnTo = searchParams.get('returnTo');
// Validate: must be relative path starting with / and not // (open redirect prevention)
const redirectTo = rawReturnTo && rawReturnTo.startsWith('/') && !rawReturnTo.startsWith('//')
  ? rawReturnTo
  : '/home';
```

Use `location.search` from react-router-dom's `useLocation()` (already imported in AuthPage).

**Important:** Also keep the `location.state` fallback during transition — some existing deep links or in-flight redirects may still use state:
```typescript
const stateFallback = (location.state as { from?: string })?.from;
const redirectTo = rawReturnTo && rawReturnTo.startsWith('/') && !rawReturnTo.startsWith('//')
  ? rawReturnTo
  : (stateFallback && stateFallback.startsWith('/') && !stateFallback.startsWith('//'))
    ? stateFallback
    : '/home';
```

Wire into: Already the auth page — reads returnTo from URL param sent by both ProtectedRoute and ProtectedLayout.
  </action>
  <verify>
    <automated>cd /c/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && pnpm test:run 2>&1 | tail -10</automated>
  </verify>
  <done>
    - `app/(protected)/layout.tsx` exists as `'use client'` with useAuth + redirect pattern
    - `ProtectedRoute.tsx` uses URL param `?returnTo=` instead of router state
    - `AuthPage.tsx` reads returnTo from URL search params with state fallback
    - All returnTo values validated for relative paths only (open redirect prevention)
    - `pnpm test:run` passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Full build verification</name>
  <files></files>
  <action>
Run the complete verification suite to confirm Phase 40 is complete:

1. `pnpm test:run` — all existing tests pass (no regressions from provider extraction or returnTo changes)
2. `pnpm build` — production build succeeds with both Pages Router and App Router coexisting

**Expected results:**
- Build compiles `app/layout.tsx` as Server Component with metadata/viewport exports
- Build compiles `app/(protected)/layout.tsx` as client component
- Build compiles refactored `AppShell.tsx` with ClientProviders
- Pages Router routes still work via `pages/[[...slug]].tsx`
- No type errors, no ESLint errors, no build warnings about conflicting routes

If either command fails, diagnose and fix the issue. Common failure modes:
- CSS import path issues in `app/layout.tsx` — verify relative path `../src/styles/globals.css`
- Type mismatch in ClientProviders `routerWrapper` prop
- Duplicate `<html>` or `<body>` tags warning — should not happen since the two routers serve different routes
  </action>
  <verify>
    <automated>cd /c/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && pnpm test:run && pnpm build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - `pnpm test:run` passes with 0 failures
    - `pnpm build` succeeds with exit code 0
    - No type errors across the codebase
    - Both routers coexist without conflicts
  </done>
</task>

</tasks>

<verification>
- `pnpm test:run` passes (all existing tests green)
- `pnpm build` succeeds (both routers coexist)
- `app/(protected)/layout.tsx` exists and compiles
- `ProtectedRoute.tsx` uses `?returnTo=` URL param
- `AuthPage.tsx` reads returnTo from URL search params
- returnTo validation rejects non-relative paths
</verification>

<success_criteria>
- Auth guard layout redirects unauthenticated users with returnTo URL param
- returnTo pattern unified across both routers (URL param, not router state)
- Open redirect prevention validates relative paths only
- Full build succeeds with all Phase 40 changes
- All existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/40-app-router-foundation/40-03-SUMMARY.md`
</output>
