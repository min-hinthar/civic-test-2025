---
phase: 21-test-practice-ux
plan: 08
type: execute
wave: 3
depends_on: ["21-05"]
files_modified:
  - src/components/interview/InterviewSession.tsx
  - src/components/interview/TranscriptionReview.tsx
  - src/components/interview/InterviewSetup.tsx
  - src/pages/InterviewPage.tsx
autonomous: true

must_haves:
  truths:
    - "Interview uses chat-style layout with examiner messages left, user answers right"
    - "Voice-only input with auto-detect silence to stop recording"
    - "User sees transcription before grading and can re-record up to 3 times"
    - "Practice mode gives per-question feedback, Real mode has no per-question feedback"
    - "Real mode has early termination at 12 correct or 9 incorrect"
    - "USCIS 2025 rules: 20 questions, pass at 12, fail at 9"
  artifacts:
    - path: "src/components/interview/InterviewSession.tsx"
      provides: "Refactored interview with chat layout and speech recognition"
    - path: "src/components/interview/TranscriptionReview.tsx"
      provides: "Transcription display with confirm/re-record controls"
      exports: ["TranscriptionReview"]
    - path: "src/components/interview/InterviewSetup.tsx"
      provides: "Updated setup with Practice/Real mode selection"
    - path: "src/pages/InterviewPage.tsx"
      provides: "Updated interview page with mode routing"
  key_links:
    - from: "src/components/interview/InterviewSession.tsx"
      to: "src/hooks/useSpeechRecognition.ts"
      via: "uses speech recognition hook"
      pattern: "useInterviewSpeech"
    - from: "src/components/interview/InterviewSession.tsx"
      to: "src/lib/interview/answerGrader.ts"
      via: "grades spoken answers"
      pattern: "gradeAnswer"
    - from: "src/components/interview/InterviewSession.tsx"
      to: "src/components/interview/ExaminerCharacter.tsx"
      via: "renders examiner character"
      pattern: "ExaminerCharacter"
---

<objective>
Overhaul the interview session with chat-style layout, speech recognition, Practice/Real modes, and the animated examiner character.

Purpose: Transform the interview from a basic Q&A flow into an immersive USCIS interview simulation with voice input, visual conversation, and dual practice/real modes.
Output: Refactored InterviewSession.tsx, TranscriptionReview.tsx, updated InterviewSetup.tsx and InterviewPage.tsx
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/21-test-practice-ux/21-CONTEXT.md
@.planning/phases/21-test-practice-ux/21-RESEARCH.md
@.planning/phases/21-test-practice-ux/21-05-SUMMARY.md
@.planning/phases/21-test-practice-ux/21-02-SUMMARY.md

@src/components/interview/InterviewSession.tsx
@src/components/interview/InterviewSetup.tsx
@src/components/interview/InterviewResults.tsx
@src/pages/InterviewPage.tsx
@src/hooks/useSpeechRecognition.ts
@src/hooks/useSilenceDetection.ts
@src/lib/interview/answerGrader.ts
@src/components/interview/ExaminerCharacter.tsx
@src/components/interview/ChatBubble.tsx
@src/components/interview/TypingIndicator.tsx
@src/components/interview/AudioWaveform.tsx
@src/hooks/useAudioRecorder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TranscriptionReview and InterviewSetup update</name>
  <files>src/components/interview/TranscriptionReview.tsx, src/components/interview/InterviewSetup.tsx</files>
  <action>
**TranscriptionReview.tsx:**

Props:
```typescript
interface TranscriptionReviewProps {
  transcript: string;
  attemptNumber: number;         // 1, 2, or 3
  maxAttempts: number;           // 3 per locked decision
  onConfirm: () => void;        // User accepts transcript
  onReRecord: () => void;       // User wants to try again
  isGrading?: boolean;          // Show loading state while grading
}
```

Per locked decisions:
- Shows transcription to user before grading (user can see what was heard)
- User can confirm OR re-record (up to 3 attempts)
- Re-record only (no text typing fallback per locked decision)
- Display: Card with transcript text, "Confirm" primary button, "Re-record" secondary button
- Show attempt counter: "Attempt 1 of 3"
- When attemptNumber >= maxAttempts, hide re-record button (last chance, must confirm)
- Animated entrance with SPRING_GENTLE
- If transcript is empty (recognition failed), show "No speech detected. Try speaking more clearly." and only offer re-record
- AudioWaveform visual (small, inline) showing the recording that produced this transcript

**InterviewSetup.tsx update:**

Update the existing InterviewSetup to reflect the dual mode system:
- Rename modes: "realistic" -> "real" in display labels (keep 'realistic' type internally for backward compat)
- Practice Interview card: "Get feedback after each question. Great for learning!"
- Real Interview card: "USCIS 2025 rules: 20 questions. Pass at 12, fail at 9."
- Add USCIS 2025 rule details to the Real mode card description
- Keep existing mic permission check flow
- Update bilingual labels
- Improve the visual design of mode cards (larger, more prominent, clearer distinction)
- Add "Practice" badge on practice card, "USCIS Simulation" badge on real card
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run lint`. Components compile and export correctly.</verify>
  <done>TranscriptionReview shows user their transcribed answer with confirm/re-record controls. InterviewSetup updated with clear Practice/Real mode distinction and USCIS 2025 rule descriptions.</done>
</task>

<task type="auto">
  <name>Task 2: InterviewSession chat-style overhaul</name>
  <files>src/components/interview/InterviewSession.tsx, src/pages/InterviewPage.tsx</files>
  <action>
**Major refactor of InterviewSession.tsx:**

Replace the current question-phase-based flow with a chat-style conversation layout. Keep the existing phase state machine but transform the UI.

**Visual Layout per locked decisions:**
- ExaminerCharacter at top of screen (large, prominent)
- Chat messages area below (flexbox column, auto-scroll to bottom)
- Recording area (mic + AudioWaveform) fixed at bottom of screen
- Distinct darker/moody color theme: use `bg-gradient-to-b from-slate-900 to-slate-800` background
- US flag SVG motif: subtle SVG pattern in background (low opacity)
- Repeat and Rephrase buttons as quick-reply buttons below examiner's question bubble

**Chat Flow:**

1. **Greeting**: Examiner ChatBubble with greeting text + TTS auto-read. TypingIndicator shows briefly before message appears.

2. **Question phase**:
   - TypingIndicator appears for 1-2 seconds
   - Examiner ChatBubble with question text appears + TTS auto-reads
   - ExaminerCharacter transitions to 'speaking' state during TTS
   - After TTS finishes, recording starts automatically
   - ExaminerCharacter transitions to 'listening' state

3. **Recording phase**:
   - AudioWaveform shows animated waveform at bottom
   - useSilenceDetection auto-stops after 2 seconds of silence
   - Animated audio waveform while recording per locked decision
   - Manual submit button as fallback (Claude's discretion: include it)
   - Recording indicator sound (subtle) per locked decision

4. **Transcription review**:
   - TranscriptionReview component shows what was heard
   - User confirms or re-records (up to 3 attempts per locked decision)
   - User's confirmed answer appears as user ChatBubble (right-aligned)

5. **Grading**:
   - Call `gradeAnswer()` from answerGrader with the confirmed transcript
   - **Practice mode**: Full feedback via examiner ChatBubble with correct/incorrect + correct answer + explanation + TTS
   - **Real mode**: Brief acknowledgment ChatBubble ("Thank you", "Next question") per locked decision -- no per-question feedback
   - ExaminerCharacter transitions to 'nodding' state briefly

6. **Next question**: After grading feedback (or acknowledgment), TypingIndicator -> next question bubble

7. **Time limit**: Gentle visual indicator after 15-20 seconds (progress bar or timer glow). Auto-advance eventually (timeout = skipped in Practice, incorrect in Real per locked decision).

8. **Repeat/Rephrase**: Quick-reply buttons below examiner question bubble. Repeat: re-read same question via TTS. Rephrase: provide alternate wording (1 per question per locked decision).

9. **Early termination (Real mode)**: At 12 correct, examiner says "Congratulations! You've passed!" with TTS. At 9 incorrect, examiner says "Unfortunately, you didn't reach the passing score this time." with TTS. Then transition to results.

10. **Practice mode always asks all 20 questions** per locked decision.

11. **Exit**: Allowed in Practice mode (with session save), NOT allowed in Real mode per locked decision.

12. **Response time tracking**: Silently record time from question end (TTS finish) to answer submit for analytics per locked decision.

**Speech recognition integration:**
- Use `useInterviewSpeech()` hook
- If speech recognition not supported, fall back to existing SelfGradeButtons (keep as fallback)
- Sequence strictly: TTS finishes -> start recording. Never overlap per pitfall.
- Cancel TTS before starting recognition per pitfall.

**Existing compatibility:**
- Keep session persistence integration (save to IndexedDB)
- Keep resume support (initialQuestions, initialResults, etc.)
- Keep existing InterviewResult type but add `confidence` and `responseTimeMs` optional fields
- Update InterviewPage.tsx to pass new mode labels and handle updated flow

**Update InterviewPage.tsx:**
- Update mode type handling for Practice/Real
- Clear resumeData on retry/switchMode (existing pattern)
- Pass correct props to updated InterviewSession

**User avatar**: Show user's profile picture or initials on user chat bubbles. Get from AuthContext user data.

**Claude's discretion:**
- Warm-up question: Include one simple warm-up before scored questions ("What is your name?")
- Manual submit button: Include as small icon button below waveform
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run lint`. Run `npm run build`. Navigate to /#/interview -- verify chat layout renders, examiner character appears, and basic flow works.</verify>
  <done>InterviewSession overhauled with chat-style layout, ExaminerCharacter, speech recognition, Practice/Real modes, early termination, and transcription review. Interview feels like a real conversation.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run lint` passes
- `npm run build` succeeds
- Interview renders chat-style layout with examiner at top
- Speech recognition captures user answers (Chrome)
- Practice mode shows per-question feedback
- Real mode has no per-question feedback, early termination
- SelfGradeButtons still available as fallback
</verification>

<success_criteria>
- Chat-style conversation layout with examiner character
- Voice-only input with silence detection and transcription review
- Practice mode: per-question feedback, always 20 questions
- Real mode: USCIS 2025 rules (20q, pass@12, fail@9), early termination
- Existing interview features preserved (session persistence, resume, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/21-test-practice-ux/21-08-SUMMARY.md`
</output>
