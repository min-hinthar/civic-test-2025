---
phase: 24-accessibility-performance
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/sort/SwipeableCard.tsx
  - src/components/sort/SwipeableStack.tsx
  - src/components/sort/SortModeContainer.tsx
  - src/components/ui/SpeechButton.tsx
autonomous: true

must_haves:
  truths:
    - "Swipe gesture registers reliably on mobile (lower threshold or velocity-only commit)"
    - "Swipe animation does not freeze mid-way on mobile"
    - "Swipe overlay UI does not interfere with touch events"
    - "Auto-read fires AFTER card animation completes (not during)"
    - "Speech button background remains opaque inside 3D card context"
  artifacts:
    - path: "src/components/sort/SwipeableCard.tsx"
      provides: "Fixed swipe gesture with lower threshold and animation guard"
      contains: "dragElastic"
    - path: "src/components/sort/SortModeContainer.tsx"
      provides: "Auto-read gated on animation completion"
      contains: "onAnimationComplete"
  key_links:
    - from: "src/components/sort/SwipeableCard.tsx"
      to: "gesture handler"
      via: "onDragEnd with velocity + distance threshold"
      pattern: "onDragEnd"
---

<objective>
Fix 5 swipe/gesture and UI bugs in sort mode: swipe not registering, animation freeze, overlay interference, auto-read timing, and speech button transparency.

Purpose: Sort mode works reliably on mobile with correct gesture handling and no visual glitches (flashcard bug fixes from phase context).
Output: Fixed SwipeableCard, SwipeableStack, SortModeContainer, and SpeechButton.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@src/components/sort/SwipeableCard.tsx
@src/components/sort/SwipeableStack.tsx
@src/components/sort/SortModeContainer.tsx
@src/components/ui/SpeechButton.tsx
@.planning/phases/24-accessibility-performance/24-RESEARCH.md
@.planning/phases/23-flashcard-sort/23-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix swipe gesture threshold, animation freeze, and overlay interference</name>
  <files>src/components/sort/SwipeableCard.tsx, src/components/sort/SwipeableStack.tsx</files>
  <action>
    **Bug 1: Swipe not registering on mobile:**

    1. Current threshold: `cardWidth * 0.4` (40% of card width). On a 360px mobile screen with card ~300px wide, that's 120px -- too far for comfortable swipe.
    2. Fix: Lower the distance threshold to `cardWidth * 0.25` (25%, ~75px on mobile).
    3. Also lower velocity threshold from 800px/s to 500px/s for velocity-only commits.
    4. Add a combined check: if velocity > 300px/s AND distance > cardWidth * 0.15, commit the swipe. This catches medium-speed, medium-distance gestures that currently fall through.
    5. Reduce `dragElastic` from 1 to 0.6 -- less bounceback makes the card feel more responsive.

    **Bug 2: Swipe animation freezes on mobile:**

    1. If `scope.current` becomes null mid-animation (component unmounts during spring fling), the animation hangs.
    2. Fix: Guard the `animate()` call with null check:
       ```typescript
       if (!scope.current) return;
       await animate(scope.current, { x: exitX, opacity: 0 }, springConfig);
       ```
    3. Add an `onAnimationComplete` callback or use `.then()` after the animation promise.
    4. If the component unmounts during animation, catch the error silently:
       ```typescript
       try {
         await animate(scope.current, ...);
       } catch {
         // Component unmounted during animation -- expected
       }
       ```
    5. Also add a timeout safety: if animation hasn't completed after 1.5 seconds, force-complete it.

    **Bug 3: Swipe overlay UI issue:**

    1. The green/amber overlays (Know/Don't Know labels) have `pointer-events-none` and `z-10`.
    2. Check if `touch-action` is set on the overlay or card. If `touch-action: none` is on the overlay, it may prevent the browser from reporting touch events to the drag handler.
    3. Fix: Ensure the overlay div has `touch-action: none` ONLY on the draggable element itself, not on overlay children.
    4. Add `user-select: none` to prevent text selection during drag (which can interfere with touch gestures).
    5. Verify the overlay `z-10` doesn't create a compositing layer that intercepts events despite `pointer-events-none`. If so, remove z-index from overlays.
  </action>
  <verify>
    - `pnpm run typecheck` passes
    - `pnpm run lint` passes
    - SwipeableCard threshold is 25% (lowered from 40%)
    - Velocity threshold is 500px/s (lowered from 800px/s)
    - Animation has null guard and try/catch
    - Overlays have pointer-events-none without interfering z-index
  </verify>
  <done>Swipe registers reliably on mobile with lower thresholds. Animation does not freeze on unmount. Overlays do not interfere with touch events.</done>
</task>

<task type="auto">
  <name>Task 2: Fix auto-read timing and speech button transparency</name>
  <files>src/components/sort/SortModeContainer.tsx, src/components/ui/SpeechButton.tsx</files>
  <action>
    **Bug 4: Auto-read fires before card animation completes:**

    1. In SortModeContainer (or wherever auto-read is triggered after sorting), the auto-read likely fires on state change (new card becomes active) immediately.
    2. The card entrance animation (sliding in from behind, or the next card becoming top of stack) takes ~300-500ms.
    3. Fix: Gate auto-read on animation completion:
       - Option A: Add a delay matching the animation duration (e.g., `setTimeout(() => triggerAutoRead(), 400)`)
       - Option B: Use `onAnimationComplete` callback from motion/react on the card entrance animation, then trigger auto-read
       - Option A is simpler and more reliable (animation timing is a best-effort estimate anyway)
    4. Also ensure auto-read reads the CURRENT card, not the previous card. The state update (new card at top) should be settled before auto-read fires.

    **Bug 5: Speech button background becomes transparent:**

    1. Inside a 3D transform context (`preserve-3d`), child elements' backgrounds may be composited incorrectly.
    2. The SpeechButton likely has a glass/translucent background that becomes fully transparent in the 3D card context.
    3. Fix: Add `isolation: isolate` to the SpeechButton container (the wrapper div with click handler in Flashcard3D).
    4. Also add `transform: translateZ(0)` to the SpeechButton itself to force it into its own compositing layer, preventing the 3D context from affecting its background.
    5. Alternatively, in Flashcard3D's TTS wrapper div (the `div className="flex gap-2" onClick={handleTTSClick}`), add:
       ```tsx
       style={{ isolation: 'isolate', transform: 'translateZ(0)' }}
       ```
    6. This creates an isolated stacking context for the speech buttons, preventing the 3D card's transform from making their backgrounds transparent.

    **SpeechButton.tsx (if needed):**

    1. Check if SpeechButton has a background class that relies on backdrop-filter or opacity.
    2. If so, add a fallback solid background for when it's inside a 3D context:
       - Add a data attribute or className to indicate 3D context
       - Or simply ensure the button has `bg-surface` (opaque) not `bg-surface/80` (translucent) when active
  </action>
  <verify>
    - `pnpm run typecheck` passes
    - `pnpm run lint` passes
    - `pnpm run build` passes
    - Auto-read in SortModeContainer has delay or animation-complete gate
    - Speech button wrapper has isolation: isolate and transform: translateZ(0)
  </verify>
  <done>Auto-read fires after card animation completes. Speech button background stays opaque inside 3D card transform context.</done>
</task>

</tasks>

<verification>
- `pnpm run typecheck` passes
- `pnpm run lint` passes
- `pnpm run build` passes
- `pnpm test:run` passes
- Swipe threshold lowered, animation guarded, overlays fixed, auto-read gated, speech button opaque
</verification>

<success_criteria>
- Swipe gesture registers on mobile with comfortable threshold
- Animation never freezes (null guards, try/catch, timeout safety)
- Overlay UI does not block touch events
- Auto-read fires AFTER card transition animation
- Speech button background opaque in 3D card context
</success_criteria>

<output>
After completion, create `.planning/phases/24-accessibility-performance/24-09-SUMMARY.md`
</output>
