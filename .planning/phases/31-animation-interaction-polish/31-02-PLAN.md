---
phase: 31-animation-interaction-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/Dialog.tsx
  - src/lib/audio/soundEffects.ts
autonomous: true
requirements: [ANIM-03]

must_haves:
  truths:
    - "Closing any dialog plays a fade + scale(0.95) exit animation instead of instant disappearance"
    - "Dialog overlay (backdrop) fades out synchronized with the content panel"
    - "Exit animation is faster than enter (~150ms exit vs ~250ms enter spring)"
    - "Pressing Escape triggers the same animated exit, not instant close"
    - "prefers-reduced-motion makes dialogs hide instantly with no animation"
    - "A subtle audio cue (soft descending pop) plays on overlay dismiss"
  artifacts:
    - path: "src/components/ui/Dialog.tsx"
      provides: "Dialog with forceMount + AnimatePresence exit animations"
      contains: "AnimatePresence"
    - path: "src/lib/audio/soundEffects.ts"
      provides: "playDismiss sound effect for overlay exit"
      exports: ["playDismiss"]
  key_links:
    - from: "src/components/ui/Dialog.tsx"
      to: "motion/react"
      via: "AnimatePresence wrapping forceMount content"
      pattern: "AnimatePresence"
    - from: "src/components/ui/Dialog.tsx"
      to: "src/lib/audio/soundEffects.ts"
      via: "playDismiss() call on close"
      pattern: "playDismiss"
---

<objective>
Add exit animations to Dialog and a dismiss audio cue so overlays exit gracefully with fade + scale(0.95) instead of instantly vanishing.

Purpose: Instant overlay dismissal feels jarring and unfinished. Animated exits reinforce the spatial model (overlays recede into the background), provide satisfying closure, and match the playful spring-in enter animations. A soft audio cue adds multi-sensory feedback.

Output: Refactored Dialog.tsx with AnimatePresence + forceMount for exit animations, and a new playDismiss() function in soundEffects.ts.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/ui/Dialog.tsx
@src/lib/audio/soundEffects.ts
@src/lib/motion-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Dialog.tsx with forceMount + AnimatePresence for exit animations</name>
  <files>src/components/ui/Dialog.tsx</files>
  <action>
The current Dialog.tsx has enter animations (spring from scale 0.95 + y:50) but NO exit animation because Radix unmounts content instantly when `open` becomes false. Fix by restructuring to use `forceMount` + `AnimatePresence`.

**Key restructuring:**

1. **Thread `open` prop to DialogContent.** Currently, `DialogContent` is a standalone component that doesn't know the `open` state. The `Dialog` wrapper has `open` but doesn't pass it down. Restructure:

   Option A (preferred): Add an optional `open` prop to `DialogContent`. When provided, wrap everything in `AnimatePresence` and conditionally render based on `open`. When not provided, keep current behavior for backward compatibility.

   ```typescript
   export const DialogContent = forwardRef<
     HTMLDivElement,
     DialogPrimitive.DialogContentProps & {
       showCloseButton?: boolean;
       open?: boolean; // NEW: enables exit animation
     }
   >(...);
   ```

2. **When `open` is provided, use AnimatePresence + forceMount pattern:**

   ```typescript
   // Import AnimatePresence from motion/react
   import { motion, AnimatePresence } from 'motion/react';

   // Inside DialogContent render:
   if (typeof open === 'boolean') {
     return (
       <AnimatePresence>
         {open && (
           <DialogPortal forceMount>
             <DialogOverlay forceMount />
             <DialogPrimitive.Content forceMount asChild ref={ref} {...props}>
               <div className="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
                 <motion.div
                   initial={shouldReduceMotion ? false : { opacity: 0, y: 50, scale: 0.95 }}
                   animate={{ opacity: 1, y: 0, scale: 1 }}
                   exit={shouldReduceMotion ? undefined : { opacity: 0, scale: 0.95 }}
                   transition={{
                     // Enter uses spring, exit uses tween
                     ...SPRING_BOUNCY,
                   }}
                   className={/* same classes as current */}
                 >
                   {children}
                   {showCloseButton && /* same close button */}
                 </motion.div>
               </div>
             </DialogPrimitive.Content>
           </DialogPortal>
         )}
       </AnimatePresence>
     );
   }
   // else: fall through to current implementation (backward compat)
   ```

3. **DialogOverlay exit animation.** Also update `DialogOverlay` to accept `forceMount` and add `exit={{ opacity: 0 }}`:
   - When used with `forceMount` (via the new pattern), use `exit` prop for fade-out
   - Add `AnimatePresence` wrapping for the overlay too (or share the parent `AnimatePresence`)
   - Overlay and content share the same `AnimatePresence` wrapper, so both animate in sync

4. **Exit transition timing.** Exit should be faster than enter (~150ms tween):
   ```typescript
   // For exit: override spring with tween
   // motion/react allows different enter/exit transitions via the exit prop's transition
   exit={shouldReduceMotion ? undefined : {
     opacity: 0,
     scale: 0.95,
     transition: { duration: 0.15, ease: 'easeIn' }
   }}
   ```

5. **Play dismiss audio on close.** In the `onOpenChange` handler or via an effect that detects `open` going from true to false, call `playDismiss()`. The cleanest approach: wrap `onOpenChange` in the `Dialog` component:
   ```typescript
   export function Dialog({ open, onOpenChange, children }: DialogProps) {
     const handleOpenChange = (newOpen: boolean) => {
       if (!newOpen && open) {
         playDismiss(); // Play audio on close
       }
       onOpenChange(newOpen);
     };
     return (
       <DialogPrimitive.Root open={open} onOpenChange={handleOpenChange}>
         {children}
       </DialogPrimitive.Root>
     );
   }
   ```

6. **DialogPortal with forceMount.** Radix `DialogPrimitive.Portal` supports `forceMount` prop. When set, it keeps the portal in the DOM regardless of open state, which is needed for AnimatePresence to animate exit.

7. **Verify all 7 Dialog consumer files still work.** The new `open` prop is optional, so existing consumers that don't pass `open` to `DialogContent` keep current behavior. Consumers that want exit animations pass `open`:
   ```tsx
   <Dialog open={isOpen} onOpenChange={setIsOpen}>
     <DialogContent open={isOpen}>
       ...
     </DialogContent>
   </Dialog>
   ```
   To enable exit animations by default, check if `Dialog` can automatically provide `open` to children via React context. This would be cleaner but requires more restructuring. For now, the explicit `open` prop approach is safer.

**CRITICAL PITFALLS (from research):**
- `asChild` on `DialogPrimitive.Content` merges props onto its single child. When `motion.div` is that child wrapped in a positioning div, ensure the `asChild` target receives all Radix accessibility props (aria-*, role, etc.).
- `AnimatePresence` needs `key` prop on its direct children to track exits. Since there's only one child (the portal), this is handled automatically.
- Do NOT use `AnimatePresence mode="wait"` — that would delay new dialog opening if one is closing.
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run lint` passes
- Check that Dialog.tsx imports `AnimatePresence` from `motion/react`
- Check that `forceMount` is used on Portal, Overlay, and Content
- Check that `exit` prop is present on motion.div elements
- Verify backward compatibility: consumers not passing `open` prop still work
  </verify>
  <done>
Dialog overlays play fade + scale(0.95) exit animation synchronized with backdrop fade-out. Exit takes ~150ms (faster than enter). Escape key triggers same animated exit. prefers-reduced-motion users see instant hide. Backward compatible — consumers can opt into exit animation by passing `open` prop to `DialogContent`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add playDismiss sound effect for overlay exit audio cue</name>
  <files>src/lib/audio/soundEffects.ts</files>
  <action>
Add a `playDismiss` function to `soundEffects.ts` following the established pattern (mute check, getContext, oscillator+gain envelope, silent catch).

**Implementation:**
```typescript
/**
 * Soft descending pop for overlay/dialog dismiss.
 * 600 Hz -> 300 Hz sine sweep over 100ms. Gentle, satisfying close.
 */
export function playDismiss(): void {
  if (isSoundMuted()) return;
  try {
    const ctx = getContext();
    if (!ctx) return;
    const osc = ctx.createOscillator();
    const gainNode = ctx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(600, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 0.1);
    gainNode.gain.setValueAtTime(0.08, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
    osc.connect(gainNode);
    gainNode.connect(ctx.destination);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.1);
  } catch {
    // Silently ignore -- sound failure must never break app flow
  }
}
```

Place it in a new "Overlay sounds" section after the existing "Quiz interaction sounds" section. Follow the same documentation pattern (JSDoc with frequency/duration/character description).
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run lint` passes
- `playDismiss` is exported from soundEffects.ts
- Function follows established pattern: mute check, getContext, oscillator, silent catch
  </verify>
  <done>
`playDismiss()` exported from soundEffects.ts. Plays a soft 600->300 Hz descending sine sweep over 100ms at volume 0.08. Respects mute setting. Silent no-op on error.
  </done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes with no errors
- `npm run lint` passes
- `npm run build` completes without errors
- Dialog.tsx imports AnimatePresence and uses forceMount pattern
- soundEffects.ts exports playDismiss function
- Exit animation uses faster timing (~150ms) than enter (spring ~250ms)
</verification>

<success_criteria>
Closing any dialog plays a smooth fade + scale(0.95) exit animation with synchronized backdrop fade-out and a subtle audio dismiss cue. Exit feels snappier than enter. Escape key triggers the same animated exit. Reduced motion users see instant hide. Existing dialog consumers continue working without changes.
</success_criteria>

<output>
After completion, create `.planning/phases/31-animation-interaction-polish/31-02-SUMMARY.md`
</output>
