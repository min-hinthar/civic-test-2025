---
phase: 44-test-date-countdown-and-study-plan
plan: 02
type: execute
wave: 2
depends_on:
  - 44-01
files_modified:
  - src/components/dashboard/TestDateCountdownCard.tsx
  - src/components/dashboard/StudyPlanCard.tsx
  - src/components/dashboard/PostTestPrompt.tsx
  - src/views/Dashboard.tsx
  - src/views/SettingsPage.tsx
  - src/views/HubPage.tsx
  - src/components/hub/OverviewTab.tsx
  - src/lib/nba/nbaTypes.ts
  - src/lib/nba/determineNBA.ts
  - src/hooks/useNextBestAction.ts
autonomous: true
requirements: [RDNS-07, RDNS-08, RDNS-09, RDNS-10]

must_haves:
  truths:
    - "User sees a 'Set your test date' card on Dashboard when no test date is set"
    - "User can tap the card to open a date picker and set their USCIS test date"
    - "Dashboard shows countdown card with days remaining and readiness score when test date is set"
    - "Countdown card uses urgency gradient: green (>21 days), amber (8-21 days), red (<=7 days)"
    - "Countdown card shows pace indicator (On track / Behind / Ahead)"
    - "User can change test date by tapping the countdown card"
    - "Dashboard shows 'Today's Plan' card with SRS reviews, new questions, drill, and mock test recommendation"
    - "Study plan card shows estimated time for daily targets"
    - "After test date passes, user sees 'How did your test go?' prompt with Pass/Reschedule options"
    - "Settings page has a 'Test Date' setting row for setting/editing the date"
    - "Progress Hub shows days remaining in its header area"
    - "NBA engine becomes test-date-aware (boosts SRS priority when test is within 14 days)"
    - "Study plan card updates automatically when user completes study activities (recompute-on-render)"
    - "All UI text is bilingual (English + Burmese) following existing patterns"
  artifacts:
    - path: "src/components/dashboard/TestDateCountdownCard.tsx"
      provides: "Countdown card with urgency gradient, days remaining, readiness, pace indicator, date picker"
      exports: ["TestDateCountdownCard"]
    - path: "src/components/dashboard/StudyPlanCard.tsx"
      provides: "Today's Plan card with SRS, new questions, drill, mock test, estimated time"
      exports: ["StudyPlanCard"]
    - path: "src/components/dashboard/PostTestPrompt.tsx"
      provides: "Post-test modal with Pass/Reschedule options"
      exports: ["PostTestPrompt"]
    - path: "src/views/Dashboard.tsx"
      provides: "Dashboard with countdown card, study plan card, and post-test prompt integrated"
    - path: "src/views/SettingsPage.tsx"
      provides: "Settings page with test date setting row"
    - path: "src/views/HubPage.tsx"
      provides: "Progress Hub with countdown in header"
    - path: "src/lib/nba/determineNBA.ts"
      provides: "NBA engine with test-date-aware priority boosting"
  key_links:
    - from: "src/components/dashboard/TestDateCountdownCard.tsx"
      to: "src/hooks/useStudyPlan.ts"
      via: "receives dailyPlan prop for daysRemaining and paceStatus"
      pattern: "daysRemaining.*paceStatus"
    - from: "src/components/dashboard/StudyPlanCard.tsx"
      to: "src/hooks/useStudyPlan.ts"
      via: "receives dailyPlan prop for SRS, new questions, drill, mock, time"
      pattern: "srsReviewCount.*newQuestionTarget.*drillRecommendation"
    - from: "src/views/Dashboard.tsx"
      to: "src/hooks/useStudyPlan.ts"
      via: "calls useStudyPlan and passes results to card components"
      pattern: "useStudyPlan"
    - from: "src/views/SettingsPage.tsx"
      to: "src/hooks/useTestDate.ts"
      via: "imports useTestDate for date setting row"
      pattern: "useTestDate"
    - from: "src/lib/nba/determineNBA.ts"
      to: "src/lib/nba/nbaTypes.ts"
      via: "reads testDate and daysRemaining from extended NBAInput"
      pattern: "testDate.*daysRemaining"
---

<objective>
Build all UI components and wire them into Dashboard, Settings, Progress Hub, and NBA engine.

Purpose: Surface the study plan engine's output as user-facing cards. The countdown card provides urgency context, the study plan card tells users exactly what to do today, and the post-test prompt handles the test-date-has-passed flow. NBA integration makes the recommendation engine test-date-aware.

Output: TestDateCountdownCard, StudyPlanCard, PostTestPrompt components; Dashboard, Settings, and Hub wiring; NBA test-date integration.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/44-test-date-countdown-and-study-plan/44-RESEARCH.md
@.planning/phases/44-test-date-countdown-and-study-plan/44-01-SUMMARY.md

<interfaces>
<!-- Types created in Plan 01 that this plan consumes -->

From src/lib/studyPlan/studyPlanTypes.ts (created in 44-01):
```typescript
export type PaceStatus = 'ahead' | 'on-track' | 'behind';

export interface StudyPlanInput {
  readinessScore: number;
  readinessTarget: number;
  srsDueCount: number;
  unpracticedCount: number;
  weakCategories: { name: string; mastery: number }[];
  testDate: string | null;
  lastMockTestDate: string | null;
  overallMastery: number;
  now?: Date;
}

export interface DailyPlan {
  srsReviewCount: number;
  newQuestionTarget: number;
  drillRecommendation: { category: string; count: number } | null;
  mockTestRecommended: boolean;
  estimatedMinutes: number;
  paceStatus: PaceStatus | null;
  daysRemaining: number | null;
}
```

From src/hooks/useTestDate.ts (created in 44-01):
```typescript
export type PostTestAction = 'pending' | 'passed' | 'rescheduled';

export function useTestDate(): {
  testDate: string | null;
  setTestDate: (date: string | null) => void;
  postTestAction: PostTestAction;
  setPostTestAction: (action: PostTestAction) => void;
};
```

From src/hooks/useStudyPlan.ts (created in 44-01):
```typescript
export function useStudyPlan(): {
  dailyPlan: DailyPlan | null;
  testDate: string | null;
  setTestDate: (date: string | null) => void;
  postTestAction: PostTestAction;
  setPostTestAction: (action: PostTestAction) => void;
  isLoading: boolean;
};
```

From src/components/readiness/ReadinessHeroCard.tsx (existing):
```typescript
interface TierGradient { light: string; dark: string; }
function getTierGradient(score: number): TierGradient;
// Pattern: bg-gradient-to-br ${gradient.light} ${gradient.dark}
```

From src/lib/readiness/types.ts (existing):
```typescript
export interface ReadinessResult {
  score: number;
  dimensions: { accuracy: DimensionScore; coverage: DimensionScore; consistency: DimensionScore };
  tierLabel: TierLabel;
}
```

From src/lib/nba/nbaTypes.ts (existing, to be extended):
```typescript
export interface NBAInput {
  currentStreak: number;
  activityDates: string[];
  srsDueCount: number;
  overallMastery: number;
  categoryMasteries: Record<string, number>;
  testHistory: { date: string; score: number; totalQuestions: number }[];
  interviewHistory: { date: string; passed: boolean }[];
  uniqueQuestionsPracticed: number;
  totalQuestions: number;
  // TO ADD:
  // testDate?: string | null;
}
```

From src/views/Dashboard.tsx (existing):
```typescript
// StaggeredList/StaggeredItem pattern for card layout
<StaggeredList delay={80} stagger={80}>
  <StaggeredItem className="mb-6">
    <ReadinessHeroCard ... />
  </StaggeredItem>
  {/* New cards slot in after ReadinessHeroCard */}
  <StaggeredItem className="mb-6">
    <NBAHeroCard ... />
  </StaggeredItem>
  ...
</StaggeredList>
```

From src/views/SettingsPage.tsx (existing):
```typescript
// SettingsSection and SettingsRow patterns
function SettingsSection({ icon, titleEn, titleMy, showBurmese, children, variant? }): JSX.Element;
function SettingsRow({ label, labelMy?, description?, descriptionMy?, showBurmese, action, isLast? }): JSX.Element;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create countdown card, study plan card, and post-test prompt components</name>
  <files>src/components/dashboard/TestDateCountdownCard.tsx, src/components/dashboard/StudyPlanCard.tsx, src/components/dashboard/PostTestPrompt.tsx</files>
  <action>
    **TestDateCountdownCard.tsx:**

    Props interface:
    ```typescript
    interface TestDateCountdownCardProps {
      testDate: string | null;
      daysRemaining: number | null;
      paceStatus: PaceStatus | null;
      readinessScore: number;
      onSetDate: (date: string | null) => void;
      showBurmese: boolean;
    }
    ```

    Two states based on whether testDate is set:

    **State 1 -- No date set:**
    - GlassCard-style card with `Calendar` icon (lucide-react)
    - Title: "Set Your Test Date" / Burmese equivalent
    - Description: "Know when your USCIS interview is? Set it here for a personalized study plan." / Burmese
    - Native `<input type="date">` styled as a button/CTA. On change, call onSetDate(value).
    - Muted gradient background (neutral/blue tones)

    **State 2 -- Date set (daysRemaining > 0):**
    - Card with urgency gradient background using the SAME tier gradient pattern from ReadinessHeroCard:
      - daysRemaining <= 7: red gradient (`from-red-500/5 to-red-500/10`, `dark:from-red-500/15 dark:to-red-500/20`)
      - daysRemaining <= 21: amber gradient
      - daysRemaining > 21: green gradient
    - Large days remaining number with CountUp animation (react-countup, already installed)
    - "days until your test" / Burmese label
    - Readiness score inline: "{readinessScore}% ready" / Burmese
    - Pace indicator badge: "On Track" (green), "Behind" (amber), "Ahead" (blue) based on paceStatus. Each with bilingual text.
    - Tap anywhere on card opens `<input type="date">` to change date (use a hidden input + label trick or ref.click()).
    - The native date input should have min={today} to prevent past dates.

    Use `motion/react` for gentle enter animation (SPRING_GENTLE). Support `useReducedMotion`.

    **StudyPlanCard.tsx:**

    Props interface:
    ```typescript
    interface StudyPlanCardProps {
      dailyPlan: DailyPlan;
      showBurmese: boolean;
    }
    ```

    - GlassCard-style card with `Target` icon (lucide-react)
    - Title: "Today's Plan" / Burmese equivalent
    - Estimated time badge: "{estimatedMinutes} min" in top-right corner
    - Activity list (each item is a row with icon, count, label):
      - `BookOpen` icon: "{srsReviewCount} SRS reviews" (only show if > 0)
      - `Plus` or `Sparkles` icon: "{newQuestionTarget} new questions" (only show if > 0)
      - `Zap` icon: "Drill: {category} ({count} questions)" (only show if drillRecommendation not null). Category name bilingual using USCIS_CATEGORY_NAMES.
      - `ClipboardCheck` icon: "Take a mock test" (only show if mockTestRecommended)
    - Each activity row is tappable, navigating to the appropriate route:
      - SRS reviews -> `/study#deck`
      - New questions -> `/practice`
      - Drill -> `/drill`
      - Mock test -> `/test`
    - If all counts are 0 and no recommendations: show a "You're all caught up!" / Burmese celebration state with CheckCircle icon.
    - Subtle checkmark animation (motion/react scale + opacity) when all items are "done" (all counts zero).

    **PostTestPrompt.tsx:**

    Props interface:
    ```typescript
    interface PostTestPromptProps {
      isOpen: boolean;
      onPass: () => void;
      onReschedule: () => void;
      onDismiss: () => void;
      showBurmese: boolean;
    }
    ```

    - Modal overlay (AnimatePresence for enter/exit) following the MasteryMilestone/BadgeCelebration pattern.
    - Title: "How did your test go?" / Burmese
    - Two large buttons:
      - "I Passed!" (green, with Trophy icon) -> calls onPass
      - "I Need to Reschedule" (amber, with Calendar icon) -> calls onReschedule
    - Small dismiss link at bottom
    - The onPass handler should trigger a brief celebration (confetti or similar from existing useCelebration pattern if available, or just a nice checkmark animation).
    - The onReschedule handler should reset the date picker flow.

    All components must:
    - Use `'use client'` directive
    - Follow existing bilingual pattern: English primary, Burmese secondary with `font-myanmar` class
    - Use Tailwind classes consistent with existing card components
    - Support dark mode via existing `dark:` variants
    - Use lucide-react icons only (already installed)
  </action>
  <verify>
    <automated>pnpm tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>Three new components created: TestDateCountdownCard (urgency gradient, date picker, pace indicator), StudyPlanCard (activity list with navigation, estimated time), PostTestPrompt (pass/reschedule modal). All TypeScript-clean and bilingual.</done>
</task>

<task type="auto">
  <name>Task 2: Wire cards into Dashboard, add test date to Settings, countdown to Hub, and NBA integration</name>
  <files>src/views/Dashboard.tsx, src/views/SettingsPage.tsx, src/views/HubPage.tsx, src/components/hub/OverviewTab.tsx, src/lib/nba/nbaTypes.ts, src/lib/nba/determineNBA.ts, src/hooks/useNextBestAction.ts</files>
  <action>
    **Dashboard.tsx modifications:**

    1. Import useStudyPlan, TestDateCountdownCard, StudyPlanCard, PostTestPrompt.
    2. Call `useStudyPlan()` to get `{ dailyPlan, testDate, setTestDate, postTestAction, setPostTestAction, isLoading: studyPlanLoading }`.
    3. Add `studyPlanLoading` to the `isDashboardLoading` check.
    4. In the StaggeredList, add TWO new StaggeredItems AFTER the ReadinessHeroCard and BEFORE the Unfinished Session Banners:
       ```tsx
       {/* Test Date Countdown Card */}
       <StaggeredItem className="mb-6">
         <TestDateCountdownCard
           testDate={testDate}
           daysRemaining={dailyPlan?.daysRemaining ?? null}
           paceStatus={dailyPlan?.paceStatus ?? null}
           readinessScore={readiness?.score ?? 0}
           onSetDate={setTestDate}
           showBurmese={showBurmese}
         />
       </StaggeredItem>

       {/* Today's Plan Card */}
       {dailyPlan && (
         <StaggeredItem className="mb-6">
           <StudyPlanCard dailyPlan={dailyPlan} showBurmese={showBurmese} />
         </StaggeredItem>
       )}
       ```
    5. Add PostTestPrompt modal at the bottom (same area as MasteryMilestone/BadgeCelebration):
       ```tsx
       <PostTestPrompt
         isOpen={dailyPlan?.daysRemaining !== null && dailyPlan?.daysRemaining <= 0 && postTestAction === 'pending'}
         onPass={() => setPostTestAction('passed')}
         onReschedule={() => {
           setPostTestAction('rescheduled');
           // The setTestDate(null) resets, and the countdown card will show "Set your test date" again
           setTestDate(null);
         }}
         onDismiss={() => setPostTestAction('rescheduled')}
         showBurmese={showBurmese}
       />
       ```

    **SettingsPage.tsx modifications:**

    1. Import useTestDate.
    2. Call `const { testDate, setTestDate } = useTestDate();` in the component.
    3. Add a new SettingsSection AFTER the Location section and BEFORE Speech & Audio:
       ```tsx
       <SettingsSection
         icon={<Calendar className="h-5 w-5" />}
         titleEn="Test Preparation"
         titleMy="စာမေးပွဲ ပြင်ဆင်ခြင်း"
         showBurmese={showBurmese}
       >
         <SettingsRow
           label="USCIS Test Date"
           labelMy="USCIS စာမေးပွဲ ရက်"
           description="Set your scheduled citizenship interview date"
           descriptionMy="သင်၏ နိုင်ငံသားဖြစ်ခွင့် အင်တာဗျူး ရက်ကို သတ်မှတ်ပါ"
           showBurmese={showBurmese}
           action={
             <input
               type="date"
               value={testDate ?? ''}
               onChange={(e) => setTestDate(e.target.value || null)}
               min={new Date().toISOString().slice(0, 10)}
               className="rounded-xl border border-border bg-card px-3 py-2 text-sm text-foreground min-h-[48px] min-w-[140px]"
               aria-label="USCIS test date"
             />
           }
           isLast
         />
       </SettingsSection>
       ```
    4. Import Calendar from lucide-react.

    **HubPage.tsx and OverviewTab.tsx modifications:**

    1. In the OverviewTab (or HubPage header area -- check which renders the top section), add a compact countdown display.
    2. Import useTestDate in the relevant component.
    3. Add a small countdown badge/chip near the page header when testDate is set:
       - Compute daysRemaining using the same UTC math as the engine.
       - Show: "{N} days until test" / Burmese, with urgency color (green/amber/red text).
       - Only visible when testDate is set AND daysRemaining > 0.
    4. Keep it minimal -- this is secondary to the Dashboard's full countdown card.

    **NBA Integration (nbaTypes.ts + determineNBA.ts + useNextBestAction.ts):**

    1. **nbaTypes.ts:** Add optional `testDate?: string | null` field to `NBAInput` interface.

    2. **determineNBA.ts:** After the existing priority chain computations, add test-date awareness:
       - If `input.testDate` is set and daysRemaining < 14:
         - When at the srs-due check (priority 4), SRS is already highest non-streak priority -- no change needed for < 14 days.
         - When daysRemaining <= 7 and the engine reaches celebration or default-celebration states, override to suggest review/practice instead. Add a check: if testDate within 7 days and we'd normally show celebration, show `srs-due` if any SRS cards, or `weak-category` if any weak, or `no-recent-test` if no recent test. This ensures test-soon users always get actionable advice.
       - Keep changes MINIMAL. The NBA priority chain works well -- just prevent "everything is great" states when the test is imminent.

    3. **useNextBestAction.ts:**
       - Import useTestDate.
       - Call `const { testDate } = useTestDate();`
       - Pass `testDate` to `determineNextBestAction({ ...existingInput, testDate })`.
  </action>
  <verify>
    <automated>pnpm tsc --noEmit 2>&1 | head -30 && pnpm vitest run src/lib/nba/ -x 2>&1 | tail -10</automated>
  </verify>
  <done>
    Dashboard shows TestDateCountdownCard (with urgency gradient and date picker) and StudyPlanCard (with daily targets). PostTestPrompt appears when test date has passed. Settings page has test date row. Progress Hub shows compact countdown. NBA engine is test-date-aware (prevents celebration states when test is within 7 days). All UI is bilingual.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` -- no TypeScript errors
2. `pnpm vitest run src/lib/ -x` -- all unit tests pass (studyPlan + nba)
3. `pnpm build --webpack` -- production build succeeds
4. Visual: Dashboard shows "Set your test date" card when no date set
5. Visual: After setting a date, countdown card appears with urgency gradient and pace indicator
6. Visual: Study plan card shows daily targets with activity breakdown
7. Visual: Settings has test date row with native date picker
8. Visual: Post-test prompt appears when test date has passed
</verification>

<success_criteria>
- TestDateCountdownCard shows "Set your test date" when no date, countdown with urgency gradient when date is set
- Date picker uses native `<input type="date">` (zero new dependencies)
- Urgency gradient: green (>21 days), amber (8-21), red (<=7)
- Pace indicator shows "On Track" / "Behind" / "Ahead" from engine output
- StudyPlanCard shows SRS reviews, new questions, drill recommendation, mock test suggestion, and estimated time
- Each study plan activity row navigates to the correct route when tapped
- PostTestPrompt shows after test date passes with Pass/Reschedule options
- Settings page has "USCIS Test Date" row in a "Test Preparation" section
- Progress Hub shows compact countdown in header
- NBA engine prevents celebration states when test is within 7 days
- All text is bilingual (English + Burmese)
- TypeScript compiles, all tests pass, production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/44-test-date-countdown-and-study-plan/44-02-SUMMARY.md`
</output>
