---
phase: 30-mobile-native-feel
plan: 03
type: execute
wave: 2
depends_on: ["30-02"]
files_modified:
  - src/components/BilingualToast.tsx
autonomous: true
requirements:
  - MOBI-04

must_haves:
  truths:
    - "Toasts can be swiped left or right to dismiss them"
    - "A fast flick dismisses even if the swipe distance is short (velocity-based)"
    - "A partial swipe that doesn't cross the threshold springs back with a clean animation"
    - "Opacity fades proportionally to drag distance during swipe"
    - "Auto-dismiss timer pauses while the user is touching/dragging the toast"
    - "On dismiss, the toast flies off in the swipe direction with momentum"
    - "Desktop users can click the X button to dismiss (hover-revealed)"
    - "Each toast in a stack is individually swipeable"
    - "All toast types (error, success, info, warning) are swipeable"
  artifacts:
    - path: "src/components/BilingualToast.tsx"
      provides: "Swipe-to-dismiss toast system with motion/react drag"
      contains: "drag=\"x\""
  key_links:
    - from: "src/components/BilingualToast.tsx"
      to: "motion/react"
      via: "drag API with useMotionValue, useTransform, useAnimate"
      pattern: "useMotionValue|useTransform|onDragEnd"
    - from: "src/components/BilingualToast.tsx"
      to: "src/lib/haptics.ts"
      via: "hapticLight at dismiss threshold, hapticMedium on dismiss"
      pattern: "hapticLight|hapticMedium"
---

<objective>
Rewrite the Toast component with motion/react drag for swipe-to-dismiss with physics-based gestures.

Purpose: Make toast notifications feel native with horizontal swipe dismissal, spring-back physics, velocity-aware flick detection, and progressive opacity fade -- matching the established SwipeableCard.tsx drag pattern.

Output: Rewritten BilingualToast.tsx with motion/react drag on individual toasts, spring-back on partial swipe, velocity+offset dismiss threshold, auto-dismiss timer pause on touch, opacity fade, and desktop X button.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-mobile-native-feel/30-RESEARCH.md

@src/components/BilingualToast.tsx
@src/components/sort/SwipeableCard.tsx (reference pattern for drag API)
@src/lib/haptics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Toast component with motion/react swipe-to-dismiss</name>
  <files>src/components/BilingualToast.tsx</files>
  <action>
  Rewrite the inner `Toast` component (NOT ToastProvider or ToastContext -- those stay exactly the same) to use motion/react drag for horizontal swipe-to-dismiss. Follow the proven SwipeableCard.tsx drag pattern.

  **Toast component rewrite:**

  1. **Import additions:** Add `motion, useMotionValue, useTransform, useAnimate, PanInfo` from `motion/react`. Import `hapticLight, hapticMedium` from `@/lib/haptics`.

  2. **Drag setup:**
     - `const x = useMotionValue(0);`
     - `const opacity = useTransform(x, [-150, 0, 150], [0, 1, 0]);` -- progressive fade proportional to drag distance
     - `const [scope, animate] = useAnimate<HTMLDivElement>();`

  3. **Auto-dismiss timer with pause:**
     - Track `isPaused` state (useState). When dragging starts, set isPaused to true. When drag ends without dismiss, set isPaused to false.
     - The auto-dismiss useEffect should use a `remainingTime` approach: track remaining time in a ref, decrement while not paused, clear and restart timer when isPaused changes.
     - Simpler approach: use `isPaused` in a ref. On mount, start a timeout for `toast.duration`. On drag start, clear the timeout and record elapsed time. On drag end (spring back), restart timeout with remaining time.

  4. **handleDragEnd callback:**
     ```tsx
     const handleDragEnd = useCallback((_: unknown, info: PanInfo) => {
       const { offset, velocity } = info;
       const DISMISS_THRESHOLD = 100;  // px
       const VELOCITY_THRESHOLD = 500; // px/s

       const isDismissed =
         Math.abs(offset.x) > DISMISS_THRESHOLD ||
         Math.abs(velocity.x) > VELOCITY_THRESHOLD;

       if (isDismissed) {
         hapticMedium(); // Haptic on dismiss
         const exitX = offset.x > 0 ? 400 : -400;
         animate(scope.current, { x: exitX, opacity: 0 }, {
           type: 'spring', velocity: velocity.x, stiffness: 200, damping: 30
         }).then(() => onDismiss(toast.id));
       } else {
         // Spring back
         animate(scope.current, { x: 0, opacity: 1 }, {
           type: 'spring', stiffness: 500, damping: 30
         });
         // Resume auto-dismiss timer
       }
     }, [animate, scope, onDismiss, toast.id]);
     ```

  5. **Haptic feedback at drag threshold:**
     Track whether the threshold has been crossed during drag using a ref. When `Math.abs(x.get())` first exceeds `DISMISS_THRESHOLD`, fire `hapticLight()` to signal "ready to dismiss". Use `x.on('change', ...)` in an effect to track this (clean up the subscription on unmount). Avoid firing hapticLight repeatedly -- use a boolean ref to track "threshold crossed" and reset on drag end.

  6. **motion.div wrapper:**
     ```tsx
     <motion.div
       ref={scope}
       style={{ x, opacity }}
       drag="x"
       dragElastic={0.3}       // Slight elastic resistance at start
       dragMomentum={false}    // Handle momentum manually in onDragEnd
       onDragStart={() => { /* pause timer */ }}
       onDragEnd={handleDragEnd}
       className="touch-action-pan-y"  // Let vertical scroll pass through
     >
     ```
     Add `touch-action: pan-y` as an inline style or via a class to prevent toast drag from blocking page scroll.

  7. **Desktop X button:** Keep the existing dismiss X button. Make it opacity-0 by default and group-hover:opacity-100 so it reveals on hover (desktop). On mobile it's always accessible via swipe.

  8. **Ghost trail effect:** On dismiss animation, the opacity already fades to 0 via the spring animation. For the "faint ghost trail" effect, add a brief `filter: blur(2px)` to the exit animation: `animate(scope.current, { x: exitX, opacity: 0, filter: 'blur(2px)' }, ...)`. This creates a subtle motion blur as the toast flies off.

  9. **Background dimming:** Skip for now -- the progressive opacity fade on the toast itself provides sufficient visual feedback during drag. The 5-10% background dimming is a nice-to-have but adds complexity (requires a sibling overlay element driven by motion values) that can be added later if needed.

  **ToastContainer changes:**
  - Move toast positioning to bottom-center on mobile, top-right on desktop. Use responsive classes: `fixed bottom-20 left-4 right-4 z-[9999] flex flex-col-reverse gap-3 sm:top-4 sm:bottom-auto sm:left-auto sm:max-w-sm sm:flex-col`. The `bottom-20` on mobile clears the BottomTabBar. Use `flex-col-reverse` on mobile so newest toast appears closest to thumb. On desktop (sm+), revert to top-right with normal flex-col.
  - Add `style={{ bottom: 'calc(env(safe-area-inset-bottom, 0px) + 5rem)' }}` on mobile to account for safe area (replace the `bottom-20` Tailwind class with this inline style, or use a combined approach).

  **Keep unchanged:**
  - ToastProvider, ToastContext, useToast hook, generateId, DEFAULT_DURATIONS, ToastType, ToastInstance interfaces -- ALL stay exactly as-is
  - Toast role attributes (alert for error/warning, status for success/info)
  - Bilingual message rendering (en on top, my below with showBurmese gate)
  - Type-specific styling (typeStyles, typeIcons)

  **Do NOT:**
  - Use `@use-gesture/react` (explicitly out of scope per REQUIREMENTS.md)
  - Set `dragMomentum={true}` (causes double-fire dismiss per Pitfall 7)
  - Add `touch-action: none` (blocks scroll -- use `pan-y` instead)
  </action>
  <verify>
  - `npm run build` succeeds
  - `npm run typecheck` passes
  - `npm run lint` passes
  - Grep `drag="x"` appears in BilingualToast.tsx
  - Grep `useMotionValue` appears in BilingualToast.tsx
  - Grep `onDragEnd` appears in BilingualToast.tsx
  - Grep `hapticLight\|hapticMedium` appears in BilingualToast.tsx
  - Grep `dragMomentum={false}` appears in BilingualToast.tsx
  - Existing toast consumers (useToast hook) require no changes -- API is unchanged
  </verify>
  <done>
  Toast component uses motion/react drag="x" for horizontal swipe dismissal. Velocity+offset threshold for dismiss detection. Spring-back on partial swipe. Progressive opacity fade during drag. Auto-dismiss timer pauses on touch. Desktop X button (hover-revealed). Haptic feedback at threshold and on dismiss. Mobile toasts positioned bottom-center above tab bar. All toast types swipeable. ToastProvider API unchanged.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm run typecheck` passes
- `npm run lint` passes
- Toast component uses motion/react drag with proper physics
- Swipe-to-dismiss works in both directions
- Auto-dismiss timer pauses during drag
- Desktop X button still works
- Toast API (useToast) is unchanged
</verification>

<success_criteria>
1. Toasts are swipeable left and right with velocity-aware dismiss
2. Spring-back animation on partial swipe
3. Progressive opacity fade during drag
4. Auto-dismiss timer pauses while dragging
5. Desktop X button visible on hover
6. Haptic feedback at threshold and on dismiss
7. Mobile toasts positioned bottom-center above tab bar
8. Build, typecheck, and lint all pass
</success_criteria>

<output>
After completion, create `.planning/phases/30-mobile-native-feel/30-03-SUMMARY.md`
</output>
