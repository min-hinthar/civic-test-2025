---
phase: 23-flashcard-sort
plan: 04
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/components/sort/SwipeableCard.tsx
  - src/components/sort/SwipeableStack.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag a card horizontally with rotation following finger position"
    - "Card shows green overlay when dragged right and amber overlay when dragged left"
    - "Fast flick commits regardless of distance; slow drag needs ~40% card width"
    - "Card flings off-screen with spring physics and velocity inheritance on commit"
    - "Card snaps back to center with spring animation when drag does not commit"
    - "2-3 cards visible behind active card with offset and scale transforms"
    - "Only top card receives pointer events"
  artifacts:
    - path: "src/components/sort/SwipeableCard.tsx"
      provides: "Single draggable card with rotation, color overlay, and fling animation"
      exports: ["SwipeableCard"]
    - path: "src/components/sort/SwipeableStack.tsx"
      provides: "Stacked deck rendering 2-3 visible cards with the active card on top"
      exports: ["SwipeableStack"]
  key_links:
    - from: "src/components/sort/SwipeableCard.tsx"
      to: "src/components/study/Flashcard3D.tsx"
      via: "Renders Flashcard3D as card content inside draggable wrapper"
      pattern: "Flashcard3D"
    - from: "src/components/sort/SwipeableStack.tsx"
      to: "src/components/sort/SwipeableCard.tsx"
      via: "Renders SwipeableCard for active card, static previews for stack"
      pattern: "SwipeableCard"
---

<objective>
Build the Tinder-style swipeable card and stacked deck components.

Purpose: This is the core visual interaction of sort mode -- the card follows the finger, rotates, shows color overlays, and flings off-screen. The stack shows upcoming cards behind the active one. These components are purely presentational -- they receive callbacks and don't manage sort state directly.

Output: `SwipeableCard.tsx` (draggable card) and `SwipeableStack.tsx` (deck renderer).
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/study/FlashcardStack.tsx (existing swipe pattern reference)
@src/components/study/Flashcard3D.tsx (card content to render inside swipeable wrapper)
@src/lib/sort/sortTypes.ts (SortPhase type for animation gating)
@.planning/phases/23-flashcard-sort/23-RESEARCH.md
@.planning/phases/23-flashcard-sort/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SwipeableCard component</name>
  <files>src/components/sort/SwipeableCard.tsx</files>
  <action>
Create `src/components/sort/SwipeableCard.tsx` -- a single draggable card with Tinder-style fling gesture.

**Props interface:**
```typescript
interface SwipeableCardProps {
  question: Question;
  onSwipe: (direction: 'know' | 'dont-know') => void;
  onAnimationComplete: () => void;
  isAnimating: boolean; // true when fling animation in progress
  showBurmese: boolean;
  speedLabel: string;
  className?: string;
}
```

**Implementation using motion/react:**

1. **Motion values:** Use `useMotionValue(0)` for x position. Use `useTransform` to derive:
   - `rotate`: maps x [-200, 0, 200] -> [-15, 0, 15] degrees
   - `knowOpacity`: maps x [0, 100, 200] -> [0, 0.3, 0.6] (green overlay)
   - `dontKnowOpacity`: maps x [-200, -100, 0] -> [0.6, 0.3, 0] (amber overlay)

2. **Drag handling:** Use `drag="x"` with `dragElastic={1}` and NO dragConstraints (constraints fight the fling). Handle commit in `onDragEnd`:
   - Get `offset.x` and `velocity.x` from PanInfo
   - Calculate card width from ref: `scope.current?.offsetWidth ?? 300`
   - Threshold: `cardWidth * 0.4`
   - Commit if: `Math.abs(velocity.x) > 800 || Math.abs(offset.x) > threshold`
   - Direction: `offset.x > 0 ? 'know' : 'dont-know'`

3. **Fling animation (commit):** Use `useAnimate` scope + animate:
   - Exit x: `direction === 'know' ? window.innerWidth + 100 : -(window.innerWidth + 100)`
   - Exit rotation: `direction === 'know' ? 30 : -30`
   - Spring config: `{ type: 'spring', velocity: velocity.x, stiffness: 200, damping: 30 }`
   - After animation completes (`.then()`): call `onSwipe(direction)` then `onAnimationComplete()`

4. **Snap back (no commit):** Animate to `{ x: 0, rotate: 0 }` with spring `{ stiffness: 500, damping: 30 }`

5. **Click/tap vs drag conflict:** Track `isDragging` via `onDragStart` (set true) and after animation/snapback (set false). The Flashcard3D flip should be suppressed during drag. Pass a `disableFlip` prop or use a wrapper that intercepts onClick when isDragging is true.

6. **Card content:** Render `Flashcard3D` inside the motion.div. Wrap with relative positioning. Pass through all required Flashcard3D props (questionId, questionEn, questionMy, answerEn, answerMy, category, etc.).

7. **Color overlays:** Two absolutely positioned divs inside the card wrapper:
   - Green overlay: `style={{ opacity: knowOpacity }}` with class `bg-success/30 rounded-2xl`
   - Amber overlay: `style={{ opacity: dontKnowOpacity }}` with class `bg-warning/30 rounded-2xl`
   - Both: `absolute inset-0 pointer-events-none z-10 rounded-2xl`

8. **Zone labels:** Two text labels at edges that appear during drag:
   - Right side: "Know" / "သိပါတယ်" (bilingual per FLSH-08) -- opacity tied to knowOpacity
   - Left side: "Don't Know" / "မသိပါ" (bilingual per FLSH-08) -- opacity tied to dontKnowOpacity
   - Position as absolutely positioned text outside the card bounds or at card edges
   - Use `motion.div` with `style={{ opacity: knowOpacity }}` or `style={{ opacity: dontKnowOpacity }}`

9. **Reduced motion:** If `useReducedMotion()` returns true, disable drag entirely. Swipe only via buttons (handled by parent).

10. **Accessibility:** Add `role="group"` with `aria-label="Sort card: {question text}"`. Add `aria-live="polite"` region that announces sort result after swipe.

Use `'use client'` directive. Import from `motion/react` (NOT `framer-motion`).
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run lint -- --no-warn-ignored` -- compiles and lints cleanly.</verify>
  <done>SwipeableCard renders Flashcard3D inside a draggable wrapper with rotation, green/amber overlays, velocity-based commit threshold, spring fling animation, and bilingual zone labels.</done>
</task>

<task type="auto">
  <name>Task 2: SwipeableStack component</name>
  <files>src/components/sort/SwipeableStack.tsx</files>
  <action>
Create `src/components/sort/SwipeableStack.tsx` -- renders 2-3 stacked cards with the active one on top.

**Props interface:**
```typescript
interface SwipeableStackProps {
  cards: Question[];
  currentIndex: number;
  isAnimating: boolean;
  onSwipe: (direction: 'know' | 'dont-know') => void;
  onAnimationComplete: () => void;
  showBurmese: boolean;
  speedLabel: string;
  className?: string;
}
```

**Implementation:**

1. **Visible cards:** Slice `cards` from `currentIndex` to `currentIndex + 3` (max 3 visible).

2. **Stack layout:** Use a `relative` container. Each card is positioned:
   - Active card (i=0): `position: 'relative'`, `z-index: 3`, full opacity, `pointerEvents: 'auto'`
   - Card i=1: `position: 'absolute'`, `z-index: 2`, `transform: scale(0.96) translateY(8px)`, `opacity: 0.85`, `pointerEvents: 'none'`
   - Card i=2: `position: 'absolute'`, `z-index: 1`, `transform: scale(0.92) translateY(16px)`, `opacity: 0.7`, `pointerEvents: 'none'`

3. **Active card:** Render as `SwipeableCard` with full interaction.

4. **Behind cards:** Render as static card previews (just the question text in a styled div, NOT full Flashcard3D -- too heavy for hidden cards). Show category color strip and question text only. Use `motion.div` with `initial` and `animate` for subtle scale-up when the card in front is swiped away.

5. **Category hint tag:** Show a subtle category tag on each card (per locked decision about drill round category hints). Small pill badge with category name (e.g., "American Government") at top of card.

6. **Empty state:** When no cards remain at currentIndex, render nothing or a placeholder.

7. **Key prop:** Use `cards[currentIndex + i]?.id` as key for each card slot to trigger proper animations.

8. **Background zone labels:** Behind the entire stack, show fixed "Know" and "Don't Know" labels on left and right sides. These are always visible but at low opacity, becoming more prominent as the card is dragged (via CSS -- the card overlay handles the dynamic opacity).

Use `'use client'` directive.
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run lint -- --no-warn-ignored` -- compiles and lints cleanly.</verify>
  <done>SwipeableStack renders 2-3 stacked cards with proper z-indexing, scale/offset transforms, pointer event isolation, and category hint tags. Active card is interactive SwipeableCard, behind cards are static previews.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run lint -- --no-warn-ignored` passes
3. SwipeableCard imports from `motion/react` (not `framer-motion`)
4. Only top card has `pointerEvents: 'auto'`
5. Velocity threshold and distance threshold both checked in commit logic
</verification>

<success_criteria>
- Card follows finger with rotation transform derived from x motion value
- Green/amber overlays appear during drag with opacity proportional to drag distance
- Fast flick (velocity > 800) always commits; slow drag needs 40% card width
- Fling animation uses spring physics with velocity inheritance
- Stack shows 2-3 cards with decreasing scale and increasing offset
- Bilingual zone labels visible during drag (FLSH-08)
</success_criteria>

<output>
After completion, create `.planning/phases/23-flashcard-sort/23-04-SUMMARY.md`
</output>
