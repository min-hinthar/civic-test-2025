---
phase: 08-critical-integration-fixes
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/lib/pwa/offlineDb.ts
  - src/lib/pwa/syncQueue.ts
  - src/contexts/SupabaseAuthContext.tsx
autonomous: true

must_haves:
  truths:
    - "User takes a test while offline and results are queued in IndexedDB sync queue"
    - "User goes back online and queued test results automatically sync to Supabase"
    - "Test results taken offline appear immediately in history from IndexedDB (local-first)"
    - "Silent automatic retry with bilingual error toast only on permanent failure"
  artifacts:
    - path: "src/lib/pwa/offlineDb.ts"
      provides: "PendingTestResult with full session data matching Supabase schema"
      contains: "PendingTestResult"
    - path: "src/lib/pwa/syncQueue.ts"
      provides: "syncSingleResult that inserts to Supabase with full bilingual response data"
      contains: "mock_test_responses"
    - path: "src/contexts/SupabaseAuthContext.tsx"
      provides: "Offline fallback in saveTestSession catch block"
      contains: "queueTestResult"
  key_links:
    - from: "src/contexts/SupabaseAuthContext.tsx"
      to: "src/lib/pwa/offlineDb.ts"
      via: "queueTestResult called in saveTestSession catch block"
      pattern: "queueTestResult"
    - from: "src/lib/pwa/syncQueue.ts"
      to: "supabase.from('mock_tests')"
      via: "syncSingleResult inserts to Supabase with same schema as saveTestSession"
      pattern: "mock_tests.*insert"
    - from: "src/contexts/SupabaseAuthContext.tsx"
      to: "user.testHistory"
      via: "offline session added to local testHistory immediately"
      pattern: "testHistory.*offlineSession"
---

<objective>
Wire offline test result saving to the existing sync queue infrastructure so that tests taken offline are queued in IndexedDB and automatically sync to Supabase when connectivity returns.

Purpose: Close the critical gap where offline test results are lost. The sync queue, auto-sync on reconnect, and SyncStatusIndicator all exist — they just need to be connected to the test save flow.
Output: Complete offline-to-online test result sync pipeline
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-critical-integration-fixes/08-RESEARCH.md
@src/lib/pwa/offlineDb.ts
@src/lib/pwa/syncQueue.ts
@src/contexts/SupabaseAuthContext.tsx
@src/contexts/OfflineContext.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PendingTestResult to match Supabase schema and update syncSingleResult</name>
  <files>
    src/lib/pwa/offlineDb.ts
    src/lib/pwa/syncQueue.ts
  </files>
  <action>
    **1a. Refactor PendingTestResult interface in offlineDb.ts:**

    Replace the current `PendingTestResult` interface (lines 88-103) with a new interface that stores the FULL session data matching what `saveTestSession` sends to Supabase. The new interface should be:

    ```typescript
    export interface PendingTestResult {
      id: string;
      userId: string;
      completedAt: string;
      score: number;
      totalQuestions: number;
      durationSeconds: number;
      incorrectCount: number;
      passed: boolean;
      endReason: string;
      responses: Array<{
        questionId: string;
        questionText_en: string;
        questionText_my: string;
        category: string;
        selectedAnswer_en: string;
        selectedAnswer_my: string;
        correctAnswer_en: string;
        correctAnswer_my: string;
        isCorrect: boolean;
      }>;
    }
    ```

    Key changes from old interface:
    - Added `completedAt` (was `createdAt`, needs to match Supabase `completed_at`)
    - Added `incorrectCount` (missing from old interface)
    - Response objects now include full bilingual text fields: `questionText_en`, `questionText_my`, `category`, `selectedAnswer_en`, `selectedAnswer_my`, `correctAnswer_en`, `correctAnswer_my`, `isCorrect`
    - Removed `timeSpentSeconds` from responses (Supabase doesn't store this)
    - Removed the simplified `selectedAnswer`/`correct` fields

    The `queueTestResult` function signature stays the same: `(result: Omit<PendingTestResult, 'id'>) => Promise<string>`

    **1b. Update syncSingleResult in syncQueue.ts:**

    Rewrite the `syncSingleResult` function to match the EXACT Supabase insert logic from `saveTestSession` in SupabaseAuthContext.tsx. The sync function must:

    1. Insert into `mock_tests` table with fields: `user_id`, `completed_at`, `score`, `total_questions`, `duration_seconds`, `incorrect_count`, `end_reason`, `passed` — using `.select('id').single()` to get the generated ID
    2. Insert into `mock_test_responses` table with fields: `mock_test_id`, `question_id`, `question_en`, `question_my`, `category`, `selected_answer_en`, `selected_answer_my`, `correct_answer_en`, `correct_answer_my`, `is_correct`
    3. Map the PendingTestResult fields to Supabase column names:
       - `data.userId` → `user_id`
       - `data.completedAt` → `completed_at`
       - `data.totalQuestions` → `total_questions`
       - `data.durationSeconds` → `duration_seconds`
       - `data.incorrectCount` → `incorrect_count`
       - `data.endReason` → `end_reason`
       - Response: `r.questionText_en` → `question_en`, `r.questionText_my` → `question_my`, etc.
    4. Keep the existing exponential backoff retry logic (MAX_RETRIES=5, BASE_DELAY_MS=1000)
    5. Keep `removeSyncedResult(key)` on success

    Do NOT add profile sync (`syncProfile`) to the sync queue path — the profile was already synced during the original save attempt. The sync queue only needs to replay the data insert.
  </action>
  <verify>
    - `pnpm run typecheck` passes (no type errors in offlineDb.ts or syncQueue.ts)
    - `pnpm exec eslint src/lib/pwa/offlineDb.ts src/lib/pwa/syncQueue.ts --max-warnings=0` passes
    - The PendingTestResult interface has `incorrectCount`, `completedAt`, and full bilingual response fields
    - syncSingleResult inserts to both `mock_tests` and `mock_test_responses` with the correct column names
  </verify>
  <done>
    PendingTestResult stores full session data matching Supabase schema. syncSingleResult inserts data identically to saveTestSession.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add offline fallback in saveTestSession catch block</name>
  <files>
    src/contexts/SupabaseAuthContext.tsx
  </files>
  <action>
    Modify the `saveTestSession` function in `SupabaseAuthContext.tsx` to catch network/offline errors and queue the session for later sync instead of losing the data.

    **In the catch block (currently lines 315-317):**

    Replace the simple `throw error` with offline-aware error handling:

    ```typescript
    } catch (error) {
      // Check if this is a network/offline error
      const isNetworkError =
        error instanceof TypeError && error.message.includes('fetch') ||
        error instanceof Error && (
          error.message.includes('Failed to fetch') ||
          error.message.includes('NetworkError') ||
          error.message.includes('network') ||
          error.message.includes('ERR_INTERNET_DISCONNECTED')
        ) ||
        !navigator.onLine;

      if (isNetworkError) {
        // Queue for offline sync
        const pendingResult = {
          userId: user.id,
          completedAt: session.date,
          score: session.score,
          totalQuestions: session.totalQuestions,
          durationSeconds: session.durationSeconds,
          incorrectCount: session.incorrectCount,
          passed: session.passed,
          endReason: session.endReason,
          responses: session.results.map(r => ({
            questionId: r.questionId,
            questionText_en: r.questionText_en,
            questionText_my: r.questionText_my,
            category: r.category,
            selectedAnswer_en: r.selectedAnswer.text_en,
            selectedAnswer_my: r.selectedAnswer.text_my,
            correctAnswer_en: r.correctAnswer.text_en,
            correctAnswer_my: r.correctAnswer.text_my,
            isCorrect: r.isCorrect,
          })),
        };

        await queueTestResult(pendingResult);

        // Add to local history immediately (local-first display)
        const offlineSession: TestSession = {
          ...session,
          id: `offline-${Date.now()}`,
        };

        setUser(prev =>
          prev ? { ...prev, testHistory: [offlineSession, ...prev.testHistory] } : prev
        );

        // Don't throw — the result is saved locally and will sync later
        // The caller (TestPage) will show its normal success flow
        return;
      }

      // Non-network errors: log and re-throw for caller to handle
      console.error('Failed to save mock test session', error);
      throw error;
    }
    ```

    **Important implementation notes:**

    1. Import `queueTestResult` from `@/lib/pwa/offlineDb` at the top of the file
    2. The offline session gets a client-side ID (`offline-${Date.now()}`). When the sync eventually succeeds and `hydrateFromSupabase` is called on next login, it will replace local data with server data.
    3. Do NOT show a toast in SupabaseAuthContext — the caller (TestPage) handles success/failure display. By returning normally (no throw), the test page shows its normal completion flow. The user doesn't know or care that it was saved offline.
    4. The existing `OfflineContext` auto-sync will pick up the queued item when connectivity returns, and the existing `SyncStatusIndicator` will show the pending count.
    5. The `setUser` call to add to testHistory is the same pattern used in the online success path (line 311-313).
    6. Keep the `console.error` for non-network errors.
    7. The `guard.reset()` call after the try/catch (line 324) will still execute for both paths.
  </action>
  <verify>
    - `pnpm run typecheck` passes
    - `pnpm exec eslint src/contexts/SupabaseAuthContext.tsx --max-warnings=0` passes
    - The catch block checks for network errors and queues to IndexedDB via queueTestResult
    - The offline session appears in local testHistory immediately
    - Non-network errors still throw (preserving existing error handling for server-side failures)
    - `queueTestResult` is imported from `@/lib/pwa/offlineDb`
  </verify>
  <done>
    When offline, saveTestSession queues the full session to IndexedDB and adds it to local history. The test page shows normal success. When back online, existing auto-sync infrastructure syncs to Supabase.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run typecheck` — zero errors
2. `pnpm run lint` — zero errors (depends on 08-01 completing first)
3. `pnpm run build` — succeeds
4. Code review: `grep "queueTestResult" src/contexts/SupabaseAuthContext.tsx` — import and usage present
5. Code review: `grep "incorrectCount" src/lib/pwa/offlineDb.ts` — field present in PendingTestResult
6. Code review: `grep "mock_test_responses" src/lib/pwa/syncQueue.ts` — sync inserts to responses table
7. Code review: `grep "offline-" src/contexts/SupabaseAuthContext.tsx` — offline session ID pattern present
</verification>

<success_criteria>
- PendingTestResult interface matches the full Supabase session schema (bilingual text, incorrectCount, completedAt)
- syncSingleResult inserts to both mock_tests and mock_test_responses with correct column mapping
- saveTestSession catches network errors and queues to IndexedDB instead of throwing
- Offline test sessions appear immediately in local testHistory
- Non-network errors still propagate to the caller
- All type checks and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-critical-integration-fixes/08-02-SUMMARY.md`
</output>
