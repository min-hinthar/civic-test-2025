---
phase: 02-pwa-offline
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/hooks/useInstallPrompt.ts
  - src/components/pwa/InstallPrompt.tsx
  - src/components/pwa/WelcomeModal.tsx
  - src/components/pwa/NotificationPrePrompt.tsx
  - src/contexts/OfflineContext.tsx
  - src/AppShell.tsx
autonomous: true

must_haves:
  truths:
    - "User sees bilingual install prompt on first visit"
    - "User can install app from custom prompt"
    - "User sees welcome modal after installation"
    - "Notification permission is requested in welcome modal with pre-prompt"
  artifacts:
    - path: "src/hooks/useInstallPrompt.ts"
      provides: "Hook to capture and trigger beforeinstallprompt"
      exports: ["useInstallPrompt"]
    - path: "src/components/pwa/InstallPrompt.tsx"
      provides: "Bilingual install prompt UI"
      exports: ["InstallPrompt"]
    - path: "src/components/pwa/WelcomeModal.tsx"
      provides: "Post-install welcome with offline tips and notification opt-in"
      exports: ["WelcomeModal"]
  key_links:
    - from: "src/components/pwa/InstallPrompt.tsx"
      to: "src/hooks/useInstallPrompt.ts"
      via: "hook import"
      pattern: "useInstallPrompt"
    - from: "src/components/pwa/WelcomeModal.tsx"
      to: "src/components/pwa/NotificationPrePrompt.tsx"
      via: "component import"
      pattern: "NotificationPrePrompt"
---

<objective>
Create install prompt, welcome modal, and notification permission flow.

Purpose: Per user decisions - install prompt shown immediately on first visit (bilingual), post-install welcome modal with offline tips, notification permission requested during onboarding with pre-prompt explanation.
Output: Complete install-to-onboarding flow with bilingual UI.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-pwa-offline/02-RESEARCH.md
@.planning/phases/02-pwa-offline/02-01-SUMMARY.md
@.planning/phases/02-pwa-offline/02-02-SUMMARY.md

@src/AppShell.tsx
@src/components/BilingualToast.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create install prompt hook and component</name>
  <files>
    src/hooks/useInstallPrompt.ts
    src/components/pwa/InstallPrompt.tsx
  </files>
  <action>
1. Create src/hooks/useInstallPrompt.ts:
   ```typescript
   import { useState, useEffect, useCallback } from "react";

   interface BeforeInstallPromptEvent extends Event {
     prompt(): Promise<void>;
     userChoice: Promise<{ outcome: "accepted" | "dismissed" }>;
   }

   interface UseInstallPromptResult {
     canInstall: boolean;
     isInstalled: boolean;
     isIOS: boolean;
     promptInstall: () => Promise<boolean>;
     dismissPrompt: () => void;
     wasDismissed: boolean;
   }

   const DISMISSED_KEY = "pwa-install-dismissed";
   const DISMISSED_UNTIL_KEY = "pwa-install-dismissed-until";

   export function useInstallPrompt(): UseInstallPromptResult {
     const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);
     const [isInstalled, setIsInstalled] = useState(false);
     const [wasDismissed, setWasDismissed] = useState(false);

     // Detect iOS (no beforeinstallprompt)
     const isIOS = typeof navigator !== "undefined" &&
       /iPad|iPhone|iPod/.test(navigator.userAgent);

     useEffect(() => {
       // Check if already installed
       if (typeof window !== "undefined") {
         if (window.matchMedia("(display-mode: standalone)").matches) {
           setIsInstalled(true);
           return;
         }

         // Check iOS standalone mode
         if ((navigator as unknown as { standalone?: boolean }).standalone) {
           setIsInstalled(true);
           return;
         }

         // Check if previously dismissed (with expiry)
         const dismissedUntil = localStorage.getItem(DISMISSED_UNTIL_KEY);
         if (dismissedUntil && Date.now() < parseInt(dismissedUntil, 10)) {
           setWasDismissed(true);
         }
       }

       const handleBeforeInstall = (e: Event) => {
         e.preventDefault();
         setDeferredPrompt(e as BeforeInstallPromptEvent);
       };

       const handleAppInstalled = () => {
         setIsInstalled(true);
         setDeferredPrompt(null);
         // Store that we've been installed
         localStorage.setItem("pwa-installed", "true");
       };

       window.addEventListener("beforeinstallprompt", handleBeforeInstall);
       window.addEventListener("appinstalled", handleAppInstalled);

       return () => {
         window.removeEventListener("beforeinstallprompt", handleBeforeInstall);
         window.removeEventListener("appinstalled", handleAppInstalled);
       };
     }, []);

     const promptInstall = useCallback(async (): Promise<boolean> => {
       if (!deferredPrompt) return false;

       await deferredPrompt.prompt();
       const { outcome } = await deferredPrompt.userChoice;
       setDeferredPrompt(null);

       return outcome === "accepted";
     }, [deferredPrompt]);

     const dismissPrompt = useCallback(() => {
       setWasDismissed(true);
       // Re-prompt after 7 days (Claude's discretion for re-prompt strategy)
       const dismissUntil = Date.now() + 7 * 24 * 60 * 60 * 1000;
       localStorage.setItem(DISMISSED_UNTIL_KEY, String(dismissUntil));
     }, []);

     return {
       canInstall: !!deferredPrompt && !wasDismissed,
       isInstalled,
       isIOS,
       promptInstall,
       dismissPrompt,
       wasDismissed,
     };
   }
   ```

2. Create src/components/pwa/InstallPrompt.tsx (using modal style per Claude's discretion):
   ```typescript
   import React, { useState, useEffect } from "react";
   import { X, Download, Share } from "lucide-react";
   import { useInstallPrompt } from "@/hooks/useInstallPrompt";

   interface InstallPromptProps {
     onInstalled?: () => void;
   }

   export function InstallPrompt({ onInstalled }: InstallPromptProps) {
     const { canInstall, isInstalled, isIOS, promptInstall, dismissPrompt } = useInstallPrompt();
     const [showIOSInstructions, setShowIOSInstructions] = useState(false);

     // Don't render if installed or can't install (and not iOS first visit)
     if (isInstalled) return null;

     // Show on first visit per user decision
     const shouldShow = canInstall || (isIOS && !localStorage.getItem("ios-install-shown"));

     if (!shouldShow && !showIOSInstructions) return null;

     const handleInstall = async () => {
       const accepted = await promptInstall();
       if (accepted) {
         onInstalled?.();
       }
     };

     const handleDismiss = () => {
       dismissPrompt();
       if (isIOS) {
         localStorage.setItem("ios-install-shown", "true");
       }
     };

     const handleIOSClick = () => {
       setShowIOSInstructions(true);
     };

     return (
       <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
         <div className="relative w-full max-w-md rounded-lg bg-white p-6 shadow-xl dark:bg-gray-800">
           {/* Close button */}
           <button
             onClick={handleDismiss}
             className="absolute right-3 top-3 p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
             aria-label="Close"
           >
             <X className="h-5 w-5" />
           </button>

           {/* Icon */}
           <div className="mb-4 flex justify-center">
             <div className="flex h-16 w-16 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900">
               <Download className="h-8 w-8 text-blue-600 dark:text-blue-400" />
             </div>
           </div>

           {/* Bilingual title */}
           <h2 className="mb-2 text-center text-xl font-semibold text-gray-900 dark:text-white">
             Install US Civics App
           </h2>
           <p className="mb-4 text-center font-myanmar text-lg text-gray-600 dark:text-gray-300">
             US Civics အက်ပ်ကို ထည့်သွင်းပါ
           </p>

           {/* Bilingual description */}
           <p className="mb-2 text-center text-sm text-gray-600 dark:text-gray-400">
             Study offline, anytime, anywhere.
           </p>
           <p className="mb-6 text-center font-myanmar text-sm text-gray-600 dark:text-gray-400">
             အင်တာနက်မရှိလည်း လေ့လာနိုင်ပါသည်။
           </p>

           {isIOS ? (
             showIOSInstructions ? (
               <div className="space-y-3">
                 <p className="text-sm text-gray-700 dark:text-gray-300">
                   1. Tap the <Share className="inline h-4 w-4" /> Share button
                 </p>
                 <p className="text-sm text-gray-700 dark:text-gray-300">
                   2. Select "Add to Home Screen"
                 </p>
                 <p className="font-myanmar text-sm text-gray-600 dark:text-gray-400">
                   ၁။ Share ခလုတ်ကို နှိပ်ပါ
                 </p>
                 <p className="font-myanmar text-sm text-gray-600 dark:text-gray-400">
                   ၂။ "Add to Home Screen" ကို ရွေးပါ
                 </p>
                 <button
                   onClick={handleDismiss}
                   className="mt-4 w-full rounded-lg bg-gray-200 px-4 py-2 font-medium text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600"
                 >
                   Got it / နားလည်ပါပြီ
                 </button>
               </div>
             ) : (
               <button
                 onClick={handleIOSClick}
                 className="w-full rounded-lg bg-[#002868] px-4 py-3 font-medium text-white hover:bg-blue-800"
               >
                 Show me how / ပြသပါ
               </button>
             )
           ) : (
             <button
               onClick={handleInstall}
               className="w-full rounded-lg bg-[#002868] px-4 py-3 font-medium text-white hover:bg-blue-800"
             >
               Install Now / အခုထည့်သွင်းပါ
             </button>
           )}

           <button
             onClick={handleDismiss}
             className="mt-3 w-full text-center text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
           >
             Maybe later / နောက်မှ
           </button>
         </div>
       </div>
     );
   }
   ```
  </action>
  <verify>
    pnpm run typecheck passes
    pnpm run lint passes
  </verify>
  <done>
    useInstallPrompt captures browser event, InstallPrompt shows bilingual modal with iOS fallback
  </done>
</task>

<task type="auto">
  <name>Task 2: Create welcome modal and notification pre-prompt</name>
  <files>
    src/components/pwa/WelcomeModal.tsx
    src/components/pwa/NotificationPrePrompt.tsx
  </files>
  <action>
1. Create src/components/pwa/NotificationPrePrompt.tsx:
   ```typescript
   import React, { useState } from "react";
   import { Bell, X } from "lucide-react";

   interface NotificationPrePromptProps {
     onAccept: () => void;
     onDecline: () => void;
   }

   export function NotificationPrePrompt({ onAccept, onDecline }: NotificationPrePromptProps) {
     return (
       <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-700 dark:bg-gray-800">
         <div className="flex items-start gap-3">
           <div className="flex h-10 w-10 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900">
             <Bell className="h-5 w-5 text-blue-600 dark:text-blue-400" />
           </div>
           <div className="flex-1">
             <h3 className="font-medium text-gray-900 dark:text-white">
               Get study reminders?
             </h3>
             <p className="font-myanmar text-sm text-gray-600 dark:text-gray-400">
               လေ့လာရန် သတိပေးချက် လိုချင်ပါသလား။
             </p>
             <p className="mt-1 text-sm text-gray-600 dark:text-gray-400">
               We'll send friendly reminders to help you stay on track.
             </p>
             <p className="font-myanmar text-sm text-gray-500 dark:text-gray-500">
               လေ့လာမှု ပုံမှန်ဖြစ်အောင် သတိပေးပေးပါမယ်။
             </p>
             <div className="mt-3 flex gap-2">
               <button
                 onClick={onAccept}
                 className="rounded-md bg-[#002868] px-3 py-1.5 text-sm font-medium text-white hover:bg-blue-800"
               >
                 Yes, remind me / ဟုတ်ကဲ့
               </button>
               <button
                 onClick={onDecline}
                 className="rounded-md bg-gray-200 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
               >
                 No thanks / မလိုပါ
               </button>
             </div>
           </div>
         </div>
       </div>
     );
   }
   ```

2. Create src/components/pwa/WelcomeModal.tsx:
   ```typescript
   import React, { useState } from "react";
   import { X, WifiOff, RefreshCw, Smartphone } from "lucide-react";
   import { NotificationPrePrompt } from "./NotificationPrePrompt";

   interface WelcomeModalProps {
     onClose: () => void;
   }

   export function WelcomeModal({ onClose }: WelcomeModalProps) {
     const [showNotificationPrompt, setShowNotificationPrompt] = useState(true);
     const [notificationHandled, setNotificationHandled] = useState(false);

     const handleNotificationAccept = async () => {
       try {
         const permission = await Notification.requestPermission();
         if (permission === "granted") {
           localStorage.setItem("notifications-enabled", "true");
         }
       } catch (error) {
         console.error("Notification permission error:", error);
       }
       setNotificationHandled(true);
       setShowNotificationPrompt(false);
     };

     const handleNotificationDecline = () => {
       localStorage.setItem("notifications-declined", "true");
       setNotificationHandled(true);
       setShowNotificationPrompt(false);
     };

     const handleClose = () => {
       localStorage.setItem("welcome-shown", "true");
       onClose();
     };

     return (
       <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
         <div className="relative max-h-[90vh] w-full max-w-lg overflow-y-auto rounded-lg bg-white p-6 shadow-xl dark:bg-gray-800">
           {/* Close button */}
           <button
             onClick={handleClose}
             className="absolute right-3 top-3 p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
             aria-label="Close"
           >
             <X className="h-5 w-5" />
           </button>

           {/* Welcome header */}
           <h2 className="mb-1 text-2xl font-bold text-gray-900 dark:text-white">
             Welcome! / ကြိုဆိုပါတယ်!
           </h2>
           <p className="mb-6 text-gray-600 dark:text-gray-400">
             Your app is ready. Here are some tips:
           </p>

           {/* Tips */}
           <div className="mb-6 space-y-4">
             {/* Offline tip */}
             <div className="flex items-start gap-3">
               <div className="flex h-8 w-8 items-center justify-center rounded-full bg-green-100 dark:bg-green-900">
                 <WifiOff className="h-4 w-4 text-green-600 dark:text-green-400" />
               </div>
               <div>
                 <p className="font-medium text-gray-900 dark:text-white">
                   Works offline
                 </p>
                 <p className="text-sm text-gray-600 dark:text-gray-400">
                   Study anytime, even without internet.
                 </p>
                 <p className="font-myanmar text-sm text-gray-500 dark:text-gray-500">
                   အင်တာနက်မရှိလည်း လေ့လာနိုင်ပါသည်။
                 </p>
               </div>
             </div>

             {/* Sync tip */}
             <div className="flex items-start gap-3">
               <div className="flex h-8 w-8 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900">
                 <RefreshCw className="h-4 w-4 text-blue-600 dark:text-blue-400" />
               </div>
               <div>
                 <p className="font-medium text-gray-900 dark:text-white">
                   Auto-syncs your progress
                 </p>
                 <p className="text-sm text-gray-600 dark:text-gray-400">
                   Your test results sync when you're back online.
                 </p>
                 <p className="font-myanmar text-sm text-gray-500 dark:text-gray-500">
                   အင်တာနက်ပြန်ရတဲ့အခါ သင့်ရလဒ်များ အလိုအလျောက် စင့်ခ်လုပ်ပါမယ်။
                 </p>
               </div>
             </div>

             {/* Home screen tip */}
             <div className="flex items-start gap-3">
               <div className="flex h-8 w-8 items-center justify-center rounded-full bg-purple-100 dark:bg-purple-900">
                 <Smartphone className="h-4 w-4 text-purple-600 dark:text-purple-400" />
               </div>
               <div>
                 <p className="font-medium text-gray-900 dark:text-white">
                   Open from home screen
                 </p>
                 <p className="text-sm text-gray-600 dark:text-gray-400">
                   For the best experience, open the app from your home screen.
                 </p>
                 <p className="font-myanmar text-sm text-gray-500 dark:text-gray-500">
                   အကောင်းဆုံး အတွေ့အကြုံအတွက် Home screen မှ ဖွင့်ပါ။
                 </p>
               </div>
             </div>
           </div>

           {/* Notification pre-prompt - per user decision: request during welcome modal */}
           {showNotificationPrompt && !notificationHandled && typeof Notification !== "undefined" && Notification.permission === "default" && (
             <div className="mb-6">
               <NotificationPrePrompt
                 onAccept={handleNotificationAccept}
                 onDecline={handleNotificationDecline}
               />
             </div>
           )}

           {/* Get started button */}
           <button
             onClick={handleClose}
             className="w-full rounded-lg bg-[#002868] px-4 py-3 font-medium text-white hover:bg-blue-800"
           >
             Get Started / စတင်ပါ
           </button>
         </div>
       </div>
     );
   }
   ```
  </action>
  <verify>
    pnpm run typecheck passes
    pnpm run lint passes
  </verify>
  <done>
    WelcomeModal shows tips and notification pre-prompt, NotificationPrePrompt explains value before native dialog
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate install and welcome flow into app</name>
  <files>
    src/contexts/OfflineContext.tsx
    src/AppShell.tsx
  </files>
  <action>
1. Add installation state management to OfflineContext.tsx:
   - Add `isNewInstall` state (true when appinstalled event fires)
   - Add `showWelcome` state (true after install, false after welcome dismissed)
   - Add handlers for install flow

2. Update src/AppShell.tsx to render modals:
   - Import InstallPrompt from "@/components/pwa/InstallPrompt"
   - Import WelcomeModal from "@/components/pwa/WelcomeModal"
   - Add state for showing welcome modal (triggered after install)
   - Per user decision: install prompt shown immediately on first visit
   - Show InstallPrompt when:
     - Not installed AND not previously dismissed AND (canInstall OR isIOS first visit)
   - Show WelcomeModal when:
     - Just installed OR (is installed AND welcome not shown before)

   Flow:
   1. First visit: InstallPrompt appears immediately
   2. User installs: InstallPrompt closes, WelcomeModal appears
   3. User dismisses install: prompt hidden for 7 days
   4. Returning installed user: WelcomeModal appears once if not shown before

3. Render order in AppShell:
   ```tsx
   {showInstallPrompt && <InstallPrompt onInstalled={handleInstalled} />}
   {showWelcome && <WelcomeModal onClose={handleWelcomeClose} />}
   ```
  </action>
  <verify>
    pnpm run build succeeds
    First visit shows install prompt
    After install, welcome modal appears
    Welcome modal shows notification pre-prompt
  </verify>
  <done>
    Install prompt shows on first visit, welcome modal shows after install with notification opt-in
  </done>
</task>

</tasks>

<verification>
1. Clear localStorage and visit app in Chrome - install prompt should appear immediately
2. Click "Install Now" - browser install dialog should appear
3. After install, welcome modal should appear with tips and notification prompt
4. Click notification "Yes" - native permission dialog should appear
5. Test on iOS Safari - should show manual instructions with Share button
6. Dismiss install prompt - should not reappear for 7 days (check localStorage)
7. After welcome modal, check localStorage for "welcome-shown" flag
</verification>

<success_criteria>
- Install prompt appears immediately on first visit (bilingual)
- Install prompt works on Chrome (beforeinstallprompt) and iOS (manual instructions)
- Welcome modal shows after installation with 3 bilingual tips
- Notification pre-prompt shows friendly explanation before native dialog
- Clicking "Yes, remind me" triggers native Notification.requestPermission()
- Dismissed install prompt respects 7-day cooldown
- Welcome modal only shows once per device
- All text is bilingual (English + Burmese)
</success_criteria>

<output>
After completion, create `.planning/phases/02-pwa-offline/02-04-SUMMARY.md`
</output>
