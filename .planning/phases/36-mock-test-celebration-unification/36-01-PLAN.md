---
phase: 36-mock-test-celebration-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/TestPage.tsx
autonomous: true
requirements:
  - CELB-04
  - CELB-05
  - CELB-08

must_haves:
  truths:
    - "Mock Test pass triggers the same multi-stage choreography as Practice mode (card scale-in, count-up, reveal, confetti, sound, action buttons)"
    - "hapticHeavy() fires at Mock Test pass reveal moment during choreography"
    - "playCelebrationSequence() stages are used for Mock Test result timing"
    - "Mock Test fail still shows appropriate non-celebratory results without full choreography"
    - "Save-session effect still persists test results to Supabase and SRS correctly"
  artifacts:
    - path: "src/pages/TestPage.tsx"
      provides: "Mock test page using shared TestResultsScreen component"
      contains: "TestResultsScreen"
  key_links:
    - from: "src/pages/TestPage.tsx"
      to: "src/components/results/TestResultsScreen.tsx"
      via: "component import and JSX invocation with mode='mock-test'"
      pattern: "<TestResultsScreen[\\s\\S]*mode=\"mock-test\""
---

<objective>
Replace TestPage's 350-line inline `resultView` with the shared `TestResultsScreen` component, unifying the Mock Test celebration experience with Practice mode's choreographed multi-stage celebration (card scale-in, count-up, pass/fail reveal, confetti, sound, haptics, staggered action buttons).

Purpose: Close the integration gap from Phase 32 where the celebration choreography system was built into TestResultsScreen but only wired into PracticeResults. The Mock Test's inline resultView still uses legacy basic Confetti + CountUpScore without choreography, haptics, or celebration sounds.

Output: A cleaner TestPage.tsx (~300 fewer lines) that delegates result rendering to the same shared component PracticeResults already uses.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-mock-test-celebration-unification/36-RESEARCH.md
@src/pages/TestPage.tsx
@src/components/results/TestResultsScreen.tsx
@src/components/practice/PracticeResults.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace inline resultView with TestResultsScreen and remove dead code</name>
  <files>src/pages/TestPage.tsx</files>
  <action>
This is a surgical replacement in TestPage.tsx. Follow these steps precisely:

**Step 1: Add TestResultsScreen import**

Add at the top of the file:
```typescript
import { TestResultsScreen } from '@/components/results/TestResultsScreen';
```

**Step 2: Replace the inline resultView block (lines ~1029-1377)**

Replace the entire `const resultView = (...)` block with:
```typescript
const resultView = (
  <TestResultsScreen
    results={finalResults}
    questions={questions}
    mode="mock-test"
    endReason={endReasonForDisplay}
    timeTaken={TEST_DURATION_SECONDS - timeLeft}
    showBurmese={showBurmese}
    skippedQuestionIds={quizState.skippedIndices.map(i => questions[i]?.id).filter((id): id is string => !!id)}
    onRetry={() => window.location.reload()}
    onReviewWrongOnly={() => { /* scroll handled by TestResultsScreen */ }}
    onHome={() => navigate('/dashboard')}
  />
);
```

**Step 3: Remove unused state declarations**

Remove these two useState lines:
- `const [showConfetti, setShowConfetti] = useState(false);`
- `const [showAllResults, setShowAllResults] = useState(false);`

**Step 4: Remove the `handleScoreCountComplete` callback**

Remove the entire `handleScoreCountComplete` callback (~lines 688-695) since it was only used in the inline resultView.

**Step 5: Remove `shareCardData` useMemo**

Remove the `shareCardData` useMemo block (~lines 251-274). TestResultsScreen computes its own share card data internally.

**Step 6: Remove the `completionMessage` record**

Remove the `completionMessage: Record<TestEndReason, { en: string; my: string }>` block (~lines 276-293). TestResultsScreen has its own `completionMessages` constant.

**Step 7: Keep `finalIncorrect` if needed by save-session effect**

Check: `finalIncorrect` is used at line 425 (`incorrectCount: finalIncorrect`) in the save-session effect. Keep it OR inline it as `finalResults.length - finalCorrect` at the usage site. Inlining is cleaner since it's only used once outside the old resultView.

**Step 8: Remove unused imports**

Remove these imports that are ONLY used by the inline resultView (verify each one is not used in activeView before removing):
- `Sparkles` from `lucide-react` (only in resultView retry button)
- `Trophy` from `lucide-react` (only in resultView trophy icon)
- `BilingualHeading` from `@/components/bilingual/BilingualHeading` (only in resultView; keep `SectionHeading` ONLY if still used elsewhere -- check: SectionHeading is only used at line 1219 in resultView, so remove it too)
- `BilingualButton` from `@/components/bilingual/BilingualButton` (only in resultView buttons)
- `Confetti` from `@/components/celebrations/Confetti` (only in resultView; CelebrationOverlay handles confetti now)
- `CountUpScore` from `@/components/celebrations/CountUpScore` (only in resultView)
- `ExplanationCard` from `@/components/explanations/ExplanationCard` (only in resultView at line 1363)
- `WeakAreaNudge` from `@/components/nudges/WeakAreaNudge` (only in resultView)
- `AddToDeckButton` from `@/components/srs/AddToDeckButton` (only in resultView at line 1294)
- `ShareButton` from `@/components/social/ShareButton` (only in resultView)
- `FadeIn` from `@/components/animations/StaggeredList` (only in resultView)
- `Filter` from `lucide-react` (only in resultView filter toggle)
- `playLevelUp` and `playMilestone` from `@/lib/audio/soundEffects` (only in handleScoreCountComplete; keep `playCorrect`, `playIncorrect`, `playTimerWarningTick` which are used in activeView)
- `detectWeakAreas`, `getCategoryQuestionIds`, `USCIS_CATEGORIES` from `@/lib/mastery` (only in resultView weak area nudge)
- `USCISCategory`, `CategoryMasteryEntry` types from `@/lib/mastery` (only in resultView weak area)
- `ShareCardData` type from `@/lib/social/shareCardRenderer` (only for shareCardData useMemo)

**Imports to KEEP (used in activeView or other non-result code):**
- `clsx` (used at line 963 in activeView)
- `motion, AnimatePresence` from `motion/react` (used in activeView animations)
- `useReducedMotion` (used at lines 851-854 in activeView)
- `useCategoryMastery` (hook call must stay due to rules-of-hooks, even though its value `categoryMasteries` was only used in resultView; the hook is called unconditionally at top level)
- `useStreak` (hook call must stay; `currentStreak` was used in shareCardData which is being removed, but hook calls cannot be conditional)
- `DynamicAnswerNote` (used in activeView at line ~924)
- All other imports used in activeView, pre-test, countdown, etc.

**Important:** After removing the hook consumers, the `categoryMasteries` destructure can be replaced with `useCategoryMastery()` (no destructure needed), and `currentStreak` with `useStreak()` (no destructure needed) -- or keep the destructures since unused variables are harmless and the linter may or may not flag them. If the linter flags unused destructured variables, prefix with underscore: `const { categoryMasteries: _categoryMasteries } = useCategoryMastery()` or just destructure nothing.

**Caution:** Do NOT remove any imports, state, or handlers that are used in the activeView (quiz answering flow). When in doubt, grep for usage outside the resultView block before removing.
  </action>
  <verify>
Run:
1. `npm run typecheck` -- must pass with zero errors (all removed imports/state were actually unused)
2. `npm run lint` -- must pass (no unused import warnings left, no missing imports)
3. `npm run test:run` -- existing tests must pass
4. Verify TestPage.tsx is significantly shorter (should be ~300 fewer lines, from ~1391 to ~1090)
  </verify>
  <done>
TestPage.tsx uses TestResultsScreen with mode="mock-test" for its result rendering. The inline 350-line resultView, related state (showConfetti, showAllResults), handler (handleScoreCountComplete), computed values (shareCardData, completionMessage), and ~15 resultView-only imports are all removed. TypeScript compiles cleanly and all tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify celebration choreography fires for mock test mode</name>
  <files>src/pages/TestPage.tsx</files>
  <action>
Verify that the integration is correct by checking the following code paths in TestResultsScreen:

1. **CELB-04 (choreography):** Open `src/components/results/TestResultsScreen.tsx` and confirm the `runChoreography()` function handles `mode="mock-test"` with the full stage sequence: card-enter -> count-up -> pass-fail -> confetti -> buttons -> complete. Confirm that when `mode === 'mock-test'` and the score meets `MOCK_TEST_PASS_THRESHOLD`, the full celebration choreography runs.

2. **CELB-05 (haptics):** Confirm `runChoreography()` calls:
   - `hapticLight()` at card-enter stage
   - `hapticMedium()` at count-up-land stage
   - `hapticHeavy()` at pass-fail reveal stage (only on pass)

3. **CELB-08 (celebration sounds):** Confirm `runChoreography()` calls:
   - `playCelebrationSequence('card-enter')` at card entrance
   - `playCelebrationSequence('count-up-tick')` during count-up
   - `playCelebrationSequence('count-up-land')` at count-up landing
   - `playCelebrationSequence('pass-reveal')` at pass reveal

4. **Fail path:** Confirm that when the user fails (score < threshold), the choreography plays a gentler sequence: `playFailReveal()` instead of celebration confetti, no `hapticHeavy()`.

5. **Save session integrity:** Run `npm run typecheck` one final time. Open the save-session effect in TestPage.tsx and confirm:
   - `finalCorrect` is still computed (used in session save)
   - `incorrectCount` field uses `finalResults.length - finalCorrect` (inlined) or `finalIncorrect` if kept
   - `durationSeconds` still uses `TEST_DURATION_SECONDS - timeLeft`
   - `endReason` still uses `endReasonForDisplay`

If any of these checks fail, fix the issue in TestPage.tsx. No modifications to TestResultsScreen should be needed.
  </action>
  <verify>
Run:
1. `npm run typecheck` -- zero errors
2. `npm run test:run` -- all tests pass
3. `npm run build` -- production build succeeds cleanly
  </verify>
  <done>
All three CELB requirements verified: CELB-04 (multi-stage choreography fires for mock-test mode), CELB-05 (hapticLight/Medium/Heavy progression at each stage), CELB-08 (playCelebrationSequence stages used for timing). Mock test fail path confirmed to show non-celebratory results. Save-session effect integrity confirmed. Production build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. `npm run lint` passes with no warnings about unused imports
3. `npm run test:run` passes all existing tests
4. `npm run build` produces a clean production build
5. TestPage.tsx contains `<TestResultsScreen` with `mode="mock-test"`
6. TestPage.tsx does NOT contain the old inline `<Confetti fire={showConfetti}` block
7. TestPage.tsx does NOT import `Confetti`, `CountUpScore`, `BilingualHeading`, `BilingualButton`, or `ShareButton` directly
8. TestPage.tsx is ~300 lines shorter than before
</verification>

<success_criteria>
- Mock Test results use TestResultsScreen with mode="mock-test" (identical celebration path as Practice mode)
- All inline resultView code, state, handlers, and imports removed (~300 lines of dead code)
- TypeScript compiles, ESLint passes, all tests pass, production build succeeds
- Save-session effect still correctly persists test results
</success_criteria>

<output>
After completion, create `.planning/phases/36-mock-test-celebration-unification/36-01-SUMMARY.md`
</output>
