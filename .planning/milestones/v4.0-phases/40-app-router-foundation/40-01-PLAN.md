---
phase: 40-app-router-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/themeScript.ts
  - pages/_document.tsx
  - src/components/ClientProviders.tsx
autonomous: true
requirements:
  - MIGR-04

must_haves:
  truths:
    - "Theme script content is identical between _document.tsx and the shared constant (byte-for-byte same runtime string)"
    - "ClientProviders nests all 10 context providers in the exact same order as AppShell.tsx"
    - "ClientProviders accepts an optional routerWrapper prop that wraps content between StateProvider and NavigationProvider"
  artifacts:
    - path: "src/lib/themeScript.ts"
      provides: "Shared theme script constant"
      exports: ["THEME_SCRIPT"]
    - path: "src/components/ClientProviders.tsx"
      provides: "10 context providers + ErrorBoundary + optional router wrapper"
      exports: ["ClientProviders"]
    - path: "pages/_document.tsx"
      provides: "Pages Router HTML shell importing shared theme script"
      contains: "import { THEME_SCRIPT } from"
  key_links:
    - from: "pages/_document.tsx"
      to: "src/lib/themeScript.ts"
      via: "import THEME_SCRIPT"
      pattern: "import.*THEME_SCRIPT.*themeScript"
    - from: "src/components/ClientProviders.tsx"
      to: "src/contexts/*.tsx"
      via: "provider imports"
      pattern: "import.*Provider.*from.*contexts"
---

<objective>
Extract the shared theme script constant and create the ClientProviders component that will serve both the Pages Router (AppShell) and App Router (layout.tsx).

Purpose: Establish the two foundational building blocks that Plan 02 wires into AppShell and app/layout.tsx.
Output: `src/lib/themeScript.ts`, `src/components/ClientProviders.tsx`, updated `pages/_document.tsx`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-app-router-foundation/40-CONTEXT.md
@.planning/phases/40-app-router-foundation/40-RESEARCH.md

@pages/_document.tsx
@src/AppShell.tsx
@src/components/ErrorBoundary.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract theme script to shared constant and update _document.tsx</name>
  <files>src/lib/themeScript.ts, pages/_document.tsx</files>
  <action>
Create `src/lib/themeScript.ts` with a named export `THEME_SCRIPT` containing the exact same inline theme script string currently in `pages/_document.tsx` (byte-for-byte identical runtime string — same whitespace, same line breaks, same content). This is critical because the CSP hash in `proxy.ts` (`THEME_SCRIPT_HASH`) must continue to match.

The constant:
```typescript
export const THEME_SCRIPT = `
(function() {
  try {
    var stored = localStorage.getItem('civic-theme');
    var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    var theme = stored || (prefersDark ? 'dark' : 'light');
    document.documentElement.classList.add(theme);
    document.documentElement.style.setProperty('color-scheme', theme);
    var meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.content = theme === 'dark' ? '#1a1f36' : '#002868';
  } catch(e) {}
})();
`;
```

Then update `pages/_document.tsx`:
- Remove the inline `THEME_SCRIPT` const definition (lines 6-18)
- Add import: `import { THEME_SCRIPT } from '@/lib/themeScript';`
- Leave the existing comment about updating the CSP hash — change the reference from "middleware.ts" to "proxy.ts" to match the current file name
- Everything else in _document.tsx stays identical — same `<Head>` children, same `<Html>`, same structure

Wire into: `pages/_document.tsx` imports `THEME_SCRIPT` from the new module.
Wire into: `app/layout.tsx` will import `THEME_SCRIPT` in Plan 02.
  </action>
  <verify>
    <automated>cd /c/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && npx tsc --noEmit --pretty 2>&1 | tail -5</automated>
    <manual>Verify the THEME_SCRIPT string in themeScript.ts matches the old inline string character-for-character</manual>
  </verify>
  <done>
    - `src/lib/themeScript.ts` exports `THEME_SCRIPT` with identical content to the old inline script
    - `pages/_document.tsx` imports from shared module instead of defining inline
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ClientProviders component with 10 context providers</name>
  <files>src/components/ClientProviders.tsx</files>
  <action>
Create `src/components/ClientProviders.tsx` as a `'use client'` component.

**Provider nesting order** (extracted from `src/AppShell.tsx` lines 201-335, MUST be preserved exactly):

```
ErrorBoundary
  LanguageProvider
    ThemeProvider
      TTSProvider
        ToastProvider
          OfflineProvider
            AuthProvider
              SocialProvider
                SRSProvider
                  StateProvider
                    [RouterWrapper if provided]  ← between StateProvider and NavigationProvider
                      NavigationProvider
                        {children}
```

**Interface:**
```typescript
interface ClientProvidersProps {
  children: ReactNode;
  routerWrapper?: ComponentType<{ children: ReactNode }>;
}
```

**Key implementation details:**
- `'use client'` directive at top
- Import all 10 providers from their existing source files (see AppShell.tsx imports)
- Import `ErrorBoundary` from `@/components/ErrorBoundary`
- The `routerWrapper` prop is optional. When provided (e.g., `BrowserRouter`), it wraps between StateProvider and NavigationProvider — this is where `<Router>` sits in AppShell
- When `routerWrapper` is not provided (App Router usage), NavigationProvider still renders but its children (NavigationShell) won't be used until Phase 41
- Do NOT import `NavigationShell` — it stays in AppShell (it uses `useLocation()` from react-router-dom)
- Do NOT import any overlay components (CelebrationOverlay, PWAOnboardingFlow, OnboardingTour, GreetingFlow, SyncStatusIndicator) — they stay in AppShell
- Do NOT import from `react-router-dom` or `next/navigation` — ClientProviders is framework-agnostic
- Do NOT add `useIsClient()` guard — providers already handle SSR safety internally

Wire into: `src/AppShell.tsx` will import and use this in Plan 02.
Wire into: `app/layout.tsx` will import and use this in Plan 02.
  </action>
  <verify>
    <automated>cd /c/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && npx tsc --noEmit --pretty 2>&1 | tail -5</automated>
    <manual>Verify provider nesting order matches AppShell.tsx exactly</manual>
  </verify>
  <done>
    - `src/components/ClientProviders.tsx` exists with `'use client'` directive
    - All 10 providers nested in correct order
    - ErrorBoundary wraps everything
    - Optional `routerWrapper` prop inserts between StateProvider and NavigationProvider
    - No react-router-dom or next/navigation imports
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (no type errors)
- `pages/_document.tsx` imports `THEME_SCRIPT` from shared module
- `src/components/ClientProviders.tsx` exports `ClientProviders` with correct provider nesting
- No imports from `react-router-dom` or `next/navigation` in ClientProviders
</verification>

<success_criteria>
- Theme script extracted to shared constant with identical content
- ClientProviders component created with all 10 providers in correct nesting order
- Both files compile without TypeScript errors
- _document.tsx uses the shared import
</success_criteria>

<output>
After completion, create `.planning/phases/40-app-router-foundation/40-01-SUMMARY.md`
</output>
