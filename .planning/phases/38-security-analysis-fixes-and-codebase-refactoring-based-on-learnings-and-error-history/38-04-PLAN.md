---
phase: 38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history
plan: 04
type: execute
wave: 2
depends_on: [02]
files_modified:
  - src/contexts/SRSContext.tsx
  - src/contexts/OfflineContext.tsx
  - src/contexts/SocialContext.tsx
  - src/contexts/SupabaseAuthContext.tsx
  - src/lib/sentry.ts
  - src/lib/srs/srsSync.ts
  - src/lib/social/socialProfileSync.ts
  - src/lib/social/streakSync.ts
  - src/lib/interview/interviewSync.ts
autonomous: true
requirements: [CONTEXT-throw-vs-fallback, CONTEXT-try-catch-boundaries, CONTEXT-error-fingerprinting]

must_haves:
  truths:
    - "All context providers follow the documented throw-vs-fallback convention"
    - "Critical async paths (IndexedDB, Supabase sync) use withRetry for transient failures"
    - "Sentry groups network errors under a single fingerprint instead of per-stack-trace"
    - "Console.error calls in sync modules are replaced with captureError"
    - "Non-retryable errors (401, quota) are NOT retried"
  artifacts:
    - path: "src/lib/sentry.ts"
      provides: "Error fingerprinting for high-volume categories"
      contains: "fingerprint"
    - path: "src/contexts/SRSContext.tsx"
      provides: "Standardized error handling with retry"
      contains: "withRetry"
  key_links:
    - from: "src/contexts/SRSContext.tsx"
      to: "src/lib/async/withRetry.ts"
      via: "import withRetry"
      pattern: "import.*withRetry.*from.*async"
    - from: "src/lib/sentry.ts"
      to: "Sentry beforeSend"
      via: "fingerprint assignment in beforeSendHandler"
      pattern: "event\\.fingerprint"
---

<objective>
Wire withRetry/safeAsync into context providers and sync modules, add Sentry error fingerprinting, and formalize the throw-vs-fallback pattern across all hooks.

Purpose: Standardize the 12+ inconsistent catch blocks that swallow errors with console.error, and prevent Sentry quota waste from duplicate network error issues.
Output: Consistent error handling across all async operations with proper retry, reporting, and fingerprinting
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history/38-RESEARCH.md
@.planning/phases/38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history/38-02-SUMMARY.md
@src/contexts/SRSContext.tsx
@src/contexts/OfflineContext.tsx
@src/contexts/SocialContext.tsx
@src/contexts/SupabaseAuthContext.tsx
@src/lib/sentry.ts
@src/lib/srs/srsSync.ts
@src/lib/social/socialProfileSync.ts
@src/lib/social/streakSync.ts
@src/lib/interview/interviewSync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Sentry error fingerprinting and integrate withRetry into sync modules</name>
  <files>src/lib/sentry.ts, src/lib/srs/srsSync.ts, src/lib/social/socialProfileSync.ts, src/lib/social/streakSync.ts, src/lib/interview/interviewSync.ts</files>
  <action>
    **1. Sentry error fingerprinting in `src/lib/sentry.ts`:**

    In the `beforeSend` handler (or `beforeSendHandler` function), add fingerprinting rules BEFORE the existing PII stripping logic:

    ```typescript
    // Group high-volume error categories
    const errorValue = event.exception?.values?.[0]?.value ?? '';
    if (/network|fetch|ECONNREFUSED|ERR_INTERNET_DISCONNECTED/i.test(errorValue)) {
      event.fingerprint = ['network-error'];
    } else if (/IndexedDB|QuotaExceeded|IDBDatabase/i.test(errorValue)) {
      event.fingerprint = ['indexeddb-error'];
    } else if (/SpeechSynthesis|speechSynthesis|utterance/i.test(errorValue)) {
      event.fingerprint = ['tts-error'];
    }
    ```

    **2. Wire withRetry into sync modules:**

    For each sync module (`srsSync.ts`, `socialProfileSync.ts`, `streakSync.ts`, `interviewSync.ts`):
    - Import `withRetry` from `@/lib/async`
    - Wrap Supabase calls that are currently in try-catch with console.error into `withRetry(() => supabaseCall(), { maxAttempts: 3, baseDelayMs: 1000 })`
    - Replace `console.error(...)` in catch blocks with Sentry's `captureException` (import from `@sentry/nextjs`)
    - Keep the existing offline detection pattern in SupabaseAuthContext (Pattern D from research) — it already has correct network-error-then-queue logic
    - Do NOT retry auth failures (401) or validation errors — the default `isRetryableError` handles this

    **Important:** These sync modules run in the background. If all retries fail, they should log to Sentry and NOT throw — the user should not see errors for background sync. Use `safeAsync` as the outermost wrapper when appropriate.

    **Specific file changes:**
    - `srsSync.ts` (3 console.error calls): Wrap sync operations with withRetry, replace console.error with captureException
    - `socialProfileSync.ts` (8 console.error calls — highest count): Wrap profile sync operations, replace console.error
    - `streakSync.ts` (4 console.error calls): Wrap streak sync operations, replace console.error
    - `interviewSync.ts` (4 console.error calls): Wrap interview sync operations, replace console.error
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - `grep -c "console.error" src/lib/srs/srsSync.ts src/lib/social/socialProfileSync.ts src/lib/social/streakSync.ts src/lib/interview/interviewSync.ts` shows reduced count (ideally 0)
    - `grep -c "withRetry" src/lib/srs/srsSync.ts src/lib/social/socialProfileSync.ts` shows imports
    - `grep "fingerprint" src/lib/sentry.ts` confirms fingerprinting rules
  </verify>
  <done>All 4 sync modules use withRetry for transient failures, report to Sentry instead of console.error, and Sentry groups network/IndexedDB/TTS errors under single fingerprints</done>
</task>

<task type="auto">
  <name>Task 2: Formalize throw-vs-fallback in context providers and replace console.error</name>
  <files>src/contexts/SRSContext.tsx, src/contexts/OfflineContext.tsx, src/contexts/SocialContext.tsx, src/contexts/SupabaseAuthContext.tsx</files>
  <action>
    **1. Audit and formalize throw-vs-fallback convention:**

    Review each context's hook export to confirm it follows the correct pattern:
    - **Throws** (caller needs success): useTTS, useAuth, useSRS — should throw if used outside provider
    - **No-op fallback** (fire-and-forget): useToast — should return FALLBACK if used outside provider
    - Document any that need changing and update them

    **2. Replace console.error in context catch blocks:**

    For each of the 4 context files:
    - `SRSContext.tsx` (3 console.error): Replace with `captureException` from `@sentry/nextjs`. For IndexedDB operations, wrap with `withRetry` since IndexedDB can have transient failures. Keep error swallowing behavior for non-critical operations (deck loading failure should show empty state, not crash).
    - `OfflineContext.tsx` (4 console.error): Replace with `captureException`. The sync queue operations should use withRetry. Keep the existing online/offline detection intact.
    - `SocialContext.tsx` (2 console.error): Replace with `captureException`. Social features are non-critical — failures should be silent to the user.
    - `SupabaseAuthContext.tsx` (1 console.error): Replace with `captureException`. Keep the existing Pattern D (network-error → queue offline) intact — it's already correct.

    **3. Add JSDoc comments documenting the throw-vs-fallback convention:**

    Add a brief JSDoc comment above each context hook explaining WHY it throws or falls back:
    ```typescript
    /**
     * Must be used within SRSProvider. Throws if outside provider
     * because callers depend on deck operations succeeding.
     */
    export function useSRS() { ... }
    ```

    **CRITICAL:** Do NOT change the provider tree nesting order. Do NOT consolidate providers. Only change error handling within existing catch blocks.
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - `npm run test:run` passes (no behavioral changes in contexts)
    - `grep -c "console.error" src/contexts/SRSContext.tsx src/contexts/OfflineContext.tsx src/contexts/SocialContext.tsx src/contexts/SupabaseAuthContext.tsx` shows reduced count
    - `grep -c "captureException\|captureError" src/contexts/SRSContext.tsx` shows new Sentry calls
  </verify>
  <done>All 4 context providers use Sentry instead of console.error, IndexedDB operations retry transient failures, and each hook has JSDoc documenting its throw-vs-fallback convention</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm run typecheck` passes
- `npm run lint` passes
- `npm run test:run` passes
- console.error count in contexts and sync modules is near zero
</verification>

<success_criteria>
- Network errors grouped under single Sentry fingerprint
- IndexedDB errors grouped under single Sentry fingerprint
- All sync modules use withRetry for Supabase calls
- All context providers report errors to Sentry, not console
- Each context hook documents its throw/fallback convention
- Provider tree ordering unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history/38-04-SUMMARY.md`
</output>
