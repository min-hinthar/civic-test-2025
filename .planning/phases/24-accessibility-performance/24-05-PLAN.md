---
phase: 24-accessibility-performance
plan: 05
type: execute
wave: 2
depends_on: ["24-02"]
files_modified:
  - src/hooks/usePerQuestionTimer.ts
  - src/components/quiz/PerQuestionTimer.tsx
  - src/components/quiz/TimerExtensionToast.tsx
  - src/lib/sounds.ts
  - src/lib/i18n/strings.ts
autonomous: true

must_haves:
  truths:
    - "Per-question timer counts down from 30 seconds with circular progress indicator"
    - "Timer color changes: green (>50%) to yellow (20-50%) to red (<20%)"
    - "Timer warns at 5 seconds with sound tick and haptic vibration"
    - "Timer extension toast appears at 6 seconds remaining with '+15s' button"
    - "Extension adds 15 seconds (50% of 30s), multiple extensions allowed"
    - "Timer pauses during feedback phase"
  artifacts:
    - path: "src/hooks/usePerQuestionTimer.ts"
      provides: "Per-question timer hook with pause, extend, and auto-submit"
      exports: ["usePerQuestionTimer"]
    - path: "src/components/quiz/PerQuestionTimer.tsx"
      provides: "Small circular timer component near question number"
      exports: ["PerQuestionTimer"]
    - path: "src/components/quiz/TimerExtensionToast.tsx"
      provides: "WCAG 2.2.1 timer extension banner"
      exports: ["TimerExtensionToast"]
  key_links:
    - from: "src/hooks/usePerQuestionTimer.ts"
      to: "src/components/quiz/PerQuestionTimer.tsx"
      via: "hook provides timeLeft to component"
      pattern: "usePerQuestionTimer"
    - from: "src/components/quiz/TimerExtensionToast.tsx"
      to: "src/hooks/usePerQuestionTimer.ts"
      via: "onExtend calls timer.extend()"
      pattern: "onExtend"
---

<objective>
Create the per-question timer hook, visual component, and WCAG 2.2.1 extension toast. These are standalone building blocks, not yet integrated into the quiz flow.

Purpose: Implement the per-question timer mechanism with 30-second countdown, color urgency, warning sound/haptics, and extension capability (A11Y-04, A11Y-05).
Output: usePerQuestionTimer hook, PerQuestionTimer component, TimerExtensionToast component, timer warning sound.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@src/components/test/CircularTimer.tsx
@src/lib/sounds.ts
@src/lib/haptics.ts
@src/lib/i18n/strings.ts
@.planning/phases/24-accessibility-performance/24-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: usePerQuestionTimer hook + timer warning sound</name>
  <files>src/hooks/usePerQuestionTimer.ts, src/lib/sounds.ts</files>
  <action>
    **usePerQuestionTimer hook:**

    1. Create `src/hooks/usePerQuestionTimer.ts` with this interface:
       ```typescript
       interface UsePerQuestionTimerOptions {
         duration?: number;        // Default: 30
         isPaused?: boolean;       // Pause during feedback phase
         onExpire: () => void;     // Called when timer reaches 0
         onWarning?: () => void;   // Called at 5 seconds (for sound/haptic)
         allowExtension?: boolean; // Whether WCAG extension is available
       }

       interface UsePerQuestionTimerReturn {
         timeLeft: number;              // Seconds remaining
         isWarning: boolean;            // true when <= 5 seconds
         showExtensionPrompt: boolean;  // true when <= 6 seconds AND allowExtension
         extend: () => void;            // Adds 50% of original duration
         reset: (newDuration?: number) => void;  // Reset for next question
       }
       ```

    2. Implementation details:
       - Use `useState` for `timeLeft`, `useRef` for interval ID
       - Decrement every 1000ms when not paused
       - Fire `onWarning` callback when timeLeft crosses 5 (use ref to fire only once per countdown)
       - Fire `onExpire` when timeLeft reaches 0 (use ref to fire only once)
       - `showExtensionPrompt`: true when timeLeft <= 6 AND allowExtension is true. Auto-hide after 5 seconds if not acted on (but reappear on next question).
       - `extend()`: adds `Math.ceil(duration * 0.5)` seconds (15s for 30s timer). Multiple calls allowed (no limit per locked decision). Resets the warning-fired ref so warning can fire again.
       - `reset()`: resets timeLeft to duration, clears all refs. Called when advancing to next question.
       - Guard: if `isPaused` changes to true mid-countdown, clear the interval. Resume when isPaused goes back to false.
       - Guard against onExpire race condition (per Research Pitfall 2): check if quiz phase is still 'answering' via the onExpire callback's own guard.

    3. Use `useState` lazy init for timeLeft (not useRef) for React Compiler safety.

    **Timer warning sound (src/lib/sounds.ts):**

    1. Add `playTimerWarningTick()` function following existing sound pattern:
       - Short tick sound: 800Hz sine wave, 80ms duration, low volume (0.15)
       - Use existing `createOscillator` helper if available, or follow `playCountdownTick` pattern
    2. This is separate from the countdown tick (countdown is 5-4-3-2-1-Go, timer tick is a per-second warning).
  </action>
  <verify>
    - `pnpm run typecheck` passes
    - `pnpm run lint` passes
    - The hook file exports usePerQuestionTimer
    - sounds.ts exports playTimerWarningTick
  </verify>
  <done>usePerQuestionTimer hook created with pause, extend, warning, and expiry logic. Timer warning sound added.</done>
</task>

<task type="auto">
  <name>Task 2: PerQuestionTimer visual component + TimerExtensionToast</name>
  <files>src/components/quiz/PerQuestionTimer.tsx, src/components/quiz/TimerExtensionToast.tsx, src/lib/i18n/strings.ts</files>
  <action>
    **PerQuestionTimer component:**

    1. Create small circular timer using the existing `CircularTimer` component with `size="sm"` and `allowHide={false}`.
       - Or, if CircularTimer doesn't fit the design (it's 80px at sm, might be too large), create a minimal custom SVG circle:
         - 40x40px circle with stroke-dasharray animation
         - Color: green (>50%) -> yellow (20-50%) -> red (<20%) per locked decision
         - The color thresholds differ from CircularTimer's (50/25/10 -> 50/20/0)
         - Bold time display in center (just seconds number, no minutes)

    2. Props:
       ```typescript
       interface PerQuestionTimerProps {
         timeLeft: number;
         duration: number;
         isWarning: boolean;  // For pulse animation at <= 5s
       }
       ```

    3. Accessibility:
       - `role="timer"` on the container
       - `aria-label={`${timeLeft} seconds remaining`}` (announced at key intervals per A11Y-04)
       - Screen reader announces at 5 seconds (via sr-only live region): "5 seconds remaining"
       - Use `aria-live="assertive"` sr-only span for the 5-second warning

    4. Reduced motion: no pulse animation, just color change.

    **TimerExtensionToast:**

    1. Create `src/components/quiz/TimerExtensionToast.tsx`:
       ```typescript
       interface TimerExtensionToastProps {
         show: boolean;
         onExtend: () => void;
         showBurmese: boolean;
       }
       ```

    2. Visual design (per locked decision):
       - Fixed position bottom banner (above the feedback panel area)
       - Warning-subtle background with border
       - Text: "Time running low!" with optional Burmese
       - Button: "+15s" with min-h-[44px] touch target
       - AnimatePresence for slide-in/out

    3. Accessibility (per Research Pitfall 5):
       - `role="alert" aria-live="assertive"` for immediate announcement
       - Announcement text: "Time running low. Press E or tap Extend to add 15 seconds."
       - Support keyboard shortcut: E key to extend (listener added when show=true, removed when false)
       - The keyboard shortcut remains active even after the visual toast auto-dismisses, until timer actually expires

    4. Auto-dismiss: toast disappears after 5 seconds if not tapped (but keyboard shortcut stays active until timer expires or question changes).

    **Bilingual strings:**

    1. Add to `src/lib/i18n/strings.ts` in the quiz section:
       - `timerWarning`: "Time running low!" / Burmese
       - `extend`: "+15s" / Burmese
       - `secondsRemaining`: "{n} seconds remaining" / Burmese
  </action>
  <verify>
    - `pnpm run typecheck` passes
    - `pnpm run lint` passes
    - PerQuestionTimer renders with role="timer"
    - TimerExtensionToast has role="alert" and keyboard shortcut
  </verify>
  <done>PerQuestionTimer shows circular 30s countdown with color urgency. TimerExtensionToast offers WCAG 2.2.1 extension with keyboard shortcut.</done>
</task>

</tasks>

<verification>
- `pnpm run typecheck` passes
- `pnpm run lint` passes
- `pnpm test:run` passes (no regressions)
- usePerQuestionTimer, PerQuestionTimer, and TimerExtensionToast all export correctly
- Timer warning sound plays
</verification>

<success_criteria>
- Hook manages 30s countdown with pause, extend, warning, and expiry
- Visual timer shows color changes at 50%/20% thresholds
- Extension toast appears at 6s with +15s button and E keyboard shortcut
- Screen reader announces 5-second warning
- Timer pauses when isPaused is true
</success_criteria>

<output>
After completion, create `.planning/phases/24-accessibility-performance/24-05-SUMMARY.md`
</output>
