---
phase: 37-bug-fixes-ux-polish
plan: 07
type: execute
wave: 3
depends_on: ["37-01", "37-04"]
files_modified:
  - src/lib/tts/ttsCore.ts
  - src/lib/pwa/syncQueue.ts
  - src/contexts/OfflineContext.tsx
  - src/lib/srs/fsrsEngine.ts
  - src/contexts/SRSContext.tsx
  - src/lib/social/index.ts
  - src/contexts/SocialContext.tsx
  - src/pages/DashboardPage.tsx
  - src/pages/StudyGuidePage.tsx
  - src/components/ui/BilingualToast.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "TTS does not produce audio overlap or stale utterance errors"
    - "Offline sync completes without data loss when connection resumes"
    - "SRS intervals feel appropriate — not too soon or too late"
    - "Loading states shown for all async content screens"
    - "Empty states shown for zero-data screens with actionable guidance"
    - "Error boundaries catch render errors and show recovery UI"
  artifacts:
    - path: "src/lib/tts/ttsCore.ts"
      provides: "TTS engine with verified Chrome/Safari/Firefox/Android workarounds"
    - path: "src/lib/pwa/syncQueue.ts"
      provides: "Sync queue with verified flush + conflict resolution"
    - path: "src/lib/srs/fsrsEngine.ts"
      provides: "FSRS engine with verified interval calculations"
  key_links:
    - from: "src/lib/pwa/syncQueue.ts"
      to: "src/contexts/OfflineContext.tsx"
      via: "Sync queue consumed by OfflineContext for online/offline sync"
      pattern: "syncQueue|flushQueue"
    - from: "src/lib/srs/fsrsEngine.ts"
      to: "src/contexts/SRSContext.tsx"
      via: "FSRS engine used by SRSContext for scheduling"
      pattern: "fsrsEngine|repeat|next"
---

<objective>
Systematic bug investigation and fix pass across 9 domains (TTS, offline/sync, SRS algorithm, leaderboard, PWA, responsive, toasts, error boundaries, performance) plus loading/empty state audit. Each domain gets focused code-reading, hypothesis, and targeted fix.

Purpose: User decision requires Claude to investigate and fix bugs across all these domains.
Output: Targeted fixes across multiple files based on investigation findings.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/tts/ttsCore.ts
@src/lib/pwa/syncQueue.ts
@src/contexts/OfflineContext.tsx
@src/lib/srs/fsrsEngine.ts
@src/contexts/SRSContext.tsx
@src/lib/social/index.ts
@src/contexts/SocialContext.tsx
@src/components/ui/ErrorBoundary.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate and fix TTS, offline/sync, and SRS bugs</name>
  <files>src/lib/tts/ttsCore.ts, src/lib/pwa/syncQueue.ts, src/contexts/OfflineContext.tsx, src/lib/srs/fsrsEngine.ts, src/contexts/SRSContext.tsx</files>
  <action>
**Domain 1: TTS/Audio Investigation**

Read and audit these files in order:
1. `src/lib/tts/ttsCore.ts` — Check Chrome 15s cutoff workaround, Safari cancel errors, Firefox race conditions, Android pause breakage
2. `src/hooks/useTTS.ts` — Check auto-cancel on unmount, speak/cancel race conditions
3. `src/hooks/useAutoRead.ts` — Check cleanup on component unmount

Common TTS bugs to check:
- Chrome: SpeechSynthesis.cancel() before speak() causes silent failure — need 100ms delay
- Safari: cancel() during onend callback throws — need try/catch
- Firefox: speak() during pending utterance queues instead of replacing — need explicit cancel first
- Android: pause/resume breaks WebView TTS — need to cancel and re-speak from position
- General: Multiple rapid speak() calls overlap — need cancellation gate

Fix any issues found. If the existing code already handles these (from Phase 19/22), document as "verified clean" in SUMMARY.

**Domain 2: Offline/Sync Investigation**

Read and audit:
1. `src/lib/pwa/syncQueue.ts` — Check queue flush timing, retry logic, conflict resolution
2. `src/contexts/OfflineContext.tsx` — Check online/offline detection, sync trigger
3. `src/lib/srs/srsSync.ts` — Check SRS data sync to Supabase

Common sync bugs to check:
- Queue not flushing on reconnect — check `navigator.onLine` listener
- Data loss during concurrent device sync — check conflict resolution strategy (last-write-wins vs merge)
- Sync queue growing unbounded offline — check queue size limits
- Failed sync items not retried — check retry with exponential backoff

Fix any issues found. Key concern from user: "data lost after sync between devices" — this likely points to a conflict resolution issue in srsSync.ts.

**Domain 3: SRS Algorithm Investigation**

Read and audit:
1. `src/lib/srs/fsrsEngine.ts` — Check FSRS parameters, interval calculation
2. `src/lib/srs/index.ts` — Check `isDue()` logic
3. `src/contexts/SRSContext.tsx` — Check deck refresh, timezone handling

Common SRS bugs to check:
- `isDue()` using wrong timezone (comparing UTC due date with local now)
- FSRS parameters too aggressive or too conservative — check w values
- Cards scheduled too soon after "Easy" rating — check interval multiplier
- New cards all showing as "due" when they shouldn't be — check State.New handling
- `refreshDeck()` not called on app resume/visibility — stale due counts

Fix: If `isDue()` has timezone issues, normalize both dates to same timezone. If FSRS params are off, adjust the `w` parameter array per ts-fsrs documentation defaults.
  </action>
  <verify>Run `npm run typecheck` and `npm run test:run -- src/lib/tts/ttsCore.test.ts` for TTS. Run any existing sync/SRS tests. Document all findings (verified clean or fixed) in SUMMARY.</verify>
  <done>TTS engine verified/fixed for cross-browser issues. Sync queue verified/fixed for data loss scenarios. SRS algorithm verified/fixed for interval accuracy. All findings documented.</done>
</task>

<task type="auto">
  <name>Task 2: Investigate leaderboard, PWA, responsive, toast, error, and performance issues + loading/empty state audit</name>
  <files>src/lib/social/index.ts, src/contexts/SocialContext.tsx, src/components/ui/BilingualToast.tsx, src/components/ui/ErrorBoundary.tsx, src/pages/DashboardPage.tsx, src/pages/StudyGuidePage.tsx</files>
  <action>
**Domain 4: Leaderboard Investigation**

Read `src/lib/social/` and `src/contexts/SocialContext.tsx`. Check:
- Score submission: Does it fire after test/interview completion?
- Ranking refresh: Does it refetch after score changes?
- Anonymous users: Can they see leaderboard? Are their scores tracked?
- Edge case: What happens with 0 points? Negative points?

Fix issues found or document as verified clean.

**Domain 5: PWA Investigation**

Read `src/lib/pwa/sw.ts` and check `@serwist/next` config in `next.config.mjs`:
- Service worker registration: Does it succeed on first visit?
- Cache invalidation: Are stale caches cleared on new deployments?
- Install prompt: Does it appear correctly? Delayed or never shown?
- Offline page: Does it load when offline?

Fix issues or document as verified clean.

**Domain 6: Responsive Layout Investigation**

Check global layout at breakpoints:
- Test with viewport < 375px: Do elements overflow? Text truncation issues?
- Check BottomTabBar, GlassHeader, card grids at narrow widths
- Check safe area insets on bottom nav
- Check horizontal scroll areas (new chip row from Plan 05 will need testing too)

Fix any overflow or layout issues found.

**Domain 7: Toast Notification Investigation**

Read `src/components/ui/BilingualToast.tsx` and toast provider:
- Position: Is it above BottomTabBar on mobile?
- Z-index: Does it appear above dialogs/modals?
- Content: Are bilingual messages rendering correctly?
- Swipe-to-dismiss: Does it work (from Phase 30)?

Fix issues or document as verified clean.

**Domain 8: Error Boundary Investigation**

Read `src/components/ui/ErrorBoundary.tsx`:
- Does it catch render errors? Promise rejections?
- Does it show recovery UI (retry button)?
- Does it log to Sentry?
- Are there any components NOT wrapped in error boundaries that should be?

Fix issues or document as verified clean. Note: MEMORY.md mentions "9 pre-existing test failures (localStorage mock issue in test env, not production)" — this is a known test-env issue, not a production bug.

**Domain 9: Performance Quick Wins**

Profile the app for low-hanging fruit:
- Check for unnecessary re-renders in hot paths (dashboard, study guide)
- Check bundle size of major pages — any oversized imports?
- Check animation jank — are heavy animations GPU-composited?
- Check for memory leaks in effects (missing cleanup)

Fix 2-3 quick wins. This is a bug fix phase, not a performance overhaul — scope accordingly.

**Loading/Empty State Audit**

Audit all views for proper loading and empty states:
- Dashboard: Does it show skeleton while loading? Empty state for new users?
- Study Guide: Loading skeleton? Empty state if no questions (shouldn't happen with static data)?
- Hub tabs: Loading/empty for History, Achievements, SRS Deck?
- Interview/Test: Loading states during setup?

Phase 33 implemented these — verify they still work. Fix any regressions.
  </action>
  <verify>Run `npm run typecheck` and `npm run test:run`. Document all findings per domain in SUMMARY — either "verified clean" or describe the fix. No regressions in existing tests.</verify>
  <done>All 9 investigation domains audited. Issues fixed or verified clean. Loading/empty states verified across all views. All findings documented in SUMMARY.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. `npm run test:run` passes
3. All 9 domains investigated with findings documented
4. No regressions from fixes
5. Loading/empty states verified on all major views
</verification>

<success_criteria>
- TTS verified clean or fixed for cross-browser issues
- Sync verified clean or fixed for data loss
- SRS intervals verified appropriate
- Leaderboard, PWA, responsive, toast, error boundary investigated
- Performance quick wins applied (2-3 items)
- Loading/empty state audit completed
- All findings documented in SUMMARY
</success_criteria>

<output>
After completion, create `.planning/phases/37-bug-fixes-ux-polish/37-07-SUMMARY.md`
</output>
