---
phase: 24-accessibility-performance
plan: 06
type: execute
wave: 2
depends_on: ["24-05"]
files_modified:
  - src/pages/TestPage.tsx
  - src/components/practice/PracticeSession.tsx
  - src/components/test/PreTestScreen.tsx
  - src/components/quiz/QuizHeader.tsx
  - src/components/practice/PracticeConfig.tsx
autonomous: true

must_haves:
  truths:
    - "Per-question timer shown in both practice mode and mock test"
    - "Mock test shows BOTH overall timer and per-question 30s timer"
    - "Timer toggle checkbox on PreTestScreen (optional in practice, default ON)"
    - "Timer pauses during feedback phase (after Check, while reading explanation)"
    - "Auto-submit on expiry: if answer selected submit it, if none mark as skipped"
    - "Timer extension available in practice mode only (NOT in mock test)"
    - "No per-question timer in interview mode"
  artifacts:
    - path: "src/pages/TestPage.tsx"
      provides: "Mock test with dual timers (overall + per-question)"
      contains: "usePerQuestionTimer"
    - path: "src/components/practice/PracticeSession.tsx"
      provides: "Practice mode with optional per-question timer + extension"
      contains: "usePerQuestionTimer"
    - path: "src/components/test/PreTestScreen.tsx"
      provides: "Timer toggle checkbox"
      contains: "timerEnabled"
  key_links:
    - from: "src/pages/TestPage.tsx"
      to: "src/hooks/usePerQuestionTimer.ts"
      via: "hook import for per-question timer"
      pattern: "usePerQuestionTimer"
    - from: "src/components/practice/PracticeSession.tsx"
      to: "src/components/quiz/TimerExtensionToast.tsx"
      via: "extension toast shown in practice only"
      pattern: "TimerExtensionToast"
---

<objective>
Integrate the per-question timer into the quiz flow: mock test (always ON, no extension), practice mode (optional toggle, with extension), and PreTestScreen timer toggle.

Purpose: Per-question timing creates realistic test pressure with WCAG 2.2.1 compliance for accessibility (A11Y-04, A11Y-05).
Output: TestPage and PracticeSession with working per-question timers, PreTestScreen with timer toggle.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-accessibility-performance/24-05-SUMMARY.md
@src/pages/TestPage.tsx
@src/components/practice/PracticeSession.tsx
@src/components/test/PreTestScreen.tsx
@src/components/quiz/QuizHeader.tsx
@src/components/practice/PracticeConfig.tsx
@.planning/phases/24-accessibility-performance/24-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: PreTestScreen timer toggle + PracticeConfig timer prop</name>
  <files>src/components/test/PreTestScreen.tsx, src/components/practice/PracticeConfig.tsx</files>
  <action>
    **PreTestScreen timer toggle (locked decision: optional, default ON):**

    1. Add a per-question timer toggle to PreTestScreen, below the auto-read toggle section:
       ```tsx
       // Per-question timer toggle
       <div className="mt-4 flex items-center justify-between rounded-xl border border-border bg-card px-4 py-3">
         <div>
           <p className="text-sm font-medium text-foreground">Per-Question Timer</p>
           {showBurmese && <p className="font-myanmar text-xs text-muted-foreground">...</p>}
           <p className="text-xs text-muted-foreground mt-0.5">30 seconds per question</p>
         </div>
         <button role="switch" aria-checked={timerEnabled} ...>
           {/* Toggle switch matching auto-read toggle style */}
         </button>
       </div>
       ```

    2. Add state: `const [timerEnabled, setTimerEnabled] = useState(true);` (default ON)

    3. Extend the `SpeechOverrides` interface (or create a new combined overrides):
       ```typescript
       export interface SessionOverrides extends SpeechOverrides {
         timerEnabled: boolean;
       }
       ```
       Update `onReady` to pass `timerEnabled` in the overrides object.

    4. Ensure backward compatibility: if consumers destructure only SpeechOverrides fields, the extra field is harmless.

    **PracticeConfig timer prop (if PracticeConfig exists):**

    1. Check if PracticeConfig has its own pre-screen. If so, add the same timer toggle there.
    2. If practice uses PreTestScreen directly, the toggle is already there.
    3. The practice flow should pass `timerEnabled` through to PracticeSession.

    **Mock test:**
    - Mock test does NOT get a toggle -- per-question timer is always ON in mock test (simulation fidelity).
    - This is handled in TestPage integration (Task 2).
  </action>
  <verify>
    - `pnpm run typecheck` passes
    - `pnpm run lint` passes
    - Grep for `timerEnabled` in PreTestScreen
    - Toggle uses `role="switch"` with `aria-checked`
  </verify>
  <done>PreTestScreen has per-question timer toggle (default ON). Override passed to quiz session.</done>
</task>

<task type="auto">
  <name>Task 2: TestPage + PracticeSession per-question timer integration</name>
  <files>src/pages/TestPage.tsx, src/components/practice/PracticeSession.tsx, src/components/quiz/QuizHeader.tsx</files>
  <action>
    **TestPage (mock test -- locked: BOTH timers, no extension):**

    1. Import `usePerQuestionTimer` and `PerQuestionTimer`.
    2. Initialize the hook:
       ```typescript
       const perQuestionTimer = usePerQuestionTimer({
         duration: 30,
         isPaused: quizState.phase !== 'answering', // Pause during feedback
         onExpire: handlePerQuestionExpire,
         onWarning: handleTimerWarning,
         allowExtension: false, // Mock test: no extension
       });
       ```

    3. `handlePerQuestionExpire`:
       - If an answer is selected (`quizState.selectedIndex !== null`), dispatch CHECK
       - If no answer selected, dispatch SKIP (mark as skipped)
       - Guard: only fire if `quizState.phase === 'answering'`

    4. `handleTimerWarning`:
       - Call `playTimerWarningTick()` from sounds
       - Call `hapticLight()` from haptics

    5. Reset timer on question advance: when `quizState.currentIndex` changes, call `perQuestionTimer.reset()`. Use a `useEffect` with `quizState.currentIndex` as dependency.

    6. Display: Place PerQuestionTimer in QuizHeader's timer slot, ALONGSIDE the existing CircularTimer (overall timer):
       ```tsx
       // In QuizHeader timerSlot prop:
       <div className="flex items-center gap-2">
         <PerQuestionTimer timeLeft={perQuestionTimer.timeLeft} duration={30} isWarning={perQuestionTimer.isWarning} />
         <CircularTimer ... /> {/* existing overall timer */}
       </div>
       ```
       Or if QuizHeader has a specific `timer` slot, place the per-question timer beside the question number.

    **PracticeSession (locked: optional toggle, with extension):**

    1. Same integration as TestPage but with differences:
       - `allowExtension: true`
       - Only enable if `timerEnabled` override is true (from PreTestScreen)
       - Show `TimerExtensionToast` when `perQuestionTimer.showExtensionPrompt` is true
       - `onExtend` calls `perQuestionTimer.extend()`

    2. Timer display: Place PerQuestionTimer in the QuizHeader next to the question counter.

    3. Auto-submit on expire: same pattern as TestPage (check selected answer or skip).

    4. TimerExtensionToast positioned above the FeedbackPanel area (z-index layering).

    **QuizHeader update:**

    1. If QuizHeader's timer slot needs updating to accommodate the per-question timer, modify the slot to accept the PerQuestionTimer alongside or instead of the overall timer.
    2. Per-question timer should appear near the question number (compact, not taking full slot).
  </action>
  <verify>
    - `pnpm run typecheck` passes
    - `pnpm run lint` passes
    - `pnpm run build` passes
    - Grep for `usePerQuestionTimer` in TestPage.tsx and PracticeSession.tsx
    - Grep for `TimerExtensionToast` in PracticeSession.tsx (not in TestPage)
    - Grep for `PerQuestionTimer` in both files
  </verify>
  <done>Mock test shows both timers (no extension). Practice mode has optional per-question timer with WCAG extension. Timer pauses during feedback. Auto-submit on expiry.</done>
</task>

</tasks>

<verification>
- `pnpm run typecheck` passes
- `pnpm run lint` passes
- `pnpm run build` passes
- `pnpm test:run` passes (no regressions)
- TestPage has per-question timer always on
- PracticeSession has optional per-question timer with extension
- PreTestScreen has timer toggle
- No per-question timer in interview mode (untouched)
</verification>

<success_criteria>
- Mock test shows dual timers (overall + per-question), no extension
- Practice mode per-question timer is toggleable from PreTestScreen
- Timer pauses during feedback phase
- Auto-submit: selected answer submitted on expiry, no answer = skip
- Extension toast in practice with E keyboard shortcut
- Interview mode unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/24-accessibility-performance/24-06-SUMMARY.md`
</output>
