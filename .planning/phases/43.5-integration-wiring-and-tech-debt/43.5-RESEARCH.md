# Phase 43.5 Research: Integration Wiring and Tech Debt

**Researched:** 2026-02-25
**Mode:** Implementation (codebase investigation, all items have known root causes)
**Confidence:** High — all 4 items verified directly in source code

## Executive Summary

Phase 43.5 closes 2 integration gaps, 2 flow gaps, and 4 tech debt items identified by the v4.0 milestone audit. All items are surgical fixes with known locations, no library additions, and no architecture changes. Total estimated scope: ~50 lines changed across 5-6 files + 18 SUMMARY frontmatter updates.

---

## Standard Stack

No new libraries needed. All fixes use existing Next.js App Router APIs:
- `useSearchParams()` from `next/navigation` (already used in DrillPage, StudyGuidePage, AuthPage)
- `<Suspense>` boundary from React (already used in drill, auth, study, hub page wrappers)

---

## Architecture Patterns

### Pattern 1: Search Param Pre-Selection (SC-1)

**Established pattern** — DrillPage already does this:

```
// app/(protected)/drill/page.tsx — Page wrapper with Suspense
'use client';
import { Suspense } from 'react';
import DrillPage from '@/views/DrillPage';
export default function Drill() {
  return <Suspense><DrillPage /></Suspense>;
}

// src/views/DrillPage.tsx — Reads ?category= param
const searchParams = useSearchParams();
const categoryParam = searchParams.get('category');
```

**For PracticePage:** Two approaches:

**Approach A — Prop drilling from PracticePage → PracticeConfig:**
1. PracticePage calls `useSearchParams()`, reads `?category=`
2. Passes `initialCategory` prop to PracticeConfig
3. PracticeConfig initializes `selectedCategory` state from prop
4. Page wrapper (`app/(protected)/practice/page.tsx`) wraps in `<Suspense>`

**Approach B — PracticeConfig reads searchParams directly:**
1. PracticeConfig calls `useSearchParams()` itself
2. Uses param to initialize `selectedCategory` state
3. Page wrapper wraps in `<Suspense>`

**Recommendation: Approach A** — Matches existing PracticePage architecture where the parent orchestrates phase transitions and config state. PracticeConfig is a pure UI component that receives config via props.

**Key detail:** `selectedCategory` is `useState<USCISCategory | Category | 'weak' | null>(null)`. The URL param value must be validated against known categories before using as initial state. DrillPage validates via `USCIS_CATEGORY_NAMES` and `SUB_CATEGORY_NAMES` lookups.

**Suspense requirement:** `useSearchParams()` requires a Suspense boundary in App Router. Current `practice/page.tsx` has NO Suspense — must add it (same pattern as drill/page.tsx).

### Pattern 2: OAuth Redirect Target (SC-2)

Single string change in `GoogleOneTapSignIn.tsx` line 76:
```typescript
// Current (stale):
redirectTo: `${window.location.origin}/dashboard`,
// Fixed:
redirectTo: `${window.location.origin}/home`,
```

`/dashboard` was the old react-router-dom route. `/home` is the canonical App Router route since Phase 41. The `next.config.mjs` has a permanent redirect from `/dashboard` → `/home`, so current code works but adds an unnecessary redirect hop.

### Pattern 3: ROADMAP Doc Fix (SC-3)

ROADMAP.md line 114 says: `ClientProviders.tsx wraps all 12 context providers`
Actual count in `src/components/ClientProviders.tsx`: **10 providers**
1. LanguageProvider
2. ThemeProvider
3. TTSProvider
4. ToastProvider
5. OfflineProvider
6. AuthProvider
7. SocialProvider
8. SRSProvider
9. StateProvider
10. NavigationProvider

Change "12" → "10" on ROADMAP.md line 114.

### Pattern 4: SUMMARY Frontmatter Field (SC-4)

18 SUMMARY.md files across phases 39-43 all lack a `requirements-completed` field. The audit noted this reduces the 3-source cross-reference to 2 sources (VERIFICATION + REQUIREMENTS.md, but not SUMMARY).

**Format:** Add YAML frontmatter field mapping plan → requirements it completed. Example:
```yaml
---
phase: 43-test-readiness-score-and-drill-mode
plan: 01
requirements-completed: [RDNS-01, RDNS-03]
# ...rest of frontmatter
---
```

**Mapping source:** Each plan's VERIFICATION.md or the phase's overall VERIFICATION.md lists which requirements were satisfied. Cross-reference with REQUIREMENTS.md checkboxes.

**Files to update (18):**
- `.planning/phases/39-*/{39-01,39-02,39-03,39-04}-SUMMARY.md`
- `.planning/phases/40-*/{40-01,40-02,40-03}-SUMMARY.md`
- `.planning/phases/41-*/{41-01,41-02,41-03,41-04,41-05}-SUMMARY.md`
- `.planning/phases/42-*/{42-01,42-02}-SUMMARY.md`
- `.planning/phases/43-*/{43-01,43-02,43-03,43-04}-SUMMARY.md`

---

## Don't Hand-Roll

- **Search param validation** — use the same `USCIS_CATEGORY_NAMES` / `SUB_CATEGORY_NAMES` lookup pattern from DrillPage, don't create a separate validator
- **Suspense boundaries** — use the exact same `<Suspense>` wrapper pattern from drill/page.tsx, don't add fallback UI (matches existing convention)
- **Category name resolution** — reuse `USCIS_CATEGORY_NAMES[param]` and `SUB_CATEGORY_NAMES[param]` from `@/lib/mastery`, don't duplicate logic

---

## Common Pitfalls

1. **Missing Suspense boundary for useSearchParams** — In Next.js App Router, `useSearchParams()` without a parent `<Suspense>` causes a build warning and deopts the entire page to client-side rendering. The practice page wrapper MUST wrap in Suspense.

2. **Category param validation** — The `?category=` value comes from URL, could be anything. Must validate against known category lists before setting as initial state. Invalid/missing → fall through to `null` (normal config screen with no pre-selection).

3. **React Compiler + useState initializer** — Don't use `useState(() => searchParams.get('category'))` lazy initializer with validation logic — React Compiler is strict about this. Use a simple derived initial value or useMemo.

4. **Expanded parent category for sub-categories** — If `?category=` is a sub-category (e.g., "Presidents"), PracticeConfig should also expand the parent USCIS category accordion so the selection is visible. DrillConfig doesn't need this (different UI), but PracticeConfig has expandable sections.

5. **SUMMARY frontmatter YAML arrays** — Use `[REQ-01, REQ-02]` flow syntax, not block sequence, to keep frontmatters compact. Plans with no requirement coverage should use `requirements-completed: []`.

6. **Don't change PracticeConfig's controlled state contract** — PracticeConfig uses `selectedCategory` as controlled state. The `initialCategory` prop should only set the initial value, not make it controlled from parent. Use `useState(initialCategory ?? null)` pattern.

---

## Code Examples

### SC-1: PracticePage search param reading

```typescript
// src/views/PracticePage.tsx — add to imports
import { useSearchParams } from 'next/navigation';
import { USCIS_CATEGORY_NAMES, SUB_CATEGORY_NAMES } from '@/lib/mastery';

// Inside PracticePage component, near top:
const searchParams = useSearchParams();
const categoryParam = searchParams.get('category');

// Validate category param
const initialCategory = useMemo(() => {
  if (!categoryParam) return null;
  if (categoryParam in USCIS_CATEGORY_NAMES) return categoryParam as USCISCategory;
  if (categoryParam in SUB_CATEGORY_NAMES) return categoryParam as Category;
  return null;
}, [categoryParam]);

// Pass to PracticeConfig:
<PracticeConfig onStart={handleStart} initialCategory={initialCategory} />
```

### SC-1: PracticeConfig initial category prop

```typescript
// src/components/practice/PracticeConfig.tsx
interface PracticeConfigProps {
  onStart: (config: PracticeConfigType) => void;
  initialCategory?: USCISCategory | Category | null;
}

export function PracticeConfig({ onStart, initialCategory }: PracticeConfigProps) {
  // ...
  const [selectedCategory, setSelectedCategory] = useState<
    USCISCategory | Category | 'weak' | null
  >(initialCategory ?? null);

  // Auto-expand parent if initial is a sub-category
  const [expandedCategory, setExpandedCategory] = useState<USCISCategory | null>(() => {
    if (!initialCategory) return null;
    if (initialCategory in USCIS_CATEGORY_NAMES) return initialCategory as USCISCategory;
    // Find parent of sub-category
    for (const [main, def] of Object.entries(USCIS_CATEGORIES)) {
      if (def.subCategories.includes(initialCategory as Category)) {
        return main as USCISCategory;
      }
    }
    return null;
  });
```

### SC-1: Practice page wrapper with Suspense

```typescript
// app/(protected)/practice/page.tsx
'use client';

import { Suspense } from 'react';
import PracticePage from '@/views/PracticePage';

export default function Practice() {
  return (
    <Suspense>
      <PracticePage />
    </Suspense>
  );
}
```

### SC-2: GoogleOneTapSignIn redirect fix

```typescript
// src/components/GoogleOneTapSignIn.tsx line 76
// Before:
redirectTo: `${window.location.origin}/dashboard`,
// After:
redirectTo: `${window.location.origin}/home`,
```

### SC-3: ROADMAP provider count fix

```markdown
<!-- .planning/ROADMAP.md line 114 -->
<!-- Before: -->
  2. `ClientProviders.tsx` wraps all 12 context providers in correct nesting order
<!-- After: -->
  2. `ClientProviders.tsx` wraps all 10 context providers in correct nesting order
```

### SC-4: SUMMARY frontmatter field example

```yaml
---
phase: 39-next-js-16-upgrade-and-tooling
plan: 01
requirements-completed: [MIGR-01]
subsystem: infra
# ...rest unchanged
---
```

---

## Requirement-to-Plan Mapping for SC-4

Based on REQUIREMENTS.md checkboxes and phase verification docs:

| Plan | Requirements Completed |
|------|----------------------|
| 39-01 | [MIGR-01] (partial — dependency upgrade) |
| 39-02 | [MIGR-01] (partial — Next.js 16 upgrade) |
| 39-03 | [MIGR-03] (Sentry reconfiguration) |
| 39-04 | [MIGR-01, MIGR-02, MIGR-03] (verification confirms all 3) |
| 40-01 | [MIGR-04] (partial — ClientProviders) |
| 40-02 | [MIGR-04] (partial — root layout) |
| 40-03 | [MIGR-07] (auth guard layout) |
| 41-01 | [MIGR-05, MIGR-12] (route scaffolding, clean URLs) |
| 41-02 | [MIGR-11] (API route migration) |
| 41-03 | [MIGR-05] (partial — remaining routes) |
| 41-04 | [MIGR-08] (page transitions template) |
| 41-05 | [MIGR-05, MIGR-06] (final routes + react-router-dom removal) |
| 42-01 | [MIGR-09] (CSP nonce migration) |
| 42-02 | [MIGR-10] (service worker update) |
| 43-01 | [RDNS-01, RDNS-02, RDNS-03] (readiness engine + tests) |
| 43-02 | [RDNS-04, RDNS-05] (dashboard hero card + drill list) |
| 43-03 | [RDNS-06] (drill results with mastery delta) |
| 43-04 | [] (drill entry point wiring — no new requirements, supports RDNS-04/05) |

**Note:** This mapping needs verification against actual VERIFICATION.md files during execution. The above is based on requirement descriptions and phase goals.

---

## Verification Checklist

- [ ] `?category=` param validated and pre-selects in PracticeConfig
- [ ] Suspense boundary added to practice page wrapper
- [ ] Invalid category params gracefully fall through to normal config
- [ ] Sub-category params expand parent accordion
- [ ] GoogleOneTapSignIn redirect changed to `/home`
- [ ] ROADMAP "12" changed to "10"
- [ ] All 18 SUMMARY files have `requirements-completed` field
- [ ] `npm run build` passes
