---
phase: 20-session-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/sessions/sessionTypes.ts
  - src/lib/sessions/sessionStore.ts
  - src/lib/sessions/useSessionPersistence.ts
  - src/lib/sessions/timeAgo.ts
  - src/lib/audio/soundEffects.ts
autonomous: true

must_haves:
  truths:
    - "Session snapshots can be saved to and loaded from IndexedDB"
    - "Sessions older than 24 hours are automatically discarded on load"
    - "Each session type has a distinct typed snapshot interface"
    - "Relative timestamps are formatted bilingually"
  artifacts:
    - path: "src/lib/sessions/sessionTypes.ts"
      provides: "TypeScript interfaces for MockTestSnapshot, PracticeSnapshot, InterviewSnapshot, and SessionSnapshot union"
      exports: ["BaseSessionSnapshot", "MockTestSnapshot", "PracticeSnapshot", "InterviewSnapshot", "SessionSnapshot", "SESSION_VERSION"]
    - path: "src/lib/sessions/sessionStore.ts"
      provides: "IndexedDB CRUD operations for session snapshots via idb-keyval createStore"
      exports: ["sessionStore", "saveSession", "getSessionsByType", "getAllSessions", "deleteSession", "cleanExpiredSessions"]
    - path: "src/lib/sessions/useSessionPersistence.ts"
      provides: "React hook wrapping sessionStore with loading state and auto-expiry"
      exports: ["useSessionPersistence"]
    - path: "src/lib/sessions/timeAgo.ts"
      provides: "Bilingual relative time formatter"
      exports: ["timeAgo"]
    - path: "src/lib/audio/soundEffects.ts"
      provides: "Countdown tick and go sound effects"
      contains: "playCountdownTick"
  key_links:
    - from: "src/lib/sessions/sessionStore.ts"
      to: "idb-keyval"
      via: "createStore, get, set, del, keys imports"
      pattern: "createStore.*civic-prep-sessions"
    - from: "src/lib/sessions/useSessionPersistence.ts"
      to: "src/lib/sessions/sessionStore.ts"
      via: "imports getAllSessions, getSessionsByType, deleteSession, cleanExpiredSessions"
      pattern: "import.*from.*sessionStore"
---

<objective>
Create the session persistence foundation: TypeScript types, IndexedDB store, React hook, bilingual time formatter, and countdown audio effects.

Purpose: All downstream plans (resume modal, page integrations, dashboard) depend on these foundational modules. This plan establishes the data layer and utilities that every other plan in this phase consumes.

Output: 5 new files under `src/lib/sessions/` plus additions to `soundEffects.ts`.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-session-persistence/20-RESEARCH.md
@.planning/phases/20-session-persistence/20-CONTEXT.md
@src/lib/pwa/offlineDb.ts
@src/lib/audio/soundEffects.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Session types and IndexedDB store</name>
  <files>src/lib/sessions/sessionTypes.ts, src/lib/sessions/sessionStore.ts</files>
  <action>
Create `src/lib/sessions/sessionTypes.ts`:

1. Define `BaseSessionSnapshot` interface with fields:
   - `id: string` (format: `session-{type}-{timestamp}`)
   - `type: 'mock-test' | 'practice' | 'interview'`
   - `savedAt: string` (ISO timestamp)
   - `version: number` (schema version for migration safety)

2. Define `MockTestSnapshot extends BaseSessionSnapshot` with:
   - `type: 'mock-test'`
   - `questions: Question[]` (the shuffled 20 questions with shuffled answers)
   - `results: QuestionResult[]` (answers given so far)
   - `currentIndex: number`
   - `timeLeft: number` (seconds remaining -- for display only, timer resets on resume)

3. Define `PracticeSnapshot extends BaseSessionSnapshot` with:
   - `type: 'practice'`
   - `questions: Question[]` (selected + shuffled)
   - `results: QuestionResult[]`
   - `currentIndex: number`
   - `timerEnabled: boolean`
   - `timeLeft: number`
   - `config: { category: string; categoryName: { en: string; my: string }; count: number }`

4. Define `InterviewSnapshot extends BaseSessionSnapshot` with:
   - `type: 'interview'`
   - `questions: Question[]` (shuffled questions)
   - `results: InterviewResult[]`
   - `currentIndex: number`
   - `correctCount: number`
   - `incorrectCount: number`
   - `mode: InterviewMode`
   - `startTime: number` (Date.now() of original session start)

5. Export discriminated union: `type SessionSnapshot = MockTestSnapshot | PracticeSnapshot | InterviewSnapshot`
6. Export `const SESSION_VERSION = 1`

Import `Question`, `QuestionResult`, `InterviewResult`, `InterviewMode` from `@/types`.

Create `src/lib/sessions/sessionStore.ts`:

1. `import { createStore, get, set, del, keys } from 'idb-keyval'`
2. `export const sessionStore = createStore('civic-prep-sessions', 'active-sessions')`
3. `const SESSION_EXPIRY_MS = 24 * 60 * 60 * 1000` (24 hours)

4. `saveSession(snapshot: SessionSnapshot): Promise<void>` -- sets snapshot by ID with current version

5. `getSessionsByType(type: SessionSnapshot['type']): Promise<SessionSnapshot[]>` -- iterates all keys, filters by type, discards expired (deletes them) and version-mismatched entries

6. `getAllSessions(): Promise<SessionSnapshot[]>` -- same as getSessionsByType but no type filter. Used by dashboard and nav badges.

7. `deleteSession(id: string): Promise<void>` -- deletes by ID

8. `cleanExpiredSessions(): Promise<void>` -- iterates all keys, deletes any with expired savedAt or version mismatch. Called on app startup.

Follow the exact pattern from `offlineDb.ts` -- `createStore` for isolation, iterate `keys()` + `get()` for filtering.

IMPORTANT: Max 1 session per type. In `saveSession`, before setting the new snapshot, iterate existing keys and delete any that match the same `type`. This enforces the 1-per-type limit (3 total max).
  </action>
  <verify>
`npm run typecheck` passes. Manually verify the file exports the expected types and functions. No lint errors.
  </verify>
  <done>
sessionTypes.ts exports 5 interfaces + SESSION_VERSION constant. sessionStore.ts exports sessionStore, saveSession, getSessionsByType, getAllSessions, deleteSession, cleanExpiredSessions. All use idb-keyval createStore pattern matching offlineDb.ts. Max 1 session per type enforced in saveSession.
  </done>
</task>

<task type="auto">
  <name>Task 2: Persistence hook, timeAgo utility, and countdown sounds</name>
  <files>src/lib/sessions/useSessionPersistence.ts, src/lib/sessions/timeAgo.ts, src/lib/audio/soundEffects.ts</files>
  <action>
Create `src/lib/sessions/useSessionPersistence.ts`:

A React hook that wraps the session store for use in components:

```typescript
interface UseSessionPersistenceReturn {
  sessions: SessionSnapshot[];
  isLoading: boolean;
  refresh: () => Promise<void>;
  removeSession: (id: string) => Promise<void>;
}
```

1. Use `useState` with lazy init for initial loading state: `const [isLoading, setIsLoading] = useState(true)`
2. Use `useState` for sessions: `const [sessions, setSessions] = useState<SessionSnapshot[]>([])`
3. Optional `type` parameter to filter by session type. If omitted, returns all sessions.
4. On mount, call `getAllSessions()` or `getSessionsByType(type)` and set state via a callback pattern that avoids React Compiler ESLint violations:
   - Use the `useEffect` + async IIFE pattern with a `cancelled` flag (same pattern as Dashboard.tsx line 55-70)
   - Set `isLoading` to `false` after load completes
5. Expose `refresh()` that re-fetches from IndexedDB (called after save/delete)
6. Expose `removeSession(id)` that calls `deleteSession(id)` then `refresh()`

IMPORTANT: Follow the React Compiler safe pattern from the codebase. No `setState` directly in effect body -- use the cancelled-flag async pattern.

Create `src/lib/sessions/timeAgo.ts`:

Simple bilingual relative time formatter (~20 lines):
- Input: ISO date string
- Output: `{ en: string; my: string }`
- Thresholds: < 1 min = "just now", < 60 min = "X min ago", < 24 hours = "X hours ago", else = "yesterday"
- Burmese translations: "ယခုလေးတင်", "X မိနစ်အကြာ", "X နာရီအကြာ", "မနေ့က"

Add countdown sounds to `src/lib/audio/soundEffects.ts`:

Add two new exported functions at the end of the file (before the re-exports if any):

1. `playCountdownTick()` -- short click/tick at 800 Hz, 80ms duration, volume 0.15. Uses existing `getContext()` and `playNote()` internal functions. Checks `isSoundMuted()` first.

2. `playCountdownGo()` -- ascending two-note "go" chime. C5 (523 Hz) at t=0 for 150ms at volume 0.25, then G5 (784 Hz) at t=0.1 for 200ms at volume 0.25. Checks `isSoundMuted()` first.

Both functions follow the exact pattern of existing `playCorrect()` / `playIncorrect()` -- module-level functions (NOT hooks), try/catch with silent failure.
  </action>
  <verify>
`npm run typecheck` and `npm run lint` pass. Verify `timeAgo` returns correct bilingual strings for various time deltas. Verify new sound functions are exported from soundEffects.ts.
  </verify>
  <done>
useSessionPersistence hook loads sessions from IndexedDB with loading state. timeAgo returns bilingual relative timestamps. soundEffects.ts has playCountdownTick and playCountdownGo functions matching existing audio patterns.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes -- all new files have correct type imports
2. `npm run lint` passes -- no ESLint violations in new files
3. Session types correctly reference existing `Question`, `QuestionResult`, `InterviewResult`, `InterviewMode` types
4. sessionStore.ts follows the createStore pattern from offlineDb.ts
5. useSessionPersistence hook follows React Compiler safe patterns (no setState in effect body)
6. Sound functions follow existing soundEffects.ts patterns
</verification>

<success_criteria>
- All 5 new files exist and compile without errors
- sessionStore CRUD operations use idb-keyval with custom store
- 24-hour expiry is enforced on load (SESS-04)
- 1-per-type limit is enforced on save
- Hook provides loading state and refresh capability
- Countdown sounds are audible and follow mute preference
</success_criteria>

<output>
After completion, create `.planning/phases/20-session-persistence/20-01-SUMMARY.md`
</output>
