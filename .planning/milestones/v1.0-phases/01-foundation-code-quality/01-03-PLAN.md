---
phase: 01-foundation-code-quality
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/types/supabase.ts
  - src/types/index.ts
  - src/contexts/SupabaseAuthContext.tsx
  - src/components/GoogleOneTapSignIn.tsx
autonomous: true

must_haves:
  truths:
    - "Developer runs `npm run typecheck` with zero errors"
    - "No `any` types exist in production code"
    - "Supabase responses are properly typed"
  artifacts:
    - path: "src/types/supabase.ts"
      provides: "Supabase response type definitions"
      exports: ["MockTestRow", "MockTestResponseRow", "ProfileRow"]
    - path: "src/types/index.ts"
      provides: "Updated type exports"
      contains: "supabase"
  key_links:
    - from: "src/contexts/SupabaseAuthContext.tsx"
      to: "src/types/supabase.ts"
      via: "import types"
      pattern: "MockTestRow|ProfileRow"
---

<objective>
Eliminate all `any` types in production code by creating proper TypeScript interfaces for Supabase responses and user metadata.

Purpose: Type safety prevents runtime errors from database schema mismatches and provides better developer experience with autocomplete and error detection. This satisfies FNDN-04 and FNDN-05 requirements.

Output: Supabase response type definitions, updated mapResponses function with proper types, typed Google user metadata.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-code-quality/01-RESEARCH.md
@.planning/phases/01-foundation-code-quality/01-01-SUMMARY.md
@src/types/index.ts
@src/contexts/SupabaseAuthContext.tsx
@src/components/GoogleOneTapSignIn.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase response type definitions</name>
  <files>src/types/supabase.ts, src/types/index.ts</files>
  <action>
Create src/types/supabase.ts with proper types for all Supabase table responses:

```typescript
/**
 * Supabase database response types.
 * These match the actual database schema and are used to type
 * the responses from Supabase queries.
 */

import type { TestEndReason, Category } from './index';

/**
 * Profile row from 'profiles' table
 */
export interface ProfileRow {
  id: string;
  full_name: string | null;
  email: string;
  created_at?: string;
  updated_at?: string;
}

/**
 * Mock test response row from 'mock_test_responses' table
 * Nested within MockTestRow when using joins
 */
export interface MockTestResponseRow {
  id?: string;
  mock_test_id: string;
  question_id: number;
  question_en: string;
  question_my: string;
  category: Category;
  selected_answer_en: string;
  selected_answer_my: string;
  correct_answer_en: string;
  correct_answer_my: string;
  is_correct: boolean;
}

/**
 * Mock test row from 'mock_tests' table
 * Includes nested responses when using select with join
 */
export interface MockTestRow {
  id: string;
  user_id: string;
  completed_at: string;
  score: number;
  total_questions: number;
  duration_seconds: number;
  incorrect_count: number;
  end_reason: TestEndReason | string;
  passed: boolean;
  mock_test_responses?: MockTestResponseRow[];
}

/**
 * Google OAuth user metadata structure
 * Returned in user.user_metadata after Google sign-in
 */
export interface GoogleUserMetadata {
  full_name?: string;
  name?: string;
  picture?: string;
  email?: string;
  email_verified?: boolean;
  iss?: string;
  sub?: string;
  aud?: string;
  exp?: number;
  iat?: number;
  avatar_url?: string;
}

/**
 * Supabase Auth user metadata (union of possible providers)
 */
export type UserMetadata = GoogleUserMetadata | Record<string, unknown>;

/**
 * Type guard to check if metadata is from Google OAuth
 */
export function isGoogleMetadata(metadata: UserMetadata): metadata is GoogleUserMetadata {
  return (
    typeof metadata === 'object' &&
    metadata !== null &&
    ('full_name' in metadata || 'name' in metadata)
  );
}
```

Update src/types/index.ts to re-export Supabase types:

Add at the end of the file:
```typescript
// Re-export Supabase types for convenience
export type {
  ProfileRow,
  MockTestRow,
  MockTestResponseRow,
  GoogleUserMetadata,
  UserMetadata,
} from './supabase';
export { isGoogleMetadata } from './supabase';
```
  </action>
  <verify>
Run `npm run typecheck` - should pass with new type definitions.
Verify src/types/supabase.ts exports all types correctly.
  </verify>
  <done>Supabase response types created for profiles, mock_tests, mock_test_responses, and Google OAuth metadata</done>
</task>

<task type="auto">
  <name>Task 2: Update SupabaseAuthContext to use proper types</name>
  <files>src/contexts/SupabaseAuthContext.tsx</files>
  <action>
Update src/contexts/SupabaseAuthContext.tsx to replace all `any` types:

**1. Update imports at top of file:**
```typescript
import type { QuestionResult, TestEndReason, TestSession, User, MockTestRow, MockTestResponseRow, isGoogleMetadata } from '@/types';
```

**2. Replace mapResponses function (lines 29-67):**

Change from:
```typescript
const mapResponses = (test: any): TestSession => {
  const results: QuestionResult[] = (test.mock_test_responses ?? []).map((response: any): QuestionResult => ({
```

To:
```typescript
const mapResponses = (test: MockTestRow): TestSession => {
  const results: QuestionResult[] = (test.mock_test_responses ?? []).map((response: MockTestResponseRow): QuestionResult => ({
    questionId: response.question_id,
    questionText_en: response.question_en,
    questionText_my: response.question_my,
    selectedAnswer: {
      text_en: response.selected_answer_en,
      text_my: response.selected_answer_my,
      correct: response.is_correct,
    },
    correctAnswer: {
      text_en: response.correct_answer_en,
      text_my: response.correct_answer_my,
      correct: true,
    },
    isCorrect: response.is_correct,
    category: response.category,
  }));

  const derivedScore = results.length
    ? results.filter(result => result.isCorrect).length
    : test.score ?? 0;
  const totalQuestions = test.total_questions ?? (results.length || 20);
  const derivedIncorrect = test.incorrect_count ?? Math.max(totalQuestions - derivedScore, 0);
  const normalizedReason = isEndReason(test.end_reason) ? test.end_reason : 'complete';
  const passed = typeof test.passed === 'boolean' ? test.passed : derivedScore >= PASS_THRESHOLD;

  return {
    id: test.id,
    date: test.completed_at,
    score: derivedScore,
    totalQuestions,
    durationSeconds: test.duration_seconds ?? 0,
    passed,
    incorrectCount: derivedIncorrect,
    endReason: normalizedReason,
    results,
  };
};
```

**3. Update loginWithGoogleIdToken (line 189):**

Change from:
```typescript
full_name: (data.user.user_metadata as any)?.full_name ?? data.user.email ?? 'Learner',
```

To:
```typescript
import { isGoogleMetadata } from '@/types';

// Inside loginWithGoogleIdToken:
const metadata = data.user.user_metadata;
const fullName = isGoogleMetadata(metadata)
  ? (metadata.full_name ?? metadata.name ?? data.user.email ?? 'Learner')
  : (data.user.email ?? 'Learner');

await syncProfile({
  id: data.user.id,
  email: data.user.email ?? '',
  full_name: fullName,
});
```

**4. Update hydrateFromSupabase to type the query result:**

The Supabase select query already returns typed data, but we can add explicit typing:

```typescript
const { data: testsData } = await supabase
  .from('mock_tests')
  .select(
    `id, completed_at, score, total_questions, duration_seconds, incorrect_count, end_reason, passed, mock_test_responses (
      question_id, question_en, question_my, category, selected_answer_en, selected_answer_my,
      correct_answer_en, correct_answer_my, is_correct
    )`
  )
  .eq('user_id', authUser.id)
  .order('completed_at', { ascending: false });

// Cast to our known type
const history: TestSession[] = ((testsData ?? []) as MockTestRow[]).map(mapResponses);
```
  </action>
  <verify>
Run `npm run typecheck` - should pass with zero errors.
Run `npm run lint` - should show no `@typescript-eslint/no-explicit-any` errors in SupabaseAuthContext.tsx.
  </verify>
  <done>SupabaseAuthContext uses proper TypeScript types instead of `any` for all Supabase responses and metadata</done>
</task>

<task type="auto">
  <name>Task 3: Update GoogleOneTapSignIn to remove any types</name>
  <files>src/components/GoogleOneTapSignIn.tsx</files>
  <action>
Review src/components/GoogleOneTapSignIn.tsx for any `any` types. The file uses the global google.accounts types from src/types/google.accounts.d.ts.

Check the file and if there are any `any` types:

1. Check window.google typing - should use the declared global types
2. Check credential response typing - should use google.accounts.id.CredentialResponse

If the google.accounts.d.ts types are incomplete, update them:

```typescript
// src/types/google.accounts.d.ts
declare global {
  interface Window {
    google?: {
      accounts: {
        id: {
          initialize: (config: GoogleIdConfiguration) => void;
          prompt: (callback?: PromptMomentNotification) => void;
          renderButton: (
            parent: HTMLElement,
            options: GsiButtonConfiguration
          ) => void;
          disableAutoSelect: () => void;
          revoke: (hint: string, callback?: (done: RevocationResponse) => void) => void;
          cancel: () => void;
        };
      };
    };
  }

  interface GoogleIdConfiguration {
    client_id: string;
    callback: (response: CredentialResponse) => void;
    auto_select?: boolean;
    login_uri?: string;
    native_callback?: (response: CredentialResponse) => void;
    cancel_on_tap_outside?: boolean;
    prompt_parent_id?: string;
    nonce?: string;
    context?: 'signin' | 'signup' | 'use';
    state_cookie_domain?: string;
    ux_mode?: 'popup' | 'redirect';
    allowed_parent_origin?: string | string[];
    intermediate_iframe_close_callback?: () => void;
    itp_support?: boolean;
    log_level?: 'debug' | 'info' | 'warn' | 'error';
  }

  interface CredentialResponse {
    credential: string;
    select_by: 'auto' | 'user' | 'user_1tap' | 'user_2tap' | 'btn' | 'btn_confirm' | 'btn_add_session' | 'btn_confirm_add_session';
    clientId?: string;
  }

  interface PromptMomentNotification {
    isDisplayMoment: () => boolean;
    isDisplayed: () => boolean;
    isNotDisplayed: () => boolean;
    getNotDisplayedReason: () => 'browser_not_supported' | 'invalid_client' | 'missing_client_id' | 'opt_out_or_no_session' | 'secure_http_required' | 'suppressed_by_user' | 'unregistered_origin' | 'unknown_reason';
    isSkippedMoment: () => boolean;
    getSkippedReason: () => 'auto_cancel' | 'user_cancel' | 'tap_outside' | 'issuing_failed';
    isDismissedMoment: () => boolean;
    getDismissedReason: () => 'credential_returned' | 'cancel_called' | 'flow_restarted';
    getMomentType: () => 'display' | 'skipped' | 'dismissed';
  }

  interface GsiButtonConfiguration {
    type: 'standard' | 'icon';
    theme?: 'outline' | 'filled_blue' | 'filled_black';
    size?: 'large' | 'medium' | 'small';
    text?: 'signin_with' | 'signup_with' | 'continue_with' | 'signin';
    shape?: 'rectangular' | 'pill' | 'circle' | 'square';
    logo_alignment?: 'left' | 'center';
    width?: string | number;
    locale?: string;
  }

  interface RevocationResponse {
    successful: boolean;
    error?: string;
  }
}

export {};
```

Verify GoogleOneTapSignIn.tsx uses these types correctly and has no `any` casts.
  </action>
  <verify>
Run `npm run typecheck` - should pass.
Run `npm run lint` - no `@typescript-eslint/no-explicit-any` errors.
Run `grep -r "any" src/components/GoogleOneTapSignIn.tsx` - should find zero matches (or only in comments).
  </verify>
  <done>GoogleOneTapSignIn uses proper TypeScript types for Google Identity Services API</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` - zero errors
2. `npm run lint` - no `@typescript-eslint/no-explicit-any` violations
3. `grep -rn ": any" src/` - returns zero matches in production code (test files may have some)
4. All Supabase query responses properly typed
5. Google OAuth metadata properly typed
</verification>

<success_criteria>
- Zero `any` types in src/contexts/ and src/components/
- Supabase response types match database schema
- Google user metadata typed with proper interface
- All TypeScript strict mode checks pass
- Requirements FNDN-04 and FNDN-05 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-code-quality/01-03-SUMMARY.md`
</output>
