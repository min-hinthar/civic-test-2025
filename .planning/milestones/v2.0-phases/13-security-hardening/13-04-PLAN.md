---
phase: 13-security-hardening
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - .github/dependabot.yml
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "Running pnpm audit shows zero critical or high severity vulnerabilities"
    - "Unused production dependencies (marked, react-swipeable, dotenv) are removed from package.json"
    - "Unused dev dependencies (@testing-library/user-event, @vitest/coverage-v8, eslint-config-next, lint-staged, stylelint-config-standard) are evaluated and pruned where safe"
    - "Dependabot is configured to monitor npm dependencies weekly"
    - "CI pipeline includes a pnpm audit step that fails on high/critical vulnerabilities"
  artifacts:
    - path: "package.json"
      provides: "Updated dependencies with no critical/high vulnerabilities"
    - path: ".github/dependabot.yml"
      provides: "Automated dependency update monitoring"
      contains: "npm"
    - path: ".github/workflows/ci.yml"
      provides: "CI security audit step"
      contains: "pnpm audit"
  key_links:
    - from: ".github/dependabot.yml"
      to: "package.json"
      via: "Dependabot monitors and creates PRs for dependency updates"
      pattern: "package-ecosystem.*npm"
    - from: ".github/workflows/ci.yml"
      to: "pnpm audit"
      via: "CI step that blocks PRs with critical/high vulnerabilities"
      pattern: "pnpm audit"
---

<objective>
Upgrade Next.js to resolve known CVEs, prune unused dependencies, configure Dependabot for ongoing monitoring, and add a security audit step to the CI pipeline.

Purpose: next@15.1.11 has 7 known vulnerabilities (1 critical authorization bypass, 1 high DoS). The project has 6 unused production dependencies that increase attack surface. No automated dependency monitoring or CI security checks exist.

Output: Clean dependency tree, Dependabot config, CI audit step.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade Next.js and prune unused dependencies</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
**Step 1: Upgrade Next.js to resolve CVEs.**

Run `pnpm update next` to upgrade to the latest 15.x patch. The research identified `>=15.5.10` as fixing all 7 known CVEs. If the latest 15.x is higher, that's fine. Do NOT upgrade to 16.x (breaking change risk, separate effort).

After upgrading, run `pnpm audit` and verify the critical and high vulnerabilities in next are resolved.

**Step 2: Evaluate and prune unused production dependencies.**

The research identified these as unused by depcheck:
1. **`marked` (v17)** -- REMOVE. Not imported anywhere in `src/`. It's a markdown-to-HTML renderer and an XSS vector if ever accidentally imported.
2. **`react-swipeable`** -- Search for any imports with `grep -r "react-swipeable" src/`. If truly unused, REMOVE. If used, KEEP.
3. **`dotenv`** -- EVALUATE. Next.js handles `.env.local` natively. Search for `require('dotenv')` or `import.*dotenv`. If no imports, REMOVE.
4. **`@radix-ui/react-toast`** -- Search for imports. The project may use `sonner` or a custom toast instead. If unused, REMOVE.
5. **`autoprefixer`** -- CHECK `postcss.config.js` or `postcss.config.mjs`. If referenced there, KEEP (PostCSS plugin). Depcheck can't see PostCSS config.
6. **`postcss`** -- CHECK. Same as autoprefixer -- required by Tailwind's PostCSS integration. Likely KEEP.

**Step 3: Evaluate and prune unused dev dependencies.**

1. **`@testing-library/user-event`** -- Search for imports in test files: `grep -r "user-event\|userEvent" src/ __tests__/`. If unused, REMOVE.
2. **`@vitest/coverage-v8`** -- CHECK. Referenced by `test:coverage` script? If `vitest run --coverage` uses it, KEEP.
3. **`eslint-config-next`** -- CHECK. Is it referenced in `eslint.config.*` or `.eslintrc.*`? If yes, KEEP. If not (flat config may use `@next/eslint-plugin-next` directly), REMOVE.
4. **`lint-staged`** -- CHECK. Pre-commit hook is disabled per memory. But if `package.json` has a lint-staged config section or `.lintstagedrc`, it may be needed for future re-enablement. KEEP if config exists, REMOVE if no config.
5. **`stylelint-config-standard`** -- CHECK. Is it referenced in `.stylelintrc` or `stylelint.config.*`? If yes, KEEP.

**Step 4: After all changes, run:**
```bash
pnpm install
pnpm run typecheck
pnpm run build
pnpm run test:run
pnpm audit
```

Verify: build passes, tests pass, audit shows zero critical/high.

**IMPORTANT:** Do NOT remove `autoprefixer` or `postcss` without verifying they're not in PostCSS config. Do NOT remove `@vitest/coverage-v8` if the test:coverage script uses it. Be conservative -- only remove what is provably unused.
  </action>
  <verify>
1. `pnpm audit` output shows 0 critical and 0 high severity vulnerabilities.
2. `pnpm run build` succeeds.
3. `pnpm run test:run` passes.
4. `pnpm run typecheck` passes.
5. `marked` is not in package.json dependencies.
6. `next` version in package.json is >= 15.5.10.
  </verify>
  <done>
- next upgraded to latest 15.x (>= 15.5.10) with 0 critical/high CVEs
- `marked` removed from dependencies
- Other unused deps evaluated and removed where safe
- Build, tests, and typecheck all pass after changes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Dependabot config and CI security audit step</name>
  <files>.github/dependabot.yml, .github/workflows/ci.yml</files>
  <action>
**Create `.github/dependabot.yml`:**

```yaml
version: 2
updates:
  - package-ecosystem: npm
    directory: /
    schedule:
      interval: weekly
      day: monday
    open-pull-requests-limit: 10
    groups:
      production-deps:
        dependency-type: production
      dev-deps:
        dependency-type: development
    ignore:
      # Don't auto-update major versions (review manually)
      - dependency-name: "*"
        update-types: ["version-update:semver-major"]
```

This configuration:
- Checks npm dependencies weekly (Monday)
- Groups production and dev dependency PRs to reduce noise
- Limits to 10 open PRs at once
- Ignores major version bumps (manual review needed)

**Add security audit step to `.github/workflows/ci.yml`:**

Insert a new step AFTER "Install dependencies" and BEFORE "Type check":

```yaml
      - name: Security audit
        run: pnpm audit --audit-level=high
```

This fails the CI pipeline if any critical or high severity vulnerabilities exist, catching new vulnerabilities introduced by dependency changes.

**License check (informational):**

Run `npx license-checker --summary --production` locally during this task to check for problematic licenses. If any GPL or AGPL licenses are found in production dependencies, note them in the plan summary. Do NOT add this to CI -- it's a one-time informational check per user decision.
  </action>
  <verify>
1. Read `.github/dependabot.yml` and confirm: npm ecosystem, weekly schedule, grouped updates, major version ignore.
2. Read `.github/workflows/ci.yml` and confirm: "Security audit" step with `pnpm audit --audit-level=high` exists after install and before typecheck.
3. Run `pnpm audit --audit-level=high` locally to verify it exits with code 0 (no high/critical vulns).
  </verify>
  <done>
- `.github/dependabot.yml` exists with weekly npm monitoring config
- CI pipeline has `pnpm audit --audit-level=high` step
- Audit step is positioned after install, before build/test
- License check results documented in summary (informational only)
  </done>
</task>

</tasks>

<verification>
1. `pnpm audit --audit-level=high` exits with code 0
2. `pnpm run build` succeeds
3. `pnpm run test:run` passes
4. `.github/dependabot.yml` exists
5. CI workflow includes security audit step
6. `marked` removed from package.json
7. `next` version >= 15.5.10
</verification>

<success_criteria>
- Zero critical or high npm vulnerabilities
- Unused dependencies pruned (at minimum: marked)
- Dependabot configured for weekly monitoring
- CI pipeline catches new vulnerabilities automatically
- Build and tests pass after all dependency changes
</success_criteria>

<output>
After completion, create `.planning/phases/13-security-hardening/13-04-SUMMARY.md`
</output>
