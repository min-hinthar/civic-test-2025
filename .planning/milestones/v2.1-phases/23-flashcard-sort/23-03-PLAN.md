---
phase: 23-flashcard-sort
plan: 03
type: tdd
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/lib/sort/sortReducer.test.ts
autonomous: true

must_haves:
  truths:
    - "Reducer tests cover all 9 action types with phase guard verification"
    - "Tests verify shuffling happens on START_SORT and START_NEXT_ROUND"
    - "Tests verify round cap at MAX_ROUNDS"
    - "Tests verify mastery detection when all cards sorted as Know"
    - "Tests verify undo correctly reverses know and dont-know sorts"
  artifacts:
    - path: "src/lib/sort/sortReducer.test.ts"
      provides: "Comprehensive unit tests for sort reducer"
      min_lines: 150
  key_links:
    - from: "src/lib/sort/sortReducer.test.ts"
      to: "src/lib/sort/sortReducer.ts"
      via: "import sortReducer, initialSortState"
      pattern: "import.*from.*sortReducer"
---

<objective>
TDD test suite for the sort mode reducer.

Purpose: The reducer is pure logic with defined I/O -- ideal for TDD. Tests validate all state transitions, phase guards, undo logic, round progression, and edge cases before UI integration begins.

Output: `src/lib/sort/sortReducer.test.ts` with 20+ test cases.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/sort/sortTypes.ts (types under test)
@src/lib/sort/sortReducer.ts (module under test)
@src/lib/quiz/quizReducer.test.ts (reference test patterns if exists)
@.planning/phases/23-flashcard-sort/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write sort reducer unit tests</name>
  <files>src/lib/sort/sortReducer.test.ts</files>
  <action>
Create comprehensive test suite for `sortReducer` and `initialSortState`. Use Vitest describe/it blocks.

**Test helper:** Create a `makeTestCards(n: number)` helper that generates mock Question objects with sequential IDs ('q1', 'q2', ...) and minimal required fields (question_en, question_my, category, answers, studyAnswers).

**Test groups:**

**describe('initialSortState'):**
- Creates state with phase 'sorting' and round 1
- Shuffles cards (verify cards array differs from input order for large enough sets -- use 10+ cards)
- Preserves sourceCards as original unshuffled reference
- Sets empty Sets for knownIds, unknownIds, allUnknownIds
- Records startTime close to Date.now()
- Stores categoryFilter from config

**describe('START_SORT'):**
- Creates fresh state from any existing state
- Resets all counters and Sets

**describe('SORT_CARD'):**
- Phase guard: no-op when phase is not 'sorting'
- Adds questionId to knownIds when direction is 'know'
- Adds questionId to unknownIds AND allUnknownIds when direction is 'dont-know'
- Pushes UndoEntry to undoStack
- Transitions to 'animating' phase

**describe('ANIMATION_COMPLETE'):**
- Phase guard: no-op when phase is not 'animating'
- Advances currentIndex
- Transitions to 'sorting' when more cards remain
- Transitions to 'round-summary' when all cards sorted (and some unknown)
- Creates RoundResult with correct stats in roundHistory
- Transitions to 'mastery' when all cards sorted as Know (unknownIds empty)

**describe('UNDO'):**
- Phase guard: no-op when phase is not 'sorting'
- No-op when undoStack is empty
- Removes questionId from knownIds for know undo
- Removes questionId from unknownIds AND allUnknownIds for dont-know undo
- Decrements currentIndex by 1
- Pops last entry from undoStack

**describe('START_NEXT_ROUND'):**
- Phase guard: no-op when phase is not 'round-summary'
- Filters cards to only unknownIds
- Shuffles the filtered cards
- Increments round number
- Resets knownIds, unknownIds, undoStack
- Preserves allUnknownIds (cumulative)
- No-op when round >= MAX_ROUNDS (round cap enforcement)

**describe('START_COUNTDOWN / CANCEL_COUNTDOWN'):**
- START_COUNTDOWN: round-summary -> countdown
- CANCEL_COUNTDOWN: countdown -> round-summary
- Both no-op from wrong phases

**describe('FINISH_SESSION'):**
- Transitions to idle from any phase
- Preserves roundHistory

**describe('RESUME_SESSION'):**
- Reconstructs state with empty undoStack
- Sets phase to 'sorting'

Use `expect(state.knownIds).toBeInstanceOf(Set)` to verify Set types. Use `expect(state.knownIds.has('q1')).toBe(true)` for Set membership.

Run the tests -- they should all PASS since the reducer was built in Plan 01. If any fail, fix the reducer (not the tests) to match expected behavior.
  </action>
  <verify>Run `npx vitest run src/lib/sort/sortReducer.test.ts --reporter=verbose` -- all tests pass. Run `npx tsc --noEmit`.</verify>
  <done>20+ test cases covering all 9 action types, phase guards, undo logic, round progression, round cap, mastery detection, and resume. All tests pass green.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/lib/sort/sortReducer.test.ts --reporter=verbose` -- all tests pass
2. Coverage for sortReducer.ts exceeds 90% line coverage
3. Every action type has at least one positive test and one phase-guard test
</verification>

<success_criteria>
- All reducer tests pass on first run (tests validate existing implementation, not TDD red-green)
- Phase guard tests confirm no-op behavior for wrong-phase dispatches
- Undo tests verify bidirectional correctness (know and dont-know)
- Round cap test confirms START_NEXT_ROUND is no-op at MAX_ROUNDS
- Mastery test confirms transition when unknownIds is empty
</success_criteria>

<output>
After completion, create `.planning/phases/23-flashcard-sort/23-03-SUMMARY.md`
</output>
