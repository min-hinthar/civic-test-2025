---
phase: 07-social-features
plan: 07
type: execute
wave: 3
depends_on: ["07-02", "07-04", "07-06"]
files_modified:
  - src/pages/SocialHubPage.tsx
  - src/components/social/LeaderboardTable.tsx
  - src/components/social/LeaderboardWidget.tsx
  - src/components/social/LeaderboardProfile.tsx
  - src/hooks/useLeaderboard.ts
autonomous: true

must_haves:
  truths:
    - "Social hub page has three tabs: Leaderboard | Badges | Streak"
    - "Leaderboard shows top 25 users with rank, name, score, and badge"
    - "User's own rank shown regardless of position on the board"
    - "Weekly and all-time leaderboard views toggle via tabs"
    - "Tapping a leaderboard row shows minimal read-only profile"
    - "Dashboard widget shows user's rank and top 3"
    - "Non-authenticated users can view leaderboard (read-only)"
    - "Weekly winner has crown icon next to name"
  artifacts:
    - path: "src/pages/SocialHubPage.tsx"
      provides: "Tabbed social hub page"
      exports: ["default"]
    - path: "src/components/social/LeaderboardTable.tsx"
      provides: "Leaderboard ranking table"
      exports: ["LeaderboardTable"]
    - path: "src/components/social/LeaderboardWidget.tsx"
      provides: "Dashboard compact leaderboard widget"
      exports: ["LeaderboardWidget"]
    - path: "src/components/social/LeaderboardProfile.tsx"
      provides: "Mini profile popup on row tap"
      exports: ["LeaderboardProfile"]
    - path: "src/hooks/useLeaderboard.ts"
      provides: "Leaderboard data fetching"
      exports: ["useLeaderboard"]
  key_links:
    - from: "src/hooks/useLeaderboard.ts"
      to: "supabase/schema.sql"
      via: "calls get_leaderboard RPC"
      pattern: "supabase.rpc.*get_leaderboard"
    - from: "src/pages/SocialHubPage.tsx"
      to: "src/components/social/LeaderboardTable.tsx"
      via: "rendered in Leaderboard tab"
      pattern: "LeaderboardTable"
    - from: "src/pages/SocialHubPage.tsx"
      to: "src/components/social/BadgeGrid.tsx"
      via: "rendered in Badges tab"
      pattern: "BadgeGrid"
    - from: "src/pages/SocialHubPage.tsx"
      to: "src/components/social/StreakHeatmap.tsx"
      via: "rendered in Streak tab"
      pattern: "StreakHeatmap"
---

<objective>
Build the social hub page with tabbed navigation (Leaderboard | Badges | Streak), the leaderboard table with weekly/all-time views, mini profile popup, and dashboard leaderboard widget.

Purpose: The social hub is the central destination for all social features. The leaderboard creates friendly competition that motivates consistent study. The dashboard widget provides at-a-glance social standing.
Output: Social hub page with 3 tabs, leaderboard with top 25 + user rank, mini profiles, and dashboard widget showing rank + top 3.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-social-features/07-RESEARCH.md
@.planning/phases/07-social-features/07-02-SUMMARY.md
@.planning/phases/07-social-features/07-04-SUMMARY.md
@.planning/phases/07-social-features/07-06-SUMMARY.md
@src/pages/HistoryPage.tsx (tab navigation pattern)
@src/components/social/BadgeGrid.tsx (badges tab content)
@src/components/social/StreakHeatmap.tsx (streak tab content)
@src/contexts/SocialContext.tsx
@src/lib/supabaseClient.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: useLeaderboard hook, LeaderboardTable, and LeaderboardProfile</name>
  <files>
    src/hooks/useLeaderboard.ts
    src/components/social/LeaderboardTable.tsx
    src/components/social/LeaderboardProfile.tsx
  </files>
  <action>
    Create `src/hooks/useLeaderboard.ts`:

    1. Hook `useLeaderboard(boardType: 'all-time' | 'weekly' = 'all-time')`.
    2. Calls `supabase.rpc('get_leaderboard', { board_type: boardType, result_limit: 25 })`.
    3. Returns: `{ entries: LeaderboardEntry[]; userRank: number | null; isLoading: boolean; refresh: () => void }`.
    4. Interface `LeaderboardEntry`: `{ rank: number; userId: string; displayName: string; compositeScore: number; currentStreak: number; topBadge: string | null; isWeeklyWinner: boolean }`.
    5. For authenticated users, also fetch user's own rank via `supabase.rpc('get_user_rank', { target_user_id: userId })`.
    6. Refresh on tab focus/visibility with 30-second minimum interval (per research discretion).
    7. Data loads even for unauthenticated users (anon Supabase client has RPC access).
    8. Use cancellation pattern in useEffect (cancelled flag) per existing codebase conventions.

    Create `src/components/social/LeaderboardTable.tsx`:

    1. Props: `entries: LeaderboardEntry[]; userRank: number | null; currentUserId: string | null; onRowClick: (entry: LeaderboardEntry) => void; isLoading: boolean`.
    2. Table layout showing for each row:
       - Rank number (left, bold). Top 3 get medal colors: gold (#FFD700), silver (#C0C0C0), bronze (#CD7F32).
       - Display name. Weekly winner gets Crown icon (lucide-react) in gold next to name.
       - Composite score (right-aligned, numeric).
       - Top badge icon (small, if available) — use the badge icon map from BadgeCelebration.
    3. If userRank > 25 (user not in top 25), show a divider row ("...") then user's own row highlighted with primary background at the bottom.
    4. If userRank is in top 25, highlight their row with a subtle primary background.
    5. Empty state: "No participants yet. Be the first!" / bilingual.
    6. Loading state: Skeleton rows (3 placeholder rows with shimmer).
    7. Rows are clickable (onRowClick) for profile view.
    8. Use StaggeredList for entrance animation.
    9. Bilingual column headers: "Rank" / "အဆင့်", "Name" / "အမည်", "Score" / "ရမှတ်".

    Create `src/components/social/LeaderboardProfile.tsx`:

    1. Props: `entry: LeaderboardEntry | null; open: boolean; onClose: () => void`.
    2. Radix Dialog showing minimal read-only profile:
       - Display name (large text).
       - Composite score.
       - Current streak with fire icon.
       - Top badge (if any) with icon and name.
       - "Rank #N" display.
    3. Load user's earned badges from `supabase.from('earned_badges').select().eq('user_id', entry.userId)` for opted-in users.
    4. Show badge icons in a horizontal row.
    5. No editable fields — read-only view.
    6. Close button.
  </action>
  <verify>TypeScript compiles. useLeaderboard fetches from Supabase RPC. LeaderboardTable renders rows. LeaderboardProfile opens as dialog.</verify>
  <done>Leaderboard fetches top 25 via RPC, shows ranked table with crown for weekly winner, user's own rank always visible, and tapping shows mini profile.</done>
</task>

<task type="auto">
  <name>Task 2: SocialHubPage with tabbed navigation and LeaderboardWidget</name>
  <files>
    src/pages/SocialHubPage.tsx
    src/components/social/LeaderboardWidget.tsx
  </files>
  <action>
    Create `src/pages/SocialHubPage.tsx`:

    1. Follow HistoryPage tab navigation pattern exactly:
       - `useLocation().hash` → derive active tab via `useMemo`.
       - Hash values: `#leaderboard` (default), `#badges`, `#streak`.
       - `userSelectedTab` state with `null` initial → fallback to hash-derived tab.
       - Tab buttons update `navigate({ hash: '#tabname' })`.

    2. Page layout:
       - AppNavigation at top.
       - PageTitle: "Social Hub" / "လူမှုရေး ဗဟိုချက်" (or "Community" / "အသိုင်းအဝိုင်း").
       - Tab bar: 3 tabs with icons — Trophy + "Leaderboard" / "ဦးဆောင်ဘုတ်", Award + "Badges" / "တံဆိပ်များ", Flame + "Streak" / "ဆက်တိုက်".
       - Tab content area with AnimatePresence for smooth transitions.

    3. **Leaderboard tab content:**
       - Sub-tabs: "All Time" / "Weekly" toggle (styled as pill buttons, not full tab bar).
       - `<LeaderboardTable>` with data from `useLeaderboard(boardType)`.
       - If user is not opted in, show a CTA banner: "Join the leaderboard!" with button opening SocialOptInFlow.

    4. **Badges tab content:**
       - `<BadgeGrid>` from Plan 04 with earned/locked badges from `useBadges()`.
       - Badge celebration modal if newlyEarnedBadge exists.

    5. **Streak tab content:**
       - Streak stats: current streak, longest streak, freezes available (larger display than dashboard widget).
       - `<StreakHeatmap>` from Plan 04.
       - Freeze freeze info: "Freezes: N/3" with snowflake icons.
       - How freezes work explanation (bilingual): "Complete a full practice test or 10+ SRS reviews to earn a freeze" / bilingual.

    6. Social opt-in flow: if user visits social hub for first time and hasn't opted in, trigger SocialOptInFlow dialog (check useSocial().isOptedIn). Only for authenticated users.

    7. Non-authenticated users see the page but with a "Sign in to participate" CTA instead of opt-in flow. They can still VIEW the leaderboard (read-only per locked decision).

    Create `src/components/social/LeaderboardWidget.tsx`:

    1. Compact dashboard widget (follows SRSWidget/InterviewDashboardWidget pattern).
    2. Shows: Trophy icon + "Your Rank: #N" or "Not ranked" if not opted in.
    3. Below rank: top 3 entries as a mini list (rank + name + score, one line each).
    4. Tapping navigates to `/social#leaderboard`.
    5. Uses `useLeaderboard('all-time')` with limit of 3.
    6. Loading state: skeleton shimmer.
    7. Empty state: "Join the leaderboard!" CTA navigating to `/social`.
    8. Bilingual: "Your Rank" / "သင့်အဆင့်".
  </action>
  <verify>TypeScript compiles. SocialHubPage renders with 3 tabs. LeaderboardWidget shows rank + top 3.</verify>
  <done>Social hub page has Leaderboard | Badges | Streak tabs with hash-based navigation. Leaderboard has all-time/weekly toggle. Opt-in flow triggers on first visit. Dashboard widget shows rank + top 3.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. SocialHubPage has 3 working tabs with hash-based routing
3. Leaderboard shows top 25 + user's rank
4. Weekly/all-time toggle filters leaderboard data
5. Crown icon appears for weekly winner
6. LeaderboardProfile dialog opens on row tap
7. LeaderboardWidget shows on dashboard
8. Non-authenticated users can view leaderboard
9. All text is bilingual
</verification>

<success_criteria>
- Social hub is the central destination for social features (locked decision)
- Tab navigation matches existing HistoryPage pattern (hash-based, React Compiler safe)
- Leaderboard shows top 25 + user's own rank regardless of position
- Weekly and all-time views available via toggle
- Tapping row shows mini profile with badges and streak
- Dashboard widget provides at-a-glance rank + top 3
- Non-authenticated users can view but not participate
- Opt-in flow triggers naturally on first social hub visit
</success_criteria>

<output>
After completion, create `.planning/phases/07-social-features/07-07-SUMMARY.md`
</output>
