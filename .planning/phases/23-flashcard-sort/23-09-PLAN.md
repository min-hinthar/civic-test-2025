---
phase: 23-flashcard-sort
plan: 09
type: execute
wave: 5
depends_on: ["23-06", "23-07", "23-08"]
files_modified:
  - src/components/sort/SortModeContainer.tsx
  - src/components/sort/SwipeableCard.tsx
  - src/hooks/useSortSession.ts
autonomous: false

must_haves:
  truths:
    - "Full sort flow works end-to-end: start -> sort cards -> summary -> drill -> mastery/exit"
    - "Build passes with zero TypeScript errors"
    - "All existing tests pass (no regressions)"
    - "Bilingual labels appear throughout sort mode when Myanmar mode is active"
    - "Sort mode looks and feels polished on mobile and desktop"
  artifacts:
    - path: "src/components/sort/SortModeContainer.tsx"
      provides: "Fully wired sort mode with all sub-components integrated"
  key_links:
    - from: "src/components/sort/SortModeContainer.tsx"
      to: "src/components/sort/RoundSummary.tsx"
      via: "Renders RoundSummary in round-summary phase with SRSBatchAdd and SortCountdown"
      pattern: "RoundSummary"
---

<objective>
Final integration, polish, and visual verification of the complete sort mode.

Purpose: This plan wires the RoundSummary and SRSBatchAdd components into the SortModeContainer, ensures all sub-components work together, fixes any integration issues, runs the full test suite, and provides a checkpoint for visual verification.

Output: Fully functional sort mode with all 9 requirements (FLSH-01 through FLSH-09) met. Visual checkpoint for user verification.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/sort/SortModeContainer.tsx (from Plans 06/08)
@src/components/sort/RoundSummary.tsx (from Plan 07)
@src/components/sort/SRSBatchAdd.tsx (from Plan 07)
@src/components/sort/SortCountdown.tsx (from Plan 05)
@src/components/sort/SwipeableCard.tsx (from Plan 04)
@src/components/sort/SwipeableStack.tsx (from Plan 04)
@src/hooks/useSortSession.ts (from Plans 06/08)
@.planning/phases/23-flashcard-sort/23-RESEARCH.md
@.planning/phases/23-flashcard-sort/23-06-SUMMARY.md
@.planning/phases/23-flashcard-sort/23-07-SUMMARY.md
@.planning/phases/23-flashcard-sort/23-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Full integration wiring and polish</name>
  <files>
    src/components/sort/SortModeContainer.tsx
    src/components/sort/SwipeableCard.tsx
    src/hooks/useSortSession.ts
  </files>
  <action>
Wire all remaining pieces into SortModeContainer and fix integration issues:

1. **Round summary phase:** Replace any placeholder content with actual RoundSummary component:
   ```tsx
   {(state.phase === 'round-summary' || state.phase === 'countdown') && (
     <RoundSummary
       round={state.round}
       totalCards={state.cards.length}
       knownCount={state.knownIds.size}
       unknownCount={state.unknownIds.size}
       durationMs={Date.now() - state.startTime}
       unknownIds={[...state.unknownIds]}
       allUnknownIds={[...state.allUnknownIds]}
       roundHistory={state.roundHistory}
       sourceCards={state.sourceCards}
       personalBest={personalBest}
       onStartNextRound={startNextRound}
       onStartCountdown={() => dispatch({ type: 'START_COUNTDOWN' })}
       onFinishSession={exitSession}
       isMaxRounds={state.round >= MAX_ROUNDS}
       showBurmese={showBurmese}
     >
       {/* SRS batch add prompt -- appears on every round summary per locked decision */}
       <SRSBatchAdd unknownIds={[...state.unknownIds]} showBurmese={showBurmese} />
       {/* Countdown for auto-start */}
       {state.phase === 'countdown' && (
         <SortCountdown
           onComplete={startNextRound}
           onSkip={startNextRound}
           onCancel={() => dispatch({ type: 'CANCEL_COUNTDOWN' })}
           showBurmese={showBurmese}
         />
       )}
     </RoundSummary>
   )}
   ```

2. **Dashboard readiness integration:** After each round, record "Don't Know" results as `StoredAnswer` entries with a sort-specific flag. This allows existing `weakAreaDetection.ts` to naturally incorporate sort data. Implementation approach:
   - Import answer recording utility (if exists) or directly use the mastery context
   - Record only "Don't Know" results (not "Know" -- per discretion, sort is self-assessment, not formal review)
   - Use existing category tracking to update weak area detection

3. **Focus management after swipe:** After each card swipe animation completes, focus the next card or the undo button with `{ preventScroll: true }`. After round completes, focus the summary heading. This prevents screen readers from losing context.

4. **Personal best update:** In useSortSession, after round 1 completes, check if Know % beats stored personal best. If so, update localStorage `civic-prep-sort-personal-best`.

5. **Polish items:**
   - Smooth transition between sorting phase and round-summary phase (use AnimatePresence or motion.div with opacity/y animation)
   - Mastery phase: auto-play confetti after 200ms delay, play `playMasteryComplete()` once via useEffect
   - Round summary CTA button text updates based on round: "Study Missed Cards" for rounds 1-9, "Final Review" for round 10
   - If round === MAX_ROUNDS and cards remain unknown, show "Take a break" message suggesting SRS deck
   - Add subtle entrance animation for round summary (fade-in + slide-up)

6. **Edge cases:**
   - Handle empty card set (no cards to sort) -- show empty state message
   - Handle single card -- still works, just one swipe then summary
   - Handle all cards known on first round -- immediate mastery celebration
   - Guard against rapid double-tap on Know/Don't Know buttons (disable during 'animating' phase already handled)

7. **Run full verification:**
   - `npm run typecheck` -- zero errors
   - `npm run lint` -- zero errors
   - `npm run test:run` -- all existing tests pass
   - `npm run build` -- production build succeeds
  </action>
  <verify>Run `npm run typecheck && npm run lint && npm run test:run && npm run build` -- all four pass with zero errors.</verify>
  <done>All sort mode components fully wired and integrated. Build passes. Tests pass. Focus management handles accessibility. Personal best tracking works. All edge cases handled.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Flashcard Sort Mode with all 9 requirements:
- FLSH-01: Browse/Sort toggle via PillTabBar on study guide
- FLSH-02: Tinder-style swipe right (Know) / left (Don't Know) with spring physics
- FLSH-03: Live progress counter with animated Know/Don't Know tallies
- FLSH-04: End-of-round summary with "Study missed cards" option
- FLSH-05: Know/Don't Know tap buttons as alternative to swiping
- FLSH-06: Don't Know cards prompt SRS deck addition with batch add
- FLSH-07: Session persistence via IndexedDB with resume prompt
- FLSH-08: Bilingual sort labels ("Know / သိပါတယ်" and "Don't Know / မသိပါ")
- FLSH-09: Round counter visible when drilling missed cards
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to Study Guide page
3. Verify PillTabBar shows: Browse, Sort, Deck, Review tabs
4. Tap "Sort" tab -- sort mode starts with card stack
5. Try swiping a card right (Know) -- verify:
   - Card rotates and shows green overlay during drag
   - Card flings off-screen with momentum on commit
   - Know counter increments with pop animation
   - Ding sound plays (if sound enabled)
6. Try swiping a card left (Don't Know) -- verify:
   - Amber overlay and left zone label appear
   - Don't Know counter increments
   - Thud sound plays
7. Try tapping Know and Don't Know buttons below the card
8. Try tapping Undo button -- last card should come back
9. Sort all cards -- verify round summary appears:
   - Know % with animated count-up
   - Stats grid (know, don't know, time, round)
   - Per-category breakdown
   - Missed cards expandable list
   - SRS batch add prompt
10. Verify 5-second countdown starts for next round
11. Let countdown complete or tap "Study Missed Cards" -- drill round starts with missed cards
12. Sort all missed cards as Know -- verify mastery celebration (confetti + sound)
13. Switch to Myanmar mode and verify bilingual labels throughout
14. Navigate away mid-sort, return to study guide Sort tab -- verify resume prompt appears
15. Test on mobile viewport (390px) -- verify swipe gesture works on touch

Note: Step 14 requires closing and reopening the sort page, not the browser. The IndexedDB save happens on state change.
  </how-to-verify>
  <resume-signal>Type "approved" or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run typecheck` -- zero TypeScript errors
2. `npm run lint` -- zero linting errors
3. `npm run test:run` -- all existing tests pass (no regressions)
4. `npm run build` -- production build succeeds
5. Visual verification by human tester
</verification>

<success_criteria>
All 9 FLSH requirements verified working:
- FLSH-01: Toggle between Browse and Sort mode
- FLSH-02: Swipe right/left to sort cards
- FLSH-03: Live progress counter
- FLSH-04: End-of-round summary with drill option
- FLSH-05: Tap buttons as swipe alternative
- FLSH-06: SRS deck integration for Don't Know cards
- FLSH-07: Session persistence with resume
- FLSH-08: Bilingual sort labels
- FLSH-09: Round counter during drill rounds
</success_criteria>

<output>
After completion, create `.planning/phases/23-flashcard-sort/23-09-SUMMARY.md`
</output>
