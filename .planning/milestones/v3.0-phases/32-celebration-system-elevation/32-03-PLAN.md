---
phase: 32-celebration-system-elevation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - middleware.ts
  - src/components/celebrations/DotLottieAnimation.tsx
  - src/components/celebrations/index.ts
autonomous: true
requirements:
  - CELB-06

must_haves:
  truths:
    - "DotLottie animations load lazily without blocking initial page load"
    - "DotLottie renders at 60fps and degrades gracefully to 30fps on slow devices"
    - "Reduced motion preference shows static content instead of animation playback"
    - "WASM compiles without CSP violation in production"
    - "If DotLottie fails to load, celebration continues without it (confetti + sound carry it)"
  artifacts:
    - path: "src/components/celebrations/DotLottieAnimation.tsx"
      provides: "Lazy-loaded DotLottie wrapper with reduced motion and performance fallback"
      contains: "React.lazy"
    - path: "middleware.ts"
      provides: "CSP with wasm-unsafe-eval for DotLottie WASM"
      contains: "wasm-unsafe-eval"
  key_links:
    - from: "src/components/celebrations/DotLottieAnimation.tsx"
      to: "@lottiefiles/dotlottie-react"
      via: "React.lazy dynamic import"
      pattern: "import.*dotlottie-react"
    - from: "middleware.ts"
      to: "script-src"
      via: "wasm-unsafe-eval directive"
      pattern: "wasm-unsafe-eval"
---

<objective>
Install @lottiefiles/dotlottie-react, update CSP for WASM, and create a lazy-loaded DotLottieAnimation wrapper component with reduced motion support and performance adaptation.

Purpose: CELB-06 adds rich Lottie animations (checkmark, trophy, badge glow, star burst) to celebrations. DotLottie's WASM renderer provides 60fps on modern devices. The CSP update is a prerequisite for WASM compilation.
Output: DotLottieAnimation component, CSP update in middleware.ts, DotLottie animation files in public/lottie/.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-celebration-system-elevation/32-RESEARCH.md

@middleware.ts
@src/components/celebrations/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install DotLottie, update CSP, and create DotLottieAnimation wrapper</name>
  <files>middleware.ts, src/components/celebrations/DotLottieAnimation.tsx, src/components/celebrations/index.ts</files>
  <action>
1. Install `@lottiefiles/dotlottie-react`:
   ```bash
   pnpm add @lottiefiles/dotlottie-react
   ```

2. Update CSP in `middleware.ts`:
   - In the production `scriptSrc` line, add `'wasm-unsafe-eval'` after `'self'`:
     ```
     const scriptSrc = isDev
       ? `'self' 'unsafe-eval' 'unsafe-inline' https://accounts.google.com`
       : `'self' 'wasm-unsafe-eval' ${THEME_SCRIPT_HASH} https://accounts.google.com`;
     ```
   - `wasm-unsafe-eval` is narrower than `unsafe-eval` -- only allows WASM compilation, not JS eval()
   - Dev mode already has `unsafe-eval` which covers WASM compilation

3. Create `src/components/celebrations/DotLottieAnimation.tsx`:
   ```typescript
   'use client';

   import { lazy, Suspense, useCallback, useRef } from 'react';
   import { useReducedMotion } from '@/hooks/useReducedMotion';

   // Lazy load entire DotLottie module -- WASM runtime is ~200KB
   const LazyDotLottie = lazy(async () => {
     const mod = await import('@lottiefiles/dotlottie-react');
     return { default: mod.DotLottieReact };
   });

   interface DotLottieAnimationProps {
     /** Path to .lottie file (relative to public/) */
     src: string;
     /** Whether animation loops */
     loop?: boolean;
     /** Auto-start playback */
     autoplay?: boolean;
     /** Playback speed multiplier */
     speed?: number;
     /** CSS width/height */
     width?: number | string;
     height?: number | string;
     /** Additional className */
     className?: string;
     /** Called when animation completes (non-looping) */
     onComplete?: () => void;
     /** Colored glow behind animation */
     glowColor?: string;
   }
   ```

   Implementation details:
   - If `useReducedMotion()` returns true, render nothing (return null). The celebration system has confetti + sound as primary -- DotLottie is supplementary per user decision ("if DotLottie fails, skip it")
   - Wrap `LazyDotLottie` in `<Suspense fallback={null}>` -- no visible loading state for a supplementary animation
   - Pass through all props to DotLottieReact
   - If `glowColor` is provided, wrap in a div with a soft radial gradient background using that color at 20% opacity
   - Add an `onComplete` handler wired to dotlottie's `complete` event via the `dotLottieRefCallback` pattern
   - For performance adaptation: use the `useRef` to track frame timing. If average frame duration exceeds 33ms (< 30fps) over 10 frames, set `speed` to 0.5x to reduce rendering load. This is a simple heuristic -- the WASM renderer handles most of the heavy lifting.

4. Update `src/components/celebrations/index.ts`:
   - Add export: `export { DotLottieAnimation } from './DotLottieAnimation';`

5. Source DotLottie animation files:
   - Create directory `public/lottie/` for animation assets
   - For now, create placeholder comments in DotLottieAnimation.tsx documenting the expected file paths:
     - `/lottie/checkmark.lottie` -- check draws in + sparkle particles
     - `/lottie/trophy.lottie` -- 3D spinning trophy for test pass / 100%
     - `/lottie/badge-glow.lottie` -- shimmer sweep + radial pulse for badge earn
     - `/lottie/star-burst.lottie` -- multi-star explosion for category mastery
   - The actual .lottie files will be sourced from LottieFiles marketplace during execution (free/commercial-use licensed). If marketplace files cannot be sourced, the DotLottie component still works -- consumers simply won't render it, and confetti + sound carry the celebration.

IMPORTANT: Do NOT block on sourcing animation files. The component wrapper is the deliverable. Animation files can be added incrementally.

NOTE on React 19 compatibility: dotlottie-react's core is WASM-based with a thin React wrapper. Low compatibility risk. If peer dependency warnings appear during install, use `pnpm add @lottiefiles/dotlottie-react --force` or add to pnpm overrides.
  </action>
  <verify>
1. `pnpm ls @lottiefiles/dotlottie-react` shows installed version
2. `npm run typecheck` passes
3. `npm run lint` passes
4. `npm run build` succeeds
5. CSP in middleware.ts production branch contains `wasm-unsafe-eval`
6. DotLottieAnimation is exported from celebrations index
  </verify>
  <done>
- @lottiefiles/dotlottie-react installed
- CSP updated with wasm-unsafe-eval for production
- DotLottieAnimation component lazy-loads WASM renderer
- Reduced motion returns null (animation is supplementary)
- Graceful fallback if DotLottie fails (no error boundary crash)
- Component exported from celebrations index
  </done>
</task>

</tasks>

<verification>
- `npm run typecheck && npm run lint && npm run build` all pass
- `middleware.ts` contains `wasm-unsafe-eval` in production script-src
- `DotLottieAnimation` component exists and is exported
- No CSP violations when loading the app in production mode
</verification>

<success_criteria>
- DotLottie library installed and CSP updated
- Wrapper component lazy-loads without blocking initial paint
- Reduced motion shows nothing (supplementary animation)
- Build passes without WASM-related errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-celebration-system-elevation/32-03-SUMMARY.md`
</output>

