---
phase: 18-language-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/contexts/LanguageContext.tsx
  - src/components/icons/USFlag.tsx
  - src/components/icons/MyanmarFlag.tsx
  - src/components/ui/FlagToggle.tsx
autonomous: true

must_haves:
  truths:
    - "LanguageContext syncs language mode across browser tabs via storage event"
    - "document.documentElement.lang updates to 'en' or 'en-my' when mode changes"
    - "Alt+L keyboard shortcut toggles language mode globally"
    - "FlagToggle shows both US and Myanmar flags side by side with active one highlighted"
    - "Tapping inactive flag triggers bounce animation, 150ms spinner, and haptic feedback"
    - "A 300ms debounce prevents rapid double-toggling"
  artifacts:
    - path: "src/contexts/LanguageContext.tsx"
      provides: "Enhanced language provider with multi-tab sync, HTML lang, keyboard shortcut, analytics"
    - path: "src/components/icons/USFlag.tsx"
      provides: "24px rounded-rectangle US flag SVG component"
    - path: "src/components/icons/MyanmarFlag.tsx"
      provides: "24px rounded-rectangle Myanmar flag SVG component"
    - path: "src/components/ui/FlagToggle.tsx"
      provides: "Dual-flag toggle with animation, haptic feedback, debounce, ARIA radiogroup"
  key_links:
    - from: "src/components/ui/FlagToggle.tsx"
      to: "src/contexts/LanguageContext.tsx"
      via: "useLanguage() hook"
      pattern: "useLanguage"
    - from: "src/components/ui/FlagToggle.tsx"
      to: "src/components/icons/USFlag.tsx"
      via: "import"
      pattern: "USFlag"
---

<objective>
Build the core language mode infrastructure: enhance LanguageContext with multi-tab sync, HTML lang attribute, keyboard shortcut, and analytics stubs. Create custom flag SVG components and the dual-flag FlagToggle component that replaces the old Languages-icon toggle.

Purpose: Everything in Phase 18 depends on the enhanced context and the new flag toggle component. This plan creates the foundation that Plans 02-03 wire into the navigation and settings.

Output: Enhanced LanguageContext.tsx, USFlag.tsx, MyanmarFlag.tsx, FlagToggle.tsx
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/contexts/LanguageContext.tsx
@src/components/ui/LanguageToggle.tsx
@src/contexts/ThemeContext.tsx (pattern reference for root element updates)
@src/lib/motion-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance LanguageContext with multi-tab sync, HTML lang, keyboard shortcut, and analytics</name>
  <files>src/contexts/LanguageContext.tsx</files>
  <action>
Enhance the existing LanguageContext.tsx with these additions (keep ALL existing API surface intact):

1. **Multi-tab sync**: Add a `storage` event listener in a `useEffect` inside `LanguageProvider`. When the `STORAGE_KEY` changes from another tab, call `setModeState(newMode)`. Pattern:
```typescript
useEffect(() => {
  const handleStorage = (e: StorageEvent) => {
    if (e.key === STORAGE_KEY && e.newValue) {
      setModeState(e.newValue as LanguageMode);
    }
  };
  window.addEventListener('storage', handleStorage);
  return () => window.removeEventListener('storage', handleStorage);
}, []);
```

2. **HTML lang attribute**: In the existing SSR hydration `useEffect` (or a new one), set `document.documentElement.lang` based on mode. Use `'en'` for `english-only`, `'en-my'` for `bilingual`. Also update it in the `setMode` callback.

3. **Keyboard shortcut**: Add a `useEffect` with `keydown` listener for `Alt+L` (or `Option+L` on Mac). When pressed, call `toggleMode()`. Guard against input/textarea focus (don't toggle when user is typing in a form field):
```typescript
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.altKey && e.key === 'l') {
      const target = e.target as HTMLElement;
      if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable) return;
      e.preventDefault();
      toggleMode();
    }
  };
  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [toggleMode]);
```

4. **Analytics stubs**: In the `setMode` callback, add a `console.debug` call: `console.debug('[analytics] language_mode_changed', { mode: newMode })`. This is a stub for future analytics integration.

5. **Keep default as bilingual** -- already the case, do not change.

IMPORTANT: Do NOT use `useMemo<T>()` generic syntax (React Compiler pitfall). Do NOT access refs during render. Do NOT setState directly in effect bodies -- use the storage event handler pattern shown above which only fires on cross-tab changes.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- The file still exports `LanguageProvider`, `useLanguage`, and the `LanguageMode` type
- The `storage` event listener is registered
- `document.documentElement.lang` is set in an effect
- `Alt+L` keydown handler is registered
  </verify>
  <done>LanguageContext enhanced with multi-tab sync, HTML lang, keyboard shortcut, and analytics stubs. All existing API preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Create Flag SVG components and FlagToggle component</name>
  <files>
    src/components/icons/USFlag.tsx
    src/components/icons/MyanmarFlag.tsx
    src/components/ui/FlagToggle.tsx
  </files>
  <action>
**Flag SVGs** (create `src/components/icons/` directory if needed):

1. **USFlag.tsx**: Create a simplified 24px US flag SVG as a React component. Use a `<svg>` with `viewBox="0 0 24 16"` and `className` prop. Simplified design: blue canton (top-left rectangle) with tiny white dots for stars, red/white horizontal stripes. Use `<rect>` for stripes and canton. Use a rounded `rx="2"` on the outer rect for the rounded rectangle shape. Accept `className?: string` prop.

2. **MyanmarFlag.tsx**: Create a simplified 24px Myanmar flag SVG. Three horizontal stripes (yellow #FECB32, green #34B233, red #EA2839) with a white 5-pointed star centered. `viewBox="0 0 24 16"`, rounded `rx="2"`. Accept `className?: string` prop.

Both flags should be simple, recognizable at 24px, and use inline SVG (not external files).

**FlagToggle.tsx**: Create the dual-flag segmented toggle that replaces the old LanguageToggle:

```typescript
// Key design decisions (from user locked decisions):
// - Both flags always visible, side by side
// - Active flag: full opacity + 2px ring-primary ring (discretion: ring style)
// - Inactive flag: 40% opacity, clickable to switch
// - 24px flags, same size as other nav icons
// - Bounce animation on tap + 150ms spinner + haptic feedback
// - 300ms debounce to prevent rapid toggling
// - ARIA radiogroup with descriptive labels
// - Compact variant for navbar, full variant for elsewhere
```

Component API:
```typescript
interface FlagToggleProps {
  compact?: boolean; // true for navbar (tighter spacing)
  className?: string;
}
```

Implementation:
- Use `useLanguage()` to get `mode` and `setMode`
- Use `motion/react` for bounce animation on the tapped flag: `whileTap={{ scale: 0.85 }}` then `animate={{ scale: [0.85, 1.08, 1] }}` -- wait, WAAPI only supports 2-keyframe arrays. Use `SPRING_BOUNCY` from motion-config for the tap spring instead.
- Show a tiny loading spinner (a small rotating circle or opacity flash) for ~150ms using `useState` + `setTimeout`
- Haptic: `if ('vibrate' in navigator) navigator.vibrate(10)` (progressive enhancement, no-op on iOS)
- 300ms debounce: disable buttons for 300ms after switch via `useState` + `setTimeout`
- Active flag: `opacity-100 ring-2 ring-primary rounded-md`
- Inactive flag: `opacity-40 hover:opacity-60 rounded-md`
- ARIA: `role="radiogroup"` on container, `role="radio"` + `aria-checked` on each button, descriptive `aria-label` like "Switch to English mode" / "Switch to Myanmar mode"
- Screen reader label on active: e.g., "English mode active" or "Myanmar mode active"

Do NOT keep the old LanguageToggle.tsx yet -- it will be removed later when all consumers switch. The new FlagToggle is a separate component.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- All three files export their components
- FlagToggle renders two flag buttons with proper ARIA attributes
- No `useMemo<T>()` generic syntax used
  </verify>
  <done>USFlag, MyanmarFlag SVG components created. FlagToggle component created with dual-flag design, bounce animation, spinner, haptic feedback, debounce, and full ARIA accessibility.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run lint` passes (no React Compiler ESLint violations)
- LanguageContext still exports same public API (LanguageProvider, useLanguage)
- FlagToggle is importable and renders without errors
- Flag SVGs render as valid inline SVG elements
</verification>

<success_criteria>
- LanguageContext has multi-tab sync, HTML lang, keyboard shortcut, analytics stubs
- Two flag SVG components exist and render recognizable simplified flags
- FlagToggle component exists with dual-flag design, animations, accessibility
- All TypeScript types are correct
- No React Compiler ESLint violations
</success_criteria>

<output>
After completion, create `.planning/phases/18-language-mode/18-01-SUMMARY.md`
</output>
