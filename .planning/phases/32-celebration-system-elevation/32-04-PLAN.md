---
phase: 32-celebration-system-elevation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/celebrations/CountUpScore.tsx
  - src/components/quiz/XPCounter.tsx
  - src/components/quiz/QuizHeader.tsx
  - src/components/quiz/XPPopup.tsx
autonomous: true
requirements:
  - CELB-09
  - CELB-10

must_haves:
  truths:
    - "Score count-up has dramatic easing: slow start, fast middle, spring overshoot at landing"
    - "Count-up value overshoots by ~3-5 points AND font-size grows during overshoot, then both settle back"
    - "Count-up color shifts from neutral to green (pass) or amber (fail) as it crosses thresholds"
    - "XP counter in quiz header pulses with spring animation when XP increments"
    - "Floating +N XP text drifts upward and fades (RPG-style)"
    - "X/Y fraction animates in sync alongside percentage count-up"
  artifacts:
    - path: "src/components/celebrations/CountUpScore.tsx"
      provides: "Enhanced count-up with dramatic easing, overshoot, and color shift"
      contains: "easingFn"
    - path: "src/components/quiz/XPCounter.tsx"
      provides: "Spring-animated XP counter for quiz header"
      contains: "useAnimationControls"
    - path: "src/components/quiz/QuizHeader.tsx"
      provides: "Quiz header with XP counter slot"
      contains: "xpSlot"
  key_links:
    - from: "src/components/celebrations/CountUpScore.tsx"
      to: "react-countup"
      via: "easingFn prop for dramatic easing"
      pattern: "easingFn"
    - from: "src/components/quiz/XPCounter.tsx"
      to: "src/components/quiz/XPPopup.tsx"
      via: "Renders XPPopup for floating +N text"
      pattern: "XPPopup"
---

<objective>
Enhance CountUpScore with dramatic easing/overshoot/color-shift and create XPCounter component with spring pulse for the quiz header.

Purpose: CELB-10 makes the score reveal dramatic and emotionally satisfying -- the count-up builds tension then overshoots for surprise. CELB-09 gives real-time XP feedback during quiz sessions, reinforcing the "every answer matters" feeling.
Output: Enhanced CountUpScore.tsx with dramatic easing, new XPCounter.tsx, updated QuizHeader with XP slot.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-celebration-system-elevation/32-RESEARCH.md

@src/components/celebrations/CountUpScore.tsx
@src/components/quiz/QuizHeader.tsx
@src/components/quiz/XPPopup.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance CountUpScore with dramatic easing, overshoot, and color shift</name>
  <files>src/components/celebrations/CountUpScore.tsx</files>
  <action>
Enhance `CountUpScore` to implement CELB-10 -- dramatic score count-up:

1. **Custom easing function** for react-countup:
   Create a dramatic easing function that passes to `easingFn` prop:
   ```
   function dramaticEasing(t: number, b: number, c: number, d: number): number {
     // t = current time, b = start value, c = change, d = duration
     const progress = t / d;
     // Slow start (cubic ease-in for first 30%)
     // Fast middle (linear acceleration 30-80%)
     // Decelerate at end (80-100%)
     if (progress < 0.3) return b + c * (progress / 0.3) ** 3 * 0.3;
     if (progress < 0.8) return b + c * (0.3 + (progress - 0.3) * 1.4);
     return b + c * (0.3 + 0.7 * (1 - ((1 - progress) / 0.2) ** 2));
   }
   ```
   Adjust the math so the total maps correctly to `c` (change from start to end).

2. **Spring overshoot on landing**:
   - react-countup's `easingFn` clamps to 0-1 progress range, so value overshoot isn't possible directly
   - Instead, use `handleCountEnd` to trigger motion/react `useAnimationControls`:
     - Animate font-size: scale from 1 -> 1.15 -> 1 (spring, stiffness 400, damping 10)
     - Simultaneously show a brief "+3" to "+5" text that appears and fades (overshoot visual)
     - The overshoot number is `Math.min(5, Math.ceil(score * 0.05))` (scales with score)
   - Add state `showOvershoot` that briefly shows the overshoot number for 400ms

3. **Color shift during count-up**:
   - Use react-countup's `formattingFn` to track current value and update color state
   - As count value crosses thresholds:
     - Below 40% of total: `text-muted-foreground` (neutral)
     - 40-60%: transitioning toward pass/fail color
     - Above 60% (passing): `text-success` (green)
     - If final score is failing: color shifts to `text-warning` (amber) in last 20% of count
   - Implementation: use a `useRef<number>` to track the latest formatted value from `formattingFn`, and compute color class based on `currentValue / total` ratio
   - Use CSS transition on the color (`transition-colors duration-300`) for smooth shift

4. **X/Y fraction synced animation**:
   - The "/ {total}" text below the score should animate opacity from 0 -> 1 in sync with count start
   - Add a motion.span wrapper with initial opacity 0, animate to 1 with same delay as count-up start

5. **Whole numbers only** (per user decision):
   - Ensure `decimals={0}` prop is set on CountUp
   - No decimal display at any point

6. Keep the `OdometerNumber` component unchanged -- it's a separate concern.

7. **Reduced motion**: existing behavior (show final score immediately) stays. No overshoot animation, no color shift animation -- just final state colors.
  </action>
  <verify>
1. `npm run typecheck` passes
2. `npm run lint` passes
3. CountUpScore component renders without errors
4. `easingFn` prop is passed to CountUp component
5. Overshoot animation triggers via useAnimationControls on count end
  </verify>
  <done>
- Count-up uses dramatic easing (slow start, fast middle, decelerate)
- Font-size spring overshoot on landing (scale 1 -> 1.15 -> 1)
- Visual overshoot "+N" appears briefly at count end
- Color shifts from neutral to green/amber during count-up
- X/Y fraction fades in with count-up start
- Whole numbers only, no decimals
  </done>
</task>

<task type="auto">
  <name>Task 2: Create XPCounter component and integrate into QuizHeader</name>
  <files>src/components/quiz/XPCounter.tsx, src/components/quiz/QuizHeader.tsx</files>
  <action>
Create XPCounter (CELB-09) and wire it into QuizHeader:

1. **Create `src/components/quiz/XPCounter.tsx`**:
   ```typescript
   interface XPCounterProps {
     xp: number;
     previousXp: number;
   }
   ```
   Implementation:
   - Display current XP with amber/gold styling: `text-amber-500 dark:text-amber-400 font-bold tabular-nums`
   - Use `useAnimationControls` from motion/react for spring pulse on increment:
     - When `xp` changes (and `xp > previousXp`), trigger:
       ```
       controls.start({
         scale: [1, 1.3, 1],
         transition: { type: 'spring', stiffness: 400, damping: 10 }
       })
       ```
   - Render the existing `XPPopup` component for the floating "+N" effect:
     - Compute `gained = xp - previousXp`
     - Pass `points={gained}` and `show={gained > 0}` -- XPPopup handles its own animation lifecycle
   - Position: relative container so XPPopup floats from it
   - Format: "{xp} XP" as text content
   - Reduced motion: no spring animation, XPPopup still shows (it has its own reduced motion handling)
   - Track `xp` changes to trigger animation: use the pattern from XPPopup where `prevShow` / `setPrevShow` detects transitions. Here, compare `xp !== previousXp` and `xp > previousXp` to fire the spring.

   IMPORTANT: Do NOT use `setState` in a `useEffect` to detect xp changes (React Compiler rule). Instead, use the same render-time state comparison pattern from XPPopup.tsx:
   ```
   const [prevXp, setPrevXp] = useState(previousXp);
   const gained = xp - prevXp;
   if (xp !== prevXp) {
     if (xp > prevXp && !shouldReduceMotion) {
       controls.start({ scale: [1, 1.3, 1], transition: { ... } });
     }
     setPrevXp(xp);
   }
   ```

2. **Update `src/components/quiz/QuizHeader.tsx`**:
   - Add optional `xpSlot?: ReactNode` prop to `QuizHeaderProps`
   - Render `xpSlot` between the question counter and timer slot:
     ```
     {/* Question counter */}
     <div className="flex flex-col items-center flex-1 min-w-0">
       ...
       {xpSlot && <div className="mt-0.5">{xpSlot}</div>}
     </div>
     ```
   - Or place XP slot in the header bar alongside the timer. Use the approach that fits best visually -- XP should be visible but not dominate. Recommend placing it as a small badge below the question counter.
   - Keep the `xpSlot` prop optional so existing QuizHeader usage is unaffected.

3. Do NOT modify XPPopup.tsx -- it already works correctly. XPCounter uses it as a child.
  </action>
  <verify>
1. `npm run typecheck` passes
2. `npm run lint` passes
3. QuizHeader still renders correctly without xpSlot prop (backward compatible)
4. XPCounter component exports correctly
5. No `setState` in useEffect violations (React Compiler safe)
  </verify>
  <done>
- XPCounter renders current XP with spring pulse on increment
- Floating "+N XP" text drifts upward via XPPopup
- QuizHeader has optional xpSlot for XPCounter placement
- Existing QuizHeader usage unaffected (xpSlot is optional)
- React Compiler safe -- no setState in effects
  </done>
</task>

</tasks>

<verification>
- `npm run typecheck && npm run lint && npm run build` all pass
- CountUpScore has dramatic easing with easingFn prop
- XPCounter pulses on XP increment
- QuizHeader accepts optional xpSlot
</verification>

<success_criteria>
- Score count-up has dramatic slow-start, fast-middle, overshoot-landing easing
- Color shifts from neutral through threshold colors during count-up
- XP counter pulses with spring when points are earned
- Floating +N XP drifts up and fades
- All backward compatible -- existing consumers unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/32-celebration-system-elevation/32-04-SUMMARY.md`
</output>
