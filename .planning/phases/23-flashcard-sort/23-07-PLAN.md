---
phase: 23-flashcard-sort
plan: 07
type: execute
wave: 3
depends_on: ["23-01", "23-02"]
files_modified:
  - src/components/sort/RoundSummary.tsx
  - src/components/sort/MissedCardsList.tsx
  - src/components/sort/SRSBatchAdd.tsx
autonomous: true

must_haves:
  truths:
    - "User sees comprehensive round summary with Know %, time taken, and round number"
    - "User sees per-category breakdown on summary screen"
    - "User sees expandable list of missed cards with question text"
    - "User sees improvement delta for round 2+ with encouraging message"
    - "SRS prompt distinguishes new cards vs already-in-deck cards"
    - "User sees toast confirmation after adding cards to SRS deck"
  artifacts:
    - path: "src/components/sort/RoundSummary.tsx"
      provides: "End-of-round stats screen with category breakdown and improvement delta"
      exports: ["RoundSummary"]
    - path: "src/components/sort/MissedCardsList.tsx"
      provides: "Expandable list of Don't Know cards for review"
      exports: ["MissedCardsList"]
    - path: "src/components/sort/SRSBatchAdd.tsx"
      provides: "Batch add Don't Know cards to SRS deck with new/existing distinction"
      exports: ["SRSBatchAdd"]
  key_links:
    - from: "src/components/sort/SRSBatchAdd.tsx"
      to: "src/contexts/SRSContext.tsx"
      via: "useSRS().addCard and useSRS().isInDeck for SRS integration"
      pattern: "useSRS"
    - from: "src/components/sort/RoundSummary.tsx"
      to: "src/components/sort/MissedCardsList.tsx"
      via: "Renders MissedCardsList inside summary"
      pattern: "MissedCardsList"
---

<objective>
Build the end-of-round summary screen with stats, missed cards review, and SRS batch add functionality.

Purpose: The summary screen is where users see their results, review missed cards, and feed results into the SRS deck. This is the key learning feedback loop -- sorting is just classification, the summary is where learning happens.

Output: `RoundSummary.tsx` (stats + category breakdown), `MissedCardsList.tsx` (expandable review), `SRSBatchAdd.tsx` (deck integration).
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/sort/sortTypes.ts (RoundResult, SortState)
@src/contexts/SRSContext.tsx (addCard, isInDeck for SRS integration)
@src/components/srs/SessionSummary.tsx (pattern reference for stats grid)
@src/components/srs/AddToDeckButton.tsx (individual card add pattern)
@.planning/phases/23-flashcard-sort/23-RESEARCH.md
@.planning/phases/23-flashcard-sort/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: RoundSummary with stats and category breakdown</name>
  <files>src/components/sort/RoundSummary.tsx</files>
  <action>
Create `src/components/sort/RoundSummary.tsx` -- comprehensive end-of-round stats.

Props:
```typescript
interface RoundSummaryProps {
  round: number;
  totalCards: number;
  knownCount: number;
  unknownCount: number;
  durationMs: number;
  unknownIds: string[];
  allUnknownIds: string[];
  roundHistory: RoundResult[];
  sourceCards: Question[];
  personalBest: { percentage: number; date: string; cardCount: number } | null;
  /** Callbacks for next round actions */
  onStartNextRound: () => void;
  onStartCountdown: () => void;
  onFinishSession: () => void;
  /** Whether max rounds reached */
  isMaxRounds: boolean;
  showBurmese: boolean;
  children?: React.ReactNode; // Slot for SortCountdown and SRSBatchAdd
}
```

Implementation:

1. **Hero stat:** Large Know % with animated count-up (use `react-countup` already installed). Green color if >= 80%, amber if >= 50%, red if < 50%. Format: "85% Known" / "၈၅% သိပါတယ်"

2. **Stats grid:** 4-stat grid (2x2):
   - Know: green count with check icon
   - Don't Know: amber count with X icon
   - Time: formatted MM:SS from durationMs
   - Round: current round number

3. **Improvement delta (round 2+):** If roundHistory has previous round:
   - Calculate: `currentKnown - previousRound.knownCount`
   - Display: "+5 more known vs last round" / bilingual
   - Encouraging message tier:
     - Delta > 0: "Great improvement!" / "တိုးတက်မှုကောင်းပါတယ်!"
     - Delta === 0: "Keep studying, you've got this!" / "ဆက်လေ့လာပါ!"
     - Delta < 0: "Stay focused, you're learning!" / "အာရုံစိုက်ပါ!"

4. **Personal best display:** If personalBest exists and this is round 1:
   - Show "Personal Best: 92% (Feb 15)" below hero stat
   - If current % beats personal best: "New Personal Best!" with star animation

5. **Per-category breakdown:** Group unknownIds by category. Show each category with its count:
   - "American Government: 15/20 known" with a mini progress bar per category
   - Sort categories weakest-first (most missed first)
   - Bilingual category names if available

6. **Action buttons area (where children are rendered):**
   - "Study Missed Cards" / "မမှန်ကတ်များကိုလေ့လာပါ" -- primary CTA (calls onStartCountdown to begin countdown)
   - "Finish" / "ပြီးပါပြီ" -- secondary/outline button
   - If isMaxRounds: show "Round limit reached. Add remaining cards to your review deck." instead of Study Missed Cards
   - Children slot below buttons for SortCountdown and SRSBatchAdd

7. **MissedCardsList:** Render MissedCardsList component with unknownIds

Use `'use client'` directive.
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run lint -- --no-warn-ignored` -- compiles and lints cleanly.</verify>
  <done>RoundSummary displays Know %, stats grid, improvement delta, personal best, per-category breakdown, and action buttons. Bilingual throughout.</done>
</task>

<task type="auto">
  <name>Task 2: MissedCardsList and SRSBatchAdd components</name>
  <files>
    src/components/sort/MissedCardsList.tsx
    src/components/sort/SRSBatchAdd.tsx
  </files>
  <action>
**MissedCardsList.tsx** -- Expandable list of missed cards:

Props:
```typescript
interface MissedCardsListProps {
  unknownIds: string[];
  sourceCards: Question[];
  showBurmese: boolean;
}
```

Implementation:
1. **Collapsible:** Start collapsed. Button to expand: "View missed cards ({count})" / bilingual. Use a simple useState toggle.
2. **Card list:** When expanded, show each missed question:
   - Question text (English, bilingual if showBurmese)
   - Category label as small badge
   - Individual AddToDeckButton (compact mode) per card
3. **Animation:** Use `motion.div` with `animate={{ height: expanded ? 'auto' : 0 }}` for smooth expand/collapse. Use `overflow: 'hidden'`.
4. **Empty state:** If unknownIds is empty, don't render the component at all.

**SRSBatchAdd.tsx** -- Batch add to SRS deck:

Props:
```typescript
interface SRSBatchAddProps {
  unknownIds: string[];
  showBurmese: boolean;
}
```

Implementation:
1. **Categorize cards:** Use `useSRS().isInDeck(questionId)` to split unknownIds into:
   - `newCards`: not in deck
   - `existingCards`: already in deck
2. **Display:**
   - "3 new cards to add, 5 already in your deck" / bilingual
   - Show new count prominently, existing count as secondary info
3. **Add all button:** "Add {newCount} cards to review deck" / bilingual. Primary green button. Disabled if newCount === 0.
4. **Optional per-card checkboxes:** Default all checked. User can expand to deselect individual cards (per discretion: batch default + expandable checkboxes).
5. **Add action:** Loop through selected new cards, call `useSRS().addCard(questionId)` for each. Show toast: "Added {n} cards to your review deck" / bilingual using existing toast system.
6. **Post-add state:** After adding, disable the button and show "Added!" confirmation.
7. **No effect on existing SRS cards:** Per discretion recommendation, "Don't Know" in sort mode does NOT lapse or reset existing SRS cards. Only new cards are added.

Use `'use client'` directive. Import toast from existing toast context/utility.
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run lint -- --no-warn-ignored` -- compiles and lints cleanly.</verify>
  <done>MissedCardsList shows expandable list of missed cards with per-card AddToDeckButton. SRSBatchAdd distinguishes new vs existing deck cards, batch-adds with toast confirmation, no effect on existing SRS schedules.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run lint -- --no-warn-ignored` passes
3. SRSBatchAdd correctly distinguishes new vs existing deck cards
4. All bilingual text present throughout
5. Category breakdown sorts weakest-first
</verification>

<success_criteria>
- FLSH-04: End-of-round summary with "Study missed cards" option
- FLSH-06: Don't Know cards auto-suggest adding to SRS deck
- FLSH-09: Round counter visible on summary
- Comprehensive summary: Know %, time taken, round number, improvement delta
- Per-category breakdown with mini progress bars
- Expandable missed cards list with individual review
- SRS batch add with new/existing distinction and toast confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/23-flashcard-sort/23-07-SUMMARY.md`
</output>
