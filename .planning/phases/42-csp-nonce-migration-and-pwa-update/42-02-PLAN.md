---
phase: 42-csp-nonce-migration-and-pwa-update
plan: 02
type: execute
wave: 2
depends_on: [42-01]
files_modified:
  - src/__tests__/proxy.test.ts
  - src/lib/pwa/sw.ts
autonomous: true
requirements: [MIGR-10]

must_haves:
  truths:
    - "Service worker caches App Router RSC prefetch, RSC navigation, and HTML document requests correctly"
    - "App works offline after initial load (offline fallback page displayed)"
    - "sw.js is built by Serwist during pnpm build (not committed to git)"
    - "SW registration errors are caught gracefully (log warning, do not break app)"
    - "proxy.ts nonce generation and CSP construction have unit test coverage"
  artifacts:
    - path: "src/__tests__/proxy.test.ts"
      provides: "Unit tests for proxy nonce generation, CSP directives, security headers, matcher config"
      min_lines: 50
    - path: "src/lib/pwa/sw.ts"
      provides: "Service worker with App Router-compatible caching and push notification handling"
      contains: "defaultCache"
  key_links:
    - from: "src/lib/pwa/sw.ts"
      to: "@serwist/next/worker defaultCache"
      via: "import and spread into runtimeCaching"
      pattern: "defaultCache"
    - from: "next.config.mjs"
      to: "src/lib/pwa/sw.ts"
      via: "withSerwistInit swSrc config"
      pattern: "swSrc.*sw\\.ts"
    - from: "src/__tests__/proxy.test.ts"
      to: "proxy.ts"
      via: "unit test imports"
      pattern: "proxy"
---

<objective>
Verify and update the service worker for App Router asset caching, add proxy unit tests, and run full build verification.

Purpose: MIGR-10 requires the service worker to correctly cache App Router asset paths. Unit tests for proxy.ts provide automated regression coverage for the CSP nonce migration (MIGR-09).
Output: Verified SW caching for App Router patterns, proxy.ts unit tests, passing build.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-csp-nonce-migration-and-pwa-update/42-CONTEXT.md
@.planning/phases/42-csp-nonce-migration-and-pwa-update/42-RESEARCH.md
@.planning/phases/42-csp-nonce-migration-and-pwa-update/42-01-SUMMARY.md

@proxy.ts
@src/lib/pwa/sw.ts
@next.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify SW caching and add proxy unit tests</name>
  <files>
    src/lib/pwa/sw.ts
    src/__tests__/proxy.test.ts
  </files>
  <action>
    **src/lib/pwa/sw.ts** -- Verify and minimally update:

    The `defaultCache` from `@serwist/next/worker` v9.5.6 already includes App Router cache buckets in production:
    - `pages-rsc-prefetch` (NetworkFirst): RSC prefetch requests (RSC: 1 + Next-Router-Prefetch: 1 headers)
    - `pages-rsc` (NetworkFirst): RSC navigation requests (RSC: 1 header)
    - `pages` (NetworkFirst): HTML document requests (Content-Type: text/html)
    - `next-static-js-assets` (CacheFirst): `/_next/static` JS bundles
    - `others` (NetworkFirst): same-origin non-API catch-all
    - `cross-origin` (NetworkFirst): third-party resources

    These already match App Router request patterns correctly. The sw.ts file already uses `...defaultCache` spread. No changes needed to the caching strategy.

    Per user decision, verify and confirm:
    1. `defaultCache` spread is present in `runtimeCaching` -- ALREADY DONE
    2. Audio cache bucket exists for `/audio/` paths -- ALREADY DONE
    3. Offline fallback entry exists for document requests -- ALREADY DONE
    4. `skipWaiting: true` and `clientsClaim: true` are set -- ALREADY DONE
    5. `navigationPreload: true` is set -- ALREADY DONE

    If sw.ts needs no code changes (all verification passes), do NOT modify the file -- just document the verification in the summary.

    Per user decision on graceful SW registration errors: Serwist's auto-registration (injected by `withSerwistInit` webpack plugin) already handles this gracefully -- if `sw.js` is missing (e.g., in dev mode where `disable: dev`), the registration script simply doesn't load. No additional error handling code is needed in sw.ts since the registration happens outside the SW itself.

    **src/__tests__/proxy.test.ts** -- Create unit tests for proxy.ts:

    Since proxy.ts uses `NextResponse` from `next/server`, tests need to mock it. Create a test file that:

    1. Mocks `next/server` module (NextResponse.next, NextResponse with headers)
    2. Mocks `crypto.randomUUID()` to return a deterministic UUID
    3. Tests nonce generation:
       - Verify nonce is base64-encoded UUID
       - Verify nonce appears in CSP header as `'nonce-{value}'`
    4. Tests CSP header construction:
       - Contains `strict-dynamic`
       - Contains `'unsafe-eval'` when NODE_ENV=development
       - Does NOT contain `'unsafe-eval'` when NODE_ENV=production
       - Contains `'unsafe-inline'` in style-src
       - Contains `report-uri` with Sentry endpoint
       - Contains `worker-src 'self' blob:`
       - Contains `frame-src 'self' https://accounts.google.com https://tiptopjar.com`
    5. Tests security headers on response:
       - X-Content-Type-Options: nosniff
       - X-Frame-Options: DENY
       - Referrer-Policy: strict-origin-when-cross-origin
       - Permissions-Policy present
       - X-DNS-Prefetch-Control: on
    6. Tests nonce transport:
       - `x-nonce` set on request headers
       - CSP set on both request and response headers
    7. Tests matcher config:
       - Verify config.matcher excludes api, _next/static, _next/image, favicon.ico, icons, manifest.json, sw.js, sw.js.map, offline.html

    Use Vitest (project's test framework). Import the `proxy` function and `config` export from `../../proxy.ts` (relative path from src/__tests__). Mock `NextResponse` and `NextRequest` as needed.

    NOTE: The `proxy` function takes a `NextRequest` parameter per Next.js 16 convention (the current proxy.ts takes no args but Plan 01 updated it to accept `request: NextRequest`). Create a mock NextRequest with a `headers` property.

    Wire into: Tests validate proxy.ts created in Plan 01. Run with `pnpm test -- --run src/__tests__/proxy.test.ts`.
  </action>
  <verify>
    <automated>cd /c/Users/minkk/GitHub/civic-test-2025 && pnpm test -- --run src/__tests__/proxy.test.ts 2>&1 | tail -30</automated>
    <manual>Verify all proxy tests pass and cover nonce generation, CSP directives, security headers, and nonce transport</manual>
  </verify>
  <done>proxy.test.ts exists with passing tests for nonce generation, CSP header construction (dev + prod), security headers, and nonce transport. SW verified to have correct App Router caching via defaultCache (no changes needed).</done>
</task>

<task type="auto">
  <name>Task 2: Full build verification and cleanup</name>
  <files></files>
  <action>
    Run full verification suite to confirm everything works end-to-end:

    1. Run `pnpm test -- --run` (all tests pass)
    2. Run `pnpm build` (build succeeds -- pages may show as dynamic/lambda, that's expected with `await headers()`)
    3. Verify `public/sw.js` exists after build (Serwist generates it)
    4. Verify `public/sw.js` is gitignored: `git status public/sw.js` should show nothing
    5. Run `npx tsc --noEmit` (TypeScript clean)
    6. Verify no references to `HASH_REDIRECT_SCRIPT` remain in source: `grep -r "HASH_REDIRECT_SCRIPT" --include="*.ts" --include="*.tsx" proxy.ts app/ src/`
    7. Verify proxy.ts contains `strict-dynamic` and nonce generation
    8. Verify next.config.mjs has no `headers()` function
    9. Verify app/layout.tsx is async and reads nonce from headers

    No files to modify -- this is a pure verification task. If any step fails, fix the issue and re-verify.

    Report build output showing page rendering modes (static vs dynamic) in the summary.
  </action>
  <verify>
    <automated>cd /c/Users/minkk/GitHub/civic-test-2025 && pnpm build 2>&1 | tail -40</automated>
    <manual>Build succeeds. All pages render. No CSP violations in browser. SW registers in production build.</manual>
  </verify>
  <done>Full test suite passes. Build succeeds. SW generates correctly. No HASH_REDIRECT_SCRIPT references remain. TypeScript compiles cleanly. Phase 42 requirements MIGR-09 and MIGR-10 are met.</done>
</task>

</tasks>

<verification>
1. `pnpm test -- --run` all tests pass including new proxy.test.ts
2. `pnpm build` succeeds
3. `public/sw.js` generated by build, gitignored
4. `npx tsc --noEmit` clean
5. No HASH_REDIRECT_SCRIPT references in source
6. Serwist defaultCache verified to include RSC prefetch, RSC navigation, and HTML document cache buckets
</verification>

<success_criteria>
- proxy.test.ts has 7+ test cases covering nonce, CSP directives, security headers, dev mode
- All tests pass green
- Build succeeds with Serwist generating sw.js
- SW defaultCache includes App Router RSC cache buckets (verified in source, documented in summary)
- Full phase verification: CSP nonce works, SW caches App Router assets, all integrations (OAuth, Sentry, push) function without CSP blocks
</success_criteria>

<output>
After completion, create `.planning/phases/42-csp-nonce-migration-and-pwa-update/42-02-SUMMARY.md`
</output>
