---
phase: 22-tts-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/SpeechButton.tsx
  - src/lib/ttsCore.ts
autonomous: true

must_haves:
  truths:
    - "User can tap speech button to pause active TTS, tap again to resume"
    - "User sees animated speaking indicator when TTS is active"
    - "TTS failures show inline error state on the speech button (red tint)"
    - "Speed label (e.g. '1x') visible on the speech button during sessions"
    - "On Android, pause/resume falls back to cancel/restart (platform bug workaround)"
  artifacts:
    - path: "src/components/ui/SpeechButton.tsx"
      provides: "Enhanced SpeechButton with pause/resume, speed label, error state"
  key_links:
    - from: "src/components/ui/SpeechButton.tsx"
      to: "src/hooks/useTTS.ts"
      via: "pause/resume/isSpeaking/isPaused/error from useTTS"
      pattern: "pause|resume|isPaused|error"
---

<objective>
Enhance SpeechButton with pause/resume toggle behavior (cancel/restart on Android), speed label display, inline error state, and unsupported browser handling. Also add rapid-tap debounce protection.

Purpose: Users get intuitive speech controls (TTS-03, TTS-04, TTS-05) with graceful error handling and platform-aware behavior.
Output: Enhanced SpeechButton with pause/resume, speed label, error state, debounce.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-tts-quality/22-RESEARCH.md

@src/components/ui/SpeechButton.tsx
@src/hooks/useTTS.ts
@src/lib/ttsCore.ts
@src/lib/ttsTypes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pause/resume toggle with Android detection and rapid-tap debounce</name>
  <files>src/components/ui/SpeechButton.tsx, src/lib/ttsCore.ts</files>
  <action>
**Export Android detection from ttsCore.ts:**
The `isAndroid()` helper already exists in ttsCore.ts but is not exported. Export it so SpeechButton can use it:
`export function isAndroid(): boolean { ... }`
If it doesn't exist as a named function, create one checking `navigator.userAgent` for 'Android'.

**SpeechButton pause/resume toggle:**
1. Import `isAndroid` from `@/lib/ttsCore` and destructure `pause, resume, isPaused, error` from `useTTS()`
2. Change the click handler logic:
   - If NOT speaking and NOT paused: fire-and-forget `speak(text, { lang, pitch, rate })`
   - If speaking and NOT paused:
     - On Android: `cancel()` (cancel/restart semantics -- no reliable pause)
     - On non-Android: `pause()`
   - If paused: `resume()`
3. Add a debounce guard: Use a `useRef<number>(0)` for last click timestamp. In handleClick, check if `Date.now() - lastClickRef.current < 150`. If within debounce window, return early. Otherwise update `lastClickRef.current = Date.now()`.
4. Update `aria-pressed` to reflect the three states: `aria-pressed={isSpeaking || isPaused}`
5. Update `aria-label`:
   - Not speaking: `ariaLabel ?? label`
   - Speaking (not paused): 'Pause speaking'
   - Paused: 'Resume speaking'
6. Update ARIA live region: `{isSpeaking ? 'Speaking' : isPaused ? 'Paused' : ''}`
  </action>
  <verify>
`npx tsc --noEmit` passes.
`npx eslint src/components/ui/SpeechButton.tsx src/lib/ttsCore.ts` passes.
  </verify>
  <done>
SpeechButton toggles between speak/pause/resume on click. Android gets cancel/restart. Rapid taps within 150ms are debounced. ARIA labels reflect all three states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add speed label, inline error state, and unsupported browser handling</name>
  <files>src/components/ui/SpeechButton.tsx</files>
  <action>
**Speed label prop:**
1. Add two optional props to `SpeechButtonProps`:
   - `showSpeedLabel?: boolean` (default false)
   - `speedLabel?: string` (e.g., "0.75x", "1x", "1.25x")
2. Render after the label span when both are truthy:
   ```
   {showSpeedLabel && speedLabel && (
     <span className="text-[10px] font-medium text-muted-foreground/70 tabular-nums">
       {speedLabel}
     </span>
   )}
   ```

**Inline error state:**
1. Use the `error` from `useTTS()` (already destructured in Task 1)
2. When `error` is non-null AND button is not speaking/paused, apply error styling:
   - Add to the button className: `error && !isSpeaking && !isPaused ? 'border-destructive/50 bg-destructive/5 text-destructive' : ...existing styles...`
3. Add a tooltip for error state: wrap the button in a `<span>` with `title={error}` when error is non-null. The tooltip shows the error message on hover (native browser tooltip).
4. Auto-clear error: The error auto-clears in useTTS on next successful speak, so no manual clear needed.

**Unsupported browser state:**
1. When `!isSupported`, the button is already `disabled` (existing behavior). Add a tooltip:
   - Wrap the disabled button in a `<span>` with `title="TTS not supported in this browser"` so the tooltip shows even on a disabled button
2. The button is already grayed out via `disabled:opacity-60` (existing)

**Offline awareness:**
1. Add `navigator.onLine` check (or use a simple `useState` with online/offline event listeners)
2. When offline AND speaking, show no special indicator (still attempt playback per user decision)
3. When offline AND not speaking, show subtle indicator: `title` attribute includes "(Limited audio offline)" appended to existing label

**Paused state visual:**
1. When `isPaused`, show a different style: `border-tts/50 bg-tts/5 text-tts` (dimmed version of speaking state)
2. Replace SoundWaveIcon with a static pause icon (two vertical bars SVG or the existing SoundWaveIcon with `animate={false}`)
3. Do NOT show ExpandingRings when paused
  </action>
  <verify>
`npx tsc --noEmit` passes.
`npx eslint src/components/ui/SpeechButton.tsx` passes.
`npm run build` succeeds.
  </verify>
  <done>
SpeechButton displays speed label when showSpeedLabel is true, shows red-tinted error state with tooltip on TTS failure, shows disabled tooltip for unsupported browsers, shows dimmed paused state, and offline awareness tooltip. All error/unsupported states handle gracefully with no silent failures.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. `npx tsc --noEmit` passes
3. `npm run lint` passes
4. SpeechButton renders with all new states: speaking, paused, error, disabled/unsupported
5. Speed label appears when props provided
6. Android detection correctly routes to cancel/restart instead of pause/resume
</verification>

<success_criteria>
- Tap while speaking pauses (non-Android) or cancels (Android)
- Tap while paused resumes playback
- Speed label shows "0.75x" / "1x" / "1.25x" when enabled
- TTS failure shows red-tinted button with error tooltip
- Unsupported browsers show disabled button with tooltip
- Rapid taps within 150ms are debounced
- Existing speaking animation (SoundWaveIcon + ExpandingRings) unchanged
- Paused state shows dimmed TTS color without animation
</success_criteria>

<output>
After completion, create `.planning/phases/22-tts-quality/22-02-SUMMARY.md`
</output>
