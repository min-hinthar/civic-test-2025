---
phase: 41-route-migration
plan: 05
type: execute
wave: 3
depends_on:
  - 41-03
  - 41-04
files_modified:
  - app/layout.tsx
  - app/(protected)/layout.tsx
  - src/components/ClientProviders.tsx
  - src/components/navigation/navConfig.ts
  - src/lib/themeScript.ts
  - proxy.ts
  - package.json
autonomous: true
requirements:
  - MIGR-05
  - MIGR-06
  - MIGR-08
  - MIGR-12

must_haves:
  truths:
    - "react-router-dom is no longer in package.json"
    - "No file in src/ imports from react-router-dom"
    - "Root layout includes global overlays and hash redirect script"
    - "Protected layout wraps children in NavigationShell"
    - "Hash URLs redirect to clean URL equivalents"
    - "The app builds successfully with all routes"
    - "All tests pass"
  artifacts:
    - path: "app/layout.tsx"
      provides: "Root layout with overlays and hash redirect"
      contains: "HASH_REDIRECT_SCRIPT"
    - path: "app/(protected)/layout.tsx"
      provides: "Protected layout with NavigationShell"
      contains: "NavigationShell"
    - path: "src/components/ClientProviders.tsx"
      provides: "ClientProviders without routerWrapper prop"
    - path: "package.json"
      provides: "Package file without react-router-dom"
  key_links:
    - from: "app/layout.tsx"
      to: "src/components/ClientProviders.tsx"
      via: "ClientProviders without routerWrapper"
      pattern: "<ClientProviders>"
    - from: "app/(protected)/layout.tsx"
      to: "src/components/navigation/NavigationShell.tsx"
      via: "NavigationShell wrapping children"
      pattern: "NavigationShell"
    - from: "app/layout.tsx"
      to: "src/lib/themeScript.ts"
      via: "Combined theme + hash redirect script"
      pattern: "HASH_REDIRECT_SCRIPT"
---

<objective>
Complete the migration by wiring the root and protected layouts, removing react-router-dom, deleting all Pages Router files, and verifying the entire app builds and tests pass. This is the final plan that makes the migration live.

Purpose: Activate the App Router as the sole routing system. Remove all legacy routing code. Ensure clean URLs, hash redirects, and global overlays all work.
Output: Clean codebase with zero react-router-dom references, fully functional App Router routing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-route-migration/41-CONTEXT.md
@.planning/phases/41-route-migration/41-RESEARCH.md
@.planning/phases/41-route-migration/41-03-SUMMARY.md
@.planning/phases/41-route-migration/41-04-SUMMARY.md
@app/layout.tsx
@app/(protected)/layout.tsx
@src/components/ClientProviders.tsx
@src/AppShell.tsx
@proxy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire root layout, protected layout, ClientProviders, and hash redirect</name>
  <files>
    app/layout.tsx
    app/(protected)/layout.tsx
    src/components/ClientProviders.tsx
    src/components/navigation/navConfig.ts
    src/lib/themeScript.ts
    proxy.ts
  </files>
  <action>
**Update `src/components/ClientProviders.tsx`:**
- Remove the `routerWrapper` prop entirely from the interface and implementation
- Remove the `ComponentType` import (no longer needed)
- Remove the conditional `RouterWrapper` wrapping logic
- The provider tree becomes: `<NavigationProvider>{children}</NavigationProvider>` directly inside StateProvider
- Keep all other providers unchanged

**Update `app/layout.tsx`:**
- Add hash redirect inline script. Create a `HASH_REDIRECT_SCRIPT` constant (either in `src/lib/themeScript.ts` or inline in layout):
```typescript
const HASH_REDIRECT_SCRIPT = `(function(){var h=window.location.hash;if(h&&h.indexOf('#/')===0&&h.indexOf('#access_token=')!==0){window.location.replace(h.substring(1)+window.location.search);}})();`;
```
Guard against Supabase auth callback hashes (`#access_token=...`) per research pitfall 9.

Add the hash redirect script as a second `<script dangerouslySetInnerHTML>` in `<head>` after the theme script. Or combine both scripts into one `<script>` tag. If combining, update the THEME_SCRIPT constant in `themeScript.ts` to include the hash redirect code, then regenerate the CSP hash.

If keeping separate scripts (simpler to maintain per research recommendation): add a second CSP hash to `proxy.ts`.

- Move global overlay components from AppShell into root layout, INSIDE `<ClientProviders>`:
  - `CelebrationOverlay` from `@/components/celebrations`
  - `PWAOnboardingFlow` -- extract from AppShell to a separate file or inline in layout (it's defined inline in AppShell currently, so extract to `src/components/pwa/PWAOnboardingFlow.tsx` first)
  - `OnboardingTour` from `@/components/onboarding/OnboardingTour`
  - `GreetingFlow` -- extract from AppShell to a separate file (it uses `useAuth` which is inside ClientProviders, so safe at root level per research recommendation -- it self-gates on user presence)
  - `SyncStatusIndicator` from `@/components/pwa/SyncStatusIndicator`

Extract `PWAOnboardingFlow` and `GreetingFlow` from `src/AppShell.tsx` into their own files:
- `src/components/pwa/PWAOnboardingFlow.tsx` -- move the component + its imports (InstallPrompt, WelcomeModal, IOSTip, shouldShowIOSTip)
- `src/components/onboarding/GreetingFlow.tsx` -- move the component + its imports (WelcomeScreen, WhatsNewModal, useWhatsNew, useAuth)

Root layout structure should become:
```tsx
<html lang="en" suppressHydrationWarning>
  <head>
    <script dangerouslySetInnerHTML={{ __html: THEME_SCRIPT }} />
    <script dangerouslySetInnerHTML={{ __html: HASH_REDIRECT_SCRIPT }} />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  </head>
  <body>
    <ClientProviders>
      {children}
      <CelebrationOverlay />
      <PWAOnboardingFlow />
      <OnboardingTour />
      <GreetingFlow />
      <SyncStatusIndicator />
    </ClientProviders>
  </body>
</html>
```

- Add `useViewportHeight()` call: create a tiny client component wrapper that calls the hook, or add it to one of the existing client components in the layout. Since layout.tsx is a Server Component, the hook must be called from within a client component. Options: (a) add `useViewportHeight()` to ClientProviders, (b) create a `<ViewportHeightTracker />` client component. Option (a) is simplest -- add the import and hook call at the top of ClientProviders component body.

- Add `cleanExpiredSessions()` call: add a `useEffect` in ClientProviders that calls `cleanExpiredSessions().catch(() => {})` on mount.

- Keep `installHistoryGuard()` call: add it as a module-level side effect in ClientProviders (same pattern as AppShell -- called before component mounts).

**Update `app/(protected)/layout.tsx`:**
- Import `NavigationShell` from `@/components/navigation/NavigationShell`
- Wrap `{children}` in `<NavigationShell>` for the authenticated case
- The structure becomes:
```tsx
if (!user) { redirect(authUrl); }
return <NavigationShell>{children}</NavigationShell>;
```

**Update `src/components/navigation/navConfig.ts`:**
- Remove the `HIDDEN_ROUTES` constant entirely (route groups make it redundant per user decision)
- Remove the export from the file

**Update `proxy.ts` for CSP:**
- If using a separate hash redirect script, generate its SHA-256 hash and add it to the `script-src` directive alongside the existing theme script hash
- To generate the hash: `echo -n "SCRIPT_CONTENT" | openssl dgst -sha256 -binary | openssl enc -base64`
- The hash must match the EXACT byte content of the script string
- Add the hash as `'sha256-XXXXX'` in the CSP script-src directive

Wire into: Root layout wires overlays to ClientProviders context. Protected layout wires NavigationShell to auth-guarded routes. ClientProviders is the bridge between root layout Server Component and all client-side providers.
  </action>
  <verify>
    <automated>cd C:/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && pnpm typecheck</automated>
    <manual>Verify root layout has overlays inside ClientProviders, protected layout has NavigationShell, ClientProviders has no routerWrapper prop, HIDDEN_ROUTES removed from navConfig</manual>
  </verify>
  <done>Root layout has overlays + hash redirect script. Protected layout wraps children in NavigationShell. ClientProviders has no routerWrapper. navConfig has no HIDDEN_ROUTES. proxy.ts CSP updated for hash redirect script. Typecheck passes.</done>
</task>

<task type="auto">
  <name>Task 2: Delete Pages Router files, remove react-router-dom, and full verification</name>
  <files>
    package.json
  </files>
  <action>
**Delete all Pages Router files and legacy components:**

```bash
# Pages Router files
rm pages/[[...slug]].tsx
rm pages/_app.tsx
rm pages/_document.tsx
rm pages/_error.tsx
rm pages/op-ed.tsx
rm -rf pages/api/push/

# If pages/api/ is now empty, remove it too
# If pages/ directory is now empty, remove it entirely

# Legacy components replaced by App Router patterns
rm src/AppShell.tsx
rm src/components/ProtectedRoute.tsx
rm src/components/animations/PageTransition.tsx
```

Check if any other files in `pages/` exist after deletion. The entire `pages/` directory should be removable. If only `pages/api/` remains empty, remove it. The goal is to have NO `pages/` directory at all.

**Remove react-router-dom:**
```bash
pnpm remove react-router-dom
```
This removes it from package.json and pnpm-lock.yaml.

**Verify no references remain:**
```bash
grep -r "react-router-dom" src/ --include="*.ts" --include="*.tsx"
grep -r "react-router-dom" app/ --include="*.ts" --include="*.tsx"
grep -r "from 'react-router-dom'" . --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next
```
All should return empty.

Also check for:
- `BrowserRouter` / `HashRouter` / `Router` references
- `<Navigate` component usage
- `<Route` component usage
- `useNavigate` import (should be zero)
- `useLocation` import from react-router-dom (should be zero)

**Check imports in test files:**
```bash
grep -r "react-router-dom\|BrowserRouter\|MemoryRouter" src/ --include="*.test.ts" --include="*.test.tsx"
```
If any test files reference react-router-dom, update them to mock next/navigation instead.

**Update test setup if needed:**
Check `src/__tests__/setup.ts` (or equivalent) for react-router-dom mocks. Add next/navigation mocks if not already present:
```typescript
vi.mock('next/navigation', () => ({
  useRouter: () => ({
    push: vi.fn(),
    replace: vi.fn(),
    back: vi.fn(),
    forward: vi.fn(),
    refresh: vi.fn(),
    prefetch: vi.fn(),
  }),
  usePathname: () => '/',
  useSearchParams: () => new URLSearchParams(),
  useParams: () => ({}),
  redirect: vi.fn(),
  notFound: vi.fn(),
}));
```

**Full verification suite:**
```bash
pnpm lint
pnpm lint:css
pnpm format:check
pnpm typecheck
pnpm test:run
pnpm build --webpack
```

All must pass. If any test failures, investigate and fix:
- Tests wrapping components in `<BrowserRouter>` need that wrapper removed
- Tests using `useNavigate` mocks need to mock `useRouter` from next/navigation instead
- Tests reading `location.pathname` may need to mock `usePathname` instead

Wire into: With pages/ directory deleted, Next.js exclusively uses app/ directory for routing. The `pages/[[...slug]].tsx` catch-all no longer intercepts requests.
  </action>
  <verify>
    <automated>cd C:/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && pnpm lint && pnpm typecheck && pnpm test:run && pnpm build --webpack 2>&1 | tail -30</automated>
    <manual>Verify pages/ directory does not exist, react-router-dom not in package.json, full build succeeds</manual>
  </verify>
  <done>Pages Router directory deleted entirely. react-router-dom removed from package.json. AppShell, ProtectedRoute, PageTransition deleted. Zero react-router-dom references in codebase. All linting, typechecking, tests, and build pass.</done>
</task>

</tasks>

<verification>
- `pnpm build --webpack` succeeds
- `pnpm test:run` passes all tests
- `pnpm typecheck` clean
- `pnpm lint` clean
- `ls pages/` returns "No such file or directory"
- `grep -r "react-router-dom" src/ app/ --include="*.ts" --include="*.tsx"` returns empty
- `grep "react-router-dom" package.json` returns empty
- HIDDEN_ROUTES no longer exists in navConfig.ts
- Root layout has overlay components
- Protected layout wraps children in NavigationShell
</verification>

<success_criteria>
- pages/ directory does not exist
- react-router-dom not in package.json or pnpm-lock.yaml
- Zero react-router-dom imports in entire codebase
- AppShell.tsx, ProtectedRoute.tsx, PageTransition.tsx deleted
- All 5 verification commands pass (lint, typecheck, test, build, format)
- Root layout has global overlays
- Protected layout has NavigationShell
</success_criteria>

<output>
After completion, create `.planning/phases/41-route-migration/41-05-SUMMARY.md`
</output>
