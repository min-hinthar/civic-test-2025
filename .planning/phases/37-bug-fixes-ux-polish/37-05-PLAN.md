---
phase: 37-bug-fixes-ux-polish
plan: 05
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - src/components/study/CategoryChipRow.tsx
  - src/components/study/FlashcardToolbar.tsx
  - src/pages/StudyGuidePage.tsx
  - src/components/study/FlashcardStack.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Category filter uses horizontal scrollable chip/pill row instead of select dropdown"
    - "Each category chip shows icon, accent color, question count badge, and optional subtitle"
    - "Card counter at top shows 'X of Y' with left/right arrow navigation and progress bar"
    - "Shuffle button randomizes card order within selected category"
    - "Sort options available (difficulty, category order, alphabetical)"
    - "Search box filters questions by text within selected category"
  artifacts:
    - path: "src/components/study/CategoryChipRow.tsx"
      provides: "Horizontal scrollable chip row with snap, fade masks, a11y"
      contains: "scroll-snap"
    - path: "src/components/study/FlashcardToolbar.tsx"
      provides: "Card counter, shuffle, sort dropdown, search integration"
      contains: "shuffle"
    - path: "src/pages/StudyGuidePage.tsx"
      provides: "Chip row and toolbar wired into flashcard cards view replacing old dropdown"
      contains: "CategoryChipRow"
  key_links:
    - from: "src/components/study/CategoryChipRow.tsx"
      to: "src/pages/StudyGuidePage.tsx"
      via: "Chip row renders above FlashcardStack, onSelect updates category filter"
      pattern: "onSelect"
    - from: "src/components/study/FlashcardToolbar.tsx"
      to: "src/components/study/FlashcardStack.tsx"
      via: "Toolbar controls card index, shuffle state, sort order"
      pattern: "onShuffle|onSort"
    - from: "src/components/study/FlashcardToolbar.tsx"
      to: "src/pages/StudyGuidePage.tsx"
      via: "Search input onSearchChange updates searchQuery state, which drives useMemo filteredQuestions passed to FlashcardStack"
      pattern: "searchQuery|onSearchChange|filteredQuestions"
---

<objective>
Replace the "All Categories" dropdown with a horizontal scrollable chip/pill row, add card counter with navigation arrows and progress bar, shuffle/sort controls, and search box. This transforms the flashcard browsing experience from basic dropdown filtering to a polished, touch-friendly interface.

Purpose: User decision locks chip row, card counter, shuffle, sort, and search features.
Output: CategoryChipRow.tsx, FlashcardToolbar.tsx, updated StudyGuidePage.tsx and FlashcardStack.tsx.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/pages/StudyGuidePage.tsx
@src/components/study/FlashcardStack.tsx
@src/lib/mastery.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CategoryChipRow horizontal scrollable component</name>
  <files>src/components/study/CategoryChipRow.tsx</files>
  <action>
Create a horizontal scrollable chip/pill row to replace the category `<select>` dropdown.

**User decisions (locked):**
- Each chip has: icon, accent color per category, and question count badge
- Category chips have subtitle text with brief description: "American Government -- Branches, Constitution"
- "All Categories" as default selection

**Implementation details:**

Use CSS `scroll-snap-type: x mandatory` with `snap-start` on each chip. Add fade masks using `mask-image: linear-gradient(...)` for overflow indicators.

Props interface:
```typescript
interface CategoryChipRowProps {
  categories: Array<{
    id: string;
    label: string;
    labelMy?: string;
    subtitle?: string;
    icon: React.ComponentType<{ className?: string }>;
    count: number;
    accentColor: string; // Tailwind class for accent (e.g., 'bg-rose-500')
  }>;
  activeId: string | null; // null = "All"
  onSelect: (id: string | null) => void;
  showBurmese: boolean;
  totalCount: number;
}
```

Structure:
1. Container: `flex gap-2 overflow-x-auto scrollbar-hide snap-x snap-mandatory` with mask-image fade on edges
2. First chip: "All" with total count, always visible
3. Category chips: Each with `snap-start shrink-0`, showing:
   - Row 1: Icon + label (truncated with max-width) + count badge (pill)
   - Row 2: Subtitle text (brief description, small text, muted)
   - Row 3 (if showBurmese): Burmese label (font-myanmar, xs text)
4. Active chip: `bg-primary/10 border-primary text-primary`
5. Inactive chip: `bg-card border-border/60 text-muted-foreground hover:bg-muted/50`
6. All chips: `min-h-[44px]` touch target, `rounded-2xl` for pill shape
7. `whileTap={{ scale: 0.97 }}` via motion.button + SPRING_SNAPPY

ARIA: Container has `role="listbox"` + `aria-label="Category filter"`. Each chip has `role="option"` + `aria-selected`.

Category → icon mapping: Use icons from lucide-react that match the 7 USCIS categories:
- Principles of American Democracy → `Scale` (balance/justice)
- System of Government → `Landmark` (government building)
- Rights and Responsibilities → `Shield` (protection)
- American History: Colonial Period → `Flag` (flag)
- American History: 1800s → `Scroll` (historical document)
- Recent American History → `Globe` (world events)
- Civics: Symbols and Holidays → `Star` (patriotic)

Category → subtitle mapping:
- "Principles of American Democracy" → "Constitution, Democracy"
- "System of Government" → "Branches, Elections"
- "Rights and Responsibilities" → "Amendments, Duties"
- "American History: Colonial Period and Independence" → "Colonies, Revolution"
- "American History: 1800s" → "Civil War, Expansion"
- "Recent American History..." → "Wars, Movements"
- "Civics: Symbols and Holidays" → "Flag, Holidays"

Category → accent color: Use the existing `CATEGORY_COLORS_MAP` from StudyGuidePage or `getSubCategoryColors` from mastery.ts.

Add `scrollbar-hide` utility — check if it already exists in Tailwind config. If not, add it via `@layer utilities { .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; } .scrollbar-hide::-webkit-scrollbar { display: none; } }` in globals.css.
  </action>
  <verify>Run `npm run typecheck`. Component renders without errors. Each chip shows icon, label, count badge. Scroll-snap works horizontally. Touch targets are 44px minimum. ARIA attributes present.</verify>
  <done>CategoryChipRow component renders horizontal scrollable chips with icons, accents, count badges, subtitles, snap scrolling, fade masks, and proper ARIA roles.</done>
</task>

<task type="auto">
  <name>Task 2: Create FlashcardToolbar + wire chip row and toolbar into StudyGuidePage</name>
  <files>src/components/study/FlashcardToolbar.tsx, src/pages/StudyGuidePage.tsx, src/components/study/FlashcardStack.tsx</files>
  <action>
**Step 1: Create `src/components/study/FlashcardToolbar.tsx`**

Toolbar with card counter, shuffle, sort, and navigation arrows. Sits between CategoryChipRow and FlashcardStack.

Props:
```typescript
interface FlashcardToolbarProps {
  currentIndex: number;
  totalCards: number;
  onPrev: () => void;
  onNext: () => void;
  onShuffle: () => void;
  sortMode: 'default' | 'difficulty' | 'alphabetical';
  onSortChange: (mode: 'default' | 'difficulty' | 'alphabetical') => void;
  searchQuery: string;
  onSearchChange: (query: string) => void;
  showBurmese: boolean;
}
```

Layout:
- Row 1: Search input — `<input type="text">` with `Search` icon (lucide-react) as left adornment, `X` clear button when non-empty. Placeholder: "Search questions..." (or "ရှာရန်..." if showBurmese). Controlled by `searchQuery`/`onSearchChange` props. `rounded-xl bg-muted/50 border-border/60 px-3 py-2` styling. Full width.
- Row 2: Card counter "3 of 20" centered, with left/right arrow buttons (ChevronLeft/ChevronRight from lucide-react) on each side
- Row 3: Progress bar below counter (thin, using `@radix-ui/react-progress`, fill = currentIndex/totalCards)
- Row 4: Action buttons row — Shuffle button (Shuffle icon from lucide-react) + Sort dropdown (select with 3 options: Category Order, Difficulty, Alphabetical)
- All buttons: 44px min touch target, SPRING_SNAPPY on press
- Shuffle button: rotates 180deg on click (motion.animate rotation)

**Step 2: Wire into StudyGuidePage**

In the flip-card section (lines ~634-750), replace the existing `<select>` dropdown (lines 664-678) with:

1. `<CategoryChipRow>` above the FlashcardStack/grid
2. `<FlashcardToolbar>` below chip row, above cards

Add state management:
- `searchQuery` state: `string` (default `''`)
- `sortMode` state: `'default' | 'difficulty' | 'alphabetical'`
- `isShuffled` state: boolean
- `filteredQuestions` = `useMemo` derived from `searchQuery` + category selection: filter the category-selected questions by checking if `question_en` or `answer_en` (or Burmese equivalents when `showBurmese`) includes `searchQuery.toLowerCase()`. When `searchQuery` is empty, all category-selected questions pass through.
- `sortedQuestions` computed from `filteredQuestions` + sort+shuffle:
  - Default: category order (original)
  - Difficulty: sorted by question difficulty (use FSRS data if available, else category position)
  - Alphabetical: sorted by question_en text
  - If shuffled: Fisher-Yates shuffle of current sorted order
- Pass `searchQuery` and `onSearchChange` (setter for `searchQuery`) to `<FlashcardToolbar>`. Reset `searchQuery` to `''` when category changes via `handleCategoryChange`.

Wire `CategoryChipRow.onSelect` to the existing `handleCategoryChange` function.
Wire `FlashcardToolbar.onPrev/onNext` to FlashcardStack's navigation (need to expose goToNext/goToPrev from FlashcardStack or use index control).

**Step 3: Make FlashcardStack controllable**

Currently FlashcardStack manages its own `currentIndex` state internally. To support external navigation (toolbar arrows), add:
- Optional `onPrev` / `onNext` callbacks, OR
- Make FlashcardStack a controlled component with external `currentIndex` + `onIndexChange`

The simplest approach: FlashcardStack already has `startIndex` and `onIndexChange` props. Add a new prop `controlledIndex?: number` — when provided, FlashcardStack uses it instead of internal state. When toolbar arrows are clicked, parent updates `controlledIndex`.

Actually, the cleaner pattern is to lift `currentIndex` state to StudyGuidePage and pass it down. FlashcardStack already accepts `startIndex` and `onIndexChange` — but `startIndex` only sets initial state. Modify FlashcardStack to accept an optional `externalIndex` that syncs with internal state via useEffect.

OR even simpler: just use a React `key` to force remount when the user clicks toolbar arrows that change the startIndex. But this loses flip state.

Best approach: Add `currentIndex` and `setCurrentIndex` to FlashcardStack props to make it controllable when needed:
```typescript
interface FlashcardStackProps {
  questions: Question[];
  startIndex?: number;
  currentIndex?: number; // NEW: controlled mode
  onIndexChange?: (index: number) => void;
  className?: string;
}
```
When `currentIndex` prop is provided, use it instead of internal state.

Remove the old `<select>` dropdown from StudyGuidePage (lines 664-678) — it's replaced by CategoryChipRow.
  </action>
  <verify>Run `npm run typecheck` and `npm run test:run`. Navigate to /#/study, scroll to Flip Cards section — chip row visible, toolbar visible. Category chips filter cards. Arrow buttons navigate. Shuffle randomizes. Sort changes order. Search filters. Progress bar updates.</verify>
  <done>CategoryChipRow replaces dropdown. FlashcardToolbar adds card counter with navigation, progress bar, shuffle, and sort. FlashcardStack supports controlled index for toolbar integration.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. `npm run test:run` passes
3. Chip row shows all 7 categories + "All" with scroll-snap
4. Chips show icons, accent colors, count badges
5. Card counter shows "X of Y" with working arrows
6. Progress bar fills proportionally
7. Shuffle randomizes card order
8. Sort by difficulty/alphabetical works
9. Search filters questions by text
10. All touch targets >= 44px
</verification>

<success_criteria>
- CategoryChipRow replaces select dropdown with horizontal scrollable chips
- FlashcardToolbar provides card counter, navigation arrows, progress bar, shuffle, sort
- FlashcardStack supports controlled index for external navigation
- All features work together: chip filter + sort + shuffle + search + navigation
- ARIA roles and labels on chip row
</success_criteria>

<output>
After completion, create `.planning/phases/37-bug-fixes-ux-polish/37-05-SUMMARY.md`
</output>
