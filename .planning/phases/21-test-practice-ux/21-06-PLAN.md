---
phase: 21-test-practice-ux
plan: 06
type: execute
wave: 3
depends_on: ["21-03", "21-04"]
files_modified:
  - src/pages/TestPage.tsx
  - src/components/quiz/ExitConfirmDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User selects an answer then taps Check to submit (not auto-commit on tap)"
    - "User sees feedback panel slide up after checking (green/amber)"
    - "User taps Continue to advance (no auto-advance timer)"
    - "Timer pauses during feedback panel display"
    - "Exit mid-quiz shows confirmation dialog with session persistence messaging"
    - "Circular countdown ring shows green->yellow->red color progression"
  artifacts:
    - path: "src/pages/TestPage.tsx"
      provides: "Refactored mock test page with Check/Continue flow"
    - path: "src/components/quiz/ExitConfirmDialog.tsx"
      provides: "Exit confirmation dialog with session save messaging"
      exports: ["ExitConfirmDialog"]
  key_links:
    - from: "src/pages/TestPage.tsx"
      to: "src/lib/quiz/quizReducer.ts"
      via: "useReducer for quiz state machine"
      pattern: "useReducer.*quizReducer"
    - from: "src/pages/TestPage.tsx"
      to: "src/components/quiz/FeedbackPanel.tsx"
      via: "renders FeedbackPanel in feedback phase"
      pattern: "FeedbackPanel"
    - from: "src/pages/TestPage.tsx"
      to: "src/components/quiz/SegmentedProgressBar.tsx"
      via: "renders segmented bar"
      pattern: "SegmentedProgressBar"
---

<objective>
Refactor TestPage to use the Check/Continue flow with quiz state machine, new components, and timer redesign.

Purpose: Replace auto-advance-on-tap with explicit Check/Continue -- the core TPUX requirement. This is the most critical integration.
Output: Refactored TestPage.tsx with full Duolingo-style quiz flow, ExitConfirmDialog.tsx
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/21-test-practice-ux/21-CONTEXT.md
@.planning/phases/21-test-practice-ux/21-01-SUMMARY.md
@.planning/phases/21-test-practice-ux/21-03-SUMMARY.md
@.planning/phases/21-test-practice-ux/21-04-SUMMARY.md

@src/pages/TestPage.tsx
@src/lib/quiz/quizTypes.ts
@src/lib/quiz/quizReducer.ts
@src/components/quiz/FeedbackPanel.tsx
@src/components/quiz/AnswerOption.tsx
@src/components/quiz/SegmentedProgressBar.tsx
@src/components/quiz/QuizHeader.tsx
@src/components/quiz/SkipButton.tsx
@src/lib/haptics.ts
@src/lib/audio/soundEffects.ts
@src/lib/sessions/sessionStore.ts
@src/components/test/CircularTimer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ExitConfirmDialog and TestPage refactor</name>
  <files>src/components/quiz/ExitConfirmDialog.tsx, src/pages/TestPage.tsx</files>
  <action>
**ExitConfirmDialog.tsx:**

Props:
```typescript
interface ExitConfirmDialogProps {
  open: boolean;
  onClose: () => void;
  onConfirmExit: () => void;
  mode: 'mock-test' | 'practice' | 'interview';
  showBurmese: boolean;
}
```

Use `@radix-ui/react-dialog` (already installed). Content:
- Title: "Exit Quiz?" / "Exit Practice?" / "Exit Interview?"
- Message: "Your progress is saved. You can resume this session later." (per locked decision)
- Bilingual content when showBurmese
- Two buttons: "Keep Going" (secondary, closes dialog) and "Exit" (primary, calls onConfirmExit + navigates to dashboard)
- Standard Radix Dialog focus trap and Escape key handling

**TestPage.tsx full refactor:**

This is a major refactor. Replace the current scattered boolean state with `useReducer(quizReducer, initialState)`.

Key changes from current implementation:

1. **State machine**: Replace `showFeedback`, `selectedAnswer`, `isFinished` booleans with `useReducer(quizReducer, initialQuizState(config))`. Derive all UI state from `quizState.phase`.

2. **Answer selection (TPUX-01, TPUX-05)**: Clicking an answer dispatches `SELECT_ANSWER` -- does NOT commit. Answer just gets highlighted. User can change selection freely. Check button appears enabled once answer is selected.

3. **Check button**: New primary/solid 3D button at bottom of options. Disabled until answer selected. On click:
   - Dispatch `CHECK` -> phase becomes 'checked'
   - Play correct/incorrect sound effect
   - Call `hapticLight()` for correct, `hapticDouble()` for incorrect (TPUX-07)
   - After 200-300ms delay (intentional suspense per locked decision), dispatch `SHOW_FEEDBACK`

4. **Feedback panel (TPUX-02)**: Render `<FeedbackPanel>` when phase === 'feedback'. Timer PAUSES during feedback (per locked decision). Panel shows correct/incorrect with animated icons.

5. **Continue button (TPUX-03)**: In FeedbackPanel. On click dispatches `CONTINUE` -> phase becomes 'transitioning'.

6. **Skip**: Render SkipButton next to Check. On click dispatches `SKIP`. Skipped questions shown as amber in progress bar. No review phase for mock test (per locked decision).

7. **Question transitions**: Use `AnimatePresence` with slide-left animation. Current question slides out left, next slides in from right. `key={currentIndex}` for AnimatePresence.

8. **Segmented progress bar (TPUX-04)**: Replace current `<Progress>` bar with `<SegmentedProgressBar>`. Derive segment states from quizState.results + skippedIndices. Mock test: NOT tappable, no live score.

9. **Timer redesign**: Keep using `<CircularTimer>` but add color progression: pass `colorOverrides` prop or update CircularTimer to support green->yellow->red. Timer pauses when phase === 'feedback' (stop the interval).

10. **QuizHeader**: Replace current header markup with `<QuizHeader>` component. Exit button (X) opens `<ExitConfirmDialog>`. Escape key also opens it.

11. **SRS marking**: Move to end of quiz (batch approach on results screen) per locked decision. Remove immediate `recordAnswer()` calls from answer handler. Instead, batch-record all results on finish.

12. **Session persistence**: Keep existing session save pattern (fire-and-forget IndexedDB snapshot on each answer) but update to use state machine state for current position.

13. **Keep existing**: PreTestScreen, ResumePromptModal, SessionCountdown, navigation lock behavior.

14. **Question number**: "Question 3 of 10" header above question text per locked decision.

15. **First question**: animated entrance from right (slide-from-right) per locked decision.

16. **Single selection**: always, even for questions with multiple valid answers per locked decision.

IMPORTANT React patterns:
- `useReducer` instead of multiple `useState` calls for quiz state
- Timer effect gated on `quizState.phase !== 'feedback'` to pause during feedback
- No `setState` in effects for derived state -- compute from quizState directly
- `useRef` for timeout IDs (the 200-300ms delay), only access `.current` in handlers/effects
- Use `useState(() => initialValue)` lazy init for questions (already done)
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run lint`. Run `npm run build` to verify no SSR issues. Navigate to /#/test in browser -- verify answer selection doesn't auto-commit, Check button appears, feedback panel slides up.</verify>
  <done>TestPage uses quiz state machine with Check/Continue flow. Timer pauses during feedback. Exit dialog shows session save messaging. Segmented progress bar replaces linear bar. All TPUX requirements implemented for mock test mode.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run lint` passes
- `npm run build` succeeds
- TestPage renders without errors
- Answer tap selects but doesn't commit (TPUX-01)
- Check button submits, feedback panel appears (TPUX-02)
- Continue button advances to next question (TPUX-03)
- Segmented progress bar shows color-coded segments (TPUX-04)
- Skip button works and marks amber in progress bar
</verification>

<success_criteria>
- TestPage fully refactored with Check/Continue flow
- Quiz state machine drives all UI state
- Timer pauses during feedback
- Exit confirmation with session persistence messaging
- All mock test TPUX requirements working
</success_criteria>

<output>
After completion, create `.planning/phases/21-test-practice-ux/21-06-SUMMARY.md`
</output>
