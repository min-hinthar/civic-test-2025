---
phase: 23-flashcard-sort
plan: 06
type: execute
wave: 3
depends_on: ["23-01", "23-02", "23-04", "23-05"]
files_modified:
  - src/components/sort/SortModeContainer.tsx
  - src/pages/StudyGuidePage.tsx
  - src/hooks/useSortSession.ts
  - src/components/quiz/ExitConfirmDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle between Browse and Sort mode via PillTabBar on the study guide page"
    - "Sort mode orchestrates the entire sort lifecycle: sorting, undo, sound, haptics, and round transitions"
    - "Smart card defaults: SRS due cards first, then weak areas, then all cards"
    - "TTS speech buttons work on cards during sort mode same as Browse mode"
    - "Exit button in header shows confirmation dialog"
  artifacts:
    - path: "src/components/sort/SortModeContainer.tsx"
      provides: "Top-level sort mode orchestrator wiring reducer to UI components"
      exports: ["SortModeContainer"]
    - path: "src/pages/StudyGuidePage.tsx"
      provides: "PillTabBar with Sort tab, routing to SortModeContainer"
      contains: "Sort"
    - path: "src/hooks/useSortSession.ts"
      provides: "Hook wrapping sortReducer with sound effects, haptics, and session management"
      exports: ["useSortSession"]
  key_links:
    - from: "src/components/sort/SortModeContainer.tsx"
      to: "src/hooks/useSortSession.ts"
      via: "Hook provides state and dispatch for sort mode orchestration"
      pattern: "useSortSession"
    - from: "src/pages/StudyGuidePage.tsx"
      to: "src/components/sort/SortModeContainer.tsx"
      via: "Renders SortModeContainer when sort tab is active"
      pattern: "SortModeContainer"
    - from: "src/hooks/useSortSession.ts"
      to: "src/lib/sort/sortReducer.ts"
      via: "useReducer with sortReducer"
      pattern: "useReducer.*sortReducer"
---

<objective>
Build the sort mode orchestrator, hook, and integrate into StudyGuidePage with PillTabBar toggle.

Purpose: This plan wires everything together -- the reducer, gesture components, progress UI, sound effects, and haptics into a functioning sort mode. It also adds the Sort tab to the existing study guide page so users can toggle between Browse and Sort modes (FLSH-01).

Output: `SortModeContainer.tsx` (orchestrator), `useSortSession.ts` (hook), updated `StudyGuidePage.tsx`.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/pages/StudyGuidePage.tsx (modify to add Sort tab)
@src/components/sort/SwipeableStack.tsx (from Plan 04)
@src/components/sort/SortProgress.tsx (from Plan 05)
@src/components/sort/KnowDontKnowButtons.tsx (from Plan 05)
@src/components/sort/SortCountdown.tsx (from Plan 05)
@src/lib/sort/sortReducer.ts (from Plan 01)
@src/lib/sort/sortTypes.ts (from Plan 01)
@src/lib/audio/soundEffects.ts (from Plan 02 -- playFling, playKnow, playDontKnow)
@src/lib/haptics.ts (hapticMedium, hapticDouble)
@src/contexts/SRSContext.tsx (getDueCards for smart defaults)
@src/lib/mastery/weakAreaDetection.ts (detectWeakAreas for smart defaults)
@src/components/quiz/ExitConfirmDialog.tsx (exit confirmation)
@.planning/phases/23-flashcard-sort/23-RESEARCH.md
@.planning/phases/23-flashcard-sort/23-01-SUMMARY.md
@.planning/phases/23-flashcard-sort/23-04-SUMMARY.md
@.planning/phases/23-flashcard-sort/23-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: useSortSession hook</name>
  <files>src/hooks/useSortSession.ts</files>
  <action>
Create `src/hooks/useSortSession.ts` -- wraps `useReducer(sortReducer)` with side effects (sound, haptics) and card source logic.

```typescript
interface UseSortSessionReturn {
  state: SortState;
  dispatch: React.Dispatch<SortAction>;
  /** Start a sort session with smart card defaults */
  startSession: (categoryFilter?: string) => void;
  /** Handle a sort result (called by SwipeableCard onSwipe) */
  handleSort: (direction: 'know' | 'dont-know') => void;
  /** Handle animation completion */
  handleAnimationComplete: () => void;
  /** Handle undo */
  handleUndo: () => void;
  /** Start next drill round */
  startNextRound: () => void;
  /** Exit session */
  exitSession: () => void;
  /** Whether undo is available */
  canUndo: boolean;
  /** Computed segments array for progress bar */
  segments: ('know' | 'dont-know' | null)[];
  /** Personal best first-round % */
  personalBest: { percentage: number; date: string; cardCount: number } | null;
}
```

Implementation:

1. **useReducer:** `const [state, dispatch] = useReducer(sortReducer, { phase: 'idle' } as SortState)`

2. **startSession(categoryFilter?):** Smart card source logic:
   - Get SRS due cards via `useSRS().getDueCards()` (if available)
   - If due cards exist, use those
   - Else, try `detectWeakAreas()` to find weak category cards
   - Else, use `allQuestions` (all 128)
   - If categoryFilter provided, filter to that category regardless
   - Dispatch START_SORT with resulting cards

3. **handleSort(direction):**
   - Play sound: `playFling()` immediately
   - After brief delay (50ms): `direction === 'know' ? playKnow() : playDontKnow()`
   - Haptic: `direction === 'know' ? hapticMedium() : hapticDouble()`
   - Dispatch SORT_CARD with direction

4. **handleAnimationComplete():** Dispatch ANIMATION_COMPLETE

5. **handleUndo():** Dispatch UNDO, play subtle click sound (playSkip reuse)

6. **startNextRound():** Dispatch START_NEXT_ROUND

7. **exitSession():** Dispatch FINISH_SESSION

8. **canUndo:** `state.phase === 'sorting' && state.undoStack.length > 0`

9. **segments:** Computed array mapping each card position to its sort result or null

10. **personalBest:** Read from localStorage key `civic-prep-sort-personal-best`. Update after each first round (round === 1) if current Know % beats stored best.

Use `'use client'` directive. Follow React Compiler patterns: no setState in effects, use lazy useState for personalBest read.
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run lint -- --no-warn-ignored` -- compiles and lints cleanly.</verify>
  <done>useSortSession hook wraps reducer with sound/haptic side effects, smart card defaults, personal best tracking, and computed segments array.</done>
</task>

<task type="auto">
  <name>Task 2: SortModeContainer orchestrator + StudyGuidePage integration</name>
  <files>
    src/components/sort/SortModeContainer.tsx
    src/pages/StudyGuidePage.tsx
  </files>
  <action>
**SortModeContainer.tsx** -- Top-level sort mode orchestrator:

Props:
```typescript
interface SortModeContainerProps {
  categoryFilter?: string;
  onExit: () => void;
}
```

Implementation:
1. Use `useSortSession` hook for all state and handlers.
2. Auto-start session on mount: `useEffect(() => { startSession(categoryFilter) }, [])` (single mount effect).

3. **Layout by phase:**

   **phase === 'sorting' or 'animating':**
   - Header: Round badge (if round > 1), exit button (X icon in top-right)
   - SortProgress with counters and progress bar
   - SwipeableStack with current cards
   - KnowDontKnowButtons below the stack
   - Exit triggers ExitConfirmDialog (mode extended to include 'sort')

   **phase === 'round-summary':**
   - Renders RoundSummary component (Plan 07 -- for now render placeholder "Round Complete" with stats)
   - SortCountdown below for auto-start of next round

   **phase === 'countdown':**
   - Same as round-summary but countdown is active

   **phase === 'mastery':**
   - Confetti component with `intensity="celebration"`
   - Celebration message: "You know them all!" / bilingual
   - Play `playMasteryComplete()` sound once
   - Show final stats and exit button

   **phase === 'idle':**
   - Nothing or loading state

4. **Exit dialog:** Use ExitConfirmDialog. Extend its `mode` type to accept `'sort'` -- add sort-specific title/message. On confirm exit, call exitSession() then onExit().

5. **Aria live region:** Add `<div role="status" aria-live="polite">` that announces each sort result: "Sorted as Know" / "Sorted as Don't Know".

**StudyGuidePage.tsx modifications:**

1. **Add Sort tab to PillTabBar:** Add a new tab object to the existing tabs array:
   ```typescript
   {
     id: '#sort',
     label: 'Sort',
     labelMy: 'အမျိုးအစားခွဲပါ',
     icon: ArrowLeftRight, // from lucide-react
   }
   ```
   Place it as the second tab (after Browse, before Deck).

2. **Parse hash for sort view:** Add `const isSortView = hash === '#sort' || hash.startsWith('#sort-');` Extract optional category from `#sort-{category}`.

3. **Render SortModeContainer:** When `isSortView` is true, render:
   ```tsx
   <SortModeContainer
     categoryFilter={sortCategory}
     onExit={() => navigate('/study')}
   />
   ```
   Wrap in the standard page-shell layout with header and tab bar visible.

4. **Update activeTab computation:** Include `'#sort'` in the tab mapping.

5. **Category link to sort:** On the category overview, add a "Sort" action button next to "Study as Flashcards" that links to `#sort-{category}`.

Update ExitConfirmDialog to accept `mode: 'mock-test' | 'practice' | 'interview' | 'sort'` and add sort-specific bilingual labels.
  </action>
  <verify>Run `npx tsc --noEmit`, `npm run lint -- --no-warn-ignored`, and `npm run build` -- all pass. Verify Sort tab appears in PillTabBar.</verify>
  <done>SortModeContainer orchestrates sorting -> summary -> countdown -> mastery lifecycle. StudyGuidePage has Sort tab in PillTabBar. ExitConfirmDialog supports 'sort' mode. Smart card defaults use SRS due cards first.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run lint -- --no-warn-ignored` passes
3. `npm run build` succeeds (no build errors)
4. PillTabBar shows Browse, Sort, Deck, Review tabs
5. Navigating to `#sort` renders SortModeContainer
6. ExitConfirmDialog works with mode='sort'
</verification>

<success_criteria>
- FLSH-01: User can toggle between Browse and Sort mode via PillTabBar
- FLSH-02: Swipe right (Know) and left (Don't Know) work via gesture AND buttons
- FLSH-05: Know/Don't Know tap buttons always visible below card stack
- Smart card source: SRS due cards > weak areas > all cards
- Sound effects and haptics fire on each sort
- Exit confirmation dialog shown when exiting mid-sort
- Mastery celebration with confetti and sound at 100% Know
</success_criteria>

<output>
After completion, create `.planning/phases/23-flashcard-sort/23-06-SUMMARY.md`
</output>
