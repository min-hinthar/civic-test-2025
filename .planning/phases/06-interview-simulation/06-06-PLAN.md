---
phase: 06-interview-simulation
plan: 06
type: execute
wave: 5
depends_on: ["06-01", "06-05"]
files_modified:
  - src/lib/interview/interviewSync.ts
  - src/components/interview/InterviewDashboardWidget.tsx
  - src/pages/Dashboard.tsx
  - src/pages/HistoryPage.tsx
  - src/types/supabase.ts
autonomous: true

must_haves:
  truths:
    - "Interview sessions sync to Supabase when user is online"
    - "Dashboard shows interview widget with last score and contextual suggestion"
    - "History page has Interview tab showing interview session history"
    - "Supabase types include InterviewSessionRow"
  artifacts:
    - path: "src/lib/interview/interviewSync.ts"
      provides: "Supabase sync for interview sessions"
      exports: ["syncInterviewSession", "loadInterviewHistoryFromSupabase"]
    - path: "src/components/interview/InterviewDashboardWidget.tsx"
      provides: "Dashboard card with interview stats"
      exports: ["InterviewDashboardWidget"]
  key_links:
    - from: "src/lib/interview/interviewSync.ts"
      to: "src/lib/supabaseClient.ts"
      via: "supabase.from('interview_sessions')"
      pattern: "supabase.*interview_sessions"
    - from: "src/pages/Dashboard.tsx"
      to: "src/components/interview/InterviewDashboardWidget.tsx"
      via: "renders InterviewDashboardWidget"
      pattern: "InterviewDashboardWidget"
    - from: "src/pages/HistoryPage.tsx"
      to: "src/lib/interview/interviewStore.ts"
      via: "getInterviewHistory for tab data"
      pattern: "getInterviewHistory"
---

<objective>
Add Supabase sync for interview history, a dashboard widget, and a History page interview tab.

Purpose: Interview data needs to persist across devices via Supabase, users need an at-a-glance interview widget on the dashboard, and the history page needs an interview tab alongside existing test and practice tabs.

Output: Supabase sync layer, dashboard widget with contextual suggestions, and History page interview tab.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-interview-simulation/06-CONTEXT.md
@.planning/phases/06-interview-simulation/06-RESEARCH.md
@.planning/phases/06-interview-simulation/06-01-SUMMARY.md
@.planning/phases/06-interview-simulation/06-05-SUMMARY.md

@src/lib/supabaseClient.ts
@src/types/supabase.ts
@src/pages/Dashboard.tsx
@src/pages/HistoryPage.tsx
@src/lib/interview/interviewStore.ts
@src/components/srs/SRSWidget.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Supabase sync layer and types</name>
  <files>
    src/lib/interview/interviewSync.ts
    src/types/supabase.ts
    src/lib/interview/index.ts
  </files>
  <action>
    1. Add Supabase row type to `src/types/supabase.ts`:
       ```typescript
       export interface InterviewSessionRow {
         id: string;
         user_id: string;
         completed_at: string;
         mode: string;
         score: number;
         total_questions: number;
         duration_seconds: number;
         passed: boolean;
         end_reason: string;
         created_at: string;
       }
       ```
       Also add to re-exports in `src/types/index.ts` if appropriate.

    2. Create `src/lib/interview/interviewSync.ts`:
       - Import supabase from @/lib/supabaseClient
       - Import InterviewSession type

       - Export `syncInterviewSession(session: InterviewSession, userId: string): Promise<void>`:
         - Insert into 'interview_sessions' table:
           ```
           { user_id: userId, completed_at: session.date, mode: session.mode, score: session.score,
             total_questions: session.totalQuestions, duration_seconds: session.durationSeconds,
             passed: session.passed, end_reason: session.endReason }
           ```
         - On error: log to console, don't throw (sync failure shouldn't break UX)
         - If user is offline (check navigator.onLine), skip silently (offline-first, data is in IndexedDB)

       - Export `loadInterviewHistoryFromSupabase(userId: string): Promise<InterviewSession[]>`:
         - Query 'interview_sessions' where user_id matches, order by completed_at desc, limit 20
         - Map InterviewSessionRow to InterviewSession format
         - On error: return empty array (graceful degradation)
         - Note: does NOT include individual question results (those stay in IndexedDB only for simplicity)

    3. Update barrel export in `src/lib/interview/index.ts` to include interviewSync exports.

    4. Provide SQL migration for Supabase (as a comment in interviewSync.ts):
       ```sql
       -- Supabase Migration: Interview Sessions
       -- Run this in Supabase SQL Editor
       CREATE TABLE IF NOT EXISTS interview_sessions (
         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
         user_id UUID REFERENCES auth.users(id) NOT NULL,
         completed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
         mode TEXT NOT NULL CHECK (mode IN ('realistic', 'practice')),
         score INTEGER NOT NULL,
         total_questions INTEGER NOT NULL DEFAULT 20,
         duration_seconds INTEGER NOT NULL,
         passed BOOLEAN NOT NULL,
         end_reason TEXT NOT NULL,
         created_at TIMESTAMPTZ DEFAULT NOW()
       );

       ALTER TABLE interview_sessions ENABLE ROW LEVEL SECURITY;

       CREATE POLICY "Users can view own interview sessions"
         ON interview_sessions FOR SELECT USING (auth.uid() = user_id);
       CREATE POLICY "Users can insert own interview sessions"
         ON interview_sessions FOR INSERT WITH CHECK (auth.uid() = user_id);
       ```
  </action>
  <verify>Run `npx tsc --noEmit`. Verify InterviewSessionRow type is importable. Verify syncInterviewSession and loadInterviewHistoryFromSupabase compile correctly.</verify>
  <done>Supabase sync layer exists with insert and query functions. SQL migration provided as comment. Sync failures are gracefully handled without breaking UX.</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard widget and History page interview tab</name>
  <files>
    src/components/interview/InterviewDashboardWidget.tsx
    src/pages/Dashboard.tsx
    src/pages/HistoryPage.tsx
  </files>
  <action>
    1. Create `src/components/interview/InterviewDashboardWidget.tsx`:
       - Loads interview history from IndexedDB via getInterviewHistory()
       - If no history: show "Try your first interview" card with link to /interview
       - If has history:
         - Show last score prominently (e.g., "Last Interview: 15/20 - Passed")
         - Show mode of last interview (Realistic/Practice icon)
         - Show contextual suggestion based on history:
           - If never tried realistic: "Ready to try a realistic interview?"
           - If last failed: "Keep practicing! You're improving."
           - If last passed realistic: "Great job! Try to beat your score."
           - If only practiced: "Try realistic mode for the real experience"
         - Link to /interview page
       - Card styling similar to SRSWidget (Card with CardContent, compact layout)
       - Bilingual text throughout

    2. Add InterviewDashboardWidget to `src/pages/Dashboard.tsx`:
       - Import InterviewDashboardWidget
       - Place it after SRSWidget, before CategoryGrid
       - Render as: `<InterviewDashboardWidget />`

    3. Add Interview tab to `src/pages/HistoryPage.tsx`:
       - Add 'interview' to activeTab type: `'tests' | 'practice' | 'interview'`
       - Add third tab button "Interviews" (using strings.interview.interviewHistory)
       - Handle hash routing: `#interview` sets activeTab to 'interview'
       - Load interview history from IndexedDB via getInterviewHistory() in useEffect
       - Interview tab content:
         - List of interview sessions, most recent first
         - Each session shows: date, mode (Realistic/Practice badge), score (X/20), pass/fail badge, duration, endReason
         - Expandable: click to show individual question results with correct/incorrect marks
         - If no interviews: encouraging empty state message
       - Style consistently with existing test history tab (Card per session, expand/collapse)
       - Bilingual text for labels
  </action>
  <verify>Run `npx tsc --noEmit`. Visit Dashboard, verify InterviewDashboardWidget appears. Visit History page, verify Interview tab exists. Complete an interview, verify it appears in both widget and history tab.</verify>
  <done>Dashboard shows interview widget with last score and contextual nudge. History page has Interview tab showing all past interview sessions with expandable details.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Dashboard widget shows after completing an interview
3. Dashboard widget shows "Try your first interview" before any interviews
4. History page has three tabs: Tests, Practice, Interviews
5. Interview history tab shows session details with expand/collapse
6. Supabase sync function compiles and handles errors gracefully
7. SQL migration is provided in code comments
</verification>

<success_criteria>
Interview data flows from session to IndexedDB to Supabase. Dashboard provides at-a-glance interview status with contextual suggestions. History page provides complete interview history alongside existing test and practice tabs.
</success_criteria>

<output>
After completion, create `.planning/phases/06-interview-simulation/06-06-SUMMARY.md`
</output>
