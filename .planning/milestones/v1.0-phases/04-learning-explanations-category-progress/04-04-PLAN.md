---
phase: 04-learning-explanations-category-progress
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-03"]
files_modified:
  - src/pages/TestPage.tsx
  - src/lib/mastery/masteryStore.ts
autonomous: true

must_haves:
  truths:
    - "User sees expandable 'Why?' card after answering each question in test mode"
    - "User sees full review screen at end with 'You answered: X' and 'Correct answer: Y'"
    - "Review screen defaults to showing incorrect questions, with toggle to show all"
    - "Wrong answers show extra 'Common mistake' context in explanation"
    - "Each answer is recorded to masteryStore for mastery tracking"
  artifacts:
    - path: "src/pages/TestPage.tsx"
      provides: "Test page with inline explanation hints and enhanced review screen"
      contains: "WhyButton"
  key_links:
    - from: "src/pages/TestPage.tsx"
      to: "src/components/explanations/WhyButton.tsx"
      via: "WhyButton component import"
      pattern: "WhyButton"
    - from: "src/pages/TestPage.tsx"
      to: "src/lib/mastery/masteryStore.ts"
      via: "recordAnswer call after each answer"
      pattern: "recordAnswer"
---

<objective>
Integrate explanation components into the test mode: add "Why?" expandable hints after each question answer, enhance the review screen with explanations, and record answers to the mastery store.

Purpose: Users understand why answers are correct/incorrect both during and after the test. Answer recording enables mastery tracking for downstream features.

Output: Enhanced TestPage with inline explanation hints, improved review screen, and mastery data recording.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-learning-explanations-category-progress/04-CONTEXT.md
@src/pages/TestPage.tsx
@src/components/explanations/ExplanationCard.tsx
@src/components/explanations/WhyButton.tsx
@src/lib/mastery/masteryStore.ts
@src/lib/i18n/strings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WhyButton inline explanation after each answer and record to mastery store</name>
  <files>src/pages/TestPage.tsx</files>
  <action>
    Modify the TestPage to add explanation hints after each answer:

    1. **After answer feedback, show WhyButton:**
       - When `showFeedback` is true, render a `WhyButton` component below the `AnswerFeedback` component
       - Pass `explanation={currentQuestion.explanation}` and `isCorrect={selectedAnswer?.correct}`
       - The WhyButton should be collapsed by default (per CONTEXT.md: "collapsed by default with 'Why?' link")
       - Style: small expandable card below the feedback area
       - Only render if currentQuestion.explanation exists

    2. **Adjust feedback delay:**
       - Keep existing 1500ms delay for auto-advance
       - If user expands the WhyButton (taps "Why?"), pause the auto-advance timer
       - Resume auto-advance when user collapses explanation OR add a "Next" button
       - Implementation: track `explanationExpanded` state. When expanded, clear the auto-advance timeout. When collapsed or "Next" pressed, trigger processResult and advance.

    3. **Record answers to mastery store:**
       - Import `recordAnswer` from `@/lib/mastery/masteryStore`
       - After each answer selection (in handleAnswerSelect), call:
         ```typescript
         recordAnswer({
           questionId: currentQuestion.id,
           isCorrect: answer.correct,
           sessionType: 'test',
         });
         ```
       - This is fire-and-forget (don't await, don't block test flow)

    4. **Guard for missing explanation:**
       - If a question doesn't have an explanation field, don't render WhyButton (graceful fallback)
  </action>
  <verify>
    `npx tsc --noEmit` passes. Test page renders without errors. WhyButton appears after answering a question. Expanding explanation pauses auto-advance.
  </verify>
  <done>
    WhyButton appears below answer feedback in test mode. Explanation expands on tap with bilingual content. Auto-advance pauses when explanation is expanded. Each answer recorded to mastery store.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance test review screen with explanations and filtering</name>
  <files>src/pages/TestPage.tsx</files>
  <action>
    Enhance the `resultView` section of TestPage:

    1. **Add filter toggle for review:**
       - Add state: `const [showAllResults, setShowAllResults] = useState(false)`
       - Above the results list, add a toggle/tabs: "Incorrect Only" (default) | "Show All"
       - Use bilingual labels from strings
       - Filter results based on toggle: `showAllResults ? results : results.filter(r => !r.isCorrect)`
       - Show count: "Showing X of Y questions"

    2. **Enhanced result cards with explanations:**
       - Each result card already shows "Your answer" and "Correct answer" panels (keep existing layout)
       - Below the existing answer comparison, add ExplanationCard:
         ```tsx
         {result.explanation && (
           <ExplanationCard
             explanation={result.explanation}
             isCorrect={result.isCorrect}
             defaultExpanded={!result.isCorrect}  // Auto-expand for incorrect answers
           />
         )}
         ```
       - Note: Need to include question explanation in QuestionResult. Either:
         (a) Extend QuestionResult to include `explanation` field, OR
         (b) Look up explanation from the original question by questionId
         - Prefer (b) to avoid data duplication: create a `questionsMap` from the shuffled questions for quick lookup

    3. **"You answered" vs "Correct answer" display (per CONTEXT.md):**
       - Already implemented in existing code. Verify the display is clear and add bilingual labels if missing.
       - For incorrect answers, the "Your answer" panel should have a subtle warning tint
       - For correct answers, the panel should have a subtle success tint

    4. **Add bilingual "Correct" / "Incorrect" labels:**
       - Use strings for "Correct / မှန်" and "Review this answer / ပြန်လည်လေ့လာပါ"
  </action>
  <verify>
    `npx tsc --noEmit` passes. Review screen shows filter toggle. Incorrect questions show expanded explanations. Correct questions show collapsed explanations.
  </verify>
  <done>
    Review screen defaults to showing incorrect questions with explanations auto-expanded. Toggle lets user see all questions. Each result card shows explanation below answer comparison. "Common mistake" context appears for incorrect answers.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. During test: answering a question shows AnswerFeedback + WhyButton below it
3. Tapping WhyButton expands explanation and pauses auto-advance
4. After test: review screen defaults to incorrect-only view
5. Incorrect questions have explanations auto-expanded with common mistake context
6. Each answer is recorded to IndexedDB via masteryStore
</verification>

<success_criteria>
- WhyButton renders after each answer in test mode
- Explanation expansion pauses auto-advance timer
- Review screen has incorrect/all toggle
- ExplanationCard renders for each result with correct isCorrect prop
- recordAnswer called for every test answer
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-learning-explanations-category-progress/04-04-SUMMARY.md`
</output>
