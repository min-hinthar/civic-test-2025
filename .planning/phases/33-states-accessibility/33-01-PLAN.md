---
phase: 33-states-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/Skeleton.tsx
  - src/components/ui/EmptyState.tsx
  - src/components/ui/ErrorFallback.tsx
  - src/styles/animations.css
  - src/lib/a11y/announcer.ts
  - src/hooks/useRetry.ts
autonomous: true
requirements:
  - STAT-01
  - STAT-02
  - STAT-03
  - STAT-06

must_haves:
  truths:
    - "A reusable Skeleton component renders accent-tinted shimmer with staggered entrance and aria-label"
    - "A reusable EmptyState component renders duotone icon, bilingual text, CTA button, and icon pulse animation"
    - "A reusable ErrorFallback component renders inline error with icon, bilingual message, retry button, and optional stale content"
    - "An announce() utility sends messages to a persistent aria-live region for screen readers"
    - "A useRetry hook performs 1-2 silent retries and tracks escalation state"
  artifacts:
    - path: "src/components/ui/Skeleton.tsx"
      provides: "Enhanced skeleton with accent-tinted shimmer, aria-label, stagger variants"
    - path: "src/components/ui/EmptyState.tsx"
      provides: "Reusable empty state with duotone icon, bilingual text, CTA"
    - path: "src/components/ui/ErrorFallback.tsx"
      provides: "Inline error recovery with retry, escalation, stale data banner"
    - path: "src/lib/a11y/announcer.ts"
      provides: "Screen reader live region announcement utility"
    - path: "src/hooks/useRetry.ts"
      provides: "Auto-retry hook with escalation tracking"
  key_links:
    - from: "src/components/ui/EmptyState.tsx"
      to: "src/hooks/useReducedMotion.ts"
      via: "import useReducedMotion"
      pattern: "useReducedMotion"
    - from: "src/components/ui/ErrorFallback.tsx"
      to: "src/hooks/useRetry.ts"
      via: "retryCount for escalation"
      pattern: "retryCount|isEscalated"
---

<objective>
Build the three reusable "state pattern library" components (enhanced Skeleton, EmptyState, ErrorFallback) plus the a11y announcer utility and useRetry hook that all subsequent plans depend on.

Purpose: Establish the shared foundation components so Plan 03 and 04 can integrate them across all screens without duplicating patterns.
Output: Five production-ready modules that encapsulate all user-decided patterns (accent shimmer, duotone icons, encouraging tone, retry escalation, live region announcements).
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-states-accessibility/33-CONTEXT.md
@.planning/phases/33-states-accessibility/33-RESEARCH.md
@src/components/ui/Skeleton.tsx
@src/hooks/useReducedMotion.ts
@src/contexts/LanguageContext.tsx
@src/styles/animations.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Skeleton component + create EmptyState + announcer utility</name>
  <files>
    src/components/ui/Skeleton.tsx
    src/components/ui/EmptyState.tsx
    src/styles/animations.css
    src/lib/a11y/announcer.ts
  </files>
  <action>
    **Skeleton.tsx enhancement:**
    - Add `aria-label` prop (optional, string) that renders on the root element when provided (e.g., "Loading Dashboard...")
    - Add `role="status"` when aria-label is provided so screen readers announce it
    - Add CSS class `skeleton-accent` that uses accent-tinted shimmer: `linear-gradient(90deg, hsl(var(--muted)) 0%, hsl(var(--primary) / 0.08) 50%, hsl(var(--muted)) 100%)` with `background-size: 200% 100%` and `animation: shimmer 1s infinite`
    - Keep existing skeleton styles as default, add `variant` prop: `'default' | 'accent'` with accent using the new tinted shimmer
    - Add `stagger` boolean prop that when true applies `animation-delay` based on index (pass `index` prop). Delay = `index * 80ms`
    - Ensure dark mode works (the muted/primary CSS vars already adapt to dark)

    **animations.css:**
    - Add `@keyframes skeleton-shimmer` if not already present: translates background-position from 200% to -200%
    - Add `@media (prefers-reduced-motion: reduce)` rule for `.skeleton-accent` that sets `animation: none` and solid `background: hsl(var(--muted))`

    **EmptyState.tsx (NEW):**
    - Create `EmptyState` component with props:
      ```typescript
      interface EmptyStateProps {
        icon: LucideIcon;
        iconColor?: string;  // Tailwind text color class, e.g., 'text-primary'
        title: { en: string; my: string };
        description: { en: string; my: string };
        action?: {
          label: { en: string; my: string };
          onClick: () => void;
        };
        className?: string;
      }
      ```
    - Layout: flex column, centered, `py-16` vertical padding
    - Icon: `h-16 w-16` with `iconColor` (default `text-muted-foreground`), wrapped in div with `animate-soft-bounce` class (existing CSS) when `!shouldReduceMotion`
    - Title: `text-xl font-bold text-foreground mb-2` (English), then Burmese version `text-lg text-muted-foreground font-myanmar` gated by `showBurmese`
    - Description: `text-muted-foreground max-w-sm` for English, same pattern for Burmese gated by `showBurmese`
    - CTA: Render a button with `onClick`, using existing chunky button style. Show English label, and Burmese below if `showBurmese`
    - Use `useLanguage()` for `showBurmese` check
    - Use `useReducedMotion()` to disable icon animation

    **announcer.ts (NEW):**
    - Create `src/lib/a11y/announcer.ts` with:
      ```typescript
      export function announce(message: string, priority?: 'polite' | 'assertive'): void
      ```
    - On first call, create a persistent `<div>` appended to `document.body` with `aria-live`, `aria-atomic="true"`, and `class="sr-only"`
    - Cache the element in a module-level variable
    - To trigger re-announcement: clear `textContent` to empty string, then in `requestAnimationFrame` set to new message
    - Default priority: `'assertive'`
    - Support both polite and assertive by creating two separate live regions (one for each priority) on first use of each
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - Skeleton component renders with accent shimmer class
    - EmptyState renders icon, bilingual text, and CTA
    - announce() creates live region and sets textContent
  </verify>
  <done>
    Skeleton has accent-tinted shimmer with aria-label and stagger support. EmptyState is a complete reusable component with duotone icon, bilingual text, animation, and CTA. announce() utility creates and manages persistent aria-live regions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ErrorFallback component + useRetry hook</name>
  <files>
    src/components/ui/ErrorFallback.tsx
    src/hooks/useRetry.ts
  </files>
  <action>
    **useRetry hook (NEW):**
    - Create `src/hooks/useRetry.ts`:
      ```typescript
      interface UseRetryOptions {
        maxSilentRetries?: number;  // default 2
        maxManualRetries?: number;  // default 3
        silentRetryDelay?: number;  // default 1000ms
      }
      interface UseRetryResult<T> {
        data: T | null;
        error: Error | null;
        isLoading: boolean;
        retry: () => void;         // manual retry
        retryCount: number;        // manual retry count
        isEscalated: boolean;      // true after maxManualRetries
      }
      export function useRetry<T>(fetcher: () => Promise<T>, options?: UseRetryOptions): UseRetryResult<T>
      ```
    - On mount, call fetcher. If it fails, silently retry up to `maxSilentRetries` times with delay between attempts
    - After silent retries exhausted, set `error` state (triggers UI)
    - `retry()` increments `retryCount` and calls fetcher again
    - `isEscalated` is true when `retryCount >= maxManualRetries`
    - Use `useState` for all state (not useRef during render)
    - Cleanup: use closure-local `let cancelled = false` pattern per project pitfalls to prevent stale updates

    **ErrorFallback.tsx (NEW):**
    - Create `src/components/ui/ErrorFallback.tsx`:
      ```typescript
      interface ErrorFallbackProps {
        icon?: LucideIcon;           // default: CloudOff from lucide-react
        message?: { en: string; my: string };  // default: friendly error message
        onRetry: () => void;
        retryCount?: number;
        isEscalated?: boolean;
        fallbackContent?: ReactNode;
        className?: string;
      }
      ```
    - Layout: flex column centered, muted background rounded card (`bg-muted/30 rounded-2xl p-8`)
    - Icon: CloudOff (default) at `h-12 w-12 text-muted-foreground`
    - Message: bilingual, default "Hmm, something went wrong loading your data. Let's try again!" / Burmese equivalent
    - If `isEscalated`, change message to "Still having trouble? Check your connection or try later." / Burmese equivalent
    - Retry button: flex row with `RefreshCw` icon + "Try Again" text / Burmese, styled as outline button
    - If `fallbackContent` provided, render it below with a subtle banner: "Showing cached data" / Burmese + refresh icon as clickable retry
    - Use `useLanguage()` for bilingual gating
    - Use app palette muted colors per user decision (no red/amber)
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - useRetry performs silent retries before surfacing error
    - ErrorFallback renders with retry button and escalation messaging
  </verify>
  <done>
    useRetry hook handles silent retry, manual retry counting, and escalation detection. ErrorFallback renders inline error with friendly bilingual messaging, retry button, escalation state change, and optional stale data banner. Both integrate with existing language and motion contexts.
  </done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes with zero errors
- `npm run lint` passes
- All new components exported and importable
- Skeleton accent shimmer visible in accent color (not gray)
- EmptyState renders icon pulse animation, disables under reduced motion
- announce() creates sr-only div with aria-live attribute
- useRetry retries silently before showing error
- ErrorFallback escalation changes message after 3 retries
</verification>

<success_criteria>
Five new/enhanced modules exist and pass typecheck + lint:
1. Skeleton.tsx with accent shimmer, aria-label, stagger
2. EmptyState.tsx with duotone icon, bilingual text, CTA, motion-safe animation
3. ErrorFallback.tsx with retry, escalation, stale data banner
4. announcer.ts with persistent aria-live regions
5. useRetry.ts with silent + manual retry + escalation
</success_criteria>

<output>
After completion, create `.planning/phases/33-states-accessibility/33-01-SUMMARY.md`
</output>

