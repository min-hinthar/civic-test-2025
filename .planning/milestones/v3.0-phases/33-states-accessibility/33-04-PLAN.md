---
phase: 33-states-accessibility
plan: 04
type: execute
wave: 2
depends_on:
  - 33-01
files_modified:
  - src/components/pwa/OfflineBanner.tsx
  - src/contexts/OfflineContext.tsx
  - src/components/dashboard/Dashboard.tsx
  - src/components/hub/OverviewTab.tsx
  - src/components/hub/HistoryTab.tsx
  - src/components/hub/AchievementsTab.tsx
autonomous: true
requirements:
  - STAT-03

must_haves:
  truths:
    - "When content fails to load, an inline ErrorFallback appears with icon, bilingual message, and retry button"
    - "1-2 silent retries happen before the error state shows to the user"
    - "After 3 manual retries, the message escalates to a different tone"
    - "A persistent OfflineBanner appears when the device is fully offline"
    - "The OfflineBanner animates through reconnecting and back-online states"
    - "Stale cached data displays with a subtle 'Showing cached data' banner when network fetch fails"
  artifacts:
    - path: "src/components/pwa/OfflineBanner.tsx"
      provides: "Persistent offline/reconnecting/back-online banner"
    - path: "src/contexts/OfflineContext.tsx"
      provides: "Enhanced offline detection with banner state"
  key_links:
    - from: "src/components/pwa/OfflineBanner.tsx"
      to: "src/contexts/OfflineContext.tsx"
      via: "useOffline() hook for online/offline state"
      pattern: "useOffline|isOnline"
    - from: "src/components/dashboard/Dashboard.tsx"
      to: "src/components/ui/ErrorFallback.tsx"
      via: "conditional rendering on error state"
      pattern: "ErrorFallback"
---

<objective>
Integrate the ErrorFallback component and useRetry hook into data-fetching screens, and create the OfflineBanner component for persistent offline state notification.

Purpose: STAT-03 requires that content failures show inline error recovery instead of blank screens. The user decided on a hybrid pattern (toast alert + inline fallback), friendly tone, silent retries, escalation, and an animated offline/reconnecting banner.
Output: Error recovery wired into Dashboard and Hub tabs, plus OfflineBanner component for global offline state.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-states-accessibility/33-CONTEXT.md
@.planning/phases/33-states-accessibility/33-RESEARCH.md
@.planning/phases/33-states-accessibility/33-01-SUMMARY.md
@src/components/ui/ErrorFallback.tsx
@src/hooks/useRetry.ts
@src/contexts/OfflineContext.tsx
@src/components/dashboard/Dashboard.tsx
@src/components/hub/OverviewTab.tsx
@src/components/hub/HistoryTab.tsx
@src/components/hub/AchievementsTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OfflineBanner component with reconnection animation</name>
  <files>
    src/components/pwa/OfflineBanner.tsx
    src/contexts/OfflineContext.tsx
  </files>
  <action>
    **OfflineBanner.tsx (NEW):**
    - Create `src/components/pwa/OfflineBanner.tsx`
    - Three states: `offline`, `reconnecting`, `back-online`
    - **Offline state**: Persistent banner at top of content area with `WifiOff` icon + "You're offline -- some features may be limited" / Burmese. Background: muted app palette color (not red/amber per user decision). `z-40` (below modals `z-50`, below toasts `z-[9999]`).
    - **Reconnecting state**: When `navigator.onLine` becomes true, transition to "Reconnecting..." with a subtle animation (pulsing dot or spinner). Use motion/react `AnimatePresence` for smooth transition between states.
    - **Back-online state**: "Back online!" with checkmark icon, auto-dismiss after 3 seconds with a fade-out animation.
    - Position: fixed or sticky at top of the page content area (below the GlassHeader). NOT a fixed overlay to avoid z-index wars per research pitfalls.
    - Use `useReducedMotion()` to disable transition animations if needed
    - Use `useLanguage()` for bilingual text
    - Render only when offline or in transition (don't render when online and stable)

    **OfflineContext.tsx enhancement:**
    - Read existing OfflineContext to understand its online/offline detection
    - If it already provides `isOnline` boolean, use that in OfflineBanner
    - If it doesn't expose a convenient hook, add a `useOfflineStatus()` hook or ensure existing `useOffline()` provides the boolean
    - OfflineBanner should be rendered inside the provider tree. Find the appropriate place to render it (likely in `NavigationShell.tsx` or `AppShell.tsx` — read these files to determine the best placement)
    - The banner should be rendered once globally, not per-page

    **Stale data banner pattern:**
    - The OfflineBanner handles the global "you're offline" state
    - Individual screens will use ErrorFallback's `fallbackContent` + `showStaleBanner` props for per-screen stale data (wired in Task 2)
    - Per research pitfall: Only show "Showing cached data" when a network fetch was attempted AND failed AND fallback was served. NOT on normal IndexedDB fast-path loads.
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - OfflineBanner renders when device goes offline
    - OfflineBanner transitions through reconnecting -> back online states
    - OfflineBanner auto-dismisses after reconnection
    - OfflineBanner respects reduced motion
  </verify>
  <done>
    OfflineBanner component renders a persistent bilingual banner when offline, animates through "Reconnecting..." and "Back online!" states, auto-dismisses after reconnection, and is placed globally in the app shell below the header.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ErrorFallback into Dashboard and Hub tabs for data fetch failures</name>
  <files>
    src/components/dashboard/Dashboard.tsx
    src/components/hub/OverviewTab.tsx
    src/components/hub/HistoryTab.tsx
    src/components/hub/AchievementsTab.tsx
  </files>
  <action>
    **Strategy:** For each screen that fetches async data (from Supabase, IndexedDB, or API), wrap the data-fetching logic with error handling that renders `<ErrorFallback>` on failure.

    **Dashboard.tsx:**
    - Read the Dashboard to identify async data sources (likely: SRS context, social context, session data)
    - Where data fetching can fail, add error state tracking
    - On error: render `<ErrorFallback message={...} onRetry={refetchFn} retryCount={count} isEscalated={escalated} />`
    - If cached/stale data is available (from IndexedDB), pass it as `fallbackContent` so users see something rather than nothing
    - Use the `useRetry` hook from Plan 01 if applicable, or integrate retry logic into existing data hooks
    - The error toast (hybrid pattern) should fire via existing `useToast()` when the error first occurs, complementing the inline ErrorFallback

    **Hub OverviewTab.tsx:**
    - Read to find async data (mastery data, streak, stats)
    - Add ErrorFallback rendering when data fails to load
    - Retry should re-trigger the data fetch

    **Hub HistoryTab.tsx:**
    - Read to find async data (session history)
    - Add ErrorFallback for fetch failures
    - If sessions are cached locally, use as fallback content

    **Hub AchievementsTab.tsx:**
    - Read to find async data (badges, achievements)
    - Add ErrorFallback for fetch failures

    **Integration pattern for each screen:**
    1. Identify the data hook/fetch call
    2. Add error + retryCount state (or use useRetry if refactoring the hook)
    3. Render priority: loading → error (with optional fallback) → empty → content
    4. Fire toast on first error occurrence via `useToast()`
    5. Pass `onRetry` callback that re-triggers the fetch

    **Important:** Do NOT refactor working data-fetching hooks into useRetry if it would be too invasive. Instead, wrap the error handling at the component level. The useRetry hook is available for future new data fetchers; existing ones can use simpler error state + manual retry.
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - When simulating a fetch failure, Dashboard shows ErrorFallback with retry button
    - Hub tabs show ErrorFallback on data load failure
    - Retry button re-triggers the data fetch
    - Toast fires on first error
    - Escalated message appears after 3 retries
  </verify>
  <done>
    Dashboard and all Hub tabs render ErrorFallback with bilingual messaging when data fails to load. Retry button re-triggers fetches. Toast notification fires on first error. Escalated messaging appears after 3 manual retries. Stale cached data is shown as fallback when available.
  </done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- `npm run lint` passes
- OfflineBanner visible when offline, transitions through reconnecting/back-online
- Dashboard shows ErrorFallback on fetch failure with retry
- Hub tabs show ErrorFallback on fetch failure with retry
- Error toast fires alongside inline fallback (hybrid pattern)
- Escalation messaging changes after 3 retries
</verification>

<success_criteria>
1. OfflineBanner renders globally with offline/reconnecting/back-online animation
2. Dashboard renders ErrorFallback on data fetch failure
3. All 3 Hub tabs render ErrorFallback on data fetch failure
4. Retry buttons work and escalation changes message
5. Toast + inline fallback hybrid pattern active
6. All linting passes
</success_criteria>

<output>
After completion, create `.planning/phases/33-states-accessibility/33-04-SUMMARY.md`
</output>

