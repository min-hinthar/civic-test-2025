---
phase: 16-dashboard-next-best-action
plan: 03
type: execute
wave: 2
depends_on: [16-01]
files_modified:
  - src/hooks/useNextBestAction.ts
  - src/components/dashboard/NBAHeroCard.tsx
autonomous: true

must_haves:
  truths:
    - "useNextBestAction hook composes existing data hooks and returns typed NBAState"
    - "Hook waits for ALL data sources before computing (no partial-data flash)"
    - "NBA hero card displays contextual gradient, themed icon, bilingual title/hint, and CTA"
    - "Card has spring entrance animation on mount with scale"
    - "Urgent states (streak-at-risk, srs-due) have pulsing icon animation"
    - "Card crossfades to new state when recommendation changes via AnimatePresence"
    - "Primary CTA button and secondary skip link both present and contextual"
    - "'Recommended for you' label with Sparkles icon at top-left of card"
  artifacts:
    - path: "src/hooks/useNextBestAction.ts"
      provides: "Composition hook bridging data hooks to NBA pure function"
      exports: ["useNextBestAction"]
    - path: "src/components/dashboard/NBAHeroCard.tsx"
      provides: "NBA hero card UI component"
      exports: ["NBAHeroCard"]
  key_links:
    - from: "src/hooks/useNextBestAction.ts"
      to: "src/lib/nba/determineNBA.ts"
      via: "calls determineNextBestAction with composed data"
      pattern: "determineNextBestAction"
    - from: "src/hooks/useNextBestAction.ts"
      to: "src/hooks/useStreak.ts"
      via: "imports streak data"
      pattern: "useStreak"
    - from: "src/hooks/useNextBestAction.ts"
      to: "src/hooks/useSRSWidget.ts"
      via: "imports SRS due count"
      pattern: "useSRSWidget"
    - from: "src/hooks/useNextBestAction.ts"
      to: "src/hooks/useCategoryMastery.ts"
      via: "imports category mastery data"
      pattern: "useCategoryMastery"
    - from: "src/components/dashboard/NBAHeroCard.tsx"
      to: "src/lib/nba/nbaTypes.ts"
      via: "receives NBAState as prop"
      pattern: "NBAState"
---

<objective>
Create the useNextBestAction composition hook and the NBAHeroCard UI component.

Purpose: The hook bridges all existing data hooks into the pure NBA determination function, handling loading orchestration and interview history async loading. The hero card is the visual centerpiece of the new dashboard -- a full-width glassmorphic card with contextual gradients, animations, and bilingual content.

Output: `useNextBestAction` hook + `NBAHeroCard` component ready for Dashboard.tsx composition.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/16-dashboard-next-best-action/16-RESEARCH.md
@.planning/phases/16-dashboard-next-best-action/16-01-SUMMARY.md
@src/hooks/useStreak.ts
@src/hooks/useSRSWidget.ts
@src/hooks/useCategoryMastery.ts
@src/contexts/SupabaseAuthContext.tsx (useAuth for testHistory)
@src/lib/interview/interviewStore.ts (getInterviewHistory)
@src/components/hub/GlassCard.tsx
@src/hooks/useReducedMotion.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useNextBestAction composition hook</name>
  <files>src/hooks/useNextBestAction.ts</files>
  <action>
Create `src/hooks/useNextBestAction.ts`:

**Return type:**
```typescript
interface UseNextBestActionReturn {
  nbaState: NBAState | null;  // null while loading
  isLoading: boolean;
}
```

**Implementation:**

1. Call existing hooks:
   - `useStreak()` -> `{ currentStreak, activityDates, isLoading: streakLoading }`
   - `useSRSWidget()` -> `{ dueCount: srsDueCount, isLoading: srsLoading }`
   - `useCategoryMastery()` -> `{ categoryMasteries, overallMastery, isLoading: masteryLoading }`
   - `useAuth()` -> `{ user, isLoading: authLoading }` (for testHistory)

2. Load interview history from IndexedDB (same pattern as HistoryTab):
   ```typescript
   const [interviewHistory, setInterviewHistory] = useState<{ date: string; passed: boolean }[]>([]);
   const [interviewLoading, setInterviewLoading] = useState(true);
   useEffect(() => {
     let cancelled = false;
     getInterviewHistory()
       .then(sessions => {
         if (!cancelled) {
           setInterviewHistory(sessions.map(s => ({
             date: s.date,
             passed: s.passed ?? false
           })));
           setInterviewLoading(false);
         }
       })
       .catch(() => { if (!cancelled) setInterviewLoading(false); });
     return () => { cancelled = true; };
   }, []);
   ```

3. Load unique questions practiced count (same pattern as HubPage):
   ```typescript
   const [uniqueQuestionsCount, setUniqueQuestionsCount] = useState(0);
   const [questionsLoading, setQuestionsLoading] = useState(true);
   useEffect(() => {
     let cancelled = false;
     getAnswerHistory()
       .then(answers => {
         if (!cancelled) {
           const unique = new Set(answers.map(a => a.questionId));
           setUniqueQuestionsCount(unique.size);
           setQuestionsLoading(false);
         }
       })
       .catch(() => { if (!cancelled) setQuestionsLoading(false); });
     return () => { cancelled = true; };
   }, []);
   ```

4. Compute combined loading state:
   `const isLoading = streakLoading || srsLoading || masteryLoading || authLoading || interviewLoading || questionsLoading;`

5. Derive NBAState via useMemo (NOT useState+useEffect -- React Compiler safe):
   ```typescript
   const nbaState: NBAState | null = useMemo(() => {
     if (isLoading) return null;

     const testHistory = (user?.testHistory ?? []).map(s => ({
       date: s.date,
       score: s.score,
       totalQuestions: s.totalQuestions,
     }));

     return determineNextBestAction({
       currentStreak,
       activityDates,
       srsDueCount,
       overallMastery,
       categoryMasteries,
       testHistory,
       interviewHistory,
       uniqueQuestionsPracticed: uniqueQuestionsCount,
       totalQuestions,
     });
   }, [isLoading, currentStreak, activityDates, srsDueCount, overallMastery, categoryMasteries, user?.testHistory, interviewHistory, uniqueQuestionsCount]);
   ```

6. Import `totalQuestions` from `@/constants/questions` and `getAnswerHistory` from `@/lib/mastery`.

7. Return `{ nbaState, isLoading }`.

**CRITICAL: Check InterviewSession type for the `passed` field.** The InterviewSession type in types/index.ts may store `passed` as a boolean, or the pass determination may need to be computed from score. Check the actual type and adapt accordingly. If `passed` is not a direct field, compute it from the session's results (e.g., correctCount / totalQuestions >= 0.6).
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>useNextBestAction hook composes all 5 data sources, waits for all loading, and returns typed NBAState via useMemo</done>
</task>

<task type="auto">
  <name>Task 2: Create NBAHeroCard component</name>
  <files>src/components/dashboard/NBAHeroCard.tsx</files>
  <action>
Create `src/components/dashboard/NBAHeroCard.tsx`:

**Props:**
```typescript
interface NBAHeroCardProps {
  nbaState: NBAState;
}
```

**Component structure:**

1. **AnimatePresence crossfade wrapper:**
   ```tsx
   <AnimatePresence mode="wait">
     <motion.div
       key={nbaState.type}  // Key changes trigger exit/enter animation
       initial={shouldReduceMotion ? { opacity: 1 } : { opacity: 0, scale: 0.95 }}
       animate={{ opacity: 1, scale: 1 }}
       exit={shouldReduceMotion ? { opacity: 0 } : { opacity: 0, scale: 0.95 }}
       transition={{ type: 'spring', stiffness: 300, damping: 25 }}
     >
   ```

2. **GlassCard wrapper:**
   `<GlassCard className="relative overflow-hidden rounded-2xl p-6">`

3. **Gradient overlay (absolute positioned div behind content):**
   ```tsx
   <div className={clsx(
     'absolute inset-0 bg-gradient-to-br pointer-events-none',
     nbaState.gradient
   )} />
   ```

4. **Content (relative z-10):**

   a. **"Recommended for you" label** at top:
   ```tsx
   <div className="flex items-center gap-1.5 mb-3">
     <Sparkles className="h-3.5 w-3.5 text-primary" />
     <span className="text-xs font-semibold uppercase tracking-wider text-primary">
       Recommended for you
     </span>
     {showBurmese && (
       <span className="font-myanmar text-[10px] text-primary/70 ml-1">
         သင့်အတွက် အကြံပြုချက်
       </span>
     )}
   </div>
   ```

   b. **Icon + Title block (flex row):**
   - Left: NBAIcon component (see below)
   - Right: Title (English large, Burmese smaller below), hint text (English, then Burmese)

   c. **Time estimate** (if present):
   ```tsx
   {nbaState.estimatedMinutes && (
     <span className="text-xs text-muted-foreground">~{nbaState.estimatedMinutes} min</span>
   )}
   ```

   d. **CTA + Skip row:**
   - Primary CTA: `<Link>` styled as primary button (bg-primary text-white rounded-xl px-5 py-2.5 font-bold) to `nbaState.cta.to`
     - Show English CTA label; if showBurmese, append Burmese in smaller text
   - Skip link: `<Link>` as muted text link to `nbaState.skip.to`
     - Show English skip label only (saves space)

5. **NBAIcon sub-component** (inline or separate):
   - Map NBAStateType -> Lucide icon component:
     - 'new-user': Sparkles
     - 'returning-user': Heart
     - 'streak-at-risk': Flame
     - 'srs-due': Brain
     - 'weak-category': BookOpen
     - 'no-recent-test': Target
     - 'test-ready': Target
     - 'celebration': Trophy
   - Icon container: `h-12 w-12 rounded-2xl flex items-center justify-center` with contextual background tint
   - **Pulse animation for urgent states** (streak-at-risk, srs-due):
     ```tsx
     <motion.div
       animate={!shouldReduceMotion && nbaState.urgent
         ? { scale: [1, 1.05, 1], opacity: [1, 0.85, 1] }
         : {}}
       transition={nbaState.urgent
         ? { duration: 2, repeat: Infinity, ease: 'easeInOut' }
         : undefined}
     >
     ```
   - Non-urgent states: static icon, no animation

6. **Icon background tint map:**
   Map each NBAStateType to a subtle bg color class:
   - 'new-user': bg-primary/15
   - 'returning-user': bg-amber-500/15
   - 'streak-at-risk': bg-orange-500/20
   - 'srs-due': bg-blue-500/15
   - 'weak-category': bg-amber-400/15
   - 'no-recent-test': bg-emerald-500/15
   - 'test-ready': bg-emerald-600/15
   - 'celebration': bg-amber-400/15

7. **Loading skeleton:**
   Export a `NBAHeroSkeleton` component showing a glass card with pulsing bars matching the hero card layout. Used by Dashboard when `nbaState` is null.

**Important:**
- Use `Link` from react-router-dom for CTA/skip (NOT button + navigate, so it's accessible)
- Use `useLanguage()` for showBurmese
- Use `useReducedMotion()` for all animations
- motion import from 'motion/react' (NOT 'framer-motion')
- Do NOT use `useMemo<Type>()` generic syntax (React Compiler incompatible)
- Gradient overlay must be very low opacity (10-25%) to avoid muddy glass effect
  </action>
  <verify>`npx tsc --noEmit` passes; component file exists</verify>
  <done>NBAHeroCard renders contextual glassmorphic hero card with gradient overlay, themed/pulsing icon, bilingual title+hint, CTA+skip links, spring entrance animation, and crossfade transitions via AnimatePresence</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- useNextBestAction hook file exists and imports from @/lib/nba
- NBAHeroCard component file exists and imports NBAState type
- No `useMemo<Type>()` generic syntax used anywhere
- No setState in effect bodies (React Compiler safe)
</verification>

<success_criteria>
- Hook composes 5+ data sources with proper loading orchestration
- Hero card has contextual gradient, themed icon, pulse animation for urgent states
- Spring entrance animation and AnimatePresence crossfade on state change
- Bilingual content rendering with showBurmese toggle
- Primary CTA + contextual skip link both functional
- Loading skeleton exported for dashboard use
- All React Compiler ESLint rules respected
</success_criteria>

<output>
After completion, create `.planning/phases/16-dashboard-next-best-action/16-03-SUMMARY.md`
</output>
