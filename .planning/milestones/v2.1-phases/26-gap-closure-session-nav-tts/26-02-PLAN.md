---
phase: 26-gap-closure-session-nav-tts
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ttsTypes.ts
  - src/contexts/TTSContext.tsx
  - src/components/settings/VoicePicker.tsx
  - src/pages/SettingsPage.tsx
autonomous: true
requirements:
  - TTS-01
gap_closure: true

must_haves:
  truths:
    - "User can select their preferred TTS voice from a dropdown in Settings > Speech & Audio"
    - "Selected voice persists across page reloads (stored in localStorage via TTSSettings)"
    - "Voice dropdown shows English voices sorted local-first then alphabetical"
    - "Selecting a voice plays a preview of 'What is the supreme law of the land?'"
  artifacts:
    - path: "src/lib/ttsTypes.ts"
      provides: "preferredVoiceName field on TTSSettings type"
      contains: "preferredVoiceName"
    - path: "src/contexts/TTSContext.tsx"
      provides: "preferredVoiceName forwarded to engine.setDefaults"
      contains: "preferredVoiceName"
    - path: "src/components/settings/VoicePicker.tsx"
      provides: "Voice selection dropdown component"
      contains: "VoicePicker"
    - path: "src/pages/SettingsPage.tsx"
      provides: "VoicePicker rendered in Speech & Audio section"
      contains: "VoicePicker"
  key_links:
    - from: "src/components/settings/VoicePicker.tsx"
      to: "src/contexts/TTSContext.tsx"
      via: "useTTS() hook for voices, settings, updateSettings, speak, cancel"
      pattern: "useTTS"
    - from: "src/contexts/TTSContext.tsx"
      to: "src/lib/ttsTypes.ts"
      via: "TTSSettings type with preferredVoiceName"
      pattern: "preferredVoiceName"
    - from: "src/pages/SettingsPage.tsx"
      to: "src/components/settings/VoicePicker.tsx"
      via: "import and render in Speech & Audio section"
      pattern: "VoicePicker"
---

<objective>
Create VoicePicker component and wire it into SettingsPage so users can select their preferred TTS voice.

Purpose: TTS-01 requires a voice selection dropdown in Settings > Speech & Audio. VoicePicker.tsx was never created, and TTSSettings type lacks preferredVoiceName. The engine already supports preferredVoiceName in TTSEngineDefaults but the user-facing type and UI are missing.

Output: Working voice picker with persistence, preview playback, and proper integration into the settings page.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-gap-closure-session-nav-tts/26-RESEARCH.md

@src/lib/ttsTypes.ts
@src/contexts/TTSContext.tsx
@src/hooks/useTTS.ts
@src/pages/SettingsPage.tsx (Speech & Audio section starts at line 376)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend TTSSettings type and sync preferredVoiceName to engine</name>
  <files>src/lib/ttsTypes.ts, src/contexts/TTSContext.tsx</files>
  <action>
1. In `src/lib/ttsTypes.ts`, add `preferredVoiceName` to the `TTSSettings` type:
   ```typescript
   export type TTSSettings = {
     rate: 'slow' | 'normal' | 'fast';
     pitch: number;
     lang: string;
     autoRead: boolean;
     autoReadLang: AutoReadLang;
     preferredVoiceName?: string;
   };
   ```
   Place it as the last field in the type.

2. In `src/contexts/TTSContext.tsx`, update the `updateSettings` callback (around line 140-161) to forward `preferredVoiceName` to the engine. In the `engine.setDefaults()` call, add the field:
   ```typescript
   if (engine) {
     engine.setDefaults({
       rate: RATE_MAP[next.rate],
       pitch: next.pitch,
       lang: next.lang,
       preferredVoiceName: next.preferredVoiceName,
     });
   }
   ```

No changes needed to DEFAULT_SETTINGS initialization (preferredVoiceName is optional, defaults to undefined which means "auto/best available"). The existing `{ ...DEFAULT_SETTINGS, ...parsed }` merge pattern in settings loading already handles backward-compatible field additions (Phase 22 decision).
  </action>
  <verify>Run `npm run typecheck` to confirm TTSSettings extension is valid and engine.setDefaults accepts preferredVoiceName (already in TTSEngineDefaults). Run `npm run test:run -- src/` to confirm no regressions.</verify>
  <done>TTSSettings type includes optional preferredVoiceName. TTSContext.updateSettings forwards preferredVoiceName to engine.setDefaults. Existing settings backward-compat merge pattern handles the new field automatically.</done>
</task>

<task type="auto">
  <name>Task 2: Create VoicePicker component and integrate into SettingsPage</name>
  <files>src/components/settings/VoicePicker.tsx, src/pages/SettingsPage.tsx</files>
  <action>
1. Create `src/components/settings/VoicePicker.tsx`:
   - Import `useTTS` from `@/hooks/useTTS`
   - Props: `showBurmese: boolean`
   - Use `useTTS()` to get `voices`, `settings`, `updateSettings`, `speak`, `cancel`
   - Filter voices to English only: `v.lang.toLowerCase().replace(/_/g, '-')` starts with `'en-'` or equals `'en'`
   - Sort filtered voices: local voices first (`localService === true`), then alphabetical by name
   - Use `useMemo` for the filtered/sorted list (dependency: `voices`)
   - Render a native `<select>` element (per Phase 22 decision: native select for accessibility)
   - Styling: match existing SettingsPage select style `"rounded-xl border border-border bg-card px-3 py-2 text-sm text-foreground min-h-[48px] min-w-[140px]"`
   - First option: `<option value="">Auto (best available)</option>` with Burmese subtitle if showBurmese
   - Map englishVoices to `<option key={v.voiceURI} value={v.name}>{v.name} {v.localService ? '(local)' : '(online)'}</option>`
   - `value` bound to `settings.preferredVoiceName ?? ''`
   - `onChange` handler:
     a. Call `updateSettings({ preferredVoiceName: voiceName || undefined })` (empty string = auto)
     b. Cancel any active speech: `cancel()`
     c. Find the selected voice from englishVoices by name
     d. If found, call `speak('What is the supreme law of the land?', { voice })` for preview (per Phase 22 decision)
   - `aria-label="Select TTS voice"`

2. In `src/pages/SettingsPage.tsx`:
   - Import `VoicePicker` from `@/components/settings/VoicePicker`
   - Insert the VoicePicker in the Speech & Audio section AFTER the Speech Speed div (line ~425) and BEFORE the Auto-Read Toggle SettingsRow (line ~427). Per research recommendation: place after Speech Speed and before Auto-Read to group speech-output settings together.
   - Wrap in a div with label pattern matching Speech Speed:
     ```tsx
     {/* Voice Selection */}
     <div className="py-3 border-b border-border/40">
       <div className="flex items-center gap-2 mb-2">
         <Volume2 className="h-4 w-4 text-primary" />
         <p className="text-sm font-semibold text-foreground">Voice</p>
         {showBurmese && (
           <span className="font-myanmar text-sm text-muted-foreground">
             {'အသံ'}
           </span>
         )}
       </div>
       <VoicePicker showBurmese={showBurmese} />
       <p className="mt-2 text-xs text-muted-foreground">
         Choose which voice reads questions aloud.
       </p>
       {showBurmese && (
         <p className="font-myanmar text-xs text-muted-foreground mt-0.5">
           {'မေးခွန်းများကို ဖတ်ပြမည့် အသံကို ရွေးချယ်ပါ။'}
         </p>
       )}
     </div>
     ```
   - Note: Volume2 icon is already imported in SettingsPage (used for Speech & Audio section header). If a different icon is needed to avoid duplication, use `Mic` from lucide-react for the voice row instead.
  </action>
  <verify>Run `npm run typecheck` to confirm component types are valid. Run `npm run build` to confirm production build succeeds. Verify VoicePicker.tsx exists and exports correctly. Verify SettingsPage imports and renders VoicePicker in the Speech & Audio section.</verify>
  <done>VoicePicker component renders a native select with English voices sorted local-first. Selecting a voice updates settings (persisted to localStorage) and plays a preview. VoicePicker appears in Settings > Speech & Audio between Speech Speed and Auto-Read.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` -- zero errors
2. `npm run build` -- production build succeeds
3. `npm run test:run` -- all existing tests pass
4. Code review: TTSSettings has preferredVoiceName, TTSContext syncs it to engine, VoicePicker exists and is rendered in SettingsPage
</verification>

<success_criteria>
- TTSSettings type includes optional preferredVoiceName field
- TTSContext.updateSettings forwards preferredVoiceName to engine.setDefaults
- VoicePicker.tsx exists at src/components/settings/VoicePicker.tsx
- VoicePicker renders native select with English voices (local-first sort)
- Voice selection persists across page reloads
- Selection change cancels active speech and plays preview sentence
- SettingsPage renders VoicePicker in Speech & Audio section after Speech Speed
- All existing tests pass, typecheck clean, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/26-gap-closure-session-nav-tts/26-02-SUMMARY.md`
</output>
