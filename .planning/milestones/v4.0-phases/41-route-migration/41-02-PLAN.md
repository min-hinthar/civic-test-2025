---
phase: 41-route-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/push/subscribe/route.ts
  - app/api/push/send/route.ts
  - app/api/push/srs-reminder/route.ts
  - app/api/push/weak-area-nudge/route.ts
autonomous: true
requirements:
  - MIGR-11

must_haves:
  truths:
    - "POST /api/push/subscribe creates a push subscription"
    - "DELETE /api/push/subscribe removes a push subscription"
    - "POST /api/push/send sends push notifications to subscribed users"
    - "POST /api/push/srs-reminder sends SRS review reminders"
    - "POST /api/push/weak-area-nudge sends weak area practice nudges"
  artifacts:
    - path: "app/api/push/subscribe/route.ts"
      provides: "Subscribe/unsubscribe Route Handler"
      exports: ["POST", "DELETE"]
    - path: "app/api/push/send/route.ts"
      provides: "Send notifications Route Handler"
      exports: ["POST"]
    - path: "app/api/push/srs-reminder/route.ts"
      provides: "SRS reminder Route Handler"
      exports: ["POST"]
    - path: "app/api/push/weak-area-nudge/route.ts"
      provides: "Weak area nudge Route Handler"
      exports: ["POST"]
  key_links:
    - from: "app/api/push/subscribe/route.ts"
      to: "@supabase/supabase-js"
      via: "Supabase admin client for push_subscriptions table"
      pattern: "supabaseAdmin"
    - from: "app/api/push/send/route.ts"
      to: "web-push"
      via: "webPush.sendNotification for push delivery"
      pattern: "webPush.sendNotification"
---

<objective>
Migrate all 4 push notification API routes from Pages Router (`pages/api/push/*.ts`) to App Router Route Handlers (`app/api/push/*/route.ts`), converting from `NextApiRequest/NextApiResponse` pattern to Web API `Request/Response` pattern.

Purpose: Fulfill MIGR-11 (API routes as Route Handlers). Route Handlers use named HTTP method exports instead of manual method checking.
Output: 4 new Route Handler files ready to serve API requests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-route-migration/41-RESEARCH.md
@pages/api/push/subscribe.ts
@pages/api/push/send.ts
@pages/api/push/srs-reminder.ts
@pages/api/push/weak-area-nudge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate subscribe and send Route Handlers</name>
  <files>
    app/api/push/subscribe/route.ts
    app/api/push/send/route.ts
  </files>
  <action>
Convert `pages/api/push/subscribe.ts` to `app/api/push/subscribe/route.ts`:

Key conversion patterns (apply to ALL route handlers):
- Import `NextRequest, NextResponse` from `next/server` (NOT next/navigation)
- Replace `export default async function handler(req, res)` with named exports: `export async function POST(request: NextRequest)` and `export async function DELETE(request: NextRequest)`
- Remove the `if (req.method !== 'POST')` checks -- named exports handle method routing automatically (unsupported methods get automatic 405)
- `req.body` -> `await request.json()`
- `req.headers.authorization` -> `request.headers.get('authorization')`
- `req.headers['x-forwarded-for']` -> `request.headers.get('x-forwarded-for')`
- `req.socket.remoteAddress` -> remove (not available in Route Handlers, use x-forwarded-for only)
- `res.status(200).json({})` -> `NextResponse.json({}, { status: 200 })`
- `res.setHeader('Retry-After', val)` -> include in NextResponse headers: `new NextResponse(JSON.stringify({ error: 'Too many requests' }), { status: 429, headers: { 'Retry-After': String(retryAfterSeconds), 'Content-Type': 'application/json' } })`

For subscribe/route.ts specifically:
- Keep the `supabaseAdmin` client, rate limit logic, and `verifyJWT` helper at module level
- Change `verifyJWT` param from `(req: NextApiRequest)` to `(request: NextRequest)`, update header access: `request.headers.get('authorization')`
- For the IP address in Sentry `extra`, use `request.headers.get('x-forwarded-for') ?? 'unknown'` (no socket access)
- Export `POST` function (subscribe logic) and `DELETE` function (unsubscribe logic) as separate named exports
- All business logic (Supabase upsert/delete, rate limiting, JWT verification) stays identical

Convert `pages/api/push/send.ts` to `app/api/push/send/route.ts`:
- Single `export async function POST(request: NextRequest)` -- no DELETE/GET needed
- `req.headers.authorization` -> `request.headers.get('authorization')`
- `req.body` -> `const { frequency } = await request.json()`
- Keep all webPush, REMINDER_MESSAGES, and Supabase logic identical
- Return `NextResponse.json({ sent, failed })`

Wire into: These Route Handlers are auto-discovered by Next.js at `/api/push/subscribe` and `/api/push/send`. The client-side code in `src/lib/pwa/pushManager.ts` calls these URLs -- no client changes needed since the URL paths are identical.
  </action>
  <verify>
    <automated>cd C:/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && pnpm typecheck</automated>
    <manual>Verify each route.ts exports named HTTP method functions (POST, DELETE where applicable)</manual>
  </verify>
  <done>subscribe/route.ts exports POST and DELETE with rate limiting and JWT auth. send/route.ts exports POST with CRON_SECRET auth. Both use NextRequest/NextResponse. Typecheck passes.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate srs-reminder and weak-area-nudge Route Handlers</name>
  <files>
    app/api/push/srs-reminder/route.ts
    app/api/push/weak-area-nudge/route.ts
  </files>
  <action>
Convert `pages/api/push/srs-reminder.ts` to `app/api/push/srs-reminder/route.ts`:
- Single `export async function POST(request: NextRequest)` export
- Auth check: `request.headers.get('x-api-key')` instead of `req.headers['x-api-key']`
- Keep all SRS card querying, webPush notification, and 410 cleanup logic identical
- Return `NextResponse.json({ notified, errors })`

Convert `pages/api/push/weak-area-nudge.ts` to `app/api/push/weak-area-nudge/route.ts`:
- Single `export async function POST(request: NextRequest)` export
- Auth check: `request.headers.get('authorization')` instead of `req.headers.authorization`
- `const { userId, weakCategory, daysSinceStudied } = await request.json()` (await the body)
- Keep all WEAK_AREA_MESSAGES, message templating, and webPush logic identical
- Return `NextResponse.json({ sent, failed })`

Both files:
- Import `NextRequest, NextResponse` from `next/server`
- Keep the `supabaseAdmin` client and VAPID config at module level (identical to source)
- Keep the `webPush.setVapidDetails()` call in module scope (identical)
- Remove `NextApiRequest`/`NextApiResponse` imports
- No method check needed (named export handles it)

Wire into: Auto-discovered by Next.js at `/api/push/srs-reminder` and `/api/push/weak-area-nudge`. Cron jobs call these URLs directly -- no client changes needed.
  </action>
  <verify>
    <automated>cd C:/Users/minkk/OneDrive/Documents/GitHub/civic-test-2025 && pnpm typecheck && pnpm build --webpack 2>&1 | tail -20</automated>
    <manual>Verify all 4 Route Handlers exist under app/api/push/ with correct exports</manual>
  </verify>
  <done>All 4 Route Handlers created with correct Web API signatures. Each exports named HTTP method functions. Business logic preserved identically. Build passes.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes (all Route Handler types resolve)
- `pnpm build --webpack` succeeds
- All 4 files exist under `app/api/push/` with `/route.ts` naming
- Each file exports named HTTP method functions (POST, DELETE as appropriate)
- No `NextApiRequest`/`NextApiResponse` imports in new files
</verification>

<success_criteria>
- 4 Route Handler files exist: subscribe, send, srs-reminder, weak-area-nudge
- Subscribe exports POST + DELETE, other three export POST only
- All business logic (rate limiting, JWT verify, Supabase queries, webPush) preserved
- `pnpm build --webpack` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/41-route-migration/41-02-SUMMARY.md`
</output>
