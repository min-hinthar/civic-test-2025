---
phase: 11-design-token-foundation
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - pages/_document.tsx
  - src/contexts/ThemeContext.tsx
  - src/components/ThemeToggle.tsx
autonomous: true

must_haves:
  truths:
    - "No flash of unstyled content (FOUC) when loading the app in dark mode"
    - "Theme toggle shows animated sun/moon morph using motion/react"
    - "PWA browser chrome (address bar) updates color when theme changes"
    - "Theme transitions between light and dark are smooth, not jarring"
    - "System preference is respected on first visit; manual override persists"
  artifacts:
    - path: "pages/_document.tsx"
      provides: "Blocking theme script for FOUC prevention"
      contains: "civic-theme"
    - path: "src/contexts/ThemeContext.tsx"
      provides: "Theme context with PWA meta update and system preference listener"
      contains: "theme-color"
    - path: "src/components/ThemeToggle.tsx"
      provides: "Animated sun/moon toggle with motion/react"
      contains: "motion"
  key_links:
    - from: "pages/_document.tsx"
      to: "src/contexts/ThemeContext.tsx"
      via: "localStorage key 'civic-theme'"
      pattern: "civic-theme"
    - from: "src/components/ThemeToggle.tsx"
      to: "src/contexts/ThemeContext.tsx"
      via: "useThemeContext hook"
      pattern: "useThemeContext"
---

<objective>
Implement dark mode infrastructure: FOUC prevention via blocking script in _document.tsx, enhance ThemeContext with PWA theme-color meta tag updates and system preference change listener, create animated sun/moon toggle with motion/react, and add smooth theme transition CSS.

Purpose: Deliver a polished, flicker-free dark mode experience with a delightful toggle interaction.
Output: Updated _document.tsx, ThemeContext.tsx, ThemeToggle.tsx
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-design-token-foundation/11-01-SUMMARY.md
@.planning/phases/11-design-token-foundation/11-RESEARCH.md (FOUC pattern, ThemeToggle example, theme-color meta update)
@pages/_document.tsx (current _document.tsx)
@src/contexts/ThemeContext.tsx (current context)
@src/components/ThemeToggle.tsx (current toggle)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FOUC prevention and enhance ThemeContext</name>
  <files>pages/_document.tsx, src/contexts/ThemeContext.tsx</files>
  <action>
**_document.tsx - Add blocking theme script:**

Add an inline `<script>` tag inside `<Head>` BEFORE other meta tags. The script must:
1. Read `localStorage.getItem('civic-theme')`
2. Check `window.matchMedia('(prefers-color-scheme: dark)').matches`
3. Determine theme: stored preference wins, else system preference
4. Add the theme class to `document.documentElement` (`classList.add(theme)`)
5. Set `color-scheme` CSS property
6. Update `<meta name="theme-color">` content: dark = '#1a1f36', light = '#002868'
7. Wrap everything in try/catch (localStorage can throw in private browsing)

Use the exact pattern from the research Example 3. Define the script string as a const `THEME_SCRIPT` for readability.

Keep all existing `<Head>` children (manifest, apple meta tags, apple-touch-icon).

**ThemeContext.tsx - Three enhancements:**

1. **PWA theme-color meta tag update:** In the existing effect that applies the theme class (the second useEffect), also find `meta[name="theme-color"]` and update its `content` attribute. Use same values as the blocking script: dark = `#1a1f36`, light = `#002868`.

2. **System preference change listener:** Add a new useEffect that creates a `matchMedia` listener for `(prefers-color-scheme: dark)`. The listener should:
   - Only respond if NO manual override is stored in localStorage (check for key `civic-theme`)
   - If no manual override exists, update theme to match system preference
   - Clean up the listener on unmount
   - This respects the locked "two-state toggle" decision: once user manually toggles, system preference changes are ignored

3. **Smooth theme transition:** In the effect that applies the theme class, add `document.documentElement.style.setProperty('transition', 'background-color 0.3s ease, color 0.2s ease')` temporarily. Then remove it after a short delay (500ms) to avoid affecting other interactions. Alternatively, add/remove a `theme-transitioning` class that applies the transition, and remove it after the transition completes.

**IMPORTANT React Compiler constraints:**
- The existing `// eslint-disable-next-line react-hooks/set-state-in-effect` comment on the first useEffect is intentional and correct -- keep it
- Do NOT access refs during render
- Use function form of setTheme for toggling (already done)
  </action>
  <verify>
- `npx next build` passes
- _document.tsx contains the blocking script with `civic-theme` localStorage key
- ThemeContext.tsx updates `meta[name="theme-color"]` in the theme effect
- ThemeContext.tsx has a `matchMedia` listener for system preference changes
- ThemeContext.tsx has smooth transition logic
  </verify>
  <done>FOUC prevention script loads before React hydration. ThemeContext updates PWA theme-color on toggle and listens for system preference changes. Theme transitions are smooth.</done>
</task>

<task type="auto">
  <name>Task 2: Create animated sun/moon toggle with motion/react</name>
  <files>src/components/ThemeToggle.tsx</files>
  <action>
Replace the current Lucide-based ThemeToggle with an animated SVG toggle using `motion/react` (already installed in the project).

The component should:
1. Import `{ motion }` from `motion/react` and `useThemeContext`
2. Remove the Lucide `Sun` and `Moon` icon imports
3. Use a `motion.svg` with viewBox "0 0 24 24", stroke="currentColor"
4. Include two animated groups inside the SVG:
   - **Sun rays** (`motion.g`): 8 line elements forming a starburst pattern. Animate `scale` and `opacity` to 0 in dark mode, 1 in light mode. Transition duration ~0.3s.
   - **Central circle** (`motion.circle`): cx=12, cy=12, r=5. Filled in dark mode, stroked in light mode.
   - **Moon crescent** (`motion.circle`): cx=16, cy=8, r=3. Appears (opacity 1, scale 1) in dark mode, hidden (opacity 0, scale 0) in light mode. Fill with `hsl(var(--color-surface))` so the crescent matches the background.
5. The entire SVG should rotate 360 degrees when toggling to dark mode (using `animate={{ rotate: isDark ? 360 : 0 }}`).
6. Button styling:
   - `className="relative inline-flex h-10 w-10 items-center justify-center rounded-full border border-border bg-surface/80 shadow-sm transition hover:-translate-y-0.5 hover:bg-surface-muted"`
   - NOTE: `bg-surface` and `bg-surface-muted` are new Tailwind classes from Plan 01. If they don't exist yet (race condition), use `bg-card/80` and `hover:bg-muted` as fallback until Plan 01 completes.
   - Accessible: `aria-label={`Switch to ${isDark ? 'light' : 'dark'} mode`}`
   - `type="button"`

Use the research Example 2 as a reference, but adjust:
- Ensure strokeLinecap="round", strokeLinejoin="round", strokeWidth="2" on the SVG
- Use `transition={{ duration: 0.5, ease: 'easeInOut' }}` for the rotation
- Use `transition={{ duration: 0.3 }}` for ray/crescent animations

**Do NOT** use `'use client'` directive -- this is Pages Router with no app directory, so it's unnecessary (but harmless if kept for future-proofing).
  </action>
  <verify>
- ThemeToggle.tsx imports from `motion/react`, not from `lucide-react`
- ThemeToggle.tsx contains `motion.svg`, `motion.g`, `motion.circle` elements
- ThemeToggle.tsx has `aria-label` for accessibility
- `npx next build` passes
  </verify>
  <done>ThemeToggle shows an animated sun/moon morph. Sun rays scale down and moon crescent appears on dark mode toggle. SVG rotation animation provides a delightful interaction.</done>
</task>

</tasks>

<verification>
- `npx next build` passes
- _document.tsx has blocking theme script
- ThemeContext updates PWA theme-color meta tag
- ThemeContext listens for system preference changes
- ThemeToggle uses motion/react animated SVG (no Lucide icons)
- Dark mode loads without FOUC
</verification>

<success_criteria>
Dark mode loads without any visible flash. Theme toggle features a smooth sun/moon animation using motion/react. PWA address bar color matches theme. System preference is respected until user manually overrides.
</success_criteria>

<output>
After completion, create `.planning/phases/11-design-token-foundation/11-02-SUMMARY.md`
</output>
