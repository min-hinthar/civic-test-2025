---
phase: 22-tts-quality
plan: 05
type: execute
wave: 2
depends_on: [22-01, 22-02]
files_modified:
  - src/hooks/useAutoRead.ts
  - src/components/test/PreTestScreen.tsx
  - src/components/practice/PracticeConfig.tsx
  - src/components/interview/InterviewSetup.tsx
autonomous: true

must_haves:
  truths:
    - "Auto-read hook triggers speech when triggerKey changes"
    - "Auto-read cleanup cancels speech on unmount and on re-trigger"
    - "Pre-screens show speed pill selector and auto-read toggle as per-session overrides"
    - "Per-session overrides do NOT sync back to global settings"
  artifacts:
    - path: "src/hooks/useAutoRead.ts"
      provides: "useAutoRead hook with triggerKey-based auto-speech"
    - path: "src/components/test/PreTestScreen.tsx"
      provides: "Speed and auto-read per-session overrides"
  key_links:
    - from: "src/hooks/useAutoRead.ts"
      to: "src/hooks/useTTS.ts"
      via: "speak() and cancel() from useTTS"
      pattern: "speak|cancel"
    - from: "src/components/test/PreTestScreen.tsx"
      to: "src/hooks/useTTSSettings.ts"
      via: "reads global settings for initial per-session values"
      pattern: "useTTSSettings"
---

<objective>
Create the useAutoRead hook that triggers TTS on navigation events, and add per-session speed and auto-read override controls to PreTestScreen, PracticeConfig, and InterviewSetup.

Purpose: Auto-read foundation for all screens (study, test, practice), and per-session speed/auto-read overrides per user decisions. Interview auto-reads always (examiner simulation).
Output: useAutoRead hook, per-session override UI on all three pre-screens.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-tts-quality/22-RESEARCH.md

@src/hooks/useTTS.ts
@src/hooks/useTTSSettings.ts
@src/components/test/PreTestScreen.tsx
@src/components/practice/PracticeConfig.tsx
@src/components/interview/InterviewSetup.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAutoRead hook</name>
  <files>src/hooks/useAutoRead.ts</files>
  <action>
Create `src/hooks/useAutoRead.ts`:

```typescript
import { useEffect, useRef } from 'react';
import { useTTS } from './useTTS';

interface UseAutoReadOptions {
  /** Text to speak */
  text: string;
  /** Whether auto-read is enabled */
  enabled: boolean;
  /** Language override (e.g., 'en-US', 'my-MM') */
  lang?: string;
  /** Unique key that triggers re-read on change (e.g., question index, card side) */
  triggerKey: string | number;
  /** Delay before speaking in ms (default 300ms to let UI settle) */
  delay?: number;
}

export function useAutoRead(options: UseAutoReadOptions): void {
  const { speak, cancel } = useTTS();
  const { text, enabled, lang, triggerKey, delay = 300 } = options;
  // Track if the effect has been cancelled (React Strict Mode double-invoke safety)
  const cancelledRef = useRef(false);

  useEffect(() => {
    cancelledRef.current = false;

    if (!enabled || !text?.trim()) return;

    const timer = setTimeout(() => {
      if (cancelledRef.current) return;
      speak(text, { lang }).catch(() => {
        // Auto-read failure: silent -- user can tap manually
        // Per user decision: "silent retry once, then stop"
        if (cancelledRef.current) return;
        setTimeout(() => {
          if (cancelledRef.current) return;
          speak(text, { lang }).catch(() => {
            // Second failure: stop, let user tap manually
          });
        }, 500);
      });
    }, delay);

    return () => {
      cancelledRef.current = true;
      clearTimeout(timer);
      cancel();
    };
    // Dependencies: re-trigger only on key change and enabled toggle
    // speak/cancel are stable (useCallback in useTTS)
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [triggerKey, enabled]);
}
```

Key design decisions:
- `triggerKey` is the primary re-trigger mechanism (question index, card flip state, etc.)
- 300ms default delay prevents speech overlapping with UI transitions
- Silent retry once per user decision (auto-read mid-session failure handling)
- cancelledRef prevents stale speech after unmount/re-render
- cancel() in cleanup stops speech when navigating away
- Does NOT use `useAutoRead` in InterviewSession (interview has its own phase machine)
  </action>
  <verify>
`npx tsc --noEmit` passes.
`npx eslint src/hooks/useAutoRead.ts` passes.
  </verify>
  <done>
useAutoRead hook triggers speech on triggerKey change with delay, silent retry once, and cleanup on unmount. Ready for consumer integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add per-session speed and auto-read overrides to pre-screens</name>
  <files>src/components/test/PreTestScreen.tsx, src/components/practice/PracticeConfig.tsx, src/components/interview/InterviewSetup.tsx</files>
  <action>
For each pre-screen, add per-session override state that initializes from global settings but does NOT sync back.

**Pattern for all three screens:**
1. Import `useTTSSettings` and read global settings for initial values
2. Create local state:
   ```
   const { settings: globalTTS } = useTTSSettings();
   const [sessionSpeed, setSessionSpeed] = useState<'slow' | 'normal' | 'fast'>(globalTTS.rate);
   const [sessionAutoRead, setSessionAutoRead] = useState(globalTTS.autoRead);
   ```
3. Add a speed pill selector row BELOW existing options (question count, timer, etc.):
   - Three pills: Slow (0.75x) / Normal (1x) / Fast (1.25x)
   - Use the same 3-button radio group style as the Settings page speed selector
   - Label: "Speech Speed" with Burmese translation
   - Use `role="radiogroup"` and `aria-label="Speech speed"`
4. Add an auto-read toggle below the speed selector:
   - Small toggle switch with label "Auto-Read" and Burmese translation
   - Only show when TTS is supported (check `useTTS().isSupported`)
5. Pass `sessionSpeed` and `sessionAutoRead` to the session component via props or the onStart callback. Update the session start callback to include these values. Existing props interfaces will need extending.
6. For PreTestScreen and PracticeConfig: both speed and auto-read overrides
7. For InterviewSetup:
   - Speed selector: Only visible in Practice mode (Real mode uses fixed normal speed per user decision)
   - Auto-read: NOT shown (interview always auto-reads per user decision)

**Styling:**
- Speed pills: Same rounded-xl 3-column layout as Settings. Use `flex gap-2` with `flex-1` children.
- Auto-read toggle: Use the ToggleSwitch pattern (or a simple checkbox toggle) inline with the label.
- Add a subtle divider between existing config options and the new speech options.
- Keep within the existing card/section layout of each pre-screen.

**Props forwarding:**
- The session components (TestPage, PracticeSession, InterviewSession) will receive `speedOverride` and `autoReadOverride` props. Define these in the pre-screen's onStart callback data. The actual prop types on session components will be added in plan 22-07 when auto-read is wired into those screens.
- For now, pass the values via the existing callback mechanism. If the pre-screen calls `onStart({ questionCount, timer, ... })`, extend it with `{ ...existing, speedOverride: sessionSpeed, autoReadOverride: sessionAutoRead }`.
  </action>
  <verify>
`npx tsc --noEmit` passes.
`npx eslint src/components/test/PreTestScreen.tsx src/components/practice/PracticeConfig.tsx src/components/interview/InterviewSetup.tsx` passes.
`npm run build` succeeds.
  </verify>
  <done>
All three pre-screens show per-session speed pill selector and auto-read toggle (where applicable). Values initialize from global settings but remain local state. InterviewSetup only shows speed in Practice mode and hides auto-read. Session start callbacks forward override values.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npx tsc --noEmit` passes
3. `npm run lint` passes
4. useAutoRead hook triggers speech on triggerKey change
5. Pre-screens show speed and auto-read overrides
6. Interview pre-screen only shows speed in Practice mode
7. Changing per-session overrides does NOT change global settings (verify localStorage unchanged)
</verification>

<success_criteria>
- useAutoRead hook fires speech 300ms after triggerKey change when enabled
- useAutoRead cleanup cancels speech on unmount and re-trigger
- useAutoRead retries once silently on failure
- PreTestScreen and PracticeConfig show speed + auto-read overrides
- InterviewSetup shows speed in Practice mode only, no auto-read toggle
- Per-session values stay local (no localStorage mutation)
- All three pre-screens pass sessionSpeed and sessionAutoRead to session start
</success_criteria>

<output>
After completion, create `.planning/phases/22-tts-quality/22-05-SUMMARY.md`
</output>
