---
phase: 06-interview-simulation
plan: 05
type: execute
wave: 4
depends_on: ["06-01", "06-04"]
files_modified:
  - src/components/interview/InterviewResults.tsx
  - src/pages/InterviewPage.tsx
autonomous: true

must_haves:
  truths:
    - "User sees pass/fail status with animated score after interview"
    - "Results show category breakdown by USCIS categories"
    - "Results show mini line chart comparing past interview scores"
    - "Confetti plays for passing, encouragement shows for failing"
    - "Correct answer is read aloud via TTS as closing statement"
    - "User can retry or switch modes from results"
    - "Interview session is saved to IndexedDB"
    - "Correct/incorrect answers update mastery system"
    - "Incorrect questions show expandable WhyButton explanations"
  artifacts:
    - path: "src/components/interview/InterviewResults.tsx"
      provides: "Full results display with chart, breakdown, celebration"
      exports: ["InterviewResults"]
  key_links:
    - from: "src/components/interview/InterviewResults.tsx"
      to: "src/lib/interview/interviewStore.ts"
      via: "saveInterviewSession + getInterviewHistory"
      pattern: "saveInterviewSession|getInterviewHistory"
    - from: "src/components/interview/InterviewResults.tsx"
      to: "src/lib/mastery/masteryStore.ts"
      via: "recordAnswer for each result"
      pattern: "recordAnswer"
    - from: "src/components/interview/InterviewResults.tsx"
      to: "recharts"
      via: "LineChart for trend visualization"
      pattern: "LineChart|ResponsiveContainer"
---

<objective>
Build the interview results screen with full analysis, trend chart, mastery integration, and data persistence.

Purpose: After completing an interview session, users need comprehensive feedback: pass/fail status, score, category breakdown, comparison to past sessions, and learning opportunities via expandable explanations. Results must persist to IndexedDB and feed into the mastery system.

Output: InterviewResults component with all analysis features, connected to IndexedDB persistence and mastery recording.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-interview-simulation/06-CONTEXT.md
@.planning/phases/06-interview-simulation/06-RESEARCH.md
@.planning/phases/06-interview-simulation/06-01-SUMMARY.md
@.planning/phases/06-interview-simulation/06-04-SUMMARY.md

@src/components/celebrations/Confetti.tsx
@src/components/celebrations/CountUpScore.tsx
@src/lib/interview/interviewStore.ts
@src/lib/interview/interviewGreetings.ts
@src/lib/mastery/masteryStore.ts
@src/lib/mastery/categoryMapping.ts
@src/pages/HistoryPage.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: InterviewResults component with all analysis features</name>
  <files>src/components/interview/InterviewResults.tsx</files>
  <action>
    Create `src/components/interview/InterviewResults.tsx`:

    **Props:**
    - `results: InterviewResult[]`
    - `mode: InterviewMode`
    - `durationSeconds: number`
    - `endReason: InterviewEndReason`
    - `onRetry: () => void`
    - `onSwitchMode: (mode: InterviewMode) => void`

    **On mount (save results):**
    - Calculate score: results.filter(r => r.selfGrade === 'correct').length
    - Calculate passed: score >= 12
    - Build InterviewSession object with all fields
    - Save to IndexedDB via saveInterviewSession()
    - Record each result to mastery system via recordAnswer():
      - For each result: `recordAnswer({ questionId: result.questionId, isCorrect: result.selfGrade === 'correct', sessionType: 'test' })`
      - Use Promise.all for batch recording
    - Load past interview history via getInterviewHistory() for trend chart

    **TTS closing statement:**
    - On mount, after a brief delay (1s), play closing statement via TTS:
      - If passed: getClosingStatement(true)
      - If failed: getClosingStatement(false)
    - InterviewerAvatar shows at top, speaking=true during closing TTS

    **Layout sections (top to bottom):**

    1. **Pass/Fail Banner:**
       - Passed: Green gradient banner with checkmark icon, bilingual "Passed" text
       - Failed: Warm orange banner with encouragement icon, bilingual "Did Not Pass" text
       - Show endReason as subtitle (e.g., "Reached 12 correct answers" or "Completed all 20 questions")

    2. **Animated Score:**
       - Use CountUpScore component for score animation
       - Display as "X / 20" with large typography
       - Show percentage below (e.g., "60%")

    3. **Celebration:**
       - If passed: show Confetti component with 'celebration' intensity
       - If failed: show encouraging bilingual message (no confetti)

    4. **Category Breakdown:**
       - Group results by USCIS main category (American Government, American History, Integrated Civics)
       - For each category: show correct/total count with small progress bar
       - Use USCIS_CATEGORIES mapping from @/lib/mastery
       - Color-code categories using existing CATEGORY_COLORS

    5. **Trend Chart:**
       - Load past interview sessions from getInterviewHistory()
       - Show last 5-10 scores as a mini line chart using recharts (LineChart, Line, XAxis, Tooltip)
       - Single line with score values (0-20 on Y axis)
       - Each data point shows mode via tooltip (realistic vs practice icon/text)
       - Follow existing HistoryPage recharts pattern for styling
       - If fewer than 2 sessions, show "Complete more interviews to see trends" message

    6. **Incorrect Questions Review:**
       - List questions where selfGrade === 'incorrect'
       - Each shows question text (bilingual) with expandable WhyButton for explanation
       - Use existing ExplanationCard pattern
       - Questions from allQuestions lookup for full explanation data

    7. **Action Buttons:**
       - "Try Again" button: calls onRetry (returns to setup)
       - "Switch to [other mode]" button: calls onSwitchMode with opposite mode
         - If was realistic, show "Try Practice Mode"
         - If was practice, show "Try Realistic Mode"
       - "Back to Dashboard" link

    **Bilingual throughout** using BilingualText, BilingualHeading, SectionHeading components.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify InterviewResults renders with mock data. Verify Confetti appears for passing scores. Verify trend chart renders with multiple sessions. Verify incorrect questions show WhyButton.</verify>
  <done>InterviewResults shows pass/fail with animated score, confetti celebration, category breakdown, trend chart, incorrect question explanations, retry/switch mode buttons. Results saved to IndexedDB and mastery system.</done>
</task>

<task type="auto">
  <name>Task 2: Wire InterviewResults into InterviewPage</name>
  <files>src/pages/InterviewPage.tsx</files>
  <action>
    Update `src/pages/InterviewPage.tsx`:

    1. Import InterviewResults component
    2. Add state for endReason: `InterviewEndReason | null`
    3. Update onComplete handler from InterviewSession to capture endReason
    4. Replace results placeholder with actual InterviewResults:
       ```
       {phase === 'results' && (
         <InterviewResults
           results={results}
           mode={mode}
           durationSeconds={sessionDuration}
           endReason={endReason!}
           onRetry={() => { setResults([]); setEndReason(null); setPhase('setup'); }}
           onSwitchMode={(newMode) => { setResults([]); setEndReason(null); setMode(newMode); setPhase('countdown'); }}
         />
       )}
       ```
    5. Ensure TTS closing statement plays via InterviewResults mount
    6. Ensure audio recorder cleanup is called when transitioning to results
  </action>
  <verify>Run `npx tsc --noEmit`. Complete a full interview (both modes). Verify results screen appears with all sections. Verify retry returns to setup. Verify switch mode goes to countdown with new mode.</verify>
  <done>InterviewPage transitions to results phase after session completion. Results display all analysis. Retry and mode switching work correctly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Complete realistic interview -> results show pass/fail with confetti/encouragement
3. Complete practice interview -> results show all 20 questions
4. Score animated via CountUpScore
5. Category breakdown shows correct/total per USCIS category
6. Trend chart appears after 2+ interview sessions
7. Incorrect questions have expandable WhyButton explanations
8. "Try Again" returns to setup
9. "Switch mode" starts countdown with other mode
10. Interview session saved to IndexedDB (verify via getInterviewHistory)
11. Mastery system updated (verify via getAnswerHistory)
</verification>

<success_criteria>
Results screen provides comprehensive interview feedback with persistence. Users can learn from mistakes via explanations, track progress via trend chart, and easily retry or switch modes.
</success_criteria>

<output>
After completion, create `.planning/phases/06-interview-simulation/06-05-SUMMARY.md`
</output>
