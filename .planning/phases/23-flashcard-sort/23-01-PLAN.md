---
phase: 23-flashcard-sort
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/sort/sortTypes.ts
  - src/lib/sort/sortReducer.ts
autonomous: true

must_haves:
  truths:
    - "Sort state machine transitions through idle -> sorting -> animating -> round-summary -> countdown -> mastery phases"
    - "SORT_CARD action classifies current card as know or dont-know and advances index"
    - "UNDO action restores last sorted card with correct counter adjustment"
    - "START_NEXT_ROUND shuffles only dont-know cards for drill round"
    - "Round history tracks per-round stats for improvement delta display"
  artifacts:
    - path: "src/lib/sort/sortTypes.ts"
      provides: "SortPhase, SortState, SortAction, UndoEntry, RoundResult type definitions"
      exports: ["SortPhase", "SortState", "SortAction", "UndoEntry", "RoundResult", "SortConfig"]
    - path: "src/lib/sort/sortReducer.ts"
      provides: "Pure reducer function + initialSortState factory"
      exports: ["sortReducer", "initialSortState"]
  key_links:
    - from: "src/lib/sort/sortReducer.ts"
      to: "src/lib/sort/sortTypes.ts"
      via: "type imports for SortState and SortAction"
      pattern: "import.*from.*sortTypes"
---

<objective>
Create the sort mode state machine types and pure reducer function.

Purpose: The reducer is the brain of the entire sort mode -- every UI component reads from its state and dispatches its actions. Building it first as pure logic enables TDD testing and parallel UI development.

Output: `src/lib/sort/sortTypes.ts` (all type definitions) and `src/lib/sort/sortReducer.ts` (reducer + factory).
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/quiz/quizReducer.ts (reference pattern for state machine reducer)
@src/lib/quiz/quizTypes.ts (reference pattern for quiz types)
@.planning/phases/23-flashcard-sort/23-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sort mode type definitions</name>
  <files>src/lib/sort/sortTypes.ts</files>
  <action>
Create `src/lib/sort/sortTypes.ts` with all type definitions for the sort mode state machine:

**SortPhase** -- string literal union:
- `'idle'` -- before first round (landing/setup)
- `'sorting'` -- active card sorting
- `'animating'` -- card fling animation in progress (gates undo)
- `'round-summary'` -- end-of-round stats display
- `'countdown'` -- auto-start countdown for next round
- `'mastery'` -- 100% known celebration screen

**UndoEntry** -- tracks last sort for undo:
```typescript
interface UndoEntry {
  questionId: string;
  direction: 'know' | 'dont-know';
  cardIndex: number;
}
```

**RoundResult** -- stats per completed round:
```typescript
interface RoundResult {
  round: number;
  totalCards: number;
  knownCount: number;
  unknownCount: number;
  durationMs: number;
  unknownIds: string[];
}
```

**SortConfig** -- session initialization config:
```typescript
interface SortConfig {
  cards: Question[];
  categoryFilter?: string;
}
```

**SortState** -- full reducer state:
```typescript
interface SortState {
  phase: SortPhase;
  round: number;
  cards: Question[];           // Current round's cards (shuffled)
  currentIndex: number;
  knownIds: Set<string>;
  unknownIds: Set<string>;
  allUnknownIds: Set<string>;  // Cumulative across all rounds
  undoStack: UndoEntry[];
  roundHistory: RoundResult[];
  startTime: number;
  sourceCards: Question[];     // Original full card set
  categoryFilter?: string;
}
```

**SortAction** -- discriminated union of all actions:
- `START_SORT` -- begin sorting (payload: SortConfig)
- `SORT_CARD` -- classify current card (payload: { direction: 'know' | 'dont-know' })
- `ANIMATION_COMPLETE` -- card fling finished, advance to next card or round-summary
- `UNDO` -- restore last sorted card
- `START_NEXT_ROUND` -- begin drill round with dont-know cards
- `START_COUNTDOWN` -- transition to countdown phase
- `CANCEL_COUNTDOWN` -- cancel auto-start, return to round-summary
- `FINISH_SESSION` -- explicitly end session
- `RESUME_SESSION` -- restore state from persisted snapshot (payload: partial state)

Import `Question` type from `@/types`. Export all types.

Round cap: 10 rounds max (per discretion recommendation). Export as `MAX_ROUNDS = 10`.
  </action>
  <verify>Run `npx tsc --noEmit` -- file compiles with no errors.</verify>
  <done>All sort mode type definitions exist in sortTypes.ts. SortPhase has 6 phases, SortAction has 9 action types, SortState has all required fields.</done>
</task>

<task type="auto">
  <name>Task 2: Sort mode reducer implementation</name>
  <files>src/lib/sort/sortReducer.ts</files>
  <action>
Create `src/lib/sort/sortReducer.ts` implementing the pure reducer function. Follow the `quizReducer.ts` pattern: every action handler is guarded by current phase.

**`initialSortState(config: SortConfig): SortState`** factory:
- Shuffle cards using `fisherYatesShuffle` from `src/lib/shuffle.ts`
- Set phase to `'sorting'`, round to 1, currentIndex to 0
- Initialize empty Sets for knownIds, unknownIds, allUnknownIds
- Set startTime to Date.now()
- Store sourceCards and categoryFilter from config

**`sortReducer(state: SortState, action: SortAction): SortState`**:

**START_SORT** (phase: any -> sorting):
- Call initialSortState with action.payload config
- Return fresh state

**SORT_CARD** (phase: sorting -> animating):
- Guard: only in 'sorting' phase
- Get current card from `state.cards[state.currentIndex]`
- Add to knownIds or unknownIds Set based on direction
- If direction is 'dont-know', also add to allUnknownIds
- Push UndoEntry to undoStack
- Transition to 'animating' phase (card is still flying off screen)

**ANIMATION_COMPLETE** (phase: animating -> sorting or round-summary):
- Guard: only in 'animating' phase
- Advance currentIndex by 1
- If currentIndex >= cards.length: transition to 'round-summary', create RoundResult and push to roundHistory
- If all cards known (unknownIds empty): transition to 'mastery' phase instead
- Otherwise: transition back to 'sorting'

**UNDO** (phase: sorting -> sorting):
- Guard: only in 'sorting' phase and undoStack not empty
- Pop last UndoEntry from stack
- Remove questionId from the appropriate Set (knownIds or unknownIds)
- Also remove from allUnknownIds if it was dont-know
- Decrement currentIndex by 1

**START_NEXT_ROUND** (phase: round-summary -> sorting):
- Guard: only in 'round-summary' phase
- Guard: round < MAX_ROUNDS
- Get dont-know cards: filter sourceCards by unknownIds
- Shuffle them with fisherYatesShuffle
- Increment round, reset currentIndex to 0
- Reset knownIds and unknownIds to empty Sets (allUnknownIds keeps cumulative)
- Reset undoStack to empty
- Set startTime to Date.now()
- Transition to 'sorting'

**START_COUNTDOWN** (phase: round-summary -> countdown):
- Guard: only in 'round-summary' phase

**CANCEL_COUNTDOWN** (phase: countdown -> round-summary):
- Guard: only in 'countdown' phase

**FINISH_SESSION** (any -> idle):
- Return fresh idle state (preserving roundHistory for potential display)

**RESUME_SESSION** (any -> sorting):
- Reconstruct state from payload (Sets from arrays)
- Reset undoStack to empty per locked decision
- Set phase to 'sorting'

Import fisherYatesShuffle from `@/lib/shuffle`. Use `[...set]` spread for immutable Set operations. Never mutate state -- always return new objects.

Mastery credit policy (per discretion): single "Know" swipe = mastered for that session. No consecutive-Know tracking needed.
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run lint -- --no-warn-ignored` -- compiles and lints cleanly.</verify>
  <done>sortReducer handles all 9 action types with proper phase guards. initialSortState creates shuffled card deck. Round progression caps at MAX_ROUNDS (10).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run lint -- --no-warn-ignored` passes
3. Both files exist and export expected symbols
4. Reducer is pure -- no side effects, no imports of React
</verification>

<success_criteria>
- Sort state machine types fully defined with 6 phases and 9 actions
- Reducer handles all transitions with proper phase guards
- Round cap at 10 enforced in START_NEXT_ROUND
- Undo correctly reverses last sort and decrements index
- Mastery detection works when unknownIds is empty after sorting all cards
</success_criteria>

<output>
After completion, create `.planning/phases/23-flashcard-sort/23-01-SUMMARY.md`
</output>
