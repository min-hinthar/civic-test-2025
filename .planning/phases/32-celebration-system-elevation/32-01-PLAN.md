---
phase: 32-celebration-system-elevation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/celebrations/Confetti.tsx
  - src/components/celebrations/index.ts
autonomous: true
requirements:
  - CELB-01
  - CELB-03

must_haves:
  truths:
    - "Navigating away during a celebration does not leak intervals or produce console errors"
    - "Confetti particles include themed shapes (stars, shields, circles) with civics personality"
    - "Confetti bursts originate from bottom-center in party popper style"
    - "Low-end devices get reduced particle count (50 instead of 200) but same celebration style"
    - "Dark mode confetti uses brighter/more luminous colors"
  artifacts:
    - path: "src/components/celebrations/Confetti.tsx"
      provides: "Leak-free confetti with custom shapes and party popper physics"
      contains: "intervalRef"
  key_links:
    - from: "src/components/celebrations/Confetti.tsx"
      to: "canvas-confetti"
      via: "shapeFromPath for star and shield shapes"
      pattern: "shapeFromPath"
---

<objective>
Fix the existing setInterval leak in Confetti.tsx's celebration mode and upgrade confetti with custom civics-themed shapes, party popper physics, and achievement-scaled intensity levels.

Purpose: CELB-01 blocks all new celebration work -- the leak must be fixed first. CELB-03 elevates confetti from generic colored dots to themed particles that reinforce the civics identity.
Output: Leak-free Confetti.tsx with star/shield/circle shapes, bottom-center party popper origin, dark mode color adaptation, and low-end device particle reduction.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-celebration-system-elevation/32-RESEARCH.md

@src/components/celebrations/Confetti.tsx
@src/components/celebrations/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix setInterval leak and upgrade confetti with themed shapes and party popper physics</name>
  <files>src/components/celebrations/Confetti.tsx, src/components/celebrations/index.ts</files>
  <action>
Fix the setInterval leak in Confetti.tsx (CELB-01):
1. Add `const intervalRef = useRef<ReturnType<typeof setInterval> | null>(null)` at component top
2. In the `celebration` case of `fireConfetti`, store the interval ID in `intervalRef.current` instead of a local variable
3. Before creating a new interval, clear any existing one: `if (intervalRef.current) clearInterval(intervalRef.current)`
4. Add a cleanup `useEffect` that clears `intervalRef.current` on unmount
5. In the interval callback, when clearing, also set `intervalRef.current = null`

Upgrade confetti with custom shapes (CELB-03):
1. Import `confetti` from `canvas-confetti` (the underlying library, already a peer dep of react-canvas-confetti)
2. Create custom shapes at module level using `confetti.shapeFromPath`:
   - `starShape`: 5-pointed star SVG path `M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z`
   - `shieldShape`: Shield SVG path `M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5L12 1z`
3. Update `confettiDefaults`:
   - Change `origin` to `{ x: 0.5, y: 1.0 }` (bottom-center party popper)
   - Change `spread` to `70` (fans outward and up)
   - Set `angle: 90` (upward)
   - Set `startVelocity: 45`
   - Set `gravity: 1.2` (slightly heavier for realistic settle)
   - Add `shapes: [starShape, shieldShape, 'circle']` with `shapeWeights: [2, 1, 3]` (stars most common after circles)
4. Create two color palettes:
   - `lightModeColors`: `['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899']` (existing, slightly more saturated)
   - `darkModeColors`: `['#60A5FA', '#34D399', '#FBBF24', '#F87171', '#A78BFA', '#F472B6']` (brighter/more luminous for dark mode)
   - Gold accents for big achievements: `['#FFD700', '#FFC107', '#FFAB00']`
5. Accept a new `isDarkMode` prop (optional, defaults to `false`) and use it to select color palette
6. Update intensity levels with achievement-scaled particle counts:
   - `sparkle`: 30 particles (unchanged conceptually, but with new shapes + origin)
   - `burst`: 80 total (50 + 30 delayed) -- standard celebrations
   - `celebration`: base 200 particles over 3s, with party popper from bottom-center alternating left and right of center (x: 0.3-0.7)
7. Add `onComplete` callback to `sparkle` and `burst` after their animation ends (sparkle: 800ms, burst: 1200ms)
8. Add low-end device detection: `const isLowEnd = typeof navigator !== 'undefined' && (navigator.hardwareConcurrency ?? 4) <= 2`. When `isLowEnd` is true, multiply all particle counts by 0.25 (e.g., 200 -> 50)
9. Update the `useConfetti` hook to also support custom shapes and new defaults

Update index.ts exports if any new exports are added.

NOTE: The `shapeFromPath` and `shapeFromText` APIs require canvas-confetti v1.6.0+. The project has react-canvas-confetti ^2.0.7 which depends on canvas-confetti >=1.6.0, so these APIs are available.

IMPORTANT: Do NOT use hex colors in CSS (stylelint `color-no-hex` rule). The hex colors here are passed to the canvas-confetti JS API, not CSS, so they are fine.
  </action>
  <verify>
1. `npm run typecheck` passes with no errors
2. `npm run lint` passes
3. `npm run build` succeeds
4. Manually verify in the existing codebase that TestResultsScreen still renders Confetti correctly (no runtime errors)
5. Search for any `setInterval` in Confetti.tsx and confirm every one stores its ID in a ref with cleanup
  </verify>
  <done>
- setInterval leak is fixed: intervalRef stores ID, useEffect cleanup clears it on unmount
- Custom star and shield shapes render in confetti bursts
- All confetti originates from bottom-center with party popper physics (angle 90, spread 70)
- Dark mode uses brighter color palette
- Low-end devices get 25% particle count
- All three intensity levels work with new shapes and physics
  </done>
</task>

</tasks>

<verification>
- `npm run typecheck && npm run lint && npm run build` all pass
- No `setInterval` call in Confetti.tsx without corresponding ref storage and cleanup
- `shapeFromPath` is called for star and shield shapes
- confettiDefaults has `origin: { x: 0.5, y: 1.0 }` for bottom-center
</verification>

<success_criteria>
- Zero setInterval leak: every interval is stored in a ref and cleaned on unmount
- Confetti particles are themed with star, shield, and circle shapes
- Party popper physics: bottom-center origin, upward angle, spread fan
- Dark mode adaptation and low-end device reduction in place
</success_criteria>

<output>
After completion, create `.planning/phases/32-celebration-system-elevation/32-01-SUMMARY.md`
</output>
