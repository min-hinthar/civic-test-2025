---
phase: 33-states-accessibility
plan: 05
type: execute
wave: 3
depends_on:
  - 33-03
  - 33-04
files_modified:
  - src/hooks/useFocusOnNavigation.ts
  - src/components/NavigationShell.tsx
  - src/components/celebrations/Confetti.tsx
  - src/components/celebrations/BadgeCelebration.tsx
  - src/components/celebrations/MasteryMilestone.tsx
  - src/components/social/StreakReward.tsx
  - src/components/ui/Dialog.tsx
autonomous: true
requirements:
  - STAT-04
  - STAT-06
  - STAT-07

must_haves:
  truths:
    - "Navigating to any route moves focus to the page's first h1 or main content area"
    - "Keyboard and screen reader users know which page they are on after navigation"
    - "Confetti firing announces 'Congratulations!' to screen readers via aria-live region"
    - "Badge celebrations announce the badge name to screen readers"
    - "Mastery milestones announce the achievement to screen readers"
    - "All modals/dialogs use Radix Dialog which provides focus trap and focus return natively"
  artifacts:
    - path: "src/hooks/useFocusOnNavigation.ts"
      provides: "Hook that focuses h1 or main on route change with preventScroll"
    - path: "src/components/celebrations/Confetti.tsx"
      provides: "Screen reader announcement when confetti fires"
    - path: "src/components/celebrations/BadgeCelebration.tsx"
      provides: "Screen reader announcement for badge earn"
    - path: "src/components/celebrations/MasteryMilestone.tsx"
      provides: "Screen reader announcement for mastery milestone"
  key_links:
    - from: "src/hooks/useFocusOnNavigation.ts"
      to: "react-router-dom useLocation"
      via: "import useLocation"
      pattern: "useLocation.*pathname"
    - from: "src/components/NavigationShell.tsx"
      to: "src/hooks/useFocusOnNavigation.ts"
      via: "useFocusOnNavigation()"
      pattern: "useFocusOnNavigation"
    - from: "src/components/celebrations/Confetti.tsx"
      to: "src/lib/a11y/announcer.ts"
      via: "import announce"
      pattern: "announce\\("
---

<objective>
Add focus management on route changes, screen reader live region announcements for all celebrations, and verify all modals use Radix Dialog for focus trapping.

Purpose: STAT-04 ensures keyboard/screen reader users know which page they're on after navigation. STAT-06 ensures celebrations are announced to screen readers (especially important when visual animation is suppressed under reduced motion). STAT-07 ensures all modals trap focus and return it on dismiss.
Output: Focus management hook wired into navigation, announce() calls in all celebration components, verified modal focus trap coverage.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-states-accessibility/33-CONTEXT.md
@.planning/phases/33-states-accessibility/33-RESEARCH.md
@.planning/phases/33-states-accessibility/33-01-SUMMARY.md
@src/hooks/useFocusOnNavigation.ts
@src/lib/a11y/announcer.ts
@src/components/NavigationShell.tsx
@src/components/celebrations/Confetti.tsx
@src/components/celebrations/BadgeCelebration.tsx
@src/components/celebrations/MasteryMilestone.tsx
@src/components/social/StreakReward.tsx
@src/components/ui/Dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFocusOnNavigation hook and wire into navigation shell</name>
  <files>
    src/hooks/useFocusOnNavigation.ts
    src/components/NavigationShell.tsx
  </files>
  <action>
    **useFocusOnNavigation.ts (NEW):**
    - Create `src/hooks/useFocusOnNavigation.ts`:
    ```typescript
    import { useEffect } from 'react';
    import { useLocation } from 'react-router-dom';

    export function useFocusOnNavigation() {
      const location = useLocation();

      useEffect(() => {
        // Delay to let AnimatePresence page transition settle
        const timer = setTimeout(() => {
          const h1 = document.querySelector('h1');
          const main = document.querySelector('[role="main"]') ?? document.querySelector('main');
          const target = h1 ?? main;

          if (target instanceof HTMLElement) {
            // Ensure element is focusable without being in tab order
            if (!target.hasAttribute('tabindex')) {
              target.setAttribute('tabindex', '-1');
            }
            // preventScroll per project pitfalls
            target.focus({ preventScroll: true });
          }
        }, 150); // Match page transition animation duration

        return () => clearTimeout(timer);
      }, [location.pathname]);
    }
    ```
    - Key details:
      - 150ms delay matches existing page transition animation duration (research pitfall: focus fights with AnimatePresence)
      - `tabindex="-1"` makes non-focusable elements (h1, main) focusable without adding to tab order
      - `preventScroll: true` per project pitfall to avoid page scrolling to focused element
      - Triggers on `location.pathname` (hash routing uses pathname within the hash router)

    **NavigationShell.tsx integration:**
    - Read existing NavigationShell to understand its structure
    - Call `useFocusOnNavigation()` once at the top level of NavigationShell (it's the wrapper around all route content)
    - This single call handles focus for ALL route changes globally
    - Do NOT add it to individual page components (one global instance is sufficient)
    - Verify NavigationShell is inside the Router context (it must be, since it uses navigation)
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - Navigate between routes: focus moves to h1 (visible via keyboard focus ring outline)
    - Screen reader announces page heading on route change
    - No scroll jump on focus (preventScroll working)
  </verify>
  <done>
    useFocusOnNavigation hook listens to location.pathname changes, waits for page transition animation to settle (150ms), then focuses the first h1 or main element with preventScroll. Wired into NavigationShell for global coverage across all routes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add screen reader announcements to celebrations + audit modal focus traps</name>
  <files>
    src/components/celebrations/Confetti.tsx
    src/components/celebrations/BadgeCelebration.tsx
    src/components/celebrations/MasteryMilestone.tsx
    src/components/social/StreakReward.tsx
    src/components/ui/Dialog.tsx
  </files>
  <action>
    **Celebration announcements using announce() from Plan 01:**

    **Confetti.tsx:**
    - Read existing Confetti component. Research says it returns `null` under reduced motion - meaning NO visual or screen reader feedback.
    - Import `announce` from `@/lib/a11y/announcer`
    - When confetti fires (the trigger condition), call `announce('Congratulations!')` (or a more specific message if the component receives a message prop)
    - CRITICAL: The announce must fire BOTH when animation plays AND when reduced motion suppresses the visual. This ensures screen reader users always hear about celebrations.
    - If Confetti receives props indicating the celebration type (e.g., test pass, streak), include that in the announcement: "Congratulations! You passed the test!" or "Great streak! Keep going!"
    - If no context is available, use generic "Celebration!" announcement

    **BadgeCelebration.tsx:**
    - Read existing component. Research says it uses Dialog (has `aria-describedby`)
    - Import `announce` from `@/lib/a11y/announcer`
    - When the badge celebration triggers, call `announce('Badge earned: {badge name}!')` with the actual badge name
    - Since it already uses Dialog with aria-describedby, the dialog content is already accessible. The announce() is for the moment of earning (which might be a different trigger point than dialog open)
    - Use `'assertive'` priority since badge earns are important events

    **MasteryMilestone.tsx:**
    - Read existing component. Research says it uses Dialog.
    - Import `announce` from `@/lib/a11y/announcer`
    - When mastery milestone triggers, call `announce('Mastery milestone reached: {description}!')` with the milestone description
    - Per user decision for reduced motion: "Static overlay appears instantly with badge icon and congratulations text - no confetti, no animation on the overlay." The announce ensures screen readers get this info too.

    **StreakReward.tsx:**
    - Read existing component to see if it has any celebration/animation
    - If it triggers a visual celebration, add `announce('Streak reward: {streak count} day streak!')`
    - Check if it already has an aria-live region (Phase 24 added some). If yes, verify it works. If no, add announce() call.

    **Modal focus trap audit (STAT-07):**
    - Read `src/components/ui/Dialog.tsx` to confirm it wraps Radix UI Dialog
    - Radix Dialog provides focus trap + focus return natively. Verify this is the case.
    - Grep the codebase for these modal/overlay components and verify each uses the Radix-based Dialog:
      - `ExitConfirmDialog` - should use Dialog
      - `SocialOptInFlow` - check if uses Dialog
      - `ResumePromptModal` - check if uses Dialog
      - `WelcomeModal` - check if uses Dialog
      - `WhatsNewModal` - check if uses Dialog
      - `LeaderboardProfile` - check if uses Dialog
      - `NotificationPrePrompt` - check if uses Dialog
      - `StartFreshConfirm` - check if uses Dialog or inline
      - `MasteryMilestone` - should use Dialog
      - `BadgeCelebration` - should use Dialog
    - For any that DON'T use Radix Dialog:
      - If they're simple inline confirmations (like StartFreshConfirm which is an inline crossfade), they don't need focus trap (they're not overlays)
      - If they're actual overlay modals that don't use Radix Dialog, refactor them to use it
    - Document findings: which components use Dialog, which are inline (no trap needed), which needed migration
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - Confetti announces to screen readers (both with and without reduced motion)
    - Badge celebration announces badge name
    - Mastery milestone announces achievement
    - All overlay modals use Radix Dialog (focus trap verified)
    - Streak reward announces if applicable
  </verify>
  <done>
    All celebration components (Confetti, BadgeCelebration, MasteryMilestone, StreakReward) announce to screen readers via announce() utility. Announcements fire regardless of reduced-motion setting. All overlay modals verified to use Radix Dialog for focus trap and return. Any non-Dialog overlays identified and migrated or documented as inline (no trap needed).
  </done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- `npm run lint` passes
- Focus moves to h1/main on every route change (testable with keyboard Tab)
- Screen reader announces celebrations (Confetti, badges, milestones)
- All overlay modals trap focus and return it on dismiss
- No scroll jump during focus management
- Reduced motion users still get screen reader announcements
</verification>

<success_criteria>
1. useFocusOnNavigation wired globally in NavigationShell â€” focus moves on every route change
2. All 4 celebration components announce to screen readers via announce()
3. Announcements fire under both normal and reduced-motion modes
4. All overlay modals use Radix Dialog (focus trap verified via audit)
5. No regressions in existing navigation or celebration behavior
</success_criteria>

<output>
After completion, create `.planning/phases/33-states-accessibility/33-05-SUMMARY.md`
</output>

