---
phase: 38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sentry.server.config.ts
  - sentry.edge.config.ts
  - package.json
  - .env.example
  - .planning/security/security-checklist.md
autonomous: true
requirements: [CONTEXT-security-audit, CONTEXT-security-checklist]

must_haves:
  truths:
    - "Sentry DSN is read from environment variable, not hardcoded"
    - "Server/edge tracesSampleRate is 0.2 in production, 1.0 in development"
    - "bn.js vulnerability is resolved via pnpm override"
    - "Security checklist artifact documents all audited surfaces with pass/fail status"
    - "SRS_CRON_API_KEY is documented in .env.example"
  artifacts:
    - path: "sentry.server.config.ts"
      provides: "Production-appropriate Sentry config"
      contains: "process.env.NEXT_PUBLIC_SENTRY_DSN"
    - path: "sentry.edge.config.ts"
      provides: "Production-appropriate Sentry config"
      contains: "process.env.NEXT_PUBLIC_SENTRY_DSN"
    - path: "package.json"
      provides: "bn.js override for CVE fix"
      contains: "overrides"
    - path: ".planning/security/security-checklist.md"
      provides: "Comprehensive security audit artifact"
      min_lines: 80
  key_links:
    - from: "sentry.server.config.ts"
      to: "NEXT_PUBLIC_SENTRY_DSN env var"
      via: "process.env.NEXT_PUBLIC_SENTRY_DSN"
      pattern: "process\\.env\\.NEXT_PUBLIC_SENTRY_DSN"
---

<objective>
Harden Sentry configuration, fix known dependency vulnerability, and produce a comprehensive security checklist artifact documenting every audited surface.

Purpose: Address the concrete security gaps identified in the Phase 38 research — hardcoded DSN, wasteful sampling, unpatched bn.js CVE — and create the security checklist artifact required by the user.
Output: Fixed Sentry configs, patched package.json, documented .env.example, and security-checklist.md
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history/38-RESEARCH.md
@sentry.server.config.ts
@sentry.edge.config.ts
@src/lib/sentry.ts
@package.json
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Sentry configuration and dependency vulnerability</name>
  <files>sentry.server.config.ts, sentry.edge.config.ts, package.json, .env.example</files>
  <action>
    1. In `sentry.server.config.ts` and `sentry.edge.config.ts`:
       - Replace the hardcoded DSN string with `process.env.NEXT_PUBLIC_SENTRY_DSN`
       - Change `tracesSampleRate: 1` to `tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.2 : 1`
       - Keep all other settings unchanged

    2. In `package.json`, add a pnpm overrides section to fix the bn.js moderate vulnerability:
       ```json
       "pnpm": {
         "overrides": {
           "bn.js": ">=5.2.3"
         }
       }
       ```
       Place this at the top level of package.json (sibling to "dependencies").

    3. In `.env.example`, add:
       - `NEXT_PUBLIC_SENTRY_DSN=` with a comment explaining it's the Sentry DSN (public key, not secret)
       - `SRS_CRON_API_KEY=` with a comment explaining it's the API key for SRS cron job endpoints
       Only add these if they don't already exist.

    4. Run `pnpm install` to regenerate the lockfile with the bn.js override.

    Note: The DSN is a public key (not a secret), so `NEXT_PUBLIC_` prefix is correct. Using an env var allows per-environment DSNs and easier rotation. The Sentry SDK already in `src/lib/sentry.ts` uses `process.env.NEXT_PUBLIC_SENTRY_DSN` — we're aligning the server/edge configs to match.
  </action>
  <verify>
    - `grep -c "process.env.NEXT_PUBLIC_SENTRY_DSN" sentry.server.config.ts sentry.edge.config.ts` shows 1 match per file
    - `grep -c "tracesSampleRate" sentry.server.config.ts` confirms the line exists with conditional logic
    - `grep "bn.js" package.json` shows the override
    - `grep "SRS_CRON_API_KEY" .env.example` shows the new env var
    - `pnpm audit --prod` shows bn.js vulnerability resolved (or reduced count)
  </verify>
  <done>Sentry DSN sourced from env var in all config files, production tracesSampleRate is 0.2, bn.js override applied, .env.example documents all required env vars</done>
</task>

<task type="auto">
  <name>Task 2: Produce comprehensive security checklist artifact</name>
  <files>.planning/security/security-checklist.md</files>
  <action>
    Create `.planning/security/security-checklist.md` documenting every security surface audited, with pass/fail/fixed status. Use the security checklist structure from the RESEARCH.md as the template but expand to cover ALL surfaces from the CONTEXT.md locked decision list:

    **Sections to include:**

    1. **Dependencies** — pnpm audit results, bn.js fix status, ignoreCves justification
    2. **Authentication & Authorization** — API route auth (JWT/API key), rate limiting, service role key usage, Supabase RLS (reference existing rls-audit.md)
    3. **Content Security Policy** — middleware.ts CSP, hash-based inline script, external origins, frame-ancestors, upgrade-insecure-requests
    4. **XSS Prevention** — dangerouslySetInnerHTML audit (2 uses, both safe static constants), innerHTML audit (1 use, safe cleanup), Burmese Unicode content (all JSX auto-escaped), display_name DB constraint
    5. **Input Sanitization** — DB CHECK constraints, API input validation
    6. **Storage Security** — IndexedDB data types (no secrets stored), localStorage usage (language/theme only)
    7. **HTTP Headers** — X-Content-Type-Options, X-Frame-Options, Referrer-Policy, Permissions-Policy
    8. **API Routes** — enumerate all routes with auth requirements
    9. **Third-Party Data Flows** — Supabase, Google OAuth, Sentry, Vercel
    10. **Service Worker** — cache scope, push notification validation, no sensitive data in cache
    11. **Push Notification Security** — VAPID key handling, payload validation
    12. **Environment Variable Handling** — .env.example completeness, no secrets in client bundle
    13. **Console Output** — 63 calls across 29 files, categorize risk level
    14. **ErrorBoundary Info Leakage** — error sanitization before display
    15. **Error Reporting (Sentry)** — PII stripping, sendDefaultPii:false, fingerprinting
    16. **SRI (Subresource Integrity)** — assessment of external script loading

    For each item: `[PASS]`, `[FIXED]` (fixed in this phase), `[ACCEPTABLE RISK]` (with justification), or `[ACTION NEEDED]` (with remediation).

    Do a fresh audit of the codebase to verify each finding — do NOT just copy the research doc. Read actual source files to confirm.
  </action>
  <verify>
    - File exists at `.planning/security/security-checklist.md`
    - Contains all 16 sections listed above
    - Every item has a status tag (PASS/FIXED/ACCEPTABLE RISK/ACTION NEEDED)
    - File is at least 80 lines long
  </verify>
  <done>Comprehensive security checklist artifact exists documenting all audited surfaces with verified pass/fail status, traceable to actual codebase state</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds (Sentry config changes don't break build)
- `npm run typecheck` passes
- Sentry DSN is env-var sourced in all config files
- Security checklist covers all 16 surfaces from CONTEXT.md
</verification>

<success_criteria>
- Sentry DSN not hardcoded in any config file
- Production tracesSampleRate is 0.2 (not 1.0)
- bn.js vulnerability resolved via pnpm override
- .env.example documents all required environment variables
- Security checklist artifact produced with all audited surfaces
</success_criteria>

<output>
After completion, create `.planning/phases/38-security-analysis-fixes-and-codebase-refactoring-based-on-learnings-and-error-history/38-01-SUMMARY.md`
</output>
