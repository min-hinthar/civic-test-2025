---
phase: 17-ui-system-polish
plan: 09
type: execute
wave: 4
depends_on: ["17-01", "17-03", "17-04"]
files_modified:
  - src/contexts/ThemeContext.tsx
  - src/components/ThemeToggle.tsx
  - src/styles/globals.css
  - src/styles/tokens.css
autonomous: true

must_haves:
  truths:
    - "Dark mode toggle animates with circular reveal from toggle button position"
    - "Dark mode has frosted glass with subtle brand purple tint on all glass surfaces"
    - "Dark mode prismatic borders are neon-bright with glowing intensity"
    - "Dark mode mesh background uses deep purple + dark magenta (richer than light mode)"
    - "Surface elevation in dark mode shows both lighter color and increased blur"
    - "Browsers without View Transitions API fall back to instant theme switch"
  artifacts:
    - path: "src/contexts/ThemeContext.tsx"
      provides: "Theme toggle with View Transitions API circular reveal"
      contains: "startViewTransition"
    - path: "src/styles/tokens.css"
      provides: "Dark mode glass elevation hierarchy tokens"
      contains: "--glass-.*-blur"
  key_links:
    - from: "src/contexts/ThemeContext.tsx"
      to: "src/styles/globals.css"
      via: "View Transitions CSS"
      pattern: "view-transition"
    - from: "src/components/ThemeToggle.tsx"
      to: "src/contexts/ThemeContext.tsx"
      via: "toggleTheme with click event"
      pattern: "toggleTheme.*event"
---

<objective>
Implement the circular reveal theme toggle and refine dark mode: frosted glass purple tint, neon-bright prismatic borders, surface elevation hierarchy, and mesh gradient polish.

Purpose: Satisfies UISYS-05 (dark mode uses frosted glass variants). The circular reveal is the signature premium interaction for theme switching.
Output: Theme toggle animates with circular reveal, dark mode has distinct premium frosted glass feel.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-ui-system-polish/17-01-SUMMARY.md
@.planning/phases/17-ui-system-polish/17-03-SUMMARY.md
@.planning/phases/17-ui-system-polish/17-RESEARCH.md
@src/contexts/ThemeContext.tsx
@src/components/ThemeToggle.tsx
@src/styles/globals.css
@src/styles/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Circular reveal theme toggle via View Transitions API</name>
  <files>src/contexts/ThemeContext.tsx, src/components/ThemeToggle.tsx</files>
  <action>
  **ThemeContext.tsx:**

  Upgrade `toggleTheme` to accept a mouse event and use View Transitions API:

  1. Change `toggleTheme` signature from `() => void` to `(event?: React.MouseEvent) => void` in the interface
  2. Import `flushSync` from 'react-dom'
  3. Replace the simple `setTheme(prev => ...)` with View Transitions logic:

  ```typescript
  const toggleTheme = useCallback(
    (event?: React.MouseEvent) => {
      const newTheme = theme === 'light' ? 'dark' : 'light';

      // Fallback: instant switch for browsers without View Transitions API
      // or when prefers-reduced-motion is active
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (
        !('startViewTransition' in document) ||
        prefersReduced
      ) {
        setTheme(newTheme);
        return;
      }

      // Get toggle button position for circular reveal origin
      const x = event?.clientX ?? window.innerWidth / 2;
      const y = event?.clientY ?? 0;
      const maxRadius = Math.hypot(
        Math.max(x, window.innerWidth - x),
        Math.max(y, window.innerHeight - y)
      );

      try {
        const transition = (document as any).startViewTransition(() => {
          flushSync(() => setTheme(newTheme));
        });

        transition.ready.then(() => {
          // Asymmetric: dark expands as circle, light dissolves
          const clipPathStart =
            newTheme === 'dark'
              ? `circle(0px at ${x}px ${y}px)`
              : `circle(${maxRadius}px at ${x}px ${y}px)`;
          const clipPathEnd =
            newTheme === 'dark'
              ? `circle(${maxRadius}px at ${x}px ${y}px)`
              : `circle(0px at ${x}px ${y}px)`;

          document.documentElement.animate(
            { clipPath: [clipPathStart, clipPathEnd] },
            {
              duration: 500,
              easing: 'ease-in-out',
              pseudoElement: '::view-transition-new(root)',
            }
          );
        });
      } catch {
        // Fallback on error: just set theme directly
        setTheme(newTheme);
      }
    },
    [theme, setTheme]
  );
  ```

  4. Remove the existing `theme-transitioning` class logic from the second useEffect (the View Transitions API handles the transition now). BUT keep it as a fallback path -- if View Transitions isn't used, the CSS transition still applies. Guard it:
     ```
     if (!('startViewTransition' in document)) {
       root.classList.add('theme-transitioning');
       // ... existing cleanup timer
     }
     ```

  5. The `setTheme` function reference in `value` memo: keep as-is. The `toggleTheme` reference needs the event parameter.

  **IMPORTANT**: Use `(document as any).startViewTransition` since TypeScript may not have the type definition. Or add a type declaration:
  ```typescript
  declare global {
    interface Document {
      startViewTransition?: (callback: () => void) => {
        ready: Promise<void>;
        finished: Promise<void>;
      };
    }
  }
  ```

  **ThemeToggle.tsx:**

  1. Update the `onClick` handler to pass the mouse event: `onClick={(e) => toggleTheme(e)}`
  2. The standalone ThemeToggle component (used on landing page etc.) needs to forward the click event
  3. Also update the Sidebar.tsx and BottomTabBar.tsx theme toggle buttons to pass the click event to `toggleTheme`: `onClick={(e) => toggleTheme(e)}` -- note these may need the ThemeContext interface update to accept the event

  **BottomTabBar.tsx and Sidebar.tsx** already call `toggleTheme` directly. Since the new signature is `(event?: React.MouseEvent) => void`, the existing `onClick={toggleTheme}` will pass the React synthetic event automatically because `onClick` provides the event. But verify that the event types are compatible -- React's `onClick` passes `React.MouseEvent<HTMLButtonElement>` which extends `React.MouseEvent`. It should work.
  </action>
  <verify>
  1. `npx tsc --noEmit` -- verify no type errors with the new toggleTheme signature
  2. `npx next build` -- zero build errors
  3. In dev mode: click the theme toggle -- dark mode should expand as a circle from the click point, light mode should dissolve away. On browsers without View Transitions, it should fallback to instant switch.
  </verify>
  <done>Theme toggle animates with circular reveal (dark expands, light dissolves). View Transitions API used with graceful fallback. Reduced motion skips animation.</done>
</task>

<task type="auto">
  <name>Task 2: Dark mode frosted glass refinement and elevation hierarchy</name>
  <files>src/styles/tokens.css, src/styles/globals.css</files>
  <action>
  **tokens.css dark mode refinement:**

  Per user decisions for dark mode:

  1. "Frosted glass tint: Subtle brand purple tint in dark glass surfaces" -- already handled in Plan 01's glass tier dark variants with `background-image: linear-gradient(135deg, hsl(var(--color-accent-purple) / 0.03), transparent)`. Increase this to 0.05 for more visible purple tint.

  2. "Surface elevation: Both color hierarchy (lighter at higher elevation) AND increased glass blur -- double depth cue"

  Add elevation-specific dark mode tokens in `.dark`:
  ```css
  /* Elevation hierarchy for dark mode */
  --color-surface-elevated-1: 222 47% 16%;  /* Cards */
  --color-surface-elevated-2: 222 47% 19%;  /* Modals, popovers */
  --color-surface-elevated-3: 222 47% 22%;  /* Dropdowns on modals */

  /* Elevation blur multipliers (higher elevation = more blur) */
  --glass-light-blur: 18px;   /* Slightly more than light mode's 16px */
  --glass-medium-blur: 28px;  /* More than light mode's 24px */
  --glass-heavy-blur: 36px;   /* More than light mode's 32px */
  ```

  3. Update dark mode surface token to use the new elevation tokens:
  ```css
  --color-surface: var(--color-surface-elevated-1);
  --color-surface-raised: var(--color-surface-elevated-2);
  ```

  **globals.css dark mode glass refinement:**

  1. Increase purple tint on dark glass surfaces from 0.03 to 0.05:
     `.dark .glass-light`, `.dark .glass-medium`, `.dark .glass-heavy` → `background-image: linear-gradient(135deg, hsl(var(--color-accent-purple) / 0.05), transparent)`

  2. "Border glow: Adaptive intensity -- subtle by default, brighter on hover/focus" -- already handled in prismatic-border.css hover rules. Verify the dark mode hover brightens sufficiently:
     `.dark .prismatic-border:hover::before` should use `filter: blur(0.5px) brightness(1.5)` (increase from 1.4 to 1.5 for more visible neon glow)

  3. "Gradient overlays (NBA hero, interview cards): Deeper and more saturated in dark mode" -- this is per-component and handled in Plan 06. Verify the globals.css gradient utilities support deeper values.

  4. **Dark mode contrast audit:**
     - Check text-primary (`210 40% 98%`) against surface (`222 47% 14%`) → ~15:1 contrast ratio (excellent)
     - Check text-secondary (`215 20% 65%`) against surface (`222 47% 14%`) → ~5.5:1 (passes AA)
     - Check text-primary against glass surfaces with purple tint → still excellent since tint is subtle (0.05 opacity)
     - If any combination fails WCAG AA (4.5:1), adjust the lighter color

  5. **Mesh gradient dark mode** (should already be done in Plan 01, verify):
     - Deep purple + dark magenta blobs
     - Higher opacity than light mode (0.7 vs 0.6) for richer atmosphere
  </action>
  <verify>
  1. `npx next build` -- zero errors
  2. Verify tokens.css `.dark` has elevation hierarchy tokens
  3. Check globals.css dark glass variants have 0.05 purple tint
  4. Visual: dark mode glass surfaces should have a subtle purple tint visible against the dark mesh background
  </verify>
  <done>Dark mode has purple-tinted frosted glass, elevation hierarchy (lighter + more blur at higher levels), neon-bright prismatic borders on hover, and WCAG-compliant text contrast.</done>
</task>

</tasks>

<verification>
1. `npx next build` succeeds with zero errors
2. ThemeContext.tsx contains `startViewTransition`
3. tokens.css `.dark` has `--color-surface-elevated-*` tokens
4. globals.css dark glass variants have `accent-purple / 0.05` tint
5. Theme toggle circular reveal works in Chrome (View Transitions supported)
6. Theme toggle instant-switches in Firefox if View Transitions not yet supported
7. Reduced motion preference skips circular reveal
</verification>

<success_criteria>
Circular reveal theme toggle works with graceful fallback. Dark mode has distinct frosted glass personality: purple tint, elevation hierarchy, neon-bright prismatic borders, and rich mesh gradient.
</success_criteria>

<output>
After completion, create `.planning/phases/17-ui-system-polish/17-09-SUMMARY.md`
</output>
