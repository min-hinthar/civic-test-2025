---
phase: 02-pwa-offline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.mjs
  - src/lib/pwa/sw.ts
  - src/app/manifest.ts
  - public/offline.html
  - public/icons/icon-192.png
  - public/icons/icon-512.png
  - public/icons/icon-maskable-192.png
  - public/icons/icon-maskable-512.png
  - tsconfig.sw.json
  - package.json
autonomous: true

must_haves:
  truths:
    - "App can be installed from browser install prompt (Chrome)"
    - "Service worker is registered and active"
    - "Offline fallback page displays when navigating offline to uncached route"
  artifacts:
    - path: "src/app/manifest.ts"
      provides: "Web app manifest with icons and theme"
      exports: ["default"]
    - path: "src/lib/pwa/sw.ts"
      provides: "Service worker with precaching and navigation fallback"
      contains: "Serwist"
    - path: "public/offline.html"
      provides: "Offline fallback page"
      contains: "offline"
    - path: "public/icons/icon-192.png"
      provides: "Standard app icon 192x192"
    - path: "public/icons/icon-512.png"
      provides: "Standard app icon 512x512"
  key_links:
    - from: "next.config.mjs"
      to: "src/lib/pwa/sw.ts"
      via: "withSerwist swSrc config"
      pattern: "swSrc.*sw\\.ts"
    - from: "src/lib/pwa/sw.ts"
      to: "public/offline.html"
      via: "fallback entry"
      pattern: "offline\\.html"
---

<objective>
Create the PWA foundation: web app manifest, service worker with Serwist, and app icons.

Purpose: This is the foundation for all offline functionality. Without manifest and service worker, the app cannot be installed or work offline.
Output: Installable PWA with precaching and offline fallback page.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-pwa-offline/02-RESEARCH.md

@next.config.mjs
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Serwist dependencies and configure Next.js</name>
  <files>
    package.json
    next.config.mjs
    tsconfig.sw.json
  </files>
  <action>
1. Install PWA dependencies:
   ```bash
   pnpm add @serwist/next idb-keyval
   pnpm add -D serwist
   ```

2. Create tsconfig.sw.json for service worker TypeScript compilation:
   ```json
   {
     "extends": "./tsconfig.json",
     "compilerOptions": {
       "lib": ["ES2020", "WebWorker"],
       "types": ["@serwist/next/typings"]
     },
     "include": ["src/lib/pwa/sw.ts"],
     "exclude": ["node_modules"]
   }
   ```

3. Modify next.config.mjs to chain Serwist with existing Sentry config:
   - Import `withSerwistInit` from `@serwist/next`
   - Create withSerwist wrapper with:
     - swSrc: "src/lib/pwa/sw.ts"
     - swDest: "public/sw.js"
     - disable: process.env.NODE_ENV === "development"
     - additionalPrecacheEntries: [{ url: "/offline.html", revision: "1" }]
   - Chain order: withSentryConfig(withSerwist(nextConfig), sentryConfig)
   - Serwist should be inner (runs first) since it modifies webpack config
  </action>
  <verify>
    pnpm install succeeds
    pnpm run build does not error on next.config.mjs parse
    tsconfig.sw.json is valid JSON
  </verify>
  <done>
    Dependencies installed, next.config.mjs chains Serwist and Sentry, tsconfig.sw.json exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Create web app manifest and app icons</name>
  <files>
    src/app/manifest.ts
    public/icons/icon-192.png
    public/icons/icon-512.png
    public/icons/icon-maskable-192.png
    public/icons/icon-maskable-512.png
  </files>
  <action>
1. Create src/app/ directory if it doesn't exist (Next.js metadata API location).

2. Create src/app/manifest.ts using Next.js Metadata API:
   ```typescript
   import type { MetadataRoute } from "next";

   export default function manifest(): MetadataRoute.Manifest {
     return {
       name: "US Civics အမေရိကန်နိုင်ငံရေး",
       short_name: "US Civics",
       description: "Bilingual English-Burmese civics test preparation",
       start_url: "/",
       display: "standalone",
       background_color: "#ffffff",
       theme_color: "#002868",
       icons: [
         {
           src: "/icons/icon-192.png",
           sizes: "192x192",
           type: "image/png",
           purpose: "any",
         },
         {
           src: "/icons/icon-512.png",
           sizes: "512x512",
           type: "image/png",
           purpose: "any",
         },
         {
           src: "/icons/icon-maskable-192.png",
           sizes: "192x192",
           type: "image/png",
           purpose: "maskable",
         },
         {
           src: "/icons/icon-maskable-512.png",
           sizes: "512x512",
           type: "image/png",
           purpose: "maskable",
         },
       ],
     };
   }
   ```

3. Create public/icons/ directory.

4. Generate placeholder PNG icons using canvas or a simple colored square approach.
   - For development, create solid color placeholder icons (US blue #002868)
   - Standard icons (icon-192.png, icon-512.png): Full bleed design area
   - Maskable icons (icon-maskable-192.png, icon-maskable-512.png): Content in center 80% safe zone
   - Use a simple approach: create minimal placeholder PNGs that are valid images

Note: Per user decision, icons should be language-neutral design. For now, create solid color placeholders. Production icons can be designed later.
  </action>
  <verify>
    pnpm run build succeeds
    Manifest appears at /manifest.webmanifest in browser
    Icons load without 404
  </verify>
  <done>
    Manifest exports valid metadata, icons exist in public/icons/, browser can fetch manifest
  </done>
</task>

<task type="auto">
  <name>Task 3: Create service worker and offline fallback page</name>
  <files>
    src/lib/pwa/sw.ts
    public/offline.html
  </files>
  <action>
1. Create src/lib/pwa/ directory.

2. Create src/lib/pwa/sw.ts service worker source:
   ```typescript
   import { defaultCache } from "@serwist/next/worker";
   import type { PrecacheEntry, SerwistGlobalConfig } from "serwist";
   import { Serwist } from "serwist";

   declare global {
     interface WorkerGlobalScope extends SerwistGlobalConfig {
       __SW_MANIFEST: (PrecacheEntry | string)[] | undefined;
     }
   }

   declare const self: ServiceWorkerGlobalScope;

   const serwist = new Serwist({
     precacheEntries: self.__SW_MANIFEST,
     skipWaiting: true,
     clientsClaim: true,
     navigationPreload: true,
     runtimeCaching: defaultCache,
     fallbacks: {
       entries: [
         {
           url: "/offline.html",
           matcher({ request }) {
             return request.destination === "document";
           },
         },
       ],
     },
   });

   serwist.addEventListeners();
   ```

3. Create public/offline.html bilingual fallback page:
   - Simple, friendly message in English and Burmese
   - Explain they're offline and content isn't cached
   - Suggest: "Try again when you're back online"
   - Burmese: "အင်တာနက် ချိတ်ဆက်မှုမရှိပါ" (No internet connection)
   - Style with inline CSS matching app theme (#002868)
   - Include a "Try Again" button that calls location.reload()
  </action>
  <verify>
    pnpm run build completes successfully
    public/sw.js is generated after build
    Offline page HTML is valid and displays bilingual text
  </verify>
  <done>
    Service worker source compiles, offline.html exists with bilingual content, build generates sw.js
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm run build` - should complete without errors
2. Run `pnpm start` and open in Chrome
3. Open DevTools > Application > Manifest - should show app name, icons, theme color
4. Open DevTools > Application > Service Workers - should show registered SW
5. Check Network tab for /manifest.webmanifest and icon requests - should return 200
6. Enable "Offline" in Network tab, navigate to uncached route - should see offline.html
</verification>

<success_criteria>
- Dependencies installed: @serwist/next, serwist, idb-keyval
- next.config.mjs chains Serwist and Sentry correctly
- Manifest accessible at /manifest.webmanifest with correct metadata
- All 4 icons load without 404
- Service worker registers successfully
- Offline fallback page displays when offline
- Chrome shows installable PWA criteria met (check Lighthouse)
</success_criteria>

<output>
After completion, create `.planning/phases/02-pwa-offline/02-01-SUMMARY.md`
</output>
