---
phase: 16-dashboard-next-best-action
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/nba/nbaTypes.ts
  - src/lib/nba/nbaStrings.ts
  - src/lib/nba/determineNBA.ts
  - src/lib/nba/determineNBA.test.ts
  - src/lib/nba/index.ts
autonomous: true

must_haves:
  truths:
    - "Pure function determineNextBestAction returns correct NBA state for all 8 user scenarios"
    - "Each NBA state carries contextual bilingual copy (title, hint, CTA, skip link)"
    - "Priority chain respects learning-science ordering: new > returning > streak > SRS > weak > no-test > test-ready > celebration"
    - "Celebration state requires streak > 0, srsDueCount === 0, overallMastery >= 60, and recent test"
    - "Interview recommendation triggers at readiness >= 80% AND at least 1 passed mock test"
  artifacts:
    - path: "src/lib/nba/nbaTypes.ts"
      provides: "NBAState discriminated union and NBAInput type"
      contains: "NBAStateType"
    - path: "src/lib/nba/nbaStrings.ts"
      provides: "Bilingual copy for all 8 NBA states"
      contains: "nbaStrings"
    - path: "src/lib/nba/determineNBA.ts"
      provides: "Pure determination function"
      exports: ["determineNextBestAction"]
    - path: "src/lib/nba/determineNBA.test.ts"
      provides: "Unit tests for all 8 states + edge cases"
      contains: "describe"
    - path: "src/lib/nba/index.ts"
      provides: "Barrel export"
      exports: ["determineNextBestAction", "NBAState", "NBAInput"]
  key_links:
    - from: "src/lib/nba/determineNBA.ts"
      to: "src/lib/nba/nbaTypes.ts"
      via: "imports NBAInput and NBAState types"
      pattern: "import.*NBAInput.*nbaTypes"
    - from: "src/lib/nba/determineNBA.ts"
      to: "src/lib/nba/nbaStrings.ts"
      via: "imports bilingual strings per state"
      pattern: "import.*nbaStrings"
---

<objective>
Create the NBA type system, bilingual string catalog, and pure priority-logic determination function with comprehensive TDD test coverage.

Purpose: This is the core brain of the NBA system -- a pure function with zero side effects that takes user state as input and returns a typed recommendation. Being pure makes it trivially testable and reusable. All 8 NBA states with contextual gradients, icons, CTAs, and bilingual copy are defined here.

Output: `src/lib/nba/` module with types, strings, determination function, unit tests, and barrel exports.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-dashboard-next-best-action/16-RESEARCH.md
@src/lib/mastery/weakAreaDetection.ts (WeakArea type, detectWeakAreas function pattern)
@src/types/index.ts (TestSession, InterviewSession types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NBA type system and bilingual string catalog</name>
  <files>src/lib/nba/nbaTypes.ts, src/lib/nba/nbaStrings.ts, src/lib/nba/index.ts</files>
  <action>
Create `src/lib/nba/nbaTypes.ts`:

1. Define `NBAStateType` string literal union with 8 values: `'new-user' | 'returning-user' | 'streak-at-risk' | 'srs-due' | 'weak-category' | 'no-recent-test' | 'test-ready' | 'celebration'`

2. Define `BilingualText` as `{ en: string; my: string }` (or reuse if already exists in codebase)

3. Define `NBABase` interface with fields:
   - `type: NBAStateType`
   - `title: BilingualText` (primary recommendation text)
   - `hint: BilingualText` (reasoning one-liner)
   - `cta: { label: BilingualText; to: string }` (primary CTA)
   - `skip: { label: BilingualText; to: string }` (secondary contextual alternative)
   - `gradient: string` (Tailwind gradient classes)
   - `icon: string` (lucide icon name)
   - `urgent: boolean` (whether icon should pulse)
   - `estimatedMinutes?: number` (optional time estimate)

4. Define individual state interfaces extending NBABase with extra typed data:
   - `NewUserNBA`: type 'new-user'
   - `ReturningUserNBA`: type 'returning-user', daysSinceActivity: number
   - `StreakAtRiskNBA`: type 'streak-at-risk', currentStreak: number
   - `SRSDueNBA`: type 'srs-due', dueCount: number
   - `WeakCategoryNBA`: type 'weak-category', categoryName: BilingualText, mastery: number
   - `NoRecentTestNBA`: type 'no-recent-test', daysSinceTest: number
   - `TestReadyNBA`: type 'test-ready', readinessScore: number, suggestInterview: boolean
   - `CelebrationNBA`: type 'celebration', streak: number, mastery: number, suggestInterview: boolean

5. Export `NBAState` as the discriminated union of all 8

6. Define `NBAInput` interface:
   - `currentStreak: number`
   - `activityDates: string[]` (from useStreak)
   - `srsDueCount: number` (from useSRSWidget)
   - `overallMastery: number` (from useCategoryMastery)
   - `categoryMasteries: Record<string, number>` (per-category mastery)
   - `testHistory: { date: string; score: number; totalQuestions: number }[]` (simplified from TestSession)
   - `interviewHistory: { date: string; passed: boolean }[]` (simplified from InterviewSession)
   - `uniqueQuestionsPracticed: number`
   - `totalQuestions: number`

Create `src/lib/nba/nbaStrings.ts`:

Define a `getNBAContent(type, input)` function or `NBA_CONTENT` map that returns bilingual copy for each state. Per-state content:

1. **new-user**: Title "Start your citizenship journey" / Myanmar equivalent. Hint "Study flashcards to build knowledge" / Myanmar. CTA "Begin studying" -> /study. Skip "Take a practice test" -> /test. Gradient: from-primary/20 via-primary/5 to-transparent. Icon: sparkles. Urgent: false.

2. **returning-user**: Title "Welcome back!" / Myanmar. Hint "Pick up where you left off -- let's review" / Myanmar. CTA "Quick review" -> /study#review or /study. Skip "Check your progress" -> /hub/overview. Gradient: from-amber-500/20 via-amber-500/5 to-transparent. Icon: heart. Urgent: false.

3. **streak-at-risk**: Title "Keep your X-day streak alive!" / Myanmar. Hint "Study today to keep your streak going" / Myanmar. CTA "Study now" -> /study. Skip "Review flashcards" -> /study#review. Gradient: from-orange-500/25 via-orange-500/5 to-transparent. Icon: flame. Urgent: true.

4. **srs-due**: Title "X cards ready for review" / Myanmar. Hint "Spaced repetition keeps knowledge fresh" / Myanmar. CTA "Review N cards" -> /study#review. Skip "Practice weak areas" -> /study. Gradient: from-blue-500/20 via-blue-500/5 to-transparent. Icon: brain. Urgent: true. EstimatedMinutes: Math.ceil(dueCount * 0.5).

5. **weak-category**: Title "Practice [CategoryName] -- you're at X%" / Myanmar. Hint "Focus on your weakest area to boost overall readiness" / Myanmar. CTA "Practice [category]" -> /study?category=X#cards. Skip "Take a mock test" -> /test. Gradient: from-amber-400/20 via-amber-400/5 to-transparent. Icon: book-open. Urgent: false. EstimatedMinutes: 8.

6. **no-recent-test**: Title "Time for a practice test" / Myanmar. Hint "Testing reinforces what you've learned" / Myanmar. CTA "Start mock test" -> /test. Skip "Study flashcards" -> /study. Gradient: from-emerald-500/15 via-emerald-500/5 to-transparent. Icon: target. Urgent: false. EstimatedMinutes: 12.

7. **test-ready**: Title "You're ready for the civics test!" / Myanmar. Hint "Your readiness score is X% -- you've got this!" / Myanmar. CTA depends on suggestInterview: "Try interview practice" -> /interview if true, else "Take a mock test" -> /test. Skip "Review your progress" -> /hub/overview. Gradient: from-emerald-600/20 via-emerald-600/5 to-transparent. Icon: target. Urgent: false. EstimatedMinutes: suggestInterview ? 8 : 12.

8. **celebration**: Title "Amazing work! You're doing great!" / Myanmar. Hint about streak and mastery. CTA depends on suggestInterview: "Practice interview" -> /interview if true, else "Keep reviewing" -> /study. Skip "View achievements" -> /hub/achievements. Gradient: from-amber-400/20 via-primary/10 to-success/10. Icon: trophy. Urgent: false.

For dynamic strings (streak count, category name, due count, mastery %), the function should accept the NBAInput data to interpolate values. Use template functions, not static strings.

Create `src/lib/nba/index.ts`:
Barrel export of all types and the determination function (will be added in Task 2).

**IMPORTANT:** Use Myanmar translations consistent with existing codebase patterns (see strings.ts). For Myanmar text, provide reasonable translations following the bilingual pattern throughout the app.
  </action>
  <verify>TypeScript compiles with `npx tsc --noEmit`</verify>
  <done>NBAState discriminated union with 8 variants exists, NBAInput type covers all data sources, bilingual strings defined for all 8 states with dynamic interpolation, barrel exports work</done>
</task>

<task type="auto">
  <name>Task 2: TDD the determineNextBestAction pure function</name>
  <files>src/lib/nba/determineNBA.ts, src/lib/nba/determineNBA.test.ts, src/lib/nba/index.ts</files>
  <action>
**RED phase:** Create `src/lib/nba/determineNBA.test.ts` with failing tests FIRST.

Test cases covering all 8 priority states:

1. **New user** (all zeros/empty): `activityDates: []`, streak 0, SRS 0, mastery 0, no history -> returns type 'new-user'
2. **Returning user** (7+ day gap): `activityDates` with last date 10 days ago, has some mastery -> returns type 'returning-user' with daysSinceActivity >= 7
3. **Streak at risk**: currentStreak > 0, today NOT in activityDates (user studied yesterday but not today) -> returns type 'streak-at-risk'
4. **SRS due**: srsDueCount > 0, no streak risk -> returns type 'srs-due' with dueCount
5. **Weak category**: some category < 50% mastery, no SRS due, no streak risk -> returns type 'weak-category' with weakest category name
6. **No recent test**: all tests older than 7 days, mastery moderate -> returns type 'no-recent-test'
7. **Test ready**: overallMastery >= 70%, recent tests exist, suggest interview if mastery >= 80% AND passed test -> returns type 'test-ready'
8. **Celebration**: streak > 0, srsDueCount === 0, overallMastery >= 60, recent test within 7 days -> returns type 'celebration'

Edge case tests:
- Priority ordering: when multiple conditions true (e.g., streak at risk AND SRS due), streak wins
- Brand new vs returning: empty activityDates = new user, not returning
- Interview suggestion: only when readiness >= 80% AND at least 1 passed mock test (score >= 12/20 = 60%)
- Celebration with interview: suggestInterview true when readiness >= 80% AND passed test
- Weak category picks the WEAKEST (lowest mastery) category
- Category names include bilingual text (map from USCIS_CATEGORIES or SUB_CATEGORY_NAMES)

Run tests: `npx vitest run src/lib/nba/determineNBA.test.ts` -- all must FAIL (no implementation yet).

**GREEN phase:** Implement `src/lib/nba/determineNBA.ts`:

```
export function determineNextBestAction(input: NBAInput): NBAState
```

Priority chain implementation:
1. Check if new user: `input.activityDates.length === 0 && input.testHistory.length === 0 && input.uniqueQuestionsPracticed === 0`
2. Check returning user: compute daysSinceLastActivity from `Math.max(...activityDates)`. If >= 7, return returning-user.
3. Check streak at risk: `input.currentStreak > 0` AND today's date string NOT in activityDates. Use `new Date().toISOString().slice(0, 10)` for today.
4. Check SRS due: `input.srsDueCount > 0`
5. Check weak category: find category with mastery < 50%, pick weakest. Map category name to bilingual using USCIS_CATEGORIES from mastery lib. If no category below 50%, skip.
6. Check no recent test: `input.testHistory.length === 0 || daysSinceLastTest >= 7`
7. Check test ready: compute readiness score using same formula as ReadinessIndicator (accuracy * 0.4 + coverage * 0.5 + streak bonus up to 10). If >= 70, return test-ready. Set suggestInterview = readiness >= 80 AND has at least 1 passed test (score/total >= 0.6).
8. Default to celebration: remaining case means things are going well.

For each state, call the bilingual string builder from nbaStrings.ts to get title, hint, CTA, skip, gradient, icon, urgent, and estimatedMinutes.

Run tests: `npx vitest run src/lib/nba/determineNBA.test.ts` -- all must PASS.

**REFACTOR:** Clean up, ensure no unused imports. Update `src/lib/nba/index.ts` barrel to export `determineNextBestAction`.

**Important implementation notes:**
- Import USCIS_CATEGORIES from '@/lib/mastery' for category bilingual names
- Do NOT import any React hooks -- this is a pure function
- Date comparisons should use UTC date strings (YYYY-MM-DD) for consistency
- The "today" date should be injectable for testing (add optional `now?: Date` parameter to determineNextBestAction)
  </action>
  <verify>`npx vitest run src/lib/nba/determineNBA.test.ts` -- all tests pass</verify>
  <done>determineNextBestAction returns correct state for all 8 scenarios, edge cases covered, priority ordering verified, barrel exports updated</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no type errors
- `npx vitest run src/lib/nba/` -- all tests pass
- `src/lib/nba/index.ts` exports: determineNextBestAction, NBAState, NBAInput, NBAStateType
</verification>

<success_criteria>
- Pure function with zero React dependencies
- All 8 NBA states produce correct typed output with bilingual content
- Priority chain follows learning-science ordering
- Interview recommendation logic gated on readiness + passed test
- Edge cases (empty data, multiple conditions) handled correctly
- Barrel exports enable clean import from `@/lib/nba`
</success_criteria>

<output>
After completion, create `.planning/phases/16-dashboard-next-best-action/16-01-SUMMARY.md`
</output>
