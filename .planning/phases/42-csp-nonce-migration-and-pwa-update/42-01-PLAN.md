---
phase: 42-csp-nonce-migration-and-pwa-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - proxy.ts
  - app/layout.tsx
  - src/lib/themeScript.ts
  - src/components/GoogleOneTapSignIn.tsx
  - app/(public)/auth/page.tsx
  - next.config.mjs
autonomous: true
requirements: [MIGR-09]

must_haves:
  truths:
    - "CSP header contains a per-request nonce and strict-dynamic directive"
    - "Inline theme script executes without CSP violations"
    - "Google One Tap script loads and initializes without CSP blocks"
    - "Security headers (X-Frame-Options, Referrer-Policy, etc.) are served on every page response"
    - "HASH_REDIRECT_SCRIPT is removed (dead code after App Router migration)"
    - "No CSP violations appear in browser console for any page"
  artifacts:
    - path: "proxy.ts"
      provides: "Nonce generation, CSP header with strict-dynamic, consolidated security headers"
      contains: "strict-dynamic"
    - path: "app/layout.tsx"
      provides: "Async layout reading nonce from request headers, applying to inline scripts"
      contains: "await headers"
    - path: "src/lib/themeScript.ts"
      provides: "THEME_SCRIPT only (HASH_REDIRECT_SCRIPT removed)"
    - path: "src/components/GoogleOneTapSignIn.tsx"
      provides: "Accepts optional nonce prop, passes to Script component"
      contains: "nonce"
    - path: "app/(public)/auth/page.tsx"
      provides: "Server wrapper reading nonce and passing to GoogleOneTapSignIn"
      contains: "headers"
  key_links:
    - from: "proxy.ts"
      to: "app/layout.tsx"
      via: "x-nonce request header"
      pattern: "x-nonce"
    - from: "app/layout.tsx"
      to: "script nonce attribute"
      via: "nonce={nonce} on dangerouslySetInnerHTML script"
      pattern: "nonce=\\{nonce\\}"
    - from: "app/(public)/auth/page.tsx"
      to: "src/components/GoogleOneTapSignIn.tsx"
      via: "nonce prop from server wrapper to client component"
      pattern: "nonce="
    - from: "proxy.ts"
      to: "browser CSP enforcement"
      via: "Content-Security-Policy response header"
      pattern: "Content-Security-Policy"
---

<objective>
Migrate CSP from hash-based to nonce-based allowlisting with strict-dynamic, consolidate all security headers into proxy.ts, and wire nonce delivery from proxy through layout to inline scripts and GoogleOneTap.

Purpose: Nonce-based CSP is more maintainable than hash-based (no recomputing hashes when scripts change) and strict-dynamic eliminates the need for domain allowlists in script-src.
Output: Working nonce-based CSP with no browser console violations, all security headers consolidated in proxy.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-csp-nonce-migration-and-pwa-update/42-CONTEXT.md
@.planning/phases/42-csp-nonce-migration-and-pwa-update/42-RESEARCH.md
@.planning/phases/42-csp-nonce-migration-and-pwa-update/42-INTEGRATION-MAP.md

@proxy.ts
@app/layout.tsx
@src/lib/themeScript.ts
@src/components/GoogleOneTapSignIn.tsx
@app/(public)/auth/page.tsx
@next.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite proxy.ts with nonce CSP and consolidate security headers</name>
  <files>
    proxy.ts
    next.config.mjs
    src/lib/themeScript.ts
  </files>
  <action>
    **proxy.ts** -- Replace the entire proxy function with nonce-based CSP:
    1. Generate nonce: `const nonce = Buffer.from(crypto.randomUUID()).toString('base64');`
    2. Build CSP header using template literal with these directives (per user decision):
       - `default-src 'self'`
       - `script-src 'self' 'nonce-${nonce}' 'strict-dynamic'` + `'unsafe-eval'` in dev only
       - `style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com`
       - `img-src 'self' blob: data:`
       - `font-src 'self' https://fonts.gstatic.com`
       - `connect-src 'self' https://*.supabase.co https://*.ingest.us.sentry.io https://accounts.google.com https://tiptopjar.com` + `ws://localhost:3000` in dev
       - `media-src 'self' blob:`
       - `worker-src 'self' blob:`
       - `frame-src 'self' https://accounts.google.com https://tiptopjar.com`
       - `frame-ancestors 'self'`
       - `object-src 'none'`
       - `base-uri 'self'`
       - `form-action 'self'`
       - `upgrade-insecure-requests`
       - `report-uri https://o4507212955254784.ingest.us.sentry.io/api/4510406083346432/security/?sentry_key=c957cad31df16711843d5241cb2d6515`
    3. Clean whitespace: `.replace(/\s{2,}/g, ' ').trim()`
    4. Set nonce on request headers: `requestHeaders.set('x-nonce', nonce)`
    5. Set CSP on request headers: `requestHeaders.set('Content-Security-Policy', cspValue)`
    6. Create response with `NextResponse.next({ request: { headers: requestHeaders } })`
    7. Set CSP on response headers
    8. Set consolidated security headers on response (move FROM next.config.mjs):
       - `X-Content-Type-Options: nosniff`
       - `X-Frame-Options: DENY`
       - `Referrer-Policy: strict-origin-when-cross-origin`
       - `Permissions-Policy: camera=(), microphone=(self), geolocation=()`
       - `X-DNS-Prefetch-Control: on`
    9. Update matcher config to use the object form with `missing` clause for prefetch skipping:
       ```
       matcher: [{
         source: '/((?!api|_next/static|_next/image|favicon.ico|icons|manifest.json|sw.js|sw.js.map|offline.html).*)',
         missing: [
           { type: 'header', key: 'next-router-prefetch' },
           { type: 'header', key: 'purpose', value: 'prefetch' },
         ],
       }]
       ```
    10. Remove the old THEME_SCRIPT_HASH and HASH_REDIRECT_SCRIPT_HASH constants -- no longer needed

    IMPORTANT: Keep the file as `proxy.ts` at root with `export function proxy()` -- do NOT rename to middleware.ts. Research confirmed proxy.ts is the correct Next.js 16 convention. The CONTEXT.md mentioned renaming to middleware.ts but research found this is incorrect.

    **next.config.mjs** -- Remove the `headers()` function entirely from nextConfig (security headers now in proxy.ts). Keep `redirects()`, `reactStrictMode`, `experimental`, and all other config.

    **src/lib/themeScript.ts** -- Remove the `HASH_REDIRECT_SCRIPT` export and its comment. App Router uses clean URLs (MIGR-12 complete), and next.config.mjs redirects handle /dashboard -> /home etc. The hash redirect script is dead code. Also remove the comment at the top about updating SHA-256 hashes in proxy.ts (no longer relevant with nonce-based CSP). Keep only `THEME_SCRIPT`.

    Wire into: proxy.ts sets `x-nonce` header read by app/layout.tsx (Task 2). Security headers on response are enforced by the browser.
  </action>
  <verify>
    <automated>cd /c/Users/minkk/GitHub/civic-test-2025 && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Verify proxy.ts contains strict-dynamic and nonce generation, next.config.mjs has no headers() function, themeScript.ts has no HASH_REDIRECT_SCRIPT</manual>
  </verify>
  <done>proxy.ts generates per-request nonce, builds CSP with strict-dynamic, consolidates all security headers. next.config.mjs headers() removed. HASH_REDIRECT_SCRIPT removed from themeScript.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Wire nonce to layout, GoogleOneTap, and auth page server wrapper</name>
  <files>
    app/layout.tsx
    src/components/GoogleOneTapSignIn.tsx
    app/(public)/auth/page.tsx
  </files>
  <action>
    **app/layout.tsx** -- Make the RootLayout function async and read the nonce:
    1. Add import: `import { headers } from 'next/headers';`
    2. Change signature: `export default async function RootLayout(...)`
    3. Read nonce: `const nonce = (await headers()).get('x-nonce') ?? undefined;`
    4. Add `nonce={nonce}` attribute to the theme script tag: `<script nonce={nonce} dangerouslySetInnerHTML={{ __html: THEME_SCRIPT }} />`
    5. Remove the HASH_REDIRECT_SCRIPT `<script>` tag entirely (dead code, export already removed in Task 1)
    6. Remove `HASH_REDIRECT_SCRIPT` from the import statement (keep only `THEME_SCRIPT`)
    7. All other layout content (metadata, viewport, ClientProviders, GlobalOverlays, fonts, CSS) stays exactly the same

    NOTE: `await headers()` forces dynamic rendering for all pages. This is acceptable per research -- all pages are 'use client' thin wrappers (client-rendered SPA). No performance regression expected.

    **src/components/GoogleOneTapSignIn.tsx** -- Add optional nonce prop:
    1. Add interface: `interface GoogleOneTapSignInProps { nonce?: string; }`
    2. Change component signature: `const GoogleOneTapSignIn = ({ nonce }: GoogleOneTapSignInProps) => {`
    3. Add `nonce={nonce}` to the `<Script>` tag (the one loading `https://accounts.google.com/gsi/client`)
    4. Everything else stays the same

    Wire into: GoogleOneTapSignIn receives nonce from auth page server wrapper below.

    **app/(public)/auth/page.tsx** -- Convert to async server component that passes nonce:
    1. Remove `'use client';` directive (this becomes a Server Component)
    2. Add import: `import { headers } from 'next/headers';`
    3. Make the function async: `export default async function Auth()`
    4. Read nonce: `const nonce = (await headers()).get('x-nonce') ?? undefined;`
    5. Pass nonce as prop to AuthPage: `<AuthPage nonce={nonce} />`
    6. Keep the Suspense boundary wrapping AuthPage

    Then update **src/views/AuthPage.tsx** to accept and forward the nonce:
    1. Add `nonce?: string` to the component props (create an interface or inline)
    2. Pass `nonce={nonce}` to `<GoogleOneTapSignIn nonce={nonce} />`

    This is the YAGNI server wrapper approach per user decision -- specific to GoogleOneTap, not a generic NoncedScript. The auth page.tsx becomes the thin server wrapper that reads the nonce and forwards it through AuthPage to GoogleOneTapSignIn.

    Import from: `next/headers` (headers function), `@/lib/themeScript` (THEME_SCRIPT only)
    Wire into: proxy.ts (Task 1) sets x-nonce -> layout.tsx reads it -> script tags get nonce attribute. auth/page.tsx reads x-nonce -> AuthPage -> GoogleOneTapSignIn -> Script tag.
    Connect to: Browser CSP enforcement validates nonce on inline scripts and third-party Script tags.
  </action>
  <verify>
    <automated>cd /c/Users/minkk/GitHub/civic-test-2025 && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Run `pnpm build` and verify it succeeds. Start with `pnpm start`, visit the app, open browser console -- no CSP violations should appear. Visit /auth page and verify Google One Tap loads.</manual>
  </verify>
  <done>layout.tsx is async, reads nonce, applies to theme script. HASH_REDIRECT_SCRIPT script tag removed. GoogleOneTapSignIn accepts and uses nonce prop. Auth page is server component passing nonce through AuthPage to GoogleOneTapSignIn. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `pnpm build` succeeds (all pages may show as dynamic/lambda -- expected with `await headers()`)
3. No CSP violation errors in browser console on any page
4. Google One Tap loads on /auth page
5. Theme applies correctly (no FOUC)
6. Security headers visible in browser Network tab (X-Frame-Options, Referrer-Policy, etc.)
7. `grep -r "HASH_REDIRECT_SCRIPT" --include="*.ts" --include="*.tsx" proxy.ts app/ src/` returns no matches (dead code removed)
</verification>

<success_criteria>
- CSP header on every page response contains `nonce-{value}` and `strict-dynamic`
- All inline scripts have matching `nonce` attribute
- Google GSI script loads via nonce + strict-dynamic propagation
- Security headers consolidated in proxy.ts (removed from next.config.mjs)
- HASH_REDIRECT_SCRIPT fully removed
- Zero CSP violations in browser console
</success_criteria>

<output>
After completion, create `.planning/phases/42-csp-nonce-migration-and-pwa-update/42-01-SUMMARY.md`
</output>
