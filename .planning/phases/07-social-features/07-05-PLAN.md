---
phase: 07-social-features
plan: 05
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/lib/social/shareCardRenderer.ts
  - src/lib/social/shareUtils.ts
  - src/components/social/ShareCardPreview.tsx
  - src/components/social/ShareButton.tsx
autonomous: true

must_haves:
  truths:
    - "Score card generates as 1080x1080 PNG with gradient background and gold accents"
    - "Card shows score, streak count, top badge, and category breakdown"
    - "Card text is always bilingual (EN + Burmese) regardless of language setting"
    - "Preview modal shows generated card before sharing"
    - "Web Share API shares image on mobile, clipboard fallback on desktop"
    - "App branding footer appears on card with app name and URL"
  artifacts:
    - path: "src/lib/social/shareCardRenderer.ts"
      provides: "Canvas API score card generator"
      exports: ["renderShareCard", "ShareCardData"]
    - path: "src/lib/social/shareUtils.ts"
      provides: "Web Share + clipboard fallback"
      exports: ["shareScoreCard"]
    - path: "src/components/social/ShareCardPreview.tsx"
      provides: "Preview modal with share action"
      exports: ["ShareCardPreview"]
    - path: "src/components/social/ShareButton.tsx"
      provides: "Share trigger button"
      exports: ["ShareButton"]
  key_links:
    - from: "src/components/social/ShareCardPreview.tsx"
      to: "src/lib/social/shareCardRenderer.ts"
      via: "generates card image on open"
      pattern: "renderShareCard"
    - from: "src/components/social/ShareCardPreview.tsx"
      to: "src/lib/social/shareUtils.ts"
      via: "shares generated image"
      pattern: "shareScoreCard"
---

<objective>
Build the score sharing card system: Canvas API renderer for 1080x1080 celebratory cards, Web Share / clipboard distribution, and a preview modal for user confirmation before sharing.

Purpose: Users who pass a test or complete a practice session can generate and share a bilingual result card on social media, encouraging others in their community to study. The card is the most visible external-facing feature of the app.
Output: Canvas renderer producing vibrant gradient cards, share utility with native + fallback paths, preview modal, and reusable share button component.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-social-features/07-RESEARCH.md
@.planning/phases/07-social-features/07-01-SUMMARY.md
@src/components/ui/Dialog.tsx (Radix Dialog pattern)
@src/lib/social/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Canvas score card renderer and share utility</name>
  <files>
    src/lib/social/shareCardRenderer.ts
    src/lib/social/shareUtils.ts
  </files>
  <action>
    Create `src/lib/social/shareCardRenderer.ts`:

    Interface `ShareCardData`: `{ score: number; total: number; sessionType: 'test' | 'practice' | 'interview'; streak: number; topBadge: { name: { en: string; my: string }; icon: string } | null; categories: Array<{ name: string; correct: number; total: number }>; date: string }`.

    Function `renderShareCard(data: ShareCardData): Promise<Blob>`:

    1. Wait for fonts: `await document.fonts.ready;` then `await document.fonts.load('bold 36px "Noto Sans Myanmar"');` (handle FOUF per research pitfall).

    2. Create offscreen canvas: `document.createElement('canvas')`, 1080x1080.

    3. Draw background gradient (vibrant, celebratory per user decision):
       - Linear gradient top-left to bottom-right.
       - Stop 0: deep blue (#1e3a8a).
       - Stop 0.5: indigo (#4338ca).
       - Stop 1: purple (#7c3aed).

    4. Gold accent elements:
       - Top bar: 8px gold (#FFD700) bar at top.
       - Bottom bar: 8px gold bar at bottom.
       - Decorative corner accents (small gold triangles or circles at corners).

    5. Draw session type label at top (y ~120):
       - Test: "Mock Test Results" / "·ÄÖ·Äô·Ä∫·Ä∏·Äû·Äï·Ä∫·ÄÖ·Ä¨·Äô·Ä±·Ä∏·Äï·ÄΩ·Ä≤ ·Äõ·Äú·Äí·Ä∫·Äô·Äª·Ä¨·Ä∏"
       - Practice: "Practice Results" / "·Äú·Ä±·Ä∑·ÄÄ·Äª·ÄÑ·Ä∑·Ä∫·ÄÅ·Äî·Ä∫·Ä∏ ·Äõ·Äú·Äí·Ä∫·Äô·Äª·Ä¨·Ä∏"
       - Interview: "Interview Results" / "·Ä°·ÄÑ·Ä∫·Äê·Ä¨·Äó·Äª·Ä∞·Ä∏ ·Äõ·Äú·Äí·Ä∫·Äô·Äª·Ä¨·Ä∏"
       - White text, bold 36px system-ui, centered.

    6. Draw score (large, centered, y ~350):
       - Gold (#FFD700) color, bold 140px system-ui.
       - Format: "N/M" (e.g., "8/10").

    7. Draw streak line (y ~450):
       - Orange (#FFA500), bold 48px.
       - "üî• N day streak" text (use emoji for fire since Canvas handles it).

    8. Draw top badge (y ~530) if provided:
       - "üèÜ BadgeName" in gold text, 36px.

    9. Draw category breakdown (y ~620-800):
       - Show top 3-4 categories with horizontal progress bars drawn on canvas.
       - Each: category name (white, 28px) + bar (gold fill on dark track) + "N/M".
       - Bars at 60% width of canvas, centered.

    10. Draw branding footer (y ~950-1040):
        - "US Citizenship Civic Test Prep" ‚Äî white, 32px, centered.
        - "·Ä°·Äô·Ä±·Äõ·Ä≠·ÄÄ·Äî·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·ÄÑ·Ä∂·Äû·Ä¨·Ä∏·Äõ·Ä±·Ä∏·Äõ·Ä¨ ·ÄÖ·Ä¨·Äô·Ä±·Ä∏·Äï·ÄΩ·Ä≤·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏" ‚Äî Burmese, Noto Sans Myanmar 28px, centered.
        - App URL in smaller text (24px, white/50 opacity).

    11. Convert to blob: `canvas.toBlob()` as 'image/png'.

    IMPORTANT: Do NOT use external images on the canvas (CORS pitfall from research). Use only text, shapes, and gradients. Draw icons as Unicode emoji characters or simple geometric shapes.

    Create `src/lib/social/shareUtils.ts`:

    Function `shareScoreCard(blob: Blob): Promise<'shared' | 'copied' | 'downloaded'>`:

    1. Create File from blob: `new File([blob], 'civic-test-score.png', { type: 'image/png' })`.
    2. Try Web Share API: `navigator.canShare?.({ files: [file] })` ‚Üí `navigator.share({ files: [file], title: '...', text: '...' })` ‚Üí return 'shared'.
    3. Catch AbortError (user cancelled) ‚Üí return 'downloaded' (no-op).
    4. Fallback 1: Clipboard API: `navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])` ‚Üí return 'copied'.
    5. Fallback 2: Download: Create object URL, create `<a>` element, trigger click, revoke URL ‚Üí return 'downloaded'.
    6. Each fallback wrapped in try/catch.

    Update `src/lib/social/index.ts` barrel export to include shareCardRenderer and shareUtils exports.
  </action>
  <verify>TypeScript compiles. renderShareCard returns a Promise<Blob>. shareScoreCard handles all three share paths.</verify>
  <done>Canvas renderer generates 1080x1080 vibrant gradient card with score, streak, badge, categories, and bilingual branding. Share utility supports native share, clipboard, and download fallbacks.</done>
</task>

<task type="auto">
  <name>Task 2: ShareCardPreview modal and ShareButton component</name>
  <files>
    src/components/social/ShareCardPreview.tsx
    src/components/social/ShareButton.tsx
  </files>
  <action>
    Create `src/components/social/ShareCardPreview.tsx`:

    1. Props: `data: ShareCardData | null; open: boolean; onClose: () => void`.
    2. Uses Radix Dialog from `@/components/ui/Dialog`.
    3. When `open` becomes true, calls `renderShareCard(data)` to generate the image blob.
    4. Displays the generated image as a preview: `URL.createObjectURL(blob)` ‚Üí `<img>` element.
    5. Show loading spinner while generating (use motion/react AnimatePresence for smooth transition).
    6. Two action buttons:
       - "Share" / "·Äô·Äª·Äæ·Äù·Ä±·Äï·Ä´" (primary) ‚Äî calls `shareScoreCard(blob)`, shows success toast ("Shared!" / "Copied to clipboard!" depending on result).
       - "Close" / "·Äï·Ä≠·Äê·Ä∫·Äï·Ä´" (secondary) ‚Äî calls onClose.
    7. Clean up object URL on unmount: `URL.revokeObjectURL()`.
    8. Dialog max width: max-w-md on desktop, 95vw on mobile.
    9. Image preview scaled to fit dialog width (width: 100%, aspect-ratio: 1/1).
    10. Use BilingualToast showSuccess for share confirmation.

    Create `src/components/social/ShareButton.tsx`:

    1. Props: `data: ShareCardData; variant?: 'default' | 'compact'; className?: string`.
    2. Default variant: Full bilingual button with Share2 icon from lucide-react. Text: "Share Results" / "·Äõ·Äú·Äí·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äô·Äª·Äæ·Äù·Ä±·Äï·Ä´".
    3. Compact variant: Icon-only button (Share2 icon, 32px touch target).
    4. On click: opens ShareCardPreview modal (manages open state internally via useState).
    5. Button uses existing BilingualButton component for default variant, plain button for compact.
    6. Renders `<ShareCardPreview>` as a sibling (portal via Dialog).
  </action>
  <verify>TypeScript compiles. ShareButton opens preview modal on click. Preview shows generated image with share/close actions.</verify>
  <done>ShareCardPreview shows canvas-generated image in modal with share/close actions. ShareButton triggers the flow with default or compact variants. Success feedback via bilingual toast.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Canvas generates 1080x1080 image with gradient background
3. Card includes score, streak, badge, categories, and bilingual footer
4. Preview modal displays generated image correctly
5. Share button works in both default and compact variants
6. Clipboard fallback works when Web Share is unavailable
7. All text on card is bilingual regardless of user language setting
</verification>

<success_criteria>
- Score card is visually celebratory (gradient, gold accents, not standard app palette)
- Card is always bilingual (locked decision)
- Canvas API generates image without external image dependencies (CORS-safe)
- Burmese font loads before canvas drawing (document.fonts.ready)
- Web Share API used on mobile with clipboard + download fallbacks
- Preview lets user confirm before sharing
- ShareButton is reusable across results/history pages
</success_criteria>

<output>
After completion, create `.planning/phases/07-social-features/07-05-SUMMARY.md`
</output>
