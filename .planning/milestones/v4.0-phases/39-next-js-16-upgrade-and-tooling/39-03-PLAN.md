---
phase: 39-next-js-16-upgrade-and-tooling
plan: 03
type: execute
wave: 3
depends_on: ["39-02"]
files_modified:
  - app/global-error.tsx
  - src/lib/sentry.ts
  - app/dev-sentry-test/page.tsx
autonomous: true
requirements:
  - MIGR-03

must_haves:
  truths:
    - "app/global-error.tsx exists and reports errors to Sentry then shows a reset button"
    - "Sentry noise filters fingerprint hydration mismatches and chunk load failures"
    - "A dev-only test page exists to verify Sentry captures errors end-to-end"
    - "Existing Sentry config files (instrumentation.ts, sentry.server.config.ts, sentry.edge.config.ts, instrumentation-client.ts) remain intact"
    - "The build still succeeds after Sentry changes"
  artifacts:
    - path: "app/global-error.tsx"
      provides: "App Router error boundary that captures errors to Sentry"
      contains: "Sentry.captureException"
    - path: "src/lib/sentry.ts"
      provides: "Updated beforeSendHandler with Next.js 16 noise filters"
      contains: "hydration-mismatch"
    - path: "app/dev-sentry-test/page.tsx"
      provides: "Dev-only page with throw button to verify Sentry pipeline"
      contains: "use client"
  key_links:
    - from: "app/global-error.tsx"
      to: "src/lib/sentry.ts"
      via: "Sentry.captureException calls go through beforeSend handler"
      pattern: "Sentry\\.captureException"
    - from: "instrumentation.ts"
      to: "sentry.server.config.ts"
      via: "Dynamic import for server-side Sentry init"
      pattern: "import.*sentry\\.server\\.config"
    - from: "instrumentation-client.ts"
      to: "src/lib/sentry.ts"
      via: "Client Sentry init uses beforeSendHandler"
      pattern: "beforeSendHandler"
---

<objective>
Reconfigure Sentry for App Router compatibility by creating global-error.tsx, adding Next.js 16 noise filters, and creating a dev-only test page for end-to-end Sentry verification.

Purpose: Prepare Sentry for the upcoming App Router migration (Phase 40-41) while keeping existing Pages Router error reporting working. The global-error.tsx file catches rendering errors in the App Router tree. Noise filters reduce alert fatigue from common Next.js 16 issues.

Output: `app/global-error.tsx` for error capture, updated noise filters in `src/lib/sentry.ts`, dev-only test page at `app/dev-sentry-test/page.tsx`.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-next-js-16-upgrade-and-tooling/39-RESEARCH.md
@.planning/phases/39-next-js-16-upgrade-and-tooling/39-02-SUMMARY.md
@src/lib/sentry.ts
@instrumentation.ts
@instrumentation-client.ts
@sentry.server.config.ts
@sentry.edge.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create app/global-error.tsx and Sentry dev test page</name>
  <files>app/global-error.tsx, app/dev-sentry-test/page.tsx</files>
  <action>
1. Create `app/global-error.tsx` for App Router error capture. This is a `"use client"` component that:
   - Calls `Sentry.captureException(error)` in a `useEffect` when an error occurs
   - Renders a minimal error UI with a "Try again" button that calls `reset()`
   - Wraps content in `<html><body>` since global-error replaces the entire layout
   - Is functional only — no design polish per user decision
   - Pattern from research:
   ```tsx
   "use client";
   import * as Sentry from "@sentry/nextjs";
   import { useEffect } from "react";

   export default function GlobalError({ error, reset }: { error: Error & { digest?: string }; reset: () => void }) {
     useEffect(() => {
       Sentry.captureException(error);
     }, [error]);

     return (
       <html>
         <body>
           <div style={{ padding: '2rem', textAlign: 'center' }}>
             <h2>Something went wrong</h2>
             <button onClick={reset}>Try again</button>
           </div>
         </body>
       </html>
     );
   }
   ```

2. Create `app/dev-sentry-test/page.tsx` — a dev-only test page per user decision:
   - `"use client"` component
   - Has a button that throws an Error when clicked
   - Has a button that triggers a React rendering error (set state to throw in render)
   - Only renders in development (check `process.env.NODE_ENV === 'development'`; redirect or show "Not available" in production)
   - Shows simple instructions: "Click to trigger a test error and verify Sentry captures it"
   - Example:
   ```tsx
   "use client";
   import { useState } from "react";

   function BuggyComponent() {
     throw new Error("Sentry test: React render error");
   }

   export default function DevSentryTestPage() {
     const [renderError, setRenderError] = useState(false);

     if (process.env.NODE_ENV !== "development") {
       return <p>This page is only available in development mode.</p>;
     }

     if (renderError) {
       return <BuggyComponent />;
     }

     return (
       <div style={{ padding: "2rem" }}>
         <h1>Sentry Test Page (Dev Only)</h1>
         <p>Click buttons to verify Sentry error capture:</p>
         <button onClick={() => { throw new Error("Sentry test: click handler error"); }}>
           Throw in Click Handler
         </button>
         <button onClick={() => setRenderError(true)} style={{ marginLeft: "1rem" }}>
           Throw in Render
         </button>
       </div>
     );
   }
   ```

3. IMPORTANT: Do NOT delete or modify `sentry.server.config.ts`, `sentry.edge.config.ts`, `instrumentation.ts`, or `instrumentation-client.ts`. Per research Pitfall 4, these are the CORRECT pattern — `instrumentation.ts` dynamically imports the server/edge configs. The CONTEXT's "delete old Pages Router Sentry files" was referring to `sentry.client.config.ts` which was already renamed to `instrumentation-client.ts`.
  </action>
  <verify>
    <automated>pnpm build && pnpm typecheck</automated>
    <manual>Verify app/global-error.tsx and app/dev-sentry-test/page.tsx exist with correct content</manual>
  </verify>
  <done>app/global-error.tsx captures errors to Sentry and shows reset button. Dev test page exists at app/dev-sentry-test/page.tsx with throw buttons. Existing Sentry config files are untouched.</done>
</task>

<task type="auto">
  <name>Task 2: Add Next.js 16 noise filters to Sentry beforeSendHandler</name>
  <files>src/lib/sentry.ts</files>
  <action>
1. Update `beforeSendHandler` in `src/lib/sentry.ts` to add Next.js 16 specific noise filters. Add these BEFORE the existing fingerprinting rules (after the dev-mode skip):

   a. **Hydration mismatch fingerprinting** — Group high-volume hydration errors under a single issue:
   ```typescript
   // Next.js 16 hydration mismatch noise — group under single issue
   if (/hydration|Minified React error #(418|419|422|423|425)/i.test(errorValue)) {
     event.fingerprint = ['hydration-mismatch'];
   }
   ```

   b. **Chunk load failure fingerprinting** — Common with Turbopack cache invalidation:
   ```typescript
   // Chunk load failures (common with Turbopack cache invalidation)
   if (/ChunkLoadError|Loading chunk|Failed to fetch dynamically imported module/i.test(errorValue)) {
     event.fingerprint = ['chunk-load-failure'];
   }
   ```

   c. **AbortError suppression** — Navigation cancellation noise, drop entirely:
   ```typescript
   // Cancel errors from navigation during async operations — drop entirely
   if (/AbortError|The operation was aborted|signal is aborted/i.test(errorValue)) {
     return null;
   }
   ```

2. Place these new filters in the fingerprinting section of `beforeSendHandler`, after the `errorValue` extraction and BEFORE the existing network/IndexedDB/TTS fingerprints. The AbortError filter MUST return null (drop) rather than just fingerprint.

3. Add a comment block explaining these are Next.js 16 noise filters.

4. Run existing sentry tests to make sure nothing breaks:
   ```bash
   pnpm test:run
   ```
  </action>
  <verify>
    <automated>pnpm test:run && pnpm typecheck && pnpm build</automated>
  </verify>
  <done>beforeSendHandler has three new noise filters: hydration-mismatch fingerprinting, chunk-load-failure fingerprinting, and AbortError suppression. All tests pass. Build succeeds.</done>
</task>

</tasks>

<verification>
- `app/global-error.tsx` exists with `Sentry.captureException` and reset button
- `app/dev-sentry-test/page.tsx` exists with throw buttons and dev-only guard
- `src/lib/sentry.ts` has hydration-mismatch, chunk-load-failure, and AbortError filters
- `instrumentation.ts`, `sentry.server.config.ts`, `sentry.edge.config.ts`, `instrumentation-client.ts` are UNCHANGED
- `pnpm build` succeeds
- `pnpm test:run` passes
</verification>

<success_criteria>
Sentry is ready for App Router with global-error.tsx, noise filters reduce alert fatigue, dev test page enables end-to-end verification, and all existing Sentry infrastructure remains working.
</success_criteria>

<output>
After completion, create `.planning/phases/39-next-js-16-upgrade-and-tooling/39-03-SUMMARY.md`
</output>
