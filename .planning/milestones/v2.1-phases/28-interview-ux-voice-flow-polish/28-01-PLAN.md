---
phase: 28-interview-ux-voice-flow-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/audio/audioPrecache.ts
  - src/lib/audio/audioPrecache.test.ts
  - src/lib/audio/networkCheck.ts
autonomous: true
requirements: [IVPOL-01, IVPOL-02]
must_haves:
  truths:
    - "Audio pre-cache function fetches all interview audio URLs into Cache API"
    - "Pre-cache reports progress (loaded/total/failed) via callback"
    - "Partial failures are tracked, not thrown -- interview starts with whatever was cached"
    - "Network quality check returns fast/slow/offline for pre-start warning"
  artifacts:
    - path: "src/lib/audio/audioPrecache.ts"
      provides: "precacheInterviewAudio() function with progress tracking"
      exports: ["precacheInterviewAudio", "PrecacheProgress", "isAudioCached"]
    - path: "src/lib/audio/networkCheck.ts"
      provides: "checkNetworkQuality() function"
      exports: ["checkNetworkQuality", "NetworkQuality"]
    - path: "src/lib/audio/audioPrecache.test.ts"
      provides: "Unit tests for pre-cache module"
  key_links:
    - from: "src/lib/audio/audioPrecache.ts"
      to: "src/lib/audio/audioPlayer.ts"
      via: "imports getEnglishAudioUrl, getBurmeseAudioUrl, getInterviewAudioUrl"
      pattern: "import.*audioPlayer"
---

<objective>
Create the audio pre-cache module and network quality check utilities.

Purpose: Enable reliable interview audio by pre-fetching all needed MP3s into the browser Cache API before the interview starts. The SW already uses CacheFirst for `/audio/` paths with cache name `audio-v2`, so pre-populating this cache ensures offline-capable playback.

Output: `audioPrecache.ts` with `precacheInterviewAudio()` and `networkCheck.ts` with `checkNetworkQuality()`
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/audio/audioPlayer.ts
@src/lib/pwa/sw.ts
@src/lib/interview/interviewGreetings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audio pre-cache module</name>
  <files>src/lib/audio/audioPrecache.ts</files>
  <action>
Create `src/lib/audio/audioPrecache.ts` with:

1. **PrecacheProgress interface**: `{ loaded: number; total: number; failed: string[] }`

2. **precacheInterviewAudio(questionIds, options, onProgress?)** async function:
   - Build URL list from question IDs using `getEnglishAudioUrl(id, 'q')` and `getEnglishAudioUrl(id, 'a')` for all 20 questions
   - If `options.includeBurmese`, also add `getBurmeseAudioUrl(id, 'q')` and `getBurmeseAudioUrl(id, 'a')`
   - Add all interview-specific audio: greeting-01 through greeting-03, closing-pass-01/02, closing-fail-01/02, correct-prefix, incorrect-prefix, pass-announce, fail-announce (use `getInterviewAudioUrl()`)
   - Open cache with `caches.open('audio-v2')` -- MUST match SW cache name from `src/lib/pwa/sw.ts`
   - Fetch in parallel batches of 6 using `Promise.allSettled(batch.map(url => cache.add(url)))`
   - Track and report progress via onProgress callback after each batch
   - Return final PrecacheProgress with loaded count, total, and failed URLs
   - Handle case where Cache API is unavailable (e.g., private browsing) -- return all as failed, don't throw

3. **isAudioCached(url)** async function:
   - Check if a specific URL exists in the `audio-v2` cache
   - Returns boolean. Used by audioPlayer to decide MP3 vs TTS fallback.
   - Handle Cache API unavailability gracefully (return false)

4. **INTERVIEW_AUDIO_NAMES** constant array: list of all interview-specific audio filenames for reuse

Import URL helpers from `@/lib/audio/audioPlayer`.
  </action>
  <verify>TypeScript compiles with `npm run typecheck`. File exports are importable.</verify>
  <done>precacheInterviewAudio builds correct URL list, fetches in batches with progress, handles partial failures gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Create network quality check utility</name>
  <files>src/lib/audio/networkCheck.ts</files>
  <action>
Create `src/lib/audio/networkCheck.ts` with:

1. **NetworkQuality type**: `'fast' | 'slow' | 'offline'`

2. **checkNetworkQuality()** async function:
   - First try `navigator.connection.downlink` (Network Information API, Chrome-only): if < 1 Mbps return 'slow', else 'fast'
   - Type `navigator.connection` as `any` to handle missing type definitions
   - Fallback: time a HEAD request to `/audio/en-US/ava/interview/greeting-01.mp3`
     - If > 2000ms: 'slow'
     - If fetch succeeds within 2000ms: 'fast'
     - If fetch fails (offline): 'offline'
   - Wrap entire function in try/catch, default to 'fast' on unexpected errors (don't block interview start)
  </action>
  <verify>TypeScript compiles. Function signature matches expected usage.</verify>
  <done>checkNetworkQuality returns fast/slow/offline based on connection quality</done>
</task>

<task type="auto">
  <name>Task 3: Unit tests for pre-cache module</name>
  <files>src/lib/audio/audioPrecache.test.ts</files>
  <action>
Create `src/lib/audio/audioPrecache.test.ts` with tests:

1. Mock `caches.open()` to return a mock cache object with `add()` and `match()` methods
2. Test cases:
   - `precacheInterviewAudio` builds correct URL count (20 questions * 2 types + 11 interview = 51 English-only)
   - With `includeBurmese: true`, URL count includes Burmese (20*2 + 20*2 + 11 = 91)
   - Progress callback fires after each batch
   - Partial failures tracked in `failed` array (not thrown)
   - Cache API unavailable returns all URLs as failed
   - `isAudioCached` returns true when cache.match resolves with response
   - `isAudioCached` returns false when cache.match resolves with undefined
   - `checkNetworkQuality` returns 'fast' with good connection
   - `checkNetworkQuality` returns 'offline' when fetch fails

Use `vi.stubGlobal('caches', ...)` for Cache API mocking.
  </action>
  <verify>`npm run test:run -- src/lib/audio/audioPrecache.test.ts` passes</verify>
  <done>All pre-cache and network check tests pass</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- `npm run test:run -- src/lib/audio/audioPrecache.test.ts` passes
- No new lint errors
</verification>

<success_criteria>
- Audio pre-cache module exists with progress tracking and batch fetching
- Network quality check utility exists with cross-browser fallback
- Unit tests cover happy path, partial failure, and Cache API unavailability
- Cache name matches SW's `audio-v2` for proper CacheFirst integration
</success_criteria>

<output>
After completion, create `.planning/phases/28-interview-ux-voice-flow-polish/28-01-SUMMARY.md`
</output>
