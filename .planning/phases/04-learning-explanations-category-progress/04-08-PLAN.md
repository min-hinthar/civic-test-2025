---
phase: 04-learning-explanations-category-progress
plan: 08
type: execute
wave: 4
depends_on: ["04-02", "04-03", "04-06"]
files_modified:
  - src/components/practice/PracticeConfig.tsx
  - src/components/practice/PracticeSession.tsx
  - src/components/practice/PracticeResults.tsx
  - src/lib/practice/questionSelection.ts
  - src/pages/PracticePage.tsx
  - src/AppShell.tsx
  - src/components/test/PreTestScreen.tsx
autonomous: true

must_haves:
  truths:
    - "User can select a category and question count to start practice"
    - "Practice uses smart question mix: 70% weak, 30% strong"
    - "User sees same explanation behavior as test mode (WhyButton after each answer)"
    - "Post-practice shows score + review + animated mastery ring updating from old to new percentage"
    - "Practice results tracked separately from test results (sessionType: 'practice')"
    - "User can practice sub-categories within main USCIS categories"
    - "'Practice All Weak Areas' option available"
    - "Timer is optional, off by default"
  artifacts:
    - path: "src/lib/practice/questionSelection.ts"
      provides: "Smart 70/30 weak/strong question selection"
      exports: ["selectPracticeQuestions"]
    - path: "src/components/practice/PracticeConfig.tsx"
      provides: "Category and count selection UI"
      exports: ["PracticeConfig"]
    - path: "src/components/practice/PracticeSession.tsx"
      provides: "Practice test flow with questions, answers, explanations"
      exports: ["PracticeSession"]
    - path: "src/components/practice/PracticeResults.tsx"
      provides: "Post-practice review with animated mastery update"
      exports: ["PracticeResults"]
    - path: "src/pages/PracticePage.tsx"
      provides: "Practice mode page managing config -> session -> results flow"
      exports: ["default"]
  key_links:
    - from: "src/lib/practice/questionSelection.ts"
      to: "src/lib/mastery/masteryStore.ts"
      via: "getAnswerHistory for weakness detection"
      pattern: "getAnswerHistory"
    - from: "src/components/practice/PracticeSession.tsx"
      to: "src/lib/mastery/masteryStore.ts"
      via: "recordAnswer with sessionType: 'practice'"
      pattern: "recordAnswer"
    - from: "src/pages/PracticePage.tsx"
      to: "src/lib/practice/questionSelection.ts"
      via: "selectPracticeQuestions call"
      pattern: "selectPracticeQuestions"
---

<objective>
Build the complete category practice mode: category/count selection, smart question selection, practice session flow with explanations, and post-practice results with animated mastery update.

Purpose: Users study specific weak areas with targeted practice. The 70/30 weak/strong mix ensures focused review while maintaining breadth. Per CONTEXT.md: "User chooses via segmented control / pills: Quick (5), Standard (10), Full (all)."

Output: Complete practice mode at /practice route with config, session, and results screens.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-learning-explanations-category-progress/04-CONTEXT.md
@.planning/phases/04-learning-explanations-category-progress/04-RESEARCH.md
@src/pages/TestPage.tsx
@src/lib/mastery/categoryMapping.ts
@src/lib/mastery/calculateMastery.ts
@src/lib/mastery/masteryStore.ts
@src/lib/shuffle.ts
@src/components/explanations/WhyButton.tsx
@src/components/test/AnswerFeedback.tsx
@src/components/progress/CategoryRing.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create question selection logic and PracticeConfig UI</name>
  <files>
    src/lib/practice/questionSelection.ts,
    src/components/practice/PracticeConfig.tsx
  </files>
  <action>
    1. **questionSelection.ts** - Smart question selection:
       - `selectPracticeQuestions({ questions, count, weakRatio = 0.7 }): Promise<Question[]>`
       - Loads answer history from masteryStore
       - Calculates per-question accuracy (correct count / total attempts)
       - Unanswered questions treated as "weak" (accuracy = 0)
       - Sorts questions by accuracy (weakest first)
       - Selects `ceil(count * weakRatio)` weak questions from bottom
       - Selects remaining from strong questions (shuffled, from top)
       - Final result shuffled with fisherYatesShuffle
       - Export `getWeakQuestions(questions, threshold = 0.6): Promise<Question[]>` for "Practice All Weak Areas"

    2. **PracticeConfig.tsx** - Category and count selection:
       - Props: `onStart: (config: PracticeConfigType) => void`
       - **Category selection:**
         - 3 main USCIS categories as large tappable cards with CategoryRing showing current mastery %
         - Each category expandable to show sub-categories
         - Sub-categories also tappable for focused practice
         - "Practice All Weak Areas" option at top as prominent button (per CONTEXT.md)
         - Multi-category: Claude's discretion = allow selecting one category OR "all weak areas"
       - **Question count selection:**
         - Segmented control / pills: Quick (5), Standard (10), Full (all questions in category)
         - Show question count for "Full" option dynamically based on selected category
       - **Timer toggle:**
         - Switch/toggle: "Timer: Off" (default) / "Timer: On"
         - Per CONTEXT.md: "Optional - off by default, can be turned on for test simulation"
       - **Mastered category handling:**
         - If selected category mastery is >= 100%, show message:
           - "This is mastered! Want to practice [weakest category] instead?" (bilingual)
           - "Practice anyway" button to proceed
         - Show current mastery % and improvement potential on "Start Practice" button
       - **Start button:**
         - "Start Practice / လေ့ကျင့်မှုစတင်ပါ"
         - Shows: "Practice [Category] (72%) - 10 questions"
       - Use BilingualText, BilingualButton, strings throughout
       - Staggered animation for category cards entrance
  </action>
  <verify>
    `npx tsc --noEmit` passes. questionSelection correctly selects 70/30 weak/strong mix. PracticeConfig renders category cards with mastery rings.
  </verify>
  <done>
    Question selection algorithm implements 70/30 weak/strong mix with unanswered questions treated as weak. PracticeConfig shows category cards with mastery rings, segmented count selector, timer toggle, mastered category handling, and "Practice All Weak Areas" option. All text bilingual.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PracticeSession, PracticeResults, and PracticePage</name>
  <files>
    src/components/practice/PracticeSession.tsx,
    src/components/practice/PracticeResults.tsx,
    src/pages/PracticePage.tsx,
    src/AppShell.tsx,
    src/components/test/PreTestScreen.tsx
  </files>
  <action>
    1. **PracticeSession.tsx** - Practice test flow:
       - Props: `questions: Question[]`, `timerEnabled: boolean`, `onComplete: (results: QuestionResult[]) => void`
       - Reuses patterns from TestPage but simplified:
         - No pass/fail thresholds (practice mode)
         - Optional timer (20 min if enabled, hidden if not)
         - Same answer selection and feedback UX
         - WhyButton auto-appears (collapsed) after each answer (same as test mode, per CONTEXT.md: "Same as test mode")
         - Answer feedback with 1500ms auto-advance (paused if explanation expanded)
         - **Record answer to masteryStore:** In the answer selection handler (the `onAnswerSelect` or `handleAnswerClick` callback), immediately after determining correctness, call:
           ```typescript
           await recordAnswer({
             questionId: currentQuestion.id,
             isCorrect: selectedAnswer === currentQuestion.correctAnswer,
             sessionType: 'practice',
           });
           ```
           This must happen BEFORE advancing to the next question so mastery data is captured per-answer, not batched at end.
       - Progress bar showing current question / total
       - Navigation lock during practice (simplified - just beforeunload)
       - No retry option after finishing (per CONTEXT.md)

    2. **PracticeResults.tsx** - Post-practice review:
       - Props: `results: QuestionResult[]`, `categoryName: string`, `previousMastery: number`, `onDone: () => void`
       - **Score display:** CountUpScore component (reuse from celebrations)
       - **Review section:** Same as test review - filter toggle (incorrect/all), ExplanationCard per result
       - **Animated mastery update (per CONTEXT.md):**
         - Single CategoryRing showing mastery filling from `previousMastery` to new mastery %
         - Number counting up from old to new (use react-countup or manual animation)
         - Calculate new mastery using useCategoryMastery hook with refresh
       - **"Done" button** navigates back to practice config or dashboard
       - **No retry option** (per CONTEXT.md)

    3. **PracticePage.tsx** - Page managing the 3-screen flow:
       - State machine: 'config' -> 'session' -> 'results'
       - Config screen: PracticeConfig
       - Session screen: PracticeSession with selected questions
       - Results screen: PracticeResults with completed results
       - Track previousMastery before session starts for animated update
       - AppNavigation at top

    4. **Add /practice route to AppShell.tsx:**
       - Import PracticePage
       - Add protected route: `<Route path="/practice" element={<ProtectedRoute><PracticePage /></ProtectedRoute>} />`

    5. **Add category filter to PreTestScreen.tsx (entry point from test start):**
       - Per CONTEXT.md: "from test start screen (category filter with mini progress indicators per category)"
       - Add a "Practice by Category" link/section on PreTestScreen that links to /practice
       - Show mini CategoryRing indicators for each USCIS category on the pre-test screen
       - Keep existing "Start Test" as primary action
  </action>
  <verify>
    `npx tsc --noEmit` passes. Navigate to /practice - config screen shows. Select category and count, start practice. Answer questions with explanations. See results with animated mastery ring. PreTestScreen shows category practice link.
  </verify>
  <done>
    PracticeSession provides full practice flow with explanations, mastery recording, and optional timer. PracticeResults shows score, review, and animated mastery ring update. PracticePage manages config->session->results flow. /practice route registered. PreTestScreen links to practice by category.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /practice route works with config -> session -> results flow
3. Question selection uses 70/30 weak/strong mix
4. Practice answers recorded with sessionType: 'practice' to masteryStore
5. Post-practice shows animated mastery ring update
6. "Practice All Weak Areas" option works
7. Timer optional and off by default
8. Mastered category shows "already mastered" suggestion
9. PreTestScreen has category practice entry point
</verification>

<success_criteria>
- Complete practice mode flow: select category -> answer questions -> see results
- Smart question selection with 70/30 weak/strong mix
- Same explanation behavior as test mode (WhyButton after each answer)
- Animated mastery ring update on results screen
- Practice sessions tracked with sessionType: 'practice'
- No retry option after practice session
- Timer optional, off by default
- All text bilingual
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-learning-explanations-category-progress/04-08-SUMMARY.md`
</output>
