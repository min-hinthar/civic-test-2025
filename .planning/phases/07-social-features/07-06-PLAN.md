---
phase: 07-social-features
plan: 06
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/contexts/SocialContext.tsx
  - src/components/social/SocialOptInFlow.tsx
  - src/lib/social/streakSync.ts
  - src/lib/social/socialProfileSync.ts
  - src/components/social/SocialSettings.tsx
  - src/pages/SettingsPage.tsx
autonomous: true

must_haves:
  truths:
    - "Social opt-in flow presents bilingual privacy notice before enabling features"
    - "Combined flow: privacy notice + display name setup + confirm in one smooth dialog"
    - "Single toggle controls all social visibility (leaderboard, profile, display name)"
    - "Opt-out immediately hides user from leaderboard"
    - "Streak data syncs to Supabase for signed-in users"
    - "Display name editable from Settings page"
    - "Social opt-in state persists in Supabase social_profiles"
  artifacts:
    - path: "src/contexts/SocialContext.tsx"
      provides: "Social state provider"
      exports: ["SocialProvider", "useSocial"]
    - path: "src/components/social/SocialOptInFlow.tsx"
      provides: "Opt-in dialog flow"
      exports: ["SocialOptInFlow"]
    - path: "src/lib/social/streakSync.ts"
      provides: "Streak data Supabase sync"
      exports: ["syncStreakToSupabase", "loadStreakFromSupabase"]
    - path: "src/lib/social/socialProfileSync.ts"
      provides: "Social profile upsert"
      exports: ["upsertSocialProfile", "getSocialProfile", "updateCompositeScore"]
    - path: "src/components/social/SocialSettings.tsx"
      provides: "Settings page social section"
      exports: ["SocialSettings"]
  key_links:
    - from: "src/contexts/SocialContext.tsx"
      to: "src/lib/social/socialProfileSync.ts"
      via: "loads and saves social profile"
      pattern: "getSocialProfile|upsertSocialProfile"
    - from: "src/lib/social/streakSync.ts"
      to: "supabase/schema.sql"
      via: "reads/writes streak_data table"
      pattern: "streak_data"
    - from: "src/pages/SettingsPage.tsx"
      to: "src/components/social/SocialSettings.tsx"
      via: "rendered as settings section"
      pattern: "SocialSettings"
---

<objective>
Create the social context provider, opt-in flow, Supabase sync for streaks and profiles, and Settings page social section.

Purpose: This plan establishes the social identity layer — how users opt in, manage their display name, and sync their streak/score data to Supabase. It's the bridge between local-only data (Plan 01) and the shared leaderboard (Plan 07).
Output: SocialContext provider, opt-in dialog with privacy notice, streak/profile sync to Supabase, and Settings social section with display name and opt-in toggle.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-social-features/07-RESEARCH.md
@.planning/phases/07-social-features/07-01-SUMMARY.md
@.planning/phases/07-social-features/07-02-SUMMARY.md
@src/contexts/SupabaseAuthContext.tsx (auth context pattern)
@src/contexts/SRSContext.tsx (context provider pattern)
@src/pages/SettingsPage.tsx (settings page structure)
@src/lib/supabaseClient.ts (Supabase client)
@src/lib/social/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Supabase sync modules and SocialContext provider</name>
  <files>
    src/lib/social/streakSync.ts
    src/lib/social/socialProfileSync.ts
    src/contexts/SocialContext.tsx
  </files>
  <action>
    Create `src/lib/social/streakSync.ts`:

    1. `syncStreakToSupabase(userId: string, streakData: StreakData): Promise<void>` — Upsert streak data to `streak_data` table. Map StreakData fields to columns. Use supabaseClient.from('streak_data').upsert(). Skip silently if offline (fire-and-forget pattern from interviewSync.ts). Update lastSyncedAt in local IndexedDB after successful sync.

    2. `loadStreakFromSupabase(userId: string): Promise<StreakData | null>` — Load streak data from Supabase. Used on sign-in to merge cloud data with local. Return null if no data exists.

    3. `mergeStreakData(local: StreakData, remote: StreakData): StreakData` — Merge strategy: union of activityDates (deduplicated), max of freezesAvailable, union of freezesUsed, max of longestStreak. This handles the case where user studied on two devices.

    Create `src/lib/social/socialProfileSync.ts`:

    1. `getSocialProfile(userId: string): Promise<SocialProfile | null>` — Read from social_profiles table.

    2. `upsertSocialProfile(userId: string, data: { displayName: string; socialOptIn: boolean }): Promise<void>` — Upsert to social_profiles. Map camelCase to snake_case column names.

    3. `updateCompositeScore(userId: string, score: number, streak: number, topBadge: string | null): Promise<void>` — Update composite_score, current_streak, longest_streak, top_badge, weekly_score_updated_at fields. Called after activity completion.

    4. `toggleSocialOptIn(userId: string, optIn: boolean): Promise<void>` — Update social_opt_in field. When opting out (optIn=false), this immediately hides user from leaderboard (RLS handles visibility).

    5. Interface `SocialProfile`: `{ userId: string; displayName: string; socialOptIn: boolean; compositeScore: number; currentStreak: number; longestStreak: number; topBadge: string | null; isWeeklyWinner: boolean; createdAt: string; updatedAt: string }`.

    Create `src/contexts/SocialContext.tsx`:

    1. Context provider `SocialProvider` wrapping children.
    2. Consumes `useAuth()` to get current user.
    3. State: `socialProfile: SocialProfile | null`, `isOptedIn: boolean`, `displayName: string`, `isLoading: boolean`.
    4. On mount (when user is authenticated): load social profile from Supabase. If profile exists, set state. If not, defaults (not opted in, display name from auth user's full_name or email).
    5. On mount (when user is authenticated): sync streak data — call `loadStreakFromSupabase()`, merge with local via `mergeStreakData()`, save merged result to local IndexedDB.
    6. Expose functions:
       - `optIn(displayName: string): Promise<void>` — Calls upsertSocialProfile with socialOptIn=true, updates state.
       - `optOut(): Promise<void>` — Calls toggleSocialOptIn(false), updates state.
       - `updateDisplayName(name: string): Promise<void>` — Calls upsertSocialProfile, updates state.
       - `refreshProfile(): Promise<void>` — Reloads from Supabase.
    7. Export hook: `useSocial()` — `useContext(SocialContext)`.
    8. Place SocialProvider inside AuthProvider in the provider hierarchy (needs auth for user ID). Integration into AppShell will happen in Plan 08.
    9. When user is not authenticated, return defaults: isOptedIn=false, displayName='', and no-op functions.
    10. Follow existing context patterns from SRSContext.tsx.
  </action>
  <verify>TypeScript compiles. SocialContext exports useSocial hook. Sync functions handle offline gracefully.</verify>
  <done>Streak syncs to Supabase on sign-in with merge strategy. Social profile manages opt-in state and display name. SocialContext provides reactive social state.</done>
</task>

<task type="auto">
  <name>Task 2: Social opt-in flow dialog and Settings section</name>
  <files>
    src/components/social/SocialOptInFlow.tsx
    src/components/social/SocialSettings.tsx
    src/pages/SettingsPage.tsx
  </files>
  <action>
    Create `src/components/social/SocialOptInFlow.tsx`:

    1. Props: `open: boolean; onComplete: () => void; onCancel: () => void`.
    2. Multi-step flow in a single Radix Dialog:

    **Step 1 - Privacy Notice:**
    - Bilingual heading: "Social Features" / "လူမှုရေးလုပ်ဆောင်ချက်များ"
    - Explanation of what's shared:
      - EN: "By enabling social features, your display name and scores will be visible on the leaderboard. You can disable this at any time from Settings."
      - MY: "လူမှုရေးလုပ်ဆောင်ချက်များကို ဖွင့်ခြင်းဖြင့် သင့်ပြသမည့်အမည်နှင့် ရမှတ်များကို ဦးဆောင်ဘုတ်တွင် မြင်ရပါမည်။ Settings မှ အချိန်မရွေး ပိတ်နိုင်ပါသည်။"
    - Continue button to step 2.

    **Step 2 - Display Name Setup:**
    - Text input for display name, pre-filled with auth user's full_name.
    - Bilingual label: "Display Name" / "ပြသမည့်အမည်"
    - Bilingual hint: "This name will appear on the leaderboard" / "ဤအမည်သည် ဦးဆောင်ဘုတ်တွင် ပေါ်လာပါမည်"
    - Character limit hint (e.g., 2-30 characters).
    - Validation: non-empty, 2-30 chars.

    **Step 3 - Confirm:**
    - Summary: "You're all set! Your profile will appear on the leaderboard."
    - Bilingual confirm button: "Enable Social Features" / "လူမှုရေးလုပ်ဆောင်ချက်များ ဖွင့်ပါ"
    - On confirm: call `useSocial().optIn(displayName)`.

    3. Step navigation via local state (step 1/2/3). Back button on steps 2-3.
    4. Cancel/dismiss closes dialog without opting in.
    5. Smooth step transitions with motion/react AnimatePresence.

    Create `src/components/social/SocialSettings.tsx`:

    1. Self-contained settings section component (not a page).
    2. Shows:
       - Section heading: "Social Features" / "လူမှုရေးလုပ်ဆောင်ချက်များ" with Users icon.
       - Opt-in toggle: switch/checkbox that controls social visibility. Uses `useSocial().optIn/optOut`.
       - Display name field: editable text input, saves on blur or Enter. Uses `useSocial().updateDisplayName`.
       - Status text: "Your profile is visible on the leaderboard" or "Your profile is private" with bilingual translation.
    3. If not authenticated, show message: "Sign in to enable social features" / bilingual.
    4. Uses Card + CardContent pattern matching other Settings sections.

    Update `src/pages/SettingsPage.tsx`:

    1. Import and render `<SocialSettings />` as a new section.
    2. Place it between the Notifications section and the Review Reminders section (per research discretion recommendation).
    3. Add Users icon import from lucide-react.
  </action>
  <verify>TypeScript compiles. SocialOptInFlow renders 3-step dialog. SocialSettings renders in SettingsPage with toggle and display name.</verify>
  <done>Opt-in flow presents bilingual privacy notice in 3 steps. Settings page has social section with opt-in toggle and editable display name. Opt-out immediately hides from leaderboard.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. SocialContext provides useSocial() hook with opt-in state
3. Opt-in flow has 3 steps: privacy notice → display name → confirm
4. All text is bilingual
5. Settings page shows social section with toggle and display name
6. Streak sync merges local and remote data correctly
7. Opt-out calls toggleSocialOptIn(false)
</verification>

<success_criteria>
- Privacy notice clearly explains what's shared and how to withdraw (locked decision)
- Combined flow is smooth (privacy + name + confirm in one dialog)
- Single toggle controls all social visibility (locked decision)
- Opt-out immediately removes from leaderboard (locked decision)
- Streak data syncs bidirectionally on sign-in
- Display name editable from Settings
- Context works for both authenticated and unauthenticated users
</success_criteria>

<output>
After completion, create `.planning/phases/07-social-features/07-06-SUMMARY.md`
</output>
