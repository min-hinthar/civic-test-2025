---
phase: 20-session-persistence
plan: 04
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/components/sessions/UnfinishedBanner.tsx
  - src/components/navigation/navConfig.ts
  - src/components/navigation/useNavBadges.ts
  - src/pages/Dashboard.tsx
  - src/components/AppShell.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows amber banner card at top when unfinished sessions exist"
    - "Banner shows session type and relative timestamp"
    - "Banner is dismissible via X button, returns on next dashboard visit"
    - "Tapping banner navigates to the relevant test/practice/interview page"
    - "Nav tabs show number badges for unfinished session counts"
    - "Expired sessions are cleaned on app startup"
  artifacts:
    - path: "src/components/sessions/UnfinishedBanner.tsx"
      provides: "Amber banner card for dashboard showing unfinished session teasers"
      exports: ["UnfinishedBanner"]
    - path: "src/components/navigation/navConfig.ts"
      provides: "Extended NavBadges interface with session count badges"
      contains: "testSessionCount"
    - path: "src/components/navigation/useNavBadges.ts"
      provides: "Extended badge hook that includes session counts from IndexedDB"
      contains: "getAllSessions"
  key_links:
    - from: "src/components/sessions/UnfinishedBanner.tsx"
      to: "src/lib/sessions/sessionStore.ts"
      via: "Uses getAllSessions to check for unfinished sessions"
      pattern: "import.*getAllSessions"
    - from: "src/components/sessions/UnfinishedBanner.tsx"
      to: "react-router-dom"
      via: "useNavigate to navigate to relevant page on banner tap"
      pattern: "useNavigate"
    - from: "src/components/navigation/useNavBadges.ts"
      to: "src/lib/sessions/sessionStore.ts"
      via: "getAllSessions for badge counts"
      pattern: "import.*getAllSessions"
    - from: "src/components/AppShell.tsx"
      to: "src/lib/sessions/sessionStore.ts"
      via: "cleanExpiredSessions on startup"
      pattern: "cleanExpiredSessions"
---

<objective>
Add dashboard unfinished session banners, extend nav badges to show session counts, and wire up session cleanup on app startup.

Purpose: Users see a clear visual indicator on the dashboard when they have unfinished sessions, and nav badges remind them which pages have saved sessions waiting. Expired sessions are cleaned automatically.

Output: New UnfinishedBanner component, extended nav badge system, updated Dashboard and AppShell.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-session-persistence/20-RESEARCH.md
@.planning/phases/20-session-persistence/20-CONTEXT.md
@.planning/phases/20-session-persistence/20-01-SUMMARY.md
@src/pages/Dashboard.tsx
@src/components/navigation/navConfig.ts
@src/components/navigation/useNavBadges.ts
@src/components/AppShell.tsx
@src/components/dashboard/NBAHeroCard.tsx
@src/lib/sessions/sessionStore.ts
@src/lib/sessions/timeAgo.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: UnfinishedBanner component and Dashboard integration</name>
  <files>src/components/sessions/UnfinishedBanner.tsx, src/pages/Dashboard.tsx</files>
  <action>
Create `src/components/sessions/UnfinishedBanner.tsx`:

**Props:**
```typescript
interface UnfinishedBannerProps {
  sessions: SessionSnapshot[];
  onDismiss: (sessionId: string) => void;
}
```

**Visual design (per user decisions):**

1. **Card for each session** (amber/orange accent):
   - Use `motion.div` with slide-in entrance: `initial={{ opacity: 0, y: -20 }}`, `animate={{ opacity: 1, y: 0 }}`
   - Exit animation (on dismiss): `exit={{ opacity: 0, x: -100 }}` with `AnimatePresence`
   - Wrap each card in `AnimatePresence` for dismiss animation

2. **Card styling:**
   - `rounded-2xl border border-warning/30 bg-warning-subtle/10 p-4 cursor-pointer`
   - Hover: `hover:bg-warning-subtle/20 transition-colors`
   - Layout: flex row with icon left, text center, X button right

3. **Icon per session type:**
   - mock-test: `ClipboardCheck` in `text-warning`
   - practice: `BookOpen` in `text-warning`
   - interview: `Mic` in `text-warning`
   - Wrapped in a `h-10 w-10 rounded-xl bg-warning/10 flex items-center justify-center`
   - Also show a small `Clock` icon next to the text for time context

4. **Text content (minimal teaser per user decision):**
   - Session type name (bilingual): "Unfinished Mock Test" / "Unfinished Practice" / "Unfinished Interview"
   - Relative timestamp from `timeAgo(session.savedAt)` -- bilingual based on language mode
   - Burmese: "မပြီးဆုံးသေးသော စမ်းသပ်စာမေးပွဲ", "မပြီးဆုံးသေးသော လေ့ကျင့်ခန်း", "မပြီးဆုံးသေးသော အင်တာဗျူး"
   - Format: "Unfinished Mock Test — 2 hours ago"

5. **Dismiss button:**
   - Small X button (lucide `X` icon) at top-right of card
   - `onClick` with `e.stopPropagation()` (prevent card click navigation)
   - Calls `onDismiss(session.id)` which hides the banner for this dashboard visit

6. **Card click navigation:**
   - Use `useNavigate()` from react-router-dom
   - mock-test: navigate to `/test`
   - practice: navigate to `/test` (practice is accessed via test nav, or `/practice` if that route exists -- check routing)
   - interview: navigate to `/interview`
   - Light haptic feedback on click: `navigator.vibrate?.(10)` in try/catch

7. **Bilingual:** Use `useLanguage()` for `showBurmese`

**Update `src/pages/Dashboard.tsx`:**

1. Import `UnfinishedBanner` and `useSessionPersistence` hook
2. Call `useSessionPersistence()` (no type filter -- gets all sessions) at the top of the Dashboard component
3. Track dismissed session IDs in local state: `const [dismissedIds, setDismissedIds] = useState<Set<string>>(new Set())`
4. Filter sessions: `const visibleSessions = sessions.filter(s => !dismissedIds.has(s.id))`
5. Add `UnfinishedBanner` as the FIRST `StaggeredItem` in the `StaggeredList`, ABOVE the NBA card:
   ```tsx
   {visibleSessions.length > 0 && (
     <StaggeredItem className="mb-6">
       <UnfinishedBanner
         sessions={visibleSessions}
         onDismiss={(id) => setDismissedIds(prev => new Set([...prev, id]))}
       />
     </StaggeredItem>
   )}
   ```
6. The dismissed state is local (not persisted) -- banner returns on next dashboard visit per user decision
  </action>
  <verify>
`npm run typecheck` passes. `npm run lint` passes. Dashboard renders banners above NBA card when sessions exist. Banners dismiss with animation. Click navigates to correct page.
  </verify>
  <done>
UnfinishedBanner shows amber cards for each unfinished session with type icon, name, and relative timestamp. Cards are dismissible (per-visit only). Click navigates to relevant page. Dashboard integrates banners above NBA card in StaggeredList.
  </done>
</task>

<task type="auto">
  <name>Task 2: Nav badge extension and startup cleanup</name>
  <files>src/components/navigation/navConfig.ts, src/components/navigation/useNavBadges.ts, src/components/AppShell.tsx</files>
  <action>
**Update `src/components/navigation/navConfig.ts`:**

1. Extend `NavBadges` interface with two new optional number fields:
   ```typescript
   export interface NavBadges {
     studyDueCount: number;
     hubHasUpdate: boolean;
     settingsHasUpdate: boolean;
     testSessionCount: number;      // NEW: unfinished test/practice sessions
     interviewSessionCount: number;  // NEW: unfinished interview sessions
   }
   ```

2. Add `badgeKey` to the test and interview nav tabs:
   - Test tab (`id: 'test'`): add `badgeKey: 'testSessionCount'`
   - Interview tab (`id: 'interview'`): add `badgeKey: 'interviewSessionCount'`

**Update `src/components/navigation/useNavBadges.ts`:**

1. Import `getAllSessions` from `@/lib/sessions/sessionStore`
2. Add state for session counts:
   ```typescript
   const [testSessionCount, setTestSessionCount] = useState(0);
   const [interviewSessionCount, setInterviewSessionCount] = useState(0);
   ```
3. Inside the existing `runCheck` function, add a session count check:
   ```typescript
   getAllSessions().then(sessions => {
     if (!cancelled) {
       setTestSessionCount(sessions.filter(s => s.type === 'mock-test' || s.type === 'practice').length);
       setInterviewSessionCount(sessions.filter(s => s.type === 'interview').length);
     }
   });
   ```
4. Add the new counts to the return value:
   ```typescript
   return {
     studyDueCount: dueCount,
     hubHasUpdate,
     settingsHasUpdate,
     testSessionCount,
     interviewSessionCount,
   };
   ```

NOTE: The existing Sidebar and BottomTabBar components already read `badgeKey` from navConfig and display badges. They use `badges[tab.badgeKey]` which handles both number (shows count) and boolean (shows dot) values. Verify that the badge rendering logic handles numbers correctly (it should, since `studyDueCount` is already a number). The rendering code likely uses something like `badges[tab.badgeKey] ? <Badge>...</Badge> : null` which works for both truthy numbers and booleans.

**Update `src/components/AppShell.tsx`:**

1. Import `cleanExpiredSessions` from `@/lib/sessions/sessionStore`
2. Add a `useEffect` near the other initialization effects that calls `cleanExpiredSessions()` on mount:
   ```typescript
   useEffect(() => {
     cleanExpiredSessions().catch(() => {
       // IndexedDB not available
     });
   }, []);
   ```
3. This runs once on app startup to clean any sessions older than 24 hours

This is a minimal change -- just add the effect. Don't modify any other AppShell logic.
  </action>
  <verify>
`npm run typecheck` passes. `npm run lint` passes. Nav badges show counts for test and interview tabs when sessions exist. AppShell calls cleanExpiredSessions on mount.
  </verify>
  <done>
NavBadges interface extended with testSessionCount and interviewSessionCount. useNavBadges hook fetches session counts from IndexedDB. Test and interview nav tabs have badgeKey configured. AppShell cleans expired sessions on startup.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes for all modified files
2. `npm run lint` passes
3. Dashboard shows amber banners above NBA card when unfinished sessions exist
4. Banners are dismissible and return on next visit
5. Banner click navigates to correct page
6. Nav badges show session counts on test and interview tabs
7. Expired sessions are cleaned on app startup
8. All text is bilingual following language mode
</verification>

<success_criteria>
- UnfinishedBanner renders correctly in Dashboard above NBA card (SESS-06)
- Banner shows type, timestamp, dismiss button, and navigates on click
- Nav badges show counts for test/interview when sessions exist
- cleanExpiredSessions runs on app startup (SESS-04 enforcement)
- No regressions to existing dashboard or nav functionality
</success_criteria>

<output>
After completion, create `.planning/phases/20-session-persistence/20-04-SUMMARY.md`
</output>
