---
phase: 13-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - middleware.ts
  - pages/_document.tsx
  - next.config.mjs
autonomous: true

must_haves:
  truths:
    - "Every page response includes a Content-Security-Policy header with nonce-based script-src"
    - "The inline theme script in _document.tsx has a nonce attribute and executes without CSP violation"
    - "Google Sign-In (accounts.google.com) is allowlisted in script-src and frame-src"
    - "Supabase API calls work (connect-src includes *.supabase.co)"
    - "Sentry error reporting works (connect-src includes *.ingest.us.sentry.io)"
    - "Service worker registration works (worker-src 'self')"
    - "CSP violations are reported to Sentry via report-uri directive"
    - "upgrade-insecure-requests directive is present"
    - "form-action and base-uri restricted to 'self'"
  artifacts:
    - path: "middleware.ts"
      provides: "CSP nonce generation and header injection"
      contains: "Content-Security-Policy"
    - path: "pages/_document.tsx"
      provides: "Nonce-aware document with theme script"
      contains: "nonce"
    - path: "next.config.mjs"
      provides: "Supplementary security headers"
      contains: "X-Content-Type-Options"
  key_links:
    - from: "middleware.ts"
      to: "pages/_document.tsx"
      via: "x-nonce request header read in getInitialProps"
      pattern: "x-nonce"
    - from: "middleware.ts"
      to: "response headers"
      via: "Content-Security-Policy header set on every response"
      pattern: "Content-Security-Policy"
---

<objective>
Add Content Security Policy headers with nonce-based inline script protection, covering all external origins used by the app (Google Sign-In, Supabase, Sentry, Google Fonts, service worker).

Purpose: The app currently has zero CSP headers, leaving it vulnerable to XSS injection, clickjacking via iframes, and protocol downgrade attacks. CSP is the primary browser-side defense against XSS.

Output: middleware.ts (CSP nonce generation), updated _document.tsx (nonce-aware), updated next.config.mjs (supplementary security headers).
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@pages/_document.tsx
@next.config.mjs
@src/components/GoogleOneTapSignIn.tsx
@src/lib/pwa/sw.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSP middleware and convert _document.tsx to nonce-aware class component</name>
  <files>middleware.ts, pages/_document.tsx</files>
  <action>
**Create `middleware.ts` in project root (next to next.config.mjs):**

1. Import `NextRequest`, `NextResponse` from `next/server`.
2. Generate a nonce per request: `const nonce = Buffer.from(crypto.randomUUID()).toString('base64')`.
3. Build the CSP header string with these directives (all on one line, semicolon-separated):
   - `default-src 'self'`
   - `script-src 'self' 'nonce-${nonce}' https://accounts.google.com`
   - `style-src 'self' 'unsafe-inline' https://fonts.googleapis.com` (unsafe-inline required for Tailwind + motion/react inline styles)
   - `img-src 'self' blob: data:` (blob for ShareCardPreview canvas export, data: for SVG noise textures)
   - `font-src 'self' https://fonts.gstatic.com`
   - `connect-src 'self' https://*.supabase.co https://*.ingest.us.sentry.io`
   - `worker-src 'self'`
   - `frame-src https://accounts.google.com` (for Google One Tap iframe)
   - `frame-ancestors 'none'` (app is never embedded in iframes)
   - `object-src 'none'`
   - `base-uri 'self'`
   - `form-action 'self'`
   - `upgrade-insecure-requests`
   - `report-uri https://o4507212955254784.ingest.us.sentry.io/api/4510406083346432/security/?sentry_key=c957cad31df16711843d5241cb2d6515`
4. Clean up whitespace: `.replace(/\s{2,}/g, ' ').trim()`.
5. Set `x-nonce` on the request headers (for _document.tsx to read).
6. Set `Content-Security-Policy` on both request and response headers.
7. Return `NextResponse.next({ request: { headers: requestHeaders } })` with CSP on the response.
8. Export a `config` object with `matcher` that covers all pages but excludes static files and API routes that don't serve HTML: `matcher: ['/((?!api|_next/static|_next/image|favicon.ico|icons|manifest.json|sw.js|offline.html).*)']`.

**IMPORTANT:** The Serwist/Sentry middleware wrapping in next.config.mjs should NOT conflict with this middleware.ts -- Next.js middleware.ts runs as edge middleware on requests, while next.config.mjs wraps are build-time config. They coexist.

**Convert `pages/_document.tsx` to a class component with nonce support:**

1. Import `Document, DocumentContext, Html, Head, Main, NextScript` from `next/document`.
2. Keep the `THEME_SCRIPT` constant as-is.
3. Create class `MyDocument extends Document<{ nonce?: string }>`.
4. Add `static async getInitialProps(ctx: DocumentContext)`:
   - Call `const initialProps = await Document.getInitialProps(ctx)`.
   - Extract nonce: `const nonce = ctx.req?.headers?.['x-nonce'] as string | undefined`.
   - Return `{ ...initialProps, nonce }`.
5. In `render()`:
   - Destructure `const { nonce } = this.props`.
   - Apply `nonce` to the `<Head>` component: `<Head nonce={nonce}>`.
   - Apply `nonce` to the inline theme script: `<script nonce={nonce} dangerouslySetInnerHTML={{ __html: THEME_SCRIPT }} />`.
   - Apply `nonce` to `<NextScript nonce={nonce} />`.
6. Keep all existing `<meta>` and `<link>` tags (manifest, theme-color, apple PWA tags).
7. Export `MyDocument` as default.
  </action>
  <verify>
1. Read `middleware.ts` and confirm: CSP header string contains all required directives (script-src with nonce, connect-src with supabase and sentry, frame-src with google, upgrade-insecure-requests, report-uri, form-action 'self', base-uri 'self').
2. Read `pages/_document.tsx` and confirm: class component with getInitialProps reading x-nonce, nonce applied to script tag, Head, and NextScript.
3. Run `pnpm run typecheck` to verify TypeScript compiles.
4. Run `pnpm run build` to verify the middleware doesn't break the build (middleware + Serwist + Sentry config coexist).
  </verify>
  <done>
- middleware.ts exists in project root with CSP nonce generation
- _document.tsx is a class component with getInitialProps reading x-nonce header
- Inline theme script has nonce attribute
- NextScript has nonce attribute
- CSP allows: self, nonce for scripts, accounts.google.com for scripts+frames, supabase+sentry for connect, fonts.googleapis.com for styles, fonts.gstatic.com for fonts, worker-src self
- CSP blocks: object-src none, frame-ancestors none
- CSP enforces: upgrade-insecure-requests, form-action self, base-uri self
- CSP reports: report-uri points to Sentry
  </done>
</task>

<task type="auto">
  <name>Task 2: Add supplementary security headers in next.config.mjs</name>
  <files>next.config.mjs</files>
  <action>
Add a `headers()` async function to `nextConfig` in `next.config.mjs` that sets supplementary security headers on all routes:

```javascript
async headers() {
  return [
    {
      source: '/(.*)',
      headers: [
        { key: 'X-Content-Type-Options', value: 'nosniff' },
        { key: 'X-Frame-Options', value: 'DENY' },
        { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
        { key: 'Permissions-Policy', value: 'camera=(), microphone=(), geolocation=()' },
        { key: 'X-DNS-Prefetch-Control', value: 'on' },
      ],
    },
  ];
},
```

**These headers complement the CSP set in middleware.ts:**
- `X-Content-Type-Options: nosniff` -- prevents MIME type sniffing
- `X-Frame-Options: DENY` -- legacy iframe protection (CSP frame-ancestors is the modern version, but X-Frame-Options provides fallback for older browsers)
- `Referrer-Policy: strict-origin-when-cross-origin` -- limits referrer leakage
- `Permissions-Policy` -- disables camera/microphone/geolocation (not used by this app)
- `X-DNS-Prefetch-Control: on` -- allows DNS prefetching for linked origins

**DO NOT** set CSP in next.config.mjs headers -- it's handled by middleware.ts with per-request nonces. Setting it in both places would create conflicting headers.

Keep the existing `reactStrictMode`, `experimental.optimizePackageImports`, Sentry config, and Serwist config unchanged.
  </action>
  <verify>
1. Read `next.config.mjs` and confirm: headers() function exists with all 5 security headers.
2. Confirm CSP is NOT set in next.config.mjs (it's in middleware.ts only).
3. Run `pnpm run build` to verify build succeeds with the new headers config.
  </verify>
  <done>
- next.config.mjs has headers() function with X-Content-Type-Options, X-Frame-Options, Referrer-Policy, Permissions-Policy, X-DNS-Prefetch-Control
- CSP is only in middleware.ts (not duplicated in next.config.mjs)
- Build succeeds
  </done>
</task>

</tasks>

<verification>
1. `pnpm run typecheck` passes
2. `pnpm run build` succeeds
3. `middleware.ts` exists in project root
4. CSP header includes all required directives: script-src with nonce, connect-src with supabase and sentry, worker-src self, frame-ancestors none, upgrade-insecure-requests, report-uri to Sentry
5. _document.tsx uses nonce on inline script and NextScript
6. next.config.mjs has supplementary security headers
</verification>

<success_criteria>
- Every page response includes Content-Security-Policy header
- Nonce-based CSP protects against inline script injection
- Google Sign-In, Supabase, Sentry, Google Fonts, and service worker all allowlisted
- Supplementary security headers (X-Content-Type-Options, X-Frame-Options, etc.) set on all responses
- CSP violations reported to Sentry
</success_criteria>

<output>
After completion, create `.planning/phases/13-security-hardening/13-02-SUMMARY.md`
</output>
