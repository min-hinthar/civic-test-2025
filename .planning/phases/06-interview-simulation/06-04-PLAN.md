---
phase: 06-interview-simulation
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - src/components/interview/InterviewSession.tsx
  - src/components/interview/InterviewTimer.tsx
  - src/components/interview/SelfGradeButtons.tsx
  - src/components/interview/AnswerReveal.tsx
  - src/components/interview/AudioWaveform.tsx
  - src/pages/InterviewPage.tsx
autonomous: true

must_haves:
  truths:
    - "User hears questions read aloud via TTS with chime before each"
    - "Question text fades in AFTER TTS finishes reading"
    - "User can replay a question up to 2 times with replay count shown"
    - "Microphone recording starts automatically after TTS finishes"
    - "Live audio waveform visualization shows while recording"
    - "Realistic mode: 15-second shrinking progress bar auto-reveals answer"
    - "Practice mode: user taps Show Answer to reveal"
    - "Answer reveals primary answer and also-accepted alternatives"
    - "Correct answer is read aloud via TTS after reveal"
    - "Self-grade buttons (Correct/Incorrect) appear with grade feedback flash"
    - "Realistic mode auto-advances after grading, stops at pass/fail threshold"
    - "Practice mode includes WhyButton and AddToDeckButton on reveal"
    - "Interviewer greeting plays via TTS before first question"
    - "Session produces InterviewResult array on completion"
  artifacts:
    - path: "src/components/interview/InterviewSession.tsx"
      provides: "Core interview session flow orchestrator"
      exports: ["InterviewSession"]
    - path: "src/components/interview/InterviewTimer.tsx"
      provides: "Subtle shrinking progress bar for realistic mode"
      exports: ["InterviewTimer"]
    - path: "src/components/interview/SelfGradeButtons.tsx"
      provides: "Correct/Incorrect binary grading buttons"
      exports: ["SelfGradeButtons"]
    - path: "src/components/interview/AnswerReveal.tsx"
      provides: "Answer display with primary + alternatives"
      exports: ["AnswerReveal"]
    - path: "src/components/interview/AudioWaveform.tsx"
      provides: "Canvas-based live waveform visualization"
      exports: ["AudioWaveform"]
  key_links:
    - from: "src/components/interview/InterviewSession.tsx"
      to: "src/hooks/useInterviewTTS.ts"
      via: "speakWithCallback for TTS sequencing"
      pattern: "speakWithCallback"
    - from: "src/components/interview/InterviewSession.tsx"
      to: "src/hooks/useAudioRecorder.ts"
      via: "startRecording/stopRecording for mic capture"
      pattern: "startRecording|stopRecording"
    - from: "src/components/interview/InterviewSession.tsx"
      to: "src/lib/interview/audioChime.ts"
      via: "playChime before each question"
      pattern: "playChime"
    - from: "src/components/interview/InterviewSession.tsx"
      to: "src/lib/interview/interviewGreetings.ts"
      via: "getRandomGreeting for TTS intro"
      pattern: "getRandomGreeting"
    - from: "src/pages/InterviewPage.tsx"
      to: "src/components/interview/InterviewSession.tsx"
      via: "renders during session phase"
      pattern: "InterviewSession"
---

<objective>
Build the core interview session flow -- the heart of the interview simulation feature.

Purpose: This is the main interactive experience where users hear questions, respond verbally, review recordings, reveal answers, and self-grade. The session orchestrates TTS, recording, timers, and grading into a seamless interview simulation with distinct behaviors for Realistic and Practice modes.

Output: InterviewSession component with full question flow, plus supporting components (timer, grade buttons, answer reveal, waveform).
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-interview-simulation/06-CONTEXT.md
@.planning/phases/06-interview-simulation/06-RESEARCH.md
@.planning/phases/06-interview-simulation/06-01-SUMMARY.md
@.planning/phases/06-interview-simulation/06-02-SUMMARY.md
@.planning/phases/06-interview-simulation/06-03-SUMMARY.md

@src/hooks/useInterviewTTS.ts
@src/hooks/useAudioRecorder.ts
@src/lib/interview/audioChime.ts
@src/lib/interview/interviewGreetings.ts
@src/types/index.ts
@src/constants/questions/index.ts
@src/lib/shuffle.ts
@src/components/explanations/WhyButton.tsx
@src/components/srs/AddToDeckButton.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Supporting components (Timer, SelfGrade, AnswerReveal, AudioWaveform)</name>
  <files>
    src/components/interview/InterviewTimer.tsx
    src/components/interview/SelfGradeButtons.tsx
    src/components/interview/AnswerReveal.tsx
    src/components/interview/AudioWaveform.tsx
  </files>
  <action>
    1. **InterviewTimer** (`src/components/interview/InterviewTimer.tsx`):
       - Props: `duration: number` (seconds, default 15), `onExpired: () => void`, `isActive: boolean`
       - Renders a subtle horizontal progress bar that shrinks from 100% to 0% over `duration` seconds
       - Uses CSS transition or motion/react for smooth animation (NOT a visible number per user decision)
       - Bar color: primary-500 at start, transitions to warning-500 in last 3 seconds
       - Height: 4px, full width, rounded
       - When reaches 0, calls onExpired
       - When isActive=false, bar is hidden or paused
       - Internal state: timeRemaining tracked via setInterval (1 second ticks)
       - Cleanup: clear interval on unmount
       - Respect reduced motion: still functional but no color transition animation

    2. **SelfGradeButtons** (`src/components/interview/SelfGradeButtons.tsx`):
       - Props: `onGrade: (grade: 'correct' | 'incorrect') => void`, `disabled?: boolean`
       - Two buttons side by side:
         - "Correct" (checkmark icon + bilingual text from strings.interview.correct) - success-500 bg
         - "Incorrect" (X icon + bilingual text from strings.interview.incorrect) - warning-500 bg
       - Buttons have press animation (scale down slightly via motion/react)
       - When clicked: brief colored flash on the entire container (0.5s) using motion/react
         - Correct: green flash
         - Incorrect: orange flash
       - Disabled state: opacity-50, pointer-events-none

    3. **AnswerReveal** (`src/components/interview/AnswerReveal.tsx`):
       - Props: `question: Question`, `audioURL: string | null`, `mode: InterviewMode`, `onPlayRecording?: () => void`
       - Shows primary correct answer prominently (first studyAnswer from question.studyAnswers)
       - If question has multiple studyAnswers, show "Also accepted:" section with remaining answers (bilingual text for each)
       - If audioURL is not null, show "Your Recording" play button that creates an Audio element and plays the blob
       - If mode is 'practice': show WhyButton component (compact mode) and AddToDeckButton (compact mode)
       - Bilingual text throughout (English + Burmese using BilingualText)
       - Clean card-like layout using Card component

    4. **AudioWaveform** (`src/components/interview/AudioWaveform.tsx`):
       - Props: `stream: MediaStream | null`, `isActive: boolean`
       - Canvas-based real-time waveform visualization per research pattern
       - When stream is available and isActive:
         - Create AudioContext and AnalyserNode
         - Create MediaStreamSource from stream
         - Connect source -> analyser
         - Set fftSize to 256
         - Use requestAnimationFrame loop to draw waveform on canvas
         - Waveform line color: primary-500
         - Canvas size: full width, 48px height
       - When isActive=false or stream is null: show a flat line or static wave icon
       - Cleanup: cancel animation frame, close AudioContext on unmount
       - Handle refs properly: canvas ref accessed only in effects, not render
       - If stream is null (no mic permission): render a mic-off icon with text "Recording unavailable"
  </action>
  <verify>Run `npx tsc --noEmit`. Each component should compile without errors. Verify exports are correct.</verify>
  <done>Four supporting components created: InterviewTimer (shrinking bar), SelfGradeButtons (correct/incorrect with flash), AnswerReveal (primary + alternatives + recording playback + WhyButton/AddToDeck for practice), AudioWaveform (canvas waveform or graceful fallback).</done>
</task>

<task type="auto">
  <name>Task 2: InterviewSession orchestrator and InterviewPage integration</name>
  <files>
    src/components/interview/InterviewSession.tsx
    src/pages/InterviewPage.tsx
  </files>
  <action>
    1. Create `src/components/interview/InterviewSession.tsx`:
       - Props: `mode: InterviewMode`, `onComplete: (results: InterviewResult[], durationSeconds: number, endReason: InterviewEndReason) => void`, `micPermission: boolean`
       - **Question preparation**: On mount, select 20 random questions using `fisherYatesShuffle(allQuestions).slice(0, 20)`. Store in state.
       - **Session state**:
         - currentIndex: number (0-19)
         - results: InterviewResult[]
         - correctCount, incorrectCount: number
         - questionPhase: 'greeting' | 'chime' | 'reading' | 'responding' | 'revealing' | 'grading' | 'transition'
         - replaysUsed: number (per question, reset each question)
         - textVisible: boolean (false until TTS finishes reading)
         - startTime: number (Date.now() captured at session start)

       - **Flow per question** (orchestrated via questionPhase state transitions):
         a. `chime`: Play chime via playChime(), wait 200ms, transition to 'reading'
         b. `reading`: Show question number (e.g., "Question 3 of 20") and InterviewerAvatar (speaking=true). Call speakWithCallback with question text (English). On TTS end: set textVisible=true, set InterviewerAvatar speaking=false. If mic permission: start recording. Transition to 'responding'.
         c. `responding`:
            - Show question text with fade-in animation (motion/react, opacity 0->1, only if textVisible)
            - Show Burmese translation if user language toggle is on (uses useLanguage)
            - Show replay button with count (e.g., "Replay (1/2)"). Replay: stop recording, play TTS again with 1s pause before, increment replaysUsed, auto-start recording again after replay TTS ends.
            - Show AudioWaveform if recording
            - **Realistic mode**: InterviewTimer starts (15 seconds). On expired: stop recording, transition to 'revealing'
            - **Practice mode**: Show "Show Answer" button. On click: stop recording, transition to 'revealing'
         d. `revealing`: Stop recording if active. Show AnswerReveal component. Read correct answer aloud via TTS (English). Show SelfGradeButtons immediately (don't wait for answer TTS). InterviewerAvatar speaking=true during answer TTS.
         e. `grading`: User clicks Correct or Incorrect.
            - Record result to results array (InterviewResult)
            - Update correctCount or incorrectCount
            - Show grade feedback flash (handled by SelfGradeButtons)
            - Clear recording (revoke blob URL)
            - **Check thresholds (realistic mode only)**:
              - If correctCount >= 12: endReason='passThreshold', call onComplete
              - If incorrectCount >= 9: endReason='failThreshold', call onComplete
            - If more questions remain: wait 1.5 seconds (transition timing), advance to next question (reset replaysUsed, textVisible, questionPhase='chime')
            - If all 20 answered: endReason='complete', call onComplete

       - **Greeting flow** (before first question):
         - On mount, set questionPhase='greeting'
         - Show InterviewerAvatar (speaking=true)
         - Call speakWithCallback with getRandomGreeting()
         - On TTS end: wait 1 second, transition to first question (questionPhase='chime')

       - **Practice mode quit**:
         - If mode='practice', show a small "End Interview" button (top-right or bottom)
         - On click: show confirmation dialog (use existing Dialog component)
         - On confirm: stop recording, save answered questions to mastery via recordAnswer() for each result, call onComplete with endReason='quit'
         - **Claude's discretion**: Don't save partial sessions to Supabase (partial interviews aren't meaningful for trend tracking), but DO record individual answers to mastery system

       - **Realistic mode**: Hide progress bar, hide running score, show only question number. Navigation locked.
       - **Practice mode**: Show progress bar (question X of 20), show running score (correct: N), allow quit.

       - Layout: centered content, InterviewerAvatar at top, question area in middle, controls at bottom

    2. Update `src/pages/InterviewPage.tsx`:
       - Replace session placeholder with actual InterviewSession component
       - Pass mode, micPermission (from setup), and onComplete handler
       - onComplete: store results and durationSeconds in state, set phase='results'
       - Track micPermission state from InterviewSetup's permission request
  </action>
  <verify>Run `npx tsc --noEmit`. Navigate to /interview, select a mode, go through countdown. Verify greeting TTS plays, questions are read aloud, chime sounds before questions, text fades in after TTS, recording starts if mic allowed, timer works in realistic mode, Show Answer works in practice mode, self-grading works, thresholds stop realistic mode, practice mode shows WhyButton/AddToDeck.</verify>
  <done>Full interview session flow works for both modes: TTS reads questions with chime, text fades in after audio, recording captures responses, timer/manual reveal, self-grading with feedback, threshold stopping in realistic mode, WhyButton/AddToDeck in practice mode. Session produces InterviewResult array on completion.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Interview session plays greeting before first question
3. Chime sounds before each question TTS
4. Question text appears AFTER TTS finishes (audio-first)
5. Replay button works up to 2 times with count display
6. AudioWaveform shows during recording (or fallback if no mic)
7. Realistic mode: 15s timer auto-reveals, stops at 12 correct or 9 incorrect
8. Practice mode: Show Answer button, WhyButton, AddToDeckButton visible
9. Self-grade Correct/Incorrect with colored flash feedback
10. Session completes and passes results to InterviewPage
</verification>

<success_criteria>
Complete interview session flow works end-to-end for both Realistic and Practice modes. TTS, recording, timing, grading, and threshold logic all function correctly. The session produces a well-formed InterviewResult array.
</success_criteria>

<output>
After completion, create `.planning/phases/06-interview-simulation/06-04-SUMMARY.md`
</output>
