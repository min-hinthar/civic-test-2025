---
phase: 22-tts-quality
plan: 04
type: execute
wave: 2
depends_on: [22-01, 22-02]
files_modified:
  - src/lib/audio/burmeseAudio.ts
  - src/lib/pwa/sw.ts
  - src/components/ui/BurmeseSpeechButton.tsx
autonomous: true

must_haves:
  truths:
    - "Burmese audio plays through HTMLAudioElement with speed control matching TTS rate"
    - "Service worker caches audio files with CacheFirst strategy"
    - "Burmese speech button shows Myanmar flag and is visible only in Myanmar mode"
    - "BurmeseAudioAdapter state integrates with TTSProvider for unified speaking indicators"
  artifacts:
    - path: "src/lib/audio/burmeseAudio.ts"
      provides: "Burmese audio adapter with play/pause/resume/cancel and URL helper"
    - path: "src/components/ui/BurmeseSpeechButton.tsx"
      provides: "Myanmar flag speech button using Burmese audio adapter"
    - path: "src/lib/pwa/sw.ts"
      provides: "CacheFirst route for /audio/ files"
  key_links:
    - from: "src/components/ui/BurmeseSpeechButton.tsx"
      to: "src/lib/audio/burmeseAudio.ts"
      via: "createBurmesePlayer() adapter"
      pattern: "createBurmesePlayer|burmesePlayer"
    - from: "src/lib/pwa/sw.ts"
      to: "public/audio/"
      via: "CacheFirst runtime caching"
      pattern: "pathname.*audio"
---

<objective>
Create the Burmese audio playback infrastructure: HTMLAudioElement-based adapter with state subscription, URL helper for question audio files, service worker CacheFirst route for audio caching, and a BurmeseSpeechButton component with Myanmar flag that plays pre-generated MP3s.

Purpose: Provides the foundation for TTS-06 (Burmese audio for all 128 questions). Audio files will be generated in a later plan; this plan creates the playback and caching infrastructure.
Output: Burmese audio adapter module, BurmeseSpeechButton component, SW caching route.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-tts-quality/22-RESEARCH.md

@src/lib/audio/soundEffects.ts (existing audio pattern reference)
@src/lib/pwa/sw.ts
@src/components/ui/SpeechButton.tsx (reference for button styling)
@src/hooks/useTTS.ts
@src/contexts/TTSContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Burmese audio adapter and URL helper</name>
  <files>src/lib/audio/burmeseAudio.ts</files>
  <action>
Create `src/lib/audio/burmeseAudio.ts` with two exports:

**1. `getBurmeseAudioUrl()` helper:**
```typescript
export type AudioType = 'q' | 'a' | 'e'; // question, answer, explanation

export function getBurmeseAudioUrl(
  questionId: string,
  type: AudioType,
  voice: BurmeseVoice = 'nilar'
): string {
  const gender = voice === 'nilar' ? 'female' : 'male';
  return `/audio/my-MM/${gender}/${questionId}-${type}.mp3`;
}
```
Import `BurmeseVoice` from `@/lib/ttsTypes`.

**2. `createBurmesePlayer()` factory:**
A module-level audio player wrapping `HTMLAudioElement` with:
- `play(url: string, rate?: number): Promise<void>` -- creates new Audio element, sets playbackRate, resolves on ended, rejects on error. Cancels any previous playback first.
- `pause(): void` -- pauses the current audio element
- `resume(): void` -- resumes (calls `.play()` on the audio element)
- `cancel(): void` -- pauses, clears src, resets state
- `onStateChange(cb): () => void` -- subscribe to state changes (isSpeaking, isPaused, currentFile)
- State type: `{ isSpeaking: boolean; isPaused: boolean; currentFile: string | null }`
- On `play()`: set state to `{ isSpeaking: true, isPaused: false, currentFile: url }`, notify
- On `pause()`: set `isPaused: true`, notify
- On `resume()`: set `isPaused: false`, notify
- On `ended`/`error`/`cancel`: set to `{ isSpeaking: false, isPaused: false, currentFile: null }`, notify
- Error handling: On audio load error, retry once. If retry fails, reject with `Error('Burmese audio unavailable')`.
- The `play()` method should return a Promise that resolves when audio finishes and rejects on error.

Follow the subscriber pattern from ttsCore.ts (Set of callbacks, notify function).
  </action>
  <verify>
`npx tsc --noEmit` passes.
`npx eslint src/lib/audio/burmeseAudio.ts` passes.
  </verify>
  <done>
burmeseAudio.ts exports `getBurmeseAudioUrl` and `createBurmesePlayer`. The player wraps HTMLAudioElement with play/pause/resume/cancel and state subscription. Retry-once on load failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BurmeseSpeechButton and add SW caching route</name>
  <files>src/components/ui/BurmeseSpeechButton.tsx, src/lib/pwa/sw.ts</files>
  <action>
**BurmeseSpeechButton component** (`src/components/ui/BurmeseSpeechButton.tsx`):
1. Create a speech button specifically for Burmese audio playback
2. Props: `questionId: string`, `audioType: AudioType` (q/a/e), `label: string`, `className?: string`, `showSpeedLabel?: boolean`, `speedLabel?: string`
3. Internally:
   - Use `useTTSSettings()` to get `settings.burmeseVoice` (nilar/thiha) and `settings.rate`
   - Use `useTTS()` to get `rateToNumeric` function (from context via the hook -- NOT directly, since it's not currently on the hook). Actually, get rate from context: the rateToNumeric is on TTSContext. For simplicity, compute numeric rate inline: `const rateMap = { slow: 0.7, normal: 0.98, fast: 1.3 } as const;`
   - Create/use a module-level or useRef-based `createBurmesePlayer()` instance
   - On click: compute URL via `getBurmeseAudioUrl(questionId, audioType, burmeseVoice)`, then `player.play(url, numericRate)`
   - Toggle behavior: if playing, pause. If paused, resume. Same Android detection as SpeechButton (cancel instead of pause on Android).
   - State subscription: use `useState` + `useEffect` to subscribe to player state changes
4. Visual:
   - Myanmar flag icon instead of Volume2. Use a small inline SVG of the Myanmar flag (simple 3-stripe: yellow/green/red with white star). Make it 16x16.
   - Same base styling as SpeechButton (rounded-full, border, shadow, min-h-[44px])
   - Same speaking state: TTS color + SoundWaveIcon + ExpandingRings (reuse from SpeechButton -- extract them or import)
   - Same error state: red tint with tooltip
   - Same paused state: dimmed TTS color
5. Error handling:
   - On play error: show inline error state with tooltip "Burmese audio unavailable offline"
   - Disabled when offline AND no cached audio (check `navigator.onLine`)
6. Export as named export: `export function BurmeseSpeechButton(...)`

**Service worker caching** (`src/lib/pwa/sw.ts`):
1. Import `CacheFirst` and `ExpirationPlugin` from `serwist`
2. Replace `runtimeCaching: defaultCache` with `runtimeCaching: [...defaultCache, burmeseAudioRoute]`
3. The audio route:
```typescript
{
  matcher({ url }) {
    return url.pathname.startsWith('/audio/');
  },
  handler: new CacheFirst({
    cacheName: 'burmese-audio-v1',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 800,
        maxAgeSeconds: 90 * 24 * 60 * 60, // 90 days
      }),
    ],
  }),
}
```
4. Verify Serwist types allow this pattern. Check `@serwist/next` docs if needed. The `defaultCache` is an array of `RuntimeCaching` objects; we spread it and add our custom route.

Note: The SoundWaveIcon and ExpandingRings are currently private (not exported) in SpeechButton.tsx. Extract them to a shared file `src/components/ui/SpeechAnimations.tsx` so both SpeechButton and BurmeseSpeechButton can use them. Update SpeechButton.tsx to import from the new file.
  </action>
  <verify>
`npx tsc --noEmit` passes.
`npx eslint src/components/ui/BurmeseSpeechButton.tsx src/lib/pwa/sw.ts` passes.
`npm run build` succeeds (including service worker build).
  </verify>
  <done>
BurmeseSpeechButton renders Myanmar flag, plays pre-generated MP3s via burmeseAudio adapter, shows speaking/paused/error states. SW caches audio files with CacheFirst + 90-day expiry + 800 entry limit. SoundWaveIcon/ExpandingRings extracted to shared file.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds (SW compiles without errors)
2. `npx tsc --noEmit` passes
3. `npm run lint` passes
4. BurmeseSpeechButton renders with Myanmar flag icon
5. burmeseAudio.ts provides correct URLs: `/audio/my-MM/female/GOV-P01-q.mp3` for nilar, `/audio/my-MM/male/GOV-P01-q.mp3` for thiha
6. SW config includes CacheFirst route for `/audio/` paths
</verification>

<success_criteria>
- Burmese audio adapter plays MP3s via HTMLAudioElement with speed control
- BurmeseSpeechButton shows Myanmar flag, integrates with pause/resume, error handling
- Service worker caches audio with CacheFirst (800 entries, 90 days)
- SoundWaveIcon/ExpandingRings shared between both speech button variants
- No new npm dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/22-tts-quality/22-04-SUMMARY.md`
</output>
