---
phase: 10-tech-debt-cleanup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/social/compositeScore.test.ts
  - src/lib/social/streakTracker.test.ts
  - src/lib/mastery/weakAreaDetection.test.ts
  - src/lib/srs/fsrsEngine.test.ts
  - src/lib/mastery/nudgeMessages.test.ts
  - src/lib/social/badgeEngine.test.ts
autonomous: true

must_haves:
  truths:
    - "Six new test files exist covering pure-function modules"
    - "All new tests pass alongside existing 108 tests"
    - "src/lib coverage improves meaningfully from 34.58% baseline"
  artifacts:
    - path: "src/lib/social/compositeScore.test.ts"
      provides: "Tests for calculateCompositeScore"
    - path: "src/lib/social/streakTracker.test.ts"
      provides: "Tests for calculateStreak, shouldAutoUseFreeze, checkFreezeEligibility"
    - path: "src/lib/mastery/weakAreaDetection.test.ts"
      provides: "Tests for detectWeakAreas, detectStaleCategories, getNextMilestone"
    - path: "src/lib/srs/fsrsEngine.test.ts"
      provides: "Tests for createNewSRSCard, gradeCard, isDue, getNextReviewText, getCardStatusLabel"
    - path: "src/lib/mastery/nudgeMessages.test.ts"
      provides: "Tests for getEncouragingMessage, getNudgeMessage, getLevelUpMessage, getUnattemptedMessage"
    - path: "src/lib/social/badgeEngine.test.ts"
      provides: "Tests for evaluateBadges, getNewlyEarnedBadge"
  key_links:
    - from: "src/lib/social/compositeScore.test.ts"
      to: "src/lib/social/compositeScore.ts"
      via: "import { calculateCompositeScore }"
      pattern: "calculateCompositeScore"
    - from: "src/lib/social/streakTracker.test.ts"
      to: "src/lib/social/streakTracker.ts"
      via: "import { calculateStreak, shouldAutoUseFreeze, checkFreezeEligibility }"
      pattern: "calculateStreak"
    - from: "src/lib/mastery/weakAreaDetection.test.ts"
      to: "src/lib/mastery/weakAreaDetection.ts"
      via: "import { detectWeakAreas }"
      pattern: "detectWeakAreas"
---

<objective>
Add unit tests for 6 pure-function modules to improve src/lib test coverage from the 34.58% baseline.

Purpose: FNDN-08 requires test coverage with per-file thresholds. Currently only 6 test files exist covering shuffle, saveSession, errorSanitizer, errorBoundary, navigationLock, and calculateMastery. Adding tests for 6 more pure-function modules in src/lib strengthens regression safety with minimal effort (no mocking needed).

Output: 6 new test files targeting pure functions with deterministic I/O.
</objective>

<execution_context>
@C:/Users/minkk/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/minkk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-tech-debt-cleanup/10-RESEARCH.md

Key source files to test:
@src/lib/social/compositeScore.ts
@src/lib/social/streakTracker.ts
@src/lib/mastery/weakAreaDetection.ts
@src/lib/srs/fsrsEngine.ts
@src/lib/mastery/nudgeMessages.ts
@src/lib/social/badgeEngine.ts

Existing test patterns:
@src/__tests__/shuffle.test.ts (example of pure function test)
@src/lib/mastery/calculateMastery.test.ts (example of colocated test)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tests for social pure functions (compositeScore, streakTracker, badgeEngine)</name>
  <files>
    src/lib/social/compositeScore.test.ts
    src/lib/social/streakTracker.test.ts
    src/lib/social/badgeEngine.test.ts
  </files>
  <action>
    Create 3 colocated test files next to their source modules.

    **compositeScore.test.ts** (~15-20 tests):
    Read `src/lib/social/compositeScore.ts` first to understand the function signature and weighting.
    Test cases:
    - All zero inputs return 0
    - Streak capping at 30 days (31+ should produce same score as 30)
    - Accuracy at 100% contributes 50 points (50% weight)
    - Coverage at 100% contributes 20 points (20% weight)
    - Streak at 30 contributes 30 points (30% weight)
    - Perfect score (30-day streak + 100% accuracy + 100% coverage) = 100
    - Negative inputs clamped to 0
    - Inputs above 100 clamped
    - Various intermediate values for accuracy weighting

    **streakTracker.test.ts** (~15-20 tests):
    Read `src/lib/social/streakTracker.ts` first to understand all exported functions and their signatures.
    Use `vi.useFakeTimers()` and `vi.setSystemTime()` for date-dependent tests.
    Test cases for `calculateStreak`:
    - Empty activity array returns current:0, longest:0
    - Single today activity returns current:1, longest:1
    - Consecutive days build streak
    - Gap in days resets current streak
    - Longest streak tracked separately from current
    - Freeze days fill gaps (if freeze dates array is used)

    Test cases for `shouldAutoUseFreeze`:
    - Returns true when streak would break and freeze available
    - Returns false when no freeze available
    - Returns false when no streak to protect

    Test cases for `checkFreezeEligibility`:
    - Eligible when conditions met
    - Not eligible when conditions not met

    **badgeEngine.test.ts** (~10-15 tests):
    Read `src/lib/social/badgeEngine.ts` and `src/lib/social/badgeDefinitions.ts` first.
    Test cases for `evaluateBadges`:
    - Empty data returns no badges
    - Meeting streak threshold earns streak badge
    - Meeting coverage threshold earns coverage badge
    - Multiple badges can be earned simultaneously

    Test cases for `getNewlyEarnedBadge`:
    - Returns new badge when one is newly earned
    - Returns null when no new badges

    IMPORTANT: All imports should use relative paths from test file to source (e.g., `import { calculateCompositeScore } from './compositeScore'`).
    Use `describe`, `it`, `expect` from vitest. Use `vi.useFakeTimers()` for date-based tests and call `vi.useRealTimers()` in afterEach.
  </action>
  <verify>
    `npx vitest run src/lib/social/compositeScore.test.ts src/lib/social/streakTracker.test.ts src/lib/social/badgeEngine.test.ts` -- all tests pass.
  </verify>
  <done>
    3 social module test files created and passing. compositeScore, streakTracker, and badgeEngine have test coverage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for mastery and SRS pure functions (weakAreaDetection, nudgeMessages, fsrsEngine)</name>
  <files>
    src/lib/mastery/weakAreaDetection.test.ts
    src/lib/mastery/nudgeMessages.test.ts
    src/lib/srs/fsrsEngine.test.ts
  </files>
  <action>
    Create 3 colocated test files next to their source modules.

    **weakAreaDetection.test.ts** (~15-20 tests):
    Read `src/lib/mastery/weakAreaDetection.ts` first to understand function signatures.
    Test cases for `detectWeakAreas`:
    - Empty mastery data returns empty array
    - Categories below threshold are detected as weak
    - Categories above threshold are not weak
    - Returns sorted by weakness (lowest accuracy first)

    Test cases for `detectStaleCategories`:
    - Categories with no recent activity are stale
    - Recently active categories are not stale
    - Empty history returns all categories as stale

    Test cases for `getNextMilestone`:
    - Below 50% returns bronze milestone
    - At 50% returns silver milestone
    - At 75% returns gold milestone
    - At 100% returns null (already maxed)

    **nudgeMessages.test.ts** (~10-15 tests):
    Read `src/lib/mastery/nudgeMessages.ts` first.
    Test cases for each message function:
    - Returns a non-empty string for valid inputs
    - Returns both English and Burmese text (bilingual)
    - Different categories produce different messages (deterministic hash)
    - Edge cases: empty string category, very long category name

    **fsrsEngine.test.ts** (~15-20 tests):
    Read `src/lib/srs/fsrsEngine.ts` first to understand the wrapper functions.
    Test cases for `createNewSRSCard`:
    - Returns a card object with expected default fields
    - Card starts in "New" state

    Test cases for `gradeCard`:
    - Easy rating increases interval
    - Hard rating resets/reduces interval
    - Returns updated card with new due date

    Test cases for `isDue`:
    - Card due in the past returns true
    - Card due in the future returns false
    - Use `vi.useFakeTimers()` for deterministic date testing

    Test cases for `getNextReviewText`:
    - Returns bilingual text with Burmese numerals
    - Handles various interval lengths (minutes, hours, days)

    Test cases for `getCardStatusLabel`:
    - New card returns "New" label
    - Learning card returns "Learning" label
    - Review card returns "Review" label

    IMPORTANT: The FSRS library may need specific card/log types. Read the source file carefully to understand what types `gradeCard` expects and returns. Create minimal valid card objects for testing.
  </action>
  <verify>
    `npx vitest run src/lib/mastery/weakAreaDetection.test.ts src/lib/mastery/nudgeMessages.test.ts src/lib/srs/fsrsEngine.test.ts` -- all tests pass.
    `npx vitest run` -- ALL tests (existing + new) pass.
  </verify>
  <done>
    3 mastery/SRS test files created and passing. weakAreaDetection, nudgeMessages, and fsrsEngine have test coverage. Total test count increased meaningfully from 108 baseline.
  </done>
</task>

</tasks>

<verification>
Run these checks to verify plan completion:

1. `npx vitest run` -- all tests pass (108+ existing + new tests)
2. `npx vitest run --coverage` -- src/lib coverage improved from 34.58% baseline
3. All 6 test files exist:
   - `ls src/lib/social/compositeScore.test.ts` -- exists
   - `ls src/lib/social/streakTracker.test.ts` -- exists
   - `ls src/lib/social/badgeEngine.test.ts` -- exists
   - `ls src/lib/mastery/weakAreaDetection.test.ts` -- exists
   - `ls src/lib/mastery/nudgeMessages.test.ts` -- exists
   - `ls src/lib/srs/fsrsEngine.test.ts` -- exists
</verification>

<success_criteria>
- 6 new test files created for pure-function modules
- All new tests pass
- All existing 108 tests still pass
- src/lib coverage improved from 34.58% baseline (target: meaningful improvement toward 50%+)
- No test files require IndexedDB or Supabase mocks
</success_criteria>

<output>
After completion, create `.planning/phases/10-tech-debt-cleanup/10-03-SUMMARY.md`
</output>
